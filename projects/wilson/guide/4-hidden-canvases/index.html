<!DOCTYPE html><html lang="en"><head><title>Cruz Godar</title><meta property="og:title" content="Cruz Godar"/><meta property="og:type" content="website"/><meta property="og:url" content="https://cruzgodar.com/projects/wilson/guide/4-hidden-canvases/"/><meta property="og:image" content="https://cruzgodar.com/projects/wilson/guide/4-hidden-canvases/cover.jpg"/><meta property="og:locale" content="en_US"/><meta property="og:site_name" content="Cruz Godar"/><style>body {opacity: 0;}</style></head><body><noscript><p class="body-text" style="text-align: center">JavaScript is required to use this site and many others. Consider enabling it.</p></noscript><p class="body-text">header Part 4: Hidden Canvases</p><p class="body-text">nav-buttons</p><p class="body-text">begin-text-block</p><p class="body-text">One problem you probably noticed with the CPU canvas was a rapid fluctuation in brightness due to a high variation in the value of the brightest pixel. Now we have a different problem &mdash; there&#x2019;s not a clear way to automatically control the brightness at all. One option is to try a value, then see how many pixels are at max brightness and slightly adjust the brightness scale on the next frame. This is expensive, though, and if the brightness changes suddenly, it will take a while to catch up. A better solution is to render a second canvas with the same shader at a very low resolution &mdash; say 100x100 &mdash; and no brightness scale at all. Then we can read off the max brightness from that canvas and use it for the output one.</p><p class="body-text">This process is simple &mdash; all we have to do is register a second canvas with Wilson and give it a similar set of options.</p><p class="body-text">end-text-block</p><pre><code class="language-html" data-aos="fade-up">&lt;input id="resolution-input" type="text" value="1000"&gt;<p class="body-text">&lt;label for="resolution-input"&gt;</p><p class="body-text">&#9;&lt;p&gt;Resolution&lt;/p&gt;</p><p class="body-text">&lt;/label&gt;</p><p class="body-text">&lt;canvas id="hidden-canvas"&gt&lt;/canvas&gt;</p><p class="body-text">&lt;canvas id="output-canvas"&gt&lt;/canvas&gt;</code></pre></p><br><pre><code class="language-css" data-aos="fade-up">#hidden-canvas<p class="body-text">{</p><p class="body-text">&#9;position: fixed;</p><p class="body-text">&#9;left: -100px;</p><p class="body-text">&#9;width: 10px;</p><p class="body-text">&#9;height: 10px;</p><p class="body-text">}</code></pre></p><br><pre><code class="language-js" data-aos="fade-up">let options_hidden =<p class="body-text">{</p><p class="body-text">&#9;renderer: "gpu",</p><p class="body-text">&#9;</p><p class="body-text">&#9;shader: frag_shader_source,</p><p class="body-text">&#9;</p><p class="body-text">&#9;canvas_width: 100,</p><p class="body-text">&#9;canvas_height: 100</p><p class="body-text">};</p><p class="body-text">let wilson_hidden = new Wilson(document.querySelector("#hidden-canvas"), options_hidden);</p><p class="body-text">wilson_hidden.render.init_uniforms(["a", "b", "brightness_scale"]);</code></pre></p><br><pre><code class="language-js" data-aos="fade-up">function draw_julia_set(timestamp)<p class="body-text">{</p><p class="body-text">&#9;let time_elapsed = timestamp - last_timestamp;</p><p class="body-text">&#9;</p><p class="body-text">&#9;last_timestamp = timestamp;</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;if (time_elapsed === 0)</p><p class="body-text">&#9;{</p><p class="body-text">&#9;&#9;return;</p><p class="body-text">&#9;}</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;wilson_hidden.gl.uniform1f(wilson_hidden.uniforms["a"], a);</p><p class="body-text">&#9;wilson_hidden.gl.uniform1f(wilson_hidden.uniforms["b"], b);</p><p class="body-text">&#9;</p><p class="body-text">&#9;/*</p><p class="body-text">&#9;&#9;Like range in a photo, the brightness will get clipped if we let it go above 1.</p><p class="body-text">&#9;&#9;Therefore, we divide by a large number to make sure that doesn&#x2019;t happen.</p><p class="body-text">&#9;&#9;Too large and everything will get compressed into too few dark values instead,</p><p class="body-text">&#9;&#9;so we need to pick a brightness scale in the middle.</p><p class="body-text">&#9;*/</p><p class="body-text">&#9;wilson_hidden.gl.uniform1f(wilson_hidden.uniforms["brightness_scale"], 20);</p><p class="body-text">&#9;</p><p class="body-text">&#9;wilson_hidden.render.draw_frame();</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;let pixel_data = wilson_hidden.render.get_pixel_data();</p><p class="body-text">&#9;</p><p class="body-text">&#9;let brightnesses = new Array(resolution_hidden * resolution_hidden);</p><p class="body-text">&#9;</p><p class="body-text">&#9;for (let i = 0; i &lt; resolution_hidden * resolution_hidden; i++)</p><p class="body-text">&#9;{</p><p class="body-text">&#9;&#9;brightnesses[i] = pixel_data[4 <em> i] + pixel_data[4 </em> i + 1] + pixel_data[4 * i + 2];</p><p class="body-text">&#9;}</p><p class="body-text">&#9;</p><p class="body-text">&#9;brightnesses.sort((a, b) => a - b);</p><p class="body-text">&#9;</p><p class="body-text">&#9;//Both the .98 and 18 here were found experimentally.</p><p class="body-text">&#9;let brightness_scale = brightnesses[Math.floor(resolution_hidden <em> resolution_hidden </em> .98)] / 255 * 18;</p><p class="body-text">&#9;</p><p class="body-text">brightness_scale = Math.max(brightness_scale, .1);</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;</p><p class="body-text">&#9;wilson.gl.uniform1f(wilson.uniforms["a"], a);</p><p class="body-text">&#9;wilson.gl.uniform1f(wilson.uniforms["b"], b);</p><p class="body-text">&#9;wilson.gl.uniform1f(wilson.uniforms["brightness_scale"], brightness_scale);</p><p class="body-text">&#9;</p><p class="body-text">&#9;wilson.render.draw_frame();</p><p class="body-text">}</code></pre></p><br><p class="body-text">begin-text-block</p><p class="body-text">Notice that we&#x2019;re sorting the brightnesses and throwing out the top 2% &mdash; this effectively removes outlier pixels and keeps the brightness stable frame-to-frame. Since the hidden canvas is so small, this sorting isn&#x2019;t expensive.</p><p class="body-text">To illustrate what&#x2019;s going on, the hidden canvas is superimposed on the output canvas here, but it should obviously be hidden in all other cases.</p><p class="body-text">end-text-block</p><p class="body-text">begin-text-boxes</p><p class="body-text">resolution 1000 Resolution</p><p class="body-text">end-text-boxes</p><div class="center-content" style="margin-bottom: 50px"><div id="container" style="position: relative; width: 70vmin; height: 70vmin" data-aos="fade-up"><div style="position: absolute; top: 0; left: 0; margin: 0"><canvas id="output-canvas" class="output-canvas"></canvas></div><div style="position: absolute; top: 0; left: 0; margin: 0; width: 15vmin; height: 15vmin"><canvas id="hidden-canvas" class="hidden-canvas-superimposed"></canvas></div></div></div><p class="body-text">begin-text-buttons</p><p class="body-text">download Download</p><p class="body-text">end-text-buttons</p><p class="body-text">section</p><p class="body-text">begin-text-block</p><p class="body-text">In the next section, we&#x2019;ll add the ability to run the applet in fullscreen, leveraging as much screen space as possible.</p><p class="body-text">You can view the code for this page <a href="/projects/wilson/guide/4-hidden-canvases/scripts/hidden-canvases.js">here</a>.</p><p class="body-text">end-text-block</p><p class="body-text">nav-buttons</p><p class="body-text">footer</p></section></main><script>"undefined"==typeof Page&&(""!==window.location.search?window.location.replace("/index.html?page="+encodeURIComponent(window.location.pathname)+"&"+window.location.search.slice(1)):window.location.replace("/index.html?page="+encodeURIComponent(window.location.pathname))),Page.settings = {"title": "Part 4: Hidden Canvases","math_page": true,"small_margins_on_ultrawide": true,"parent_list": "/projects/wilson/guide"},Page.load()</script></body></html>