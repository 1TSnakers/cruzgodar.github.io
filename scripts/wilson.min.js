import{addHoverEventWithScale}from"./src/hoverEvents.min.js";import{addTemporaryListener}from"/scripts/src/main.min.js";import{metaThemeColorElement}from"/scripts/src/settings.min.js";class Wilson{canvas=null;ctx=null;gl=null;shaderPrograms=[];uniforms={};canvasWidth=null;canvasHeight=null;worldWidth=2;worldHeight=2;worldCenterX=0;worldCenterY=0;outputCanvasContainer=null;useDraggables=!1;topPadding=0;leftPadding=0;topBorder=0;leftBorder=0;constructor(canvas,options){this.canvas=canvas,this.canvasWidth=void 0===options.canvasWidth?parseInt(this.canvas.getAttribute("width")):options.canvasWidth,this.canvasHeight=void 0===options.canvasHeight?parseInt(this.canvas.getAttribute("height")):options.canvasHeight,this.canvas.setAttribute("width",this.canvasWidth),this.canvas.setAttribute("height",this.canvasHeight);var e=window.getComputedStyle(this.canvas);if(this.topPadding=parseFloat(e.paddingTop),this.leftPadding=parseFloat(e.paddingLeft),this.topBorder=parseFloat(e.borderTopWidth),this.leftBorder=parseFloat(e.borderLeftWidth),""!==(((((this.utils.interpolate.parent=this).render.parent=this).draggables.parent=this).fullscreen.parent=this).input.parent=this).canvas.id?console.log(`[Wilson] Registered a ${this.canvasWidth}x${this.canvasHeight} canvas with ID `+this.canvas.id):console.log(`[Wilson] Registered a ${this.canvasWidth}x${this.canvasHeight} canvas`),void 0===options.canvasesToResize&&(options.canvasesToResize=[this.canvas]),void 0!==options.worldWidth&&(this.worldWidth=options.worldWidth),void 0!==options.worldHeight&&(this.worldHeight=options.worldHeight),void 0!==options.worldCenterX&&(this.worldCenterX=options.worldCenterX),void 0!==options.worldCenterY&&(this.worldCenterY=options.worldCenterY),void 0===options.renderer||"hybrid"===options.renderer?this.render.renderType=1:"cpu"===options.renderer?this.render.renderType=0:this.render.renderType=2,0===this.render.renderType)this.ctx=this.canvas.getContext("2d",{colorSpace:"display-p3"}),this.render.imgData=this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight),this.render.drawFrame=this.render.drawFrameCpu;else if(1===this.render.renderType){this.render.initWebglHybrid(),this.render.drawFrame=this.render.drawFrameHybrid;try{this.gl.getExtension("OES_texture_float")}catch(e){console.log("[Wilson] Could not load float textures: "+e)}}else{try{this.render.loadNewShader(options.shader)}catch(e){console.error("[Wilson] Error loading shader: "+e)}this.render.drawFrame=this.render.drawFrameGpu;try{this.gl.getExtension("OES_texture_float")}catch(e){console.log("[Wilson] Could not load float textures: "+e)}}void 0!==options.autoArrangeCanvases&&!options.autoArrangeCanvases||this.arrangeCanvases(options),this.input.mousedownCallback=void 0===options.mousedownCallback?null:options.mousedownCallback,this.input.mouseupCallback=void 0===options.mouseupCallback?null:options.mouseupCallback,this.input.mousemoveCallback=void 0===options.mousemoveCallback?null:options.mousemoveCallback,this.input.mousedragCallback=void 0===options.mousedragCallback?null:options.mousedragCallback,this.input.touchstartCallback=void 0===options.touchstartCallback?null:options.touchstartCallback,this.input.touchendCallback=void 0===options.touchendCallback?null:options.touchendCallback,this.input.touchmoveCallback=void 0===options.touchmoveCallback?null:options.touchmoveCallback,this.input.pinchCallback=void 0===options.pinchCallback?null:options.pinchCallback,this.input.wheelCallback=void 0===options.wheelCallback?null:options.wheelCallback,this.input.init(),this.useDraggables=!0,this.draggables.static=void 0!==options.draggablesStatic&&options.draggablesStatic,this.draggables.mousedownCallback=void 0===options.draggablesMousedownCallback?null:options.draggablesMousedownCallback,this.draggables.mouseupCallback=void 0===options.draggablesMouseupCallback?null:options.draggablesMouseupCallback,this.draggables.mousemoveCallback=void 0===options.draggablesMousemoveCallback?null:options.draggablesMousemoveCallback,this.draggables.touchstartCallback=void 0===options.draggablesTouchstartCallback?null:options.draggablesTouchstartCallback,this.draggables.touchendCallback=void 0===options.draggablesTouchendCallback?null:options.draggablesTouchendCallback,this.draggables.touchmoveCallback=void 0===options.draggablesTouchmoveCallback?null:options.draggablesTouchmoveCallback,this.draggables.init(),void 0!==options.useFullscreen&&options.useFullscreen&&(this.fullscreen.trueFullscreen=void 0!==options.trueFullscreen&&options.trueFullscreen,this.fullscreen.useFullscreenButton=void 0!==options.useFullscreenButton&&options.useFullscreenButton,this.fullscreen.useFullscreenButton&&void 0===options.enterFullscreenButtonIconPath&&console.error("Missing path to Enter Fullscreen button image"),this.fullscreen.useFullscreenButton&&void 0===options.exitFullscreenButtonIconPath&&console.error("Missing path to Exit Fullscreen button image"),this.fullscreen.enterFullscreenButtonIconPath=options.enterFullscreenButtonIconPath,this.fullscreen.exitFullscreenButtonIconPath=options.exitFullscreenButtonIconPath,this.fullscreen.switchFullscreenCallback=void 0!==options.switchFullscreenCallback&&options.switchFullscreenCallback,void 0===options.canvasesToResize&&console.error("Missing canvases to resize"),this.fullscreen.canvasesToResize=options.canvasesToResize,this.fullscreen.init())}arrangeCanvases(options){0===document.querySelectorAll("#wilson-style").length&&((t=document.createElement("style")).textContent=`
				.wilson-output-canvas-container
				{
					position: relative;
					-webkit-user-select: none;
					user-select: none;
				}
				
				.wilson-applet-canvas-container
				{
					-webkit-user-select: none;
					user-select: none;
				}
				
				.wilson-center-content
				{
					display: flex;
					justify-content: center;
					margin: 0 auto;
				}
			`,t.id="wilson-style",document.head.appendChild(t));var e=document.createElement("div");e.classList.add("wilson-applet-canvas-container"),e.classList.add("wilson-center-content"),this.canvas.parentNode.insertBefore(e,this.canvas),this.outputCanvasContainer=document.createElement("div"),this.outputCanvasContainer.classList.add("wilson-output-canvas-container"),e.appendChild(this.outputCanvasContainer);for(let n=0;n<options.canvasesToResize.length;n++)e.appendChild(options.canvasesToResize[n]);this.outputCanvasContainer.appendChild(this.canvas),this.draggables.container=document.createElement("div"),this.draggables.container.classList.add("wilson-draggables-container"),e.appendChild(this.draggables.container),this.fullscreen.canvasesToResize.push(this.draggables.container);var t=window.getComputedStyle(this.canvas),s=this.canvas.clientWidth-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),a=this.canvas.clientHeight-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom);this.draggables.container.style.width=s+2*this.draggables.draggableRadius+"px",this.draggables.container.style.height=a+2*this.draggables.draggableRadius+"px",this.draggables.containerWidth=s+2*this.draggables.draggableRadius,this.draggables.containerHeight=a+2*this.draggables.draggableRadius,this.draggables.restrictedWidth=s,this.draggables.restrictedHeight=a,this.draggables.container.style.marginTop=parseFloat(t.borderTopWidth)+parseFloat(t.paddingTop)-this.draggables.draggableRadius+"px",this.fullscreen.fullscreenComponentsContainer=document.createElement("div"),this.fullscreen.fullscreenComponentsContainer.classList.add("wilson-fullscreen-components-container"),e.parentNode.insertBefore(this.fullscreen.fullscreenComponentsContainer,e),this.fullscreen.fullscreenComponentsContainer.appendChild(e),this.fullscreen.fullscreenComponentsContainerLocation=document.createElement("div"),this.fullscreen.fullscreenComponentsContainer.parentNode.insertBefore(this.fullscreen.fullscreenComponentsContainerLocation,this.fullscreen.fullscreenComponentsContainer),this.fullscreen.fullscreenComponentsContainerLocation.appendChild(this.fullscreen.fullscreenComponentsContainer);for(let i=0;i<this.fullscreen.canvasesToResize.length;i++)this.fullscreen.canvasesToResize[i].addEventListener("gesturestart",e=>e.preventDefault()),this.fullscreen.canvasesToResize[i].addEventListener("gesturechange",e=>e.preventDefault()),this.fullscreen.canvasesToResize[i].addEventListener("gestureend",e=>e.preventDefault()),this.fullscreen.canvasesToResize[i].addEventListener("click",e=>e.preventDefault())}utils={interpolate:{canvasToWorld(row,col){return[(col/this.parent.canvasWidth-.5)*this.parent.worldWidth+this.parent.worldCenterX,(.5-row/this.parent.canvasHeight)*this.parent.worldHeight+this.parent.worldCenterY]},worldToCanvas(x,y){return[Math.floor((.5-(y-this.parent.worldCenterY)/this.parent.worldHeight)*this.parent.canvasHeight),Math.floor(((x-this.parent.worldCenterX)/this.parent.worldWidth+.5)*this.parent.canvasWidth)]}},hsvToRgb(h,s,v){function e(n){var e=(n+6*h)%6;return v-v*s*Math.max(0,Math.min(e,Math.min(4-e,1)))}return[255*e(5),255*e(3),255*e(1)]}};render={drawFrame:null,renderType:null,lastImage:null,imgData:null,shaderProgram:null,shaderPrograms:[],texture:null,framebuffers:[],drawFrameCpu(image){this.parent.ctx.putImageData(new ImageData(image,this.parent.canvasWidth,this.parent.canvasHeight),0,0)},drawFrameHybrid(image){this.lastImage=image,this.parent.gl.texImage2D(this.parent.gl.TEXTURE_2D,0,this.parent.gl.RGBA,this.parent.canvasWidth,this.parent.canvasHeight,0,this.parent.gl.RGBA,this.parent.gl.UNSIGNED_BYTE,image),this.parent.gl.drawArrays(this.parent.gl.TRIANGLE_STRIP,0,4)},drawFrameGpu(){this.parent.gl.drawArrays(this.parent.gl.TRIANGLE_STRIP,0,4)},initWebglHybrid(){this.parent.gl=this.parent.canvas.getContext("webgl"),"drawingBufferColorSpace"in this.parent.gl&&(this.parent.gl.drawingBufferColorSpace="display-p3");var e=s(this.parent.gl,this.parent.gl.VERTEX_SHADER,`
				attribute vec3 position;
				varying vec2 uv;

				void main(void)
				{
					gl_Position = vec4(position, 1.0);

					//Interpolate quad coordinates in the fragment shader.
					uv = position.xy;
				}
			`),t=s(this.parent.gl,this.parent.gl.FRAGMENT_SHADER,`
				precision highp float;
				
				varying vec2 uv;
				
				uniform sampler2D uTexture;
				
				
				
				void main(void)
				{
					gl_FragColor = texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0);
				}
			`),e=(this.shaderProgram=this.parent.gl.createProgram(),this.parent.gl.attachShader(this.shaderProgram,e),this.parent.gl.attachShader(this.shaderProgram,t),this.parent.gl.linkProgram(this.shaderProgram),this.parent.gl.getProgramParameter(this.shaderProgram,this.parent.gl.LINK_STATUS)||(console.error("[Wilson] Couldn't link shader program: "+this.parent.gl.getShaderInfoLog(t)),this.parent.gl.deleteProgram(this.shaderProgram)),this.parent.gl.useProgram(this.shaderProgram),this.parent.gl.createBuffer());function s(gl,type,source){var e=gl.createShader(type);return gl.shaderSource(e,source),gl.compileShader(e),gl.getShaderParameter(e,gl.COMPILE_STATUS)||(console.error("[Wilson] Couldn't load shader: "+gl.getShaderInfoLog(e)),gl.deleteShader(e)),e}this.parent.gl.bindBuffer(this.parent.gl.ARRAY_BUFFER,e),this.parent.gl.bufferData(this.parent.gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0]),this.parent.gl.STATIC_DRAW),this.shaderProgram.positionAttribute=this.parent.gl.getAttribLocation(this.shaderProgram,"position"),this.parent.gl.enableVertexAttribArray(this.shaderProgram.positionAttribute),this.parent.gl.vertexAttribPointer(this.shaderProgram.positionAttribute,3,this.parent.gl.FLOAT,!1,0,0),this.parent.gl.viewport(0,0,this.parent.canvasWidth,this.parent.canvasHeight),this.parent.gl.pixelStorei(this.parent.gl.UNPACK_ALIGNMENT,1),this.parent.gl.pixelStorei(this.parent.gl.UNPACK_FLIP_Y_WEBGL,1),this.texture=this.parent.gl.createTexture(),this.parent.gl.bindTexture(this.parent.gl.TEXTURE_2D,this.texture),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_S,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_T,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MAG_FILTER,this.parent.gl.NEAREST),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MIN_FILTER,this.parent.gl.NEAREST),this.parent.gl.disable(this.parent.gl.DEPTH_TEST)},loadNewShader(fragShaderSource){this.parent.gl=this.parent.canvas.getContext("webgl"),"drawingBufferColorSpace"in this.parent.gl&&(this.parent.gl.drawingBufferColorSpace="display-p3");var e=s(this.parent.gl,this.parent.gl.VERTEX_SHADER,`
				attribute vec3 position;
				varying vec2 uv;

				void main(void)
				{
					gl_Position = vec4(position, 1.0);

					//Interpolate quad coordinates in the fragment shader.
					uv = position.xy;
				}
			`),t=s(this.parent.gl,this.parent.gl.FRAGMENT_SHADER,fragShaderSource),e=(this.shaderProgram=this.parent.gl.createProgram(),this.parent.gl.attachShader(this.shaderProgram,e),this.parent.gl.attachShader(this.shaderProgram,t),this.parent.gl.linkProgram(this.shaderProgram),this.parent.gl.getProgramParameter(this.shaderProgram,this.parent.gl.LINK_STATUS)||(console.log("[Wilson] Couldn't link shader program: "+this.gl.getShaderInfoLog(t)),this.parent.gl.deleteProgram(this.shaderProgram)),this.parent.gl.useProgram(this.shaderProgram),this.parent.gl.createBuffer());function s(gl,type,source){var e=gl.createShader(type);return gl.shaderSource(e,source),gl.compileShader(e),gl.getShaderParameter(e,gl.COMPILE_STATUS)||(console.log("[Wilson] Couldn't load shader: "+gl.getProgramInfoLog(e)),gl.deleteShader(e)),e}this.parent.gl.bindBuffer(this.parent.gl.ARRAY_BUFFER,e),this.parent.gl.bufferData(this.parent.gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0]),this.parent.gl.STATIC_DRAW),this.shaderProgram.positionAttribute=this.parent.gl.getAttribLocation(this.shaderProgram,"position"),this.parent.gl.enableVertexAttribArray(this.shaderProgram.positionAttribute),this.parent.gl.vertexAttribPointer(this.shaderProgram.positionAttribute,3,this.parent.gl.FLOAT,!1,0,0),this.parent.gl.viewport(0,0,this.parent.canvasWidth,this.parent.canvasHeight),this.shaderPrograms.push(this.shaderProgram)},createFramebufferTexturePair(type=this.parent.gl.FLOAT){var e=this.parent.gl.createFramebuffer(),t=this.parent.gl.createTexture();this.parent.gl.bindTexture(this.parent.gl.TEXTURE_2D,t),this.parent.gl.texImage2D(this.parent.gl.TEXTURE_2D,0,this.parent.gl.RGBA,this.parent.canvasWidth,this.parent.canvasHeight,0,this.parent.gl.RGBA,type,null),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MAG_FILTER,this.parent.gl.NEAREST),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MIN_FILTER,this.parent.gl.NEAREST),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_S,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_T,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.disable(this.parent.gl.DEPTH_TEST),this.parent.gl.bindFramebuffer(this.parent.gl.FRAMEBUFFER,e),this.parent.gl.framebufferTexture2D(this.parent.gl.FRAMEBUFFER,this.parent.gl.COLOR_ATTACHMENT0,this.parent.gl.TEXTURE_2D,t,0),this.framebuffers.push({framebuffer:e,texture:t})},initUniforms(variableNames,shaderProgramIndex=-1){if(-1===shaderProgramIndex)for(let e=0;e<variableNames.length;e++)this.parent.uniforms[variableNames[e]]=this.parent.gl.getUniformLocation(this.shaderProgram,variableNames[e]);else for(let t=0;t<variableNames.length;t++)void 0===this.parent.uniforms[variableNames[t]]&&(this.parent.uniforms[variableNames[t]]={}),this.parent.uniforms[variableNames[t]][shaderProgramIndex]=this.parent.gl.getUniformLocation(this.shaderPrograms[shaderProgramIndex],variableNames[t])},getPixelData(){var e=new Uint8Array(this.parent.canvasWidth*this.parent.canvasHeight*4);return this.parent.gl.readPixels(0,0,this.parent.canvasWidth,this.parent.canvasHeight,this.parent.gl.RGBA,this.parent.gl.UNSIGNED_BYTE,e),e}};draggables={parent:null,container:null,containerWidth:null,containerHeight:null,restrictedWidth:null,restrictedHeight:null,draggables:[],worldCoordinates:[],autoAddContainer:!0,numDraggables:0,static:!1,draggableRadius:12,activeDraggable:-1,lastActiveDraggable:-1,mouseX:0,mouseY:0,mousedownCallback:null,mouseupCallback:null,mousemoveCallback:null,touchstartCallback:null,touchendCallback:null,touchmoveCallback:null,init(){0===document.querySelectorAll("#wilson-draggables-style").length&&((e=document.createElement("style")).textContent=`
					.wilson-output-canvas-container
					{
						position: relative;
						width: fit-content;
					}

					.wilson-output-canvas-container.wilson-fullscreen
					{
						width: 100%;
					}
					
					.wilson-draggables-container
					{
						position: absolute;
						
						-webkit-user-select: none;
						user-select: none;
					}

					.wilson-draggable
					{
						position: absolute;
						
						width: 20px;
						height: 20px;
						
						left: 0;
						top: 0;
						
						background-color: rgb(255, 255, 255);
						border: 2px solid rgb(64, 64, 64);
						border-radius: 50%;
						
						touch-action: none;
						-webkit-touch-callout: none;
						-webkit-user-select: none;
						user-select: none;
						
						cursor: pointer;
						
						transition: width .125s ease-in-out, height .125s ease-in-out, top .125s ease-in-out, left .125s ease-in-out;
					}

					.wilson-draggable:active
					{
						width: 16px;
						height: 16px;
						
						left: 2px;
						top: 2px;
					}
				`,e.id="wilson-draggables-style",document.head.appendChild(e)),this.containerWidth=this.container.offsetWidth,this.containerHeight=this.container.offsetHeight;var e=this.handleTouchstartEvent.bind(this),t=this.handleTouchendEvent.bind(this),s=this.handleTouchmoveEvent.bind(this),a=this.handleMousedownEvent.bind(this),n=this.handleMouseupEvent.bind(this),i=this.handleMousemoveEvent.bind(this),r=this.onResize.bind(this);this.static||(addTemporaryListener({object:document.documentElement,event:"touchstart",callback:e}),addTemporaryListener({object:document.documentElement,event:"touchmove",callback:s}),addTemporaryListener({object:document.documentElement,event:"touchend",callback:t}),addTemporaryListener({object:document.documentElement,event:"mousedown",callback:a}),addTemporaryListener({object:document.documentElement,event:"mousemove",callback:i}),addTemporaryListener({object:document.documentElement,event:"mouseup",callback:n}),addTemporaryListener({object:window,event:"resize",callback:r}))},add(x,y){let e=Math.floor(this.restrictedHeight*(1-((y-this.parent.worldCenterY)/this.parent.worldHeight+.5)))+this.draggableRadius,t=Math.floor(this.restrictedWidth*((x-this.parent.worldCenterX)/this.parent.worldWidth+.5))+this.draggableRadius;(e=e<this.draggableRadius?this.draggableRadius:e)>this.containerHeight-this.draggableRadius&&(e=this.containerHeight-this.draggableRadius),(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerWidth-this.draggableRadius&&(t=this.containerWidth-this.draggableRadius);var s=document.createElement("div");return s.classList.add("wilson-draggable"),s.classList.add("wilson-draggable-"+this.numDraggables),s.style.transform=`translate3d(${t-this.draggableRadius}px, ${e-this.draggableRadius}px, 0)`,this.numDraggables++,this.draggables.push(s),this.worldCoordinates.push([x,y]),this.container.appendChild(s),s},handleMousedownEvent(e){this.activeDraggable=-1;for(let t=0;t<this.numDraggables;t++)if(e.target.classList.contains("wilson-draggable-"+t)&&e.target.parentNode===this.container){e.preventDefault(),this.activeDraggable=t,this.currentlyDragging=!0,this.mouseX=e.clientX,this.mouseY=e.clientY;try{this.mousedownCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],e)}catch(e){}break}},handleMouseupEvent(e){if(-1!==this.activeDraggable){document.body.style.WebkitUserSelect="",this.lastActiveDraggable=this.activeDraggable;try{this.mouseupCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],e)}catch(e){}}this.activeDraggable=-1,this.currentlyDragging=!1},handleMousemoveEvent(e){if(this.currentlyDragging&&-1!==this.activeDraggable){e.preventDefault();var a=e.clientX,n=e.clientY,a=(this.mouseX=a,this.mouseY=n,this.container.getBoundingClientRect());let t=e.clientY-a.top,s=e.clientX-a.left;(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerHeight-this.draggableRadius&&(t=this.containerHeight-this.draggableRadius),(s=s<this.draggableRadius?this.draggableRadius:s)>this.containerWidth-this.draggableRadius&&(s=this.containerWidth-this.draggableRadius),this.draggables[this.activeDraggable].style.transform=`translate3d(${s-this.draggableRadius}px, ${t-this.draggableRadius}px, 0)`;n=(s-this.draggableRadius-this.restrictedWidth/2)/this.restrictedWidth*this.parent.worldWidth+this.parent.worldCenterX,a=-(t-this.draggableRadius-this.restrictedHeight/2)/this.restrictedHeight*this.parent.worldHeight+this.parent.worldCenterY;this.worldCoordinates[this.activeDraggable][0]=n,this.worldCoordinates[this.activeDraggable][1]=a;try{this.mousemoveCallback(this.activeDraggable,n,a,e)}catch(e){}}},handleTouchstartEvent(e){this.activeDraggable=-1;for(let t=0;t<this.numDraggables;t++)if(e.target.classList.contains("wilson-draggable-"+t)&&e.target.parentNode===this.container){e.preventDefault(),this.activeDraggable=t,this.currentlyDragging=!0,this.mouseX=e.touches[0].clientX,this.mouseY=e.touches[0].clientY;try{this.touchstartCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],e)}catch(e){}break}},handleTouchendEvent(e){if(-1!==this.activeDraggable){document.body.style.WebkitUserSelect="",this.lastActiveDraggable=this.activeDraggable;try{this.touchendCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],e)}catch(e){}}this.activeDraggable=-1,this.currentlyDragging=!1},handleTouchmoveEvent(e){if(this.currentlyDragging&&-1!==this.activeDraggable){e.preventDefault(),this.mouseX=e.touches[0].clientX,this.mouseY=e.touches[0].clientY;var a=this.container.getBoundingClientRect();let t=this.mouseY-a.top,s=this.mouseX-a.left;(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerHeight-this.draggableRadius&&(t=this.containerHeight-this.draggableRadius),(s=s<this.draggableRadius?this.draggableRadius:s)>this.containerWidth-this.draggableRadius&&(s=this.containerWidth-this.draggableRadius),this.draggables[this.activeDraggable].style.transform=`translate3d(${s-this.draggableRadius}px, ${t-this.draggableRadius}px, 0)`;var a=(s-this.draggableRadius-this.restrictedWidth/2)/this.restrictedWidth*this.parent.worldWidth+this.parent.worldCenterX,n=-(t-this.draggableRadius-this.restrictedHeight/2)/this.restrictedHeight*this.parent.worldHeight+this.parent.worldCenterY;this.worldCoordinates[this.activeDraggable][0]=a,this.worldCoordinates[this.activeDraggable][1]=n;try{this.touchmoveCallback(this.activeDraggable,a,n,e)}catch(e){}}},recalculateLocations(){for(let s=0;s<this.numDraggables;s++){let e=Math.floor(this.restrictedHeight*(1-((this.worldCoordinates[s][1]-this.parent.worldCenterY)/this.parent.worldHeight+.5)))+this.draggableRadius,t=Math.floor(this.restrictedWidth*((this.worldCoordinates[s][0]-this.parent.worldCenterX)/this.parent.worldWidth+.5))+this.draggableRadius;(e=e<this.draggableRadius?this.draggableRadius:e)>this.containerHeight-this.draggableRadius&&(e=this.containerHeight-this.draggableRadius),(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerWidth-this.draggableRadius&&(t=this.containerWidth-this.draggableRadius),this.draggables[s].style.transform=`translate3d(${t-this.draggableRadius}px, ${e-this.draggableRadius}px, 0)`}},onResize(){var e=window.getComputedStyle(this.parent.canvas),t=this.parent.canvas.clientWidth-parseFloat(e.paddingLeft)-parseFloat(e.paddingRight),s=this.parent.canvas.clientHeight-parseFloat(e.paddingTop)-parseFloat(e.paddingBottom);this.container.style.width=t+2*this.draggableRadius+"px",this.container.style.height=s+2*this.draggableRadius+"px",this.containerWidth=t+2*this.draggableRadius,this.containerHeight=s+2*this.draggableRadius,this.restrictedWidth=t,this.restrictedHeight=s,this.container.style.marginTop=parseFloat(e.borderTopWidth)+parseFloat(e.paddingTop)-this.draggableRadius+"px",this.recalculateLocations()}};fullscreen={currentlyFullscreen:!1,currentlyAnimating:!1,canvasesToResize:[],trueFullscreen:!1,switchFullscreenCallback:null,fullscreenOldScroll:0,oldFooterButtonOffset:0,enterFullscreenButton:null,exitFullscreenButton:null,useFullscreenButton:!1,enterFullscreenButtonIconPath:null,exitFullscreenButtonIconPath:null,fullscreenComponentsContainerLocation:null,fullscreenComponentsContainer:null,init(){this.useFullscreenButton&&0===document.querySelectorAll("#wilson-fullscreen-button-style").length&&((e=document.createElement("style")).textContent=`
						.wilson-enter-fullscreen-button, .wilson-exit-fullscreen-button
						{
							width: 15px;
							
							background-color: rgb(255, 255, 255);
							
							border: 2px solid rgb(
								calc((1 - var(--theme)) * var(--normal-contrast-component) + var(--theme) * 127),
								calc((1 - var(--theme)) * var(--normal-contrast-component) + var(--theme) * 127),
								calc((1 - var(--theme)) * var(--normal-contrast-component) + var(--theme) * 127)
							);
							border-radius: 25%;
							padding: 5px;
							
							cursor: pointer;
							outline: none;
						}

						.wilson-enter-fullscreen-button
						{
							position: absolute;
							
							right: 10px;
							top: 10px;
							
							z-index: 50;
						}

						.wilson-exit-fullscreen-button
						{
							position: fixed;
							
							right: 10px;
							top: 10px;
							
							z-index: 100;
						}
					`,e.id="wilson-fullscreen-button-style",document.head.appendChild(e)),0===document.querySelectorAll("#wilson-fullscreen-style").length&&((e=document.createElement("style")).textContent=`
					.wilson-fullscreen-components-container.wilson-fullscreen
					{
						position: fixed !important;
						top: 0 !important;
						left: 0 !important;
						
						z-index: 100 !important;
					}
					
					.wilson-fullscreen-components-container.wilson-fullscreen .wilson-applet-canvas-container
					{
						margin-top: 0 !important;
						margin-bottom: 0 !important;
					}
					
					.wilson-fullscreen-components-container.wilson-fullscreen:not(.wilson-true-fullscreen-canvas) .wilson-output-canvas-container
					{
						margin-left: calc(50vw - 50vmin) !important;
					}
					
					.wilson-true-fullscreen-canvas
					{
						width: 100vw !important;
						height: 100% !important;
						
						border: none !important;
						border-radius: 0 !important;
						padding: 0 !important;
					}

					.wilson-letterboxed-fullscreen-canvas
					{
						width: 100vmin !important;
						height: 100vmin !important;
						
						border: none !important;
						border-radius: 0 !important;
						padding: 0 !important;
					}

					.wilson-letterboxed-canvas-background
					{
						width: 100vw;
						height: calc((100vh - 100vmin) / 2);
						
						background-color: rgb(0, 0, 0);
					}

					.wilson-black-background
					{
						width: 100vw !important;
						height: 100% !important;
						
						background-color: rgb(0, 0, 0) !important;
					}
					
					.wilson-center-content
					{
						display: flex;
						justify-content: center;
						margin: 0 auto;
					}
				`,e.id="wilson-fullscreen-style",document.head.appendChild(e)),this.useFullscreenButton&&(this.enterFullscreenButton=document.createElement("input"),this.enterFullscreenButton.type="image",this.enterFullscreenButton.classList.add("wilson-enter-fullscreen-button"),this.enterFullscreenButton.src=this.enterFullscreenButtonIconPath,this.enterFullscreenButton.alt="Enter Fullscreen",this.enterFullscreenButton.setAttribute("tabindex","-1"),this.parent.canvas.parentNode.appendChild(this.enterFullscreenButton),addHoverEventWithScale({element:this.enterFullscreenButton,scale:1.1,addBounceOnTouch:!1}),this.enterFullscreenButton.addEventListener("click",()=>{this.switchFullscreen()}));var e=this.onResize.bind(this),e=(addTemporaryListener({object:window,event:"resize",callback:e}),this.onScroll.bind(this)),e=(addTemporaryListener({object:window,event:"scroll",callback:e}),this.onKeypress.bind(this));addTemporaryListener({object:document.documentElement,event:"keydown",callback:e})},switchFullscreen(){if(this.currentlyFullscreen){if(!this.currentlyAnimating){this.currentlyFullscreen=!1,this.currentlyAnimating=!0,metaThemeColorElement.setAttribute("content",this.oldMetaThemeColor),this.fullscreenComponentsContainerLocation.appendChild(this.fullscreenComponentsContainer);var e=document.body.querySelector("#header"),s=document.body.querySelector("#header-container");e&&s&&(e.style.zIndex=110,s.style.zIndex=105),this.parent.canvas.classList.remove("wilson-fullscreen"),this.parent.canvas.parentNode.classList.remove("wilson-fullscreen"),this.fullscreenComponentsContainer.classList.remove("wilson-fullscreen"),document.documentElement.style.overflowY="scroll",document.body.style.overflowY="visible",document.body.style.width="",document.body.style.height="",document.documentElement.style.userSelect="auto",document.documentElement.style.WebkitUserSelect="auto",document.removeEventListener("gesturestart",this.preventGestures),document.removeEventListener("gesturechange",this.preventGestures),document.removeEventListener("gestureend",this.preventGestures),this.exitFullscreenButton&&this.exitFullscreenButton.remove(),this.useFullscreenButton&&(this.enterFullscreenButton=document.createElement("input"),this.enterFullscreenButton.type="image",this.enterFullscreenButton.classList.add("wilson-enter-fullscreen-button"),this.enterFullscreenButton.src=this.enterFullscreenButtonIconPath,this.enterFullscreenButton.alt="Enter Fullscreen",this.enterFullscreenButton.setAttribute("tabindex","-1"),this.parent.canvas.parentNode.appendChild(this.enterFullscreenButton),addHoverEventWithScale({element:this.enterFullscreenButton,scale:1.1,addBounceOnTouch:!1}),this.enterFullscreenButton.addEventListener("click",()=>{this.switchFullscreen()})),this.fullscreenComponentsContainer.classList.remove("wilson-true-fullscreen-canvas");for(let t=0;t<this.canvasesToResize.length;t++){this.canvasesToResize[t].classList.remove("wilson-true-fullscreen-canvas"),this.canvasesToResize[t].classList.remove("wilson-letterboxed-fullscreen-canvas"),this.parent.canvas.parentNode.parentNode.classList.remove("wilson-black-background");var a=document.querySelectorAll(".wilson-letterboxed-canvas-background");for(let e=0;e<a.length;e++)a[e]&&a[e].remove();try{this.switchFullscreenCallback()}catch(e){}this.parent.draggables.onResize()}this.parent.useDraggables&&this.parent.draggables.onResize(),window.scroll(0,this.fullscreenOldScroll),this.currentlyAnimating=!1}}else if(!this.currentlyAnimating){this.currentlyFullscreen=!0,this.currentlyAnimating=!0,this.fullscreenOldScroll=window.scrollY,document.body.appendChild(this.fullscreenComponentsContainer);e=document.body.querySelector("#header"),s=document.body.querySelector("#header-container");if(e&&s&&(e.style.zIndex=90,s.style.zIndex=90),this.parent.canvas.classList.add("wilson-fullscreen"),this.parent.canvas.parentNode.classList.add("wilson-fullscreen"),this.fullscreenComponentsContainer.classList.add("wilson-fullscreen"),this.enterFullscreenButton&&this.enterFullscreenButton.remove(),this.useFullscreenButton&&(this.exitFullscreenButton=document.createElement("input"),this.exitFullscreenButton.type="image",this.exitFullscreenButton.classList.add("wilson-exit-fullscreen-button"),this.exitFullscreenButton.src=this.exitFullscreenButtonIconPath,this.exitFullscreenButton.alt="Exit Fullscreen",this.exitFullscreenButton.setAttribute("tabindex","-1"),document.body.appendChild(this.exitFullscreenButton),addHoverEventWithScale({element:this.exitFullscreenButton,scale:1.1,addBounceOnTouch:!1}),this.exitFullscreenButton.addEventListener("click",()=>{this.switchFullscreen()})),this.oldMetaThemeColor=metaThemeColorElement.getAttribute("content"),document.documentElement.style.overflowY="hidden",document.body.style.overflowY="hidden",document.body.style.width="100vw",document.body.style.height="100%",document.documentElement.style.userSelect="none",document.documentElement.style.WebkitUserSelect="none",document.addEventListener("gesturestart",this.preventGestures),document.addEventListener("gesturechange",this.preventGestures),document.addEventListener("gestureend",this.preventGestures),metaThemeColorElement.setAttribute("content","#000000"),this.trueFullscreen){this.fullscreenComponentsContainer.classList.add("wilson-true-fullscreen-canvas");for(let e=0;e<this.canvasesToResize.length;e++){this.canvasesToResize[e].classList.add("wilson-true-fullscreen-canvas"),this.parent.canvas.parentNode.parentNode.classList.add("wilson-black-background");try{this.switchFullscreenCallback()}catch(e){}this.parent.draggables.onResize()}window.scroll(0,0)}else{for(let e=0;e<this.canvasesToResize.length;e++){this.canvasesToResize[e].classList.add("wilson-letterboxed-fullscreen-canvas");try{this.switchFullscreenCallback()}catch(e){}this.parent.draggables.onResize()}this.parent.canvas.parentNode.parentNode.insertAdjacentHTML("beforebegin","<div class='wilson-letterboxed-canvas-background'></div>"),this.parent.canvas.parentNode.parentNode.insertAdjacentHTML("afterend","<div class='wilson-letterboxed-canvas-background'></div>"),this.parent.canvas.parentNode.parentNode.classList.add("wilson-black-background"),this.onResize()}this.parent.useDraggables&&this.parent.draggables.onResize(),this.currentlyAnimating=!1}},onResize(){this.currentlyFullscreen&&(window.scroll(0,0),setTimeout(()=>{window.scroll(0,0)},500))},onScroll(){this.currentlyFullscreen&&window.scroll(0,this.fullscreenLockedScroll)},onKeypress(e){"Escape"===e.key&&this.currentlyFullscreen&&this.switchFullscreen()},preventGestures(e){e.preventDefault()}};input={mouseX:null,mouseY:null,lastRow1:-1,lastCol1:-1,lastRow2:-1,lastCol2:-1,currentlyDragging:!1,wasPinching:!1,mousedownCallback:null,mouseupCallback:null,mousemoveCallback:null,mousedragCallback:null,touchstartCallback:null,touchupCallback:null,touchmoveCallback:null,pinchCallback:null,wheelCallback:null,onMousedownBound:null,onMouseupBound:null,onMousemoveBound:null,onTouchstartBound:null,onTouchupBound:null,onTouchmoveBound:null,onWheelBound:null,init(){for(let e=0;e<this.parent.fullscreen.canvasesToResize.length;e++)this.onMousedownBound=this.onMousedown.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("mousedown",this.onMousedownBound),this.onMouseupBound=this.onMouseup.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("mouseup",this.onMouseupBound),this.onMousemoveBound=this.onMousemove.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("mousemove",this.onMousemoveBound),this.onTouchstartBound=this.onTouchstart.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("touchstart",this.onTouchstartBound),this.onTouchendBound=this.onTouchend.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("touchend",this.onTouchendBound),this.onTouchmoveBound=this.onTouchmove.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("touchmove",this.onTouchmoveBound),this.onWheelBound=this.onWheel.bind(this),this.parent.fullscreen.canvasesToResize[e].addEventListener("wheel",this.onWheelBound),this.parent.fullscreen.canvasesToResize[e].addEventListener("mouseleave",e=>{var t=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1);if(this.currentlyDragging){this.currentlyDragging=!1;try{this.mouseupCallback(...t,e)}catch(e){}}})},onMousedown(e){var t,s,a;e.target.classList.contains("wilson-draggable")||(this.mouseX=e.clientX,this.mouseY=e.clientY,this.currentlyDragging=!0,s=this.parent.canvas.getBoundingClientRect(),t=(this.mouseY-s.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,s=(this.mouseX-s.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,a=this.parent.utils.interpolate.canvasToWorld(t,s),this.lastRow1=t,this.lastCol1=s,null!==this.mousedownCallback&&(e.preventDefault(),this.mousedownCallback(...a,e)))},onMouseup(e){var t,s,a;e.target.classList.contains("wilson-draggable")||(e.preventDefault(),this.mouseX=e.clientX,this.mouseY=e.clientY,this.currentlyDragging=!1,null!==this.mouseupCallback&&(s=this.parent.canvas.getBoundingClientRect(),t=(this.mouseY-s.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,s=(this.mouseX-s.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,a=this.parent.utils.interpolate.canvasToWorld(t,s),this.mouseupCallback(...a,e),this.lastRow1=t,this.lastCol1=s))},onMousemove(e){var t,s,a,n;e.target.classList.contains("wilson-draggable")||(e.preventDefault(),this.mouseX=e.clientX,this.mouseY=e.clientY,s=this.parent.canvas.getBoundingClientRect(),t=(this.mouseY-s.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,s=(this.mouseX-s.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,a=this.parent.utils.interpolate.canvasToWorld(t,s),n=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),null!==this.mousedragCallback&&this.currentlyDragging?this.mousedragCallback(...a,a[0]-n[0],a[1]-n[1],e):null===this.mousemoveCallback||this.currentlyDragging||this.mousemoveCallback(...a,a[0]-n[0],a[1]-n[1],e),this.lastRow1=t,this.lastCol1=s)},onTouchstart(e){var t,s,a;e.target.classList.contains("wilson-draggable")||(this.mouseX=e.touches[0].clientX,this.mouseY=e.touches[0].clientY,s=this.parent.canvas.getBoundingClientRect(),t=(this.mouseY-s.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,s=(this.mouseX-s.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,a=this.parent.utils.interpolate.canvasToWorld(t,s),this.lastRow1=t,this.lastCol1=s,null!==this.touchstartCallback&&(e.preventDefault(),this.touchstartCallback(...a,e)))},onTouchend(e){var t;e.target.classList.contains("wilson-draggable")||(e.preventDefault(),this.touchDistance=-1,0===e.touches.length&&(this.wasPinching=!1),null!==this.touchendCallback&&(-1!==this.lastRow1&&(t=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),this.touchendCallback(...t,e)),this.lastRow1=-1,this.lastCol1=-1,this.lastRow2=-1,this.lastCol2=-1))},onTouchmove(e){if(!e.target.classList.contains("wilson-draggable")){e.preventDefault();var t,s,a,n=this.parent.canvas.getBoundingClientRect();if(2<=e.touches.length&&null!==this.pinchCallback){this.wasPinching=!0;var i=(e.touches[0].clientY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,r=(e.touches[0].clientX-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,l=(e.touches[1].clientY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,o=(e.touches[1].clientX-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,i=this.parent.utils.interpolate.canvasToWorld(i,r),r=this.parent.utils.interpolate.canvasToWorld(l,o),l=i[0]-r[0],o=i[1]-r[1],l=Math.sqrt(l*l+o*o),o=(i[0]+r[0])/2,i=(i[1]+r[1])/2,r=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),h=this.parent.utils.interpolate.canvasToWorld(this.lastRow2,this.lastCol2),d=r[0]-h[0],r=r[1]-h[1],h=Math.sqrt(d*d+r*r);-1!==this.lastRow2&&this.pinchCallback(o,i,l-h,e)}else if(this.wasPinching)return;this.mouseX=e.touches[0].clientX,this.mouseY=e.touches[0].clientY,null!==this.touchmoveCallback&&(d=(this.mouseY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,r=(this.mouseX-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,-1!==this.lastRow1&&-1!==this.lastCol1&&(o=this.parent.utils.interpolate.canvasToWorld(d,r),i=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),1===e.touches.length?this.touchmoveCallback(...o,o[0]-i[0],o[1]-i[1],e):(l=o[0]-i[0],h=o[1]-i[1],i=e.touches[1].clientX,t=(e.touches[1].clientY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,i=(i-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,n=this.parent.utils.interpolate.canvasToWorld(t,i),a=this.parent.utils.interpolate.canvasToWorld(this.lastRow2,this.lastCol2),s=n[0]-a[0],a=n[1]-a[1],Math.abs(l-s)/this.parent.worldWidth<.005&&Math.abs(h-a)/this.parent.worldHeight<.005&&this.touchmoveCallback((o[0]+n[0])/2,(o[1]+n[1])/2,(l+s)/2,(h+a)/2,e),this.lastRow2=t,this.lastCol2=i)),this.lastRow1=d,this.lastCol1=r)}},onWheel(e){var t;null!==this.wheelCallback&&(e.preventDefault(),-1!==this.lastRow1)&&(t=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),this.wheelCallback(...t,e.deltaY,e))},getZoomedWorldCenter(fixedPointX,fixedPointY,newWorldWidth,newWorldHeight){return[fixedPointX-(fixedPointX-this.parent.worldCenterX)/this.parent.worldWidth*newWorldWidth,fixedPointY-(fixedPointY-this.parent.worldCenterY)/this.parent.worldHeight*newWorldHeight]}};changeCanvasSize(width,height){this.canvasWidth=width,this.canvasHeight=height,this.canvas.setAttribute("width",width),this.canvas.setAttribute("height",height),0!==this.render.renderType&&this.gl.viewport(0,0,width,height);var e=window.getComputedStyle(this.canvas);this.topPadding=parseFloat(e.paddingTop),this.leftPadding=parseFloat(e.paddingLeft),this.topBorder=parseFloat(e.borderTopWidth),this.leftBorder=parseFloat(e.borderLeftWidth)}downloadFrame(filename){1===this.render.renderType?this.render.drawFrame(this.render.lastImage):2===this.render.renderType&&this.render.drawFrame(),this.canvas.toBlob(blob=>{var e=document.createElement("a");e.download=filename,e.href=window.URL.createObjectURL(blob),e.click(),e.remove()})}}export{Wilson};