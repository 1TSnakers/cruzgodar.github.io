import{changeOpacity,opacityAnimationTime}from"/scripts/src/animation.min.mjs";import{addHoverEventWithScale}from"/scripts/src/hover-events.min.mjs";import{addTemporaryListener}from"/scripts/src/main.min.mjs";import{metaThemeColorElement}from"/scripts/src/settings.min.mjs";class Wilson{canvas=null;ctx=null;gl=null;shaderPrograms=[];uniforms={};canvasWidth=null;canvasHeight=null;worldWidth=2;worldHeight=2;worldCenterX=0;worldCenterY=0;outputCanvasContainer=null;useDraggables=!1;topPadding=0;leftPadding=0;topBorder=0;leftBorder=0;constructor(t,e){this.canvas=t,this.canvasWidth=void 0===e.canvasWidth?parseInt(this.canvas.getAttribute("width")):e.canvasWidth,this.canvasHeight=void 0===e.canvasHeight?parseInt(this.canvas.getAttribute("height")):e.canvasHeight,this.canvas.setAttribute("width",this.canvasWidth),this.canvas.setAttribute("height",this.canvasHeight);t=window.getComputedStyle(this.canvas);if(this.topPadding=parseFloat(t.paddingTop),this.leftPadding=parseFloat(t.paddingLeft),this.topBorder=parseFloat(t.borderTopWidth),this.leftBorder=parseFloat(t.borderLeftWidth),""!==(((((this.utils.interpolate.parent=this).render.parent=this).draggables.parent=this).fullscreen.parent=this).input.parent=this).canvas.id?console.log(`[Wilson] Registered a ${this.canvasWidth}x${this.canvasHeight} canvas with ID `+this.canvas.id):console.log(`[Wilson] Registered a ${this.canvasWidth}x${this.canvasHeight} canvas`),void 0===e.canvasesToResize&&(e.canvasesToResize=[this.canvas]),void 0!==e.worldWidth&&(this.worldWidth=e.worldWidth),void 0!==e.worldHeight&&(this.worldHeight=e.worldHeight),void 0!==e.worldCenterX&&(this.worldCenterX=e.worldCenterX),void 0!==e.worldCenterY&&(this.worldCenterY=e.worldCenterY),void 0===e.renderer||"hybrid"===e.renderer?this.render.renderType=1:"cpu"===e.renderer?this.render.renderType=0:this.render.renderType=2,0===this.render.renderType)this.ctx=this.canvas.getContext("2d",{colorSpace:"display-p3"}),this.render.imgData=this.ctx.getImageData(0,0,this.canvasWidth,this.canvasHeight),this.render.drawFrame=this.render.drawFrameCpu;else if(1===this.render.renderType){this.render.initWebglHybrid(),this.render.drawFrame=this.render.drawFrameHybrid;try{this.gl.getExtension("OES_texture_float")}catch(t){console.log("[Wilson] Could not load float textures")}}else{try{this.render.loadNewShader(e.shader)}catch(t){console.error("[Wilson] Error loading shader")}this.render.drawFrame=this.render.drawFrameGpu;try{this.gl.getExtension("OES_texture_float")}catch(t){console.log("[Wilson] Could not load float textures")}}void 0!==e.autoArrangeCanvases&&!e.autoArrangeCanvases||this.arrangeCanvases(e),this.input.mousedownCallback=void 0===e.mousedownCallback?null:e.mousedownCallback,this.input.mouseupCallback=void 0===e.mouseupCallback?null:e.mouseupCallback,this.input.mousemoveCallback=void 0===e.mousemoveCallback?null:e.mousemoveCallback,this.input.mousedragCallback=void 0===e.mousedragCallback?null:e.mousedragCallback,this.input.touchstartCallback=void 0===e.touchstartCallback?null:e.touchstartCallback,this.input.touchendCallback=void 0===e.touchendCallback?null:e.touchendCallback,this.input.touchmoveCallback=void 0===e.touchmoveCallback?null:e.touchmoveCallback,this.input.pinchCallback=void 0===e.pinchCallback?null:e.pinchCallback,this.input.wheelCallback=void 0===e.wheelCallback?null:e.wheelCallback,this.input.init(),this.useDraggables=!0,this.draggables.static=void 0!==e.draggablesStatic&&e.draggablesStatic,this.draggables.mousedownCallback=void 0===e.draggablesMousedownCallback?null:e.draggablesMousedownCallback,this.draggables.mouseupCallback=void 0===e.draggablesMouseupCallback?null:e.draggablesMouseupCallback,this.draggables.mousemoveCallback=void 0===e.draggablesMousemoveCallback?null:e.draggablesMousemoveCallback,this.draggables.touchstartCallback=void 0===e.draggablesTouchstartCallback?null:e.draggablesTouchstartCallback,this.draggables.touchendCallback=void 0===e.draggablesTouchendCallback?null:e.draggablesTouchendCallback,this.draggables.touchmoveCallback=void 0===e.draggablesTouchmoveCallback?null:e.draggablesTouchmoveCallback,this.draggables.init(),void 0!==e.useFullscreen&&e.useFullscreen&&(this.fullscreen.trueFullscreen=void 0!==e.trueFullscreen&&e.trueFullscreen,this.fullscreen.useFullscreenButton=void 0!==e.useFullscreenButton&&e.useFullscreenButton,this.fullscreen.useFullscreenButton&&void 0===e.enterFullscreenButtonIconPath&&console.error("Missing path to Enter Fullscreen button image"),this.fullscreen.useFullscreenButton&&void 0===e.exitFullscreenButtonIconPath&&console.error("Missing path to Exit Fullscreen button image"),this.fullscreen.enterFullscreenButtonIconPath=e.enterFullscreenButtonIconPath,this.fullscreen.exitFullscreenButtonIconPath=e.exitFullscreenButtonIconPath,this.fullscreen.switchFullscreenCallback=void 0!==e.switchFullscreenCallback&&e.switchFullscreenCallback,void 0===e.canvasesToResize&&console.error("Missing canvases to resize"),this.fullscreen.canvasesToResize=e.canvasesToResize,this.fullscreen.init())}arrangeCanvases(e){0===document.querySelectorAll("#wilson-style").length&&((t=document.createElement("style")).textContent=`
				.wilson-output-canvas-container
				{
					position: relative;
					-webkit-user-select: none;
					user-select: none;
				}
				
				.wilson-applet-canvas-container
				{
					-webkit-user-select: none;
					user-select: none;
				}
				
				.wilson-center-content
				{
					display: flex;
					justify-content: center;
					margin: 0 auto;
				}
			`,t.id="wilson-style",document.head.appendChild(t));var a=document.createElement("div");a.classList.add("wilson-applet-canvas-container"),a.classList.add("wilson-center-content"),this.canvas.parentNode.insertBefore(a,this.canvas),this.outputCanvasContainer=document.createElement("div"),this.outputCanvasContainer.classList.add("wilson-output-canvas-container"),a.appendChild(this.outputCanvasContainer);for(let t=0;t<e.canvasesToResize.length;t++)a.appendChild(e.canvasesToResize[t]);this.outputCanvasContainer.appendChild(this.canvas),this.draggables.container=document.createElement("div"),this.draggables.container.classList.add("wilson-draggables-container"),a.appendChild(this.draggables.container),this.fullscreen.canvasesToResize.push(this.draggables.container);var t=window.getComputedStyle(this.canvas),s=this.canvas.clientWidth-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),n=this.canvas.clientHeight-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom);this.draggables.container.style.width=s+2*this.draggables.draggableRadius+"px",this.draggables.container.style.height=n+2*this.draggables.draggableRadius+"px",this.draggables.containerWidth=s+2*this.draggables.draggableRadius,this.draggables.containerHeight=n+2*this.draggables.draggableRadius,this.draggables.restrictedWidth=s,this.draggables.restrictedHeight=n,this.draggables.container.style.marginTop=parseFloat(t.borderTopWidth)+parseFloat(t.paddingTop)-this.draggables.draggableRadius+"px",this.fullscreen.fullscreenComponentsContainer=document.createElement("div"),this.fullscreen.fullscreenComponentsContainer.classList.add("wilson-fullscreen-components-container"),a.parentNode.insertBefore(this.fullscreen.fullscreenComponentsContainer,a),this.fullscreen.fullscreenComponentsContainer.appendChild(a),this.fullscreen.fullscreenComponentsContainerLocation=document.createElement("div"),this.fullscreen.fullscreenComponentsContainer.parentNode.insertBefore(this.fullscreen.fullscreenComponentsContainerLocation,this.fullscreen.fullscreenComponentsContainer),this.fullscreen.fullscreenComponentsContainerLocation.appendChild(this.fullscreen.fullscreenComponentsContainer);for(let t=0;t<this.fullscreen.canvasesToResize.length;t++)this.fullscreen.canvasesToResize[t].addEventListener("gesturestart",t=>t.preventDefault()),this.fullscreen.canvasesToResize[t].addEventListener("gesturechange",t=>t.preventDefault()),this.fullscreen.canvasesToResize[t].addEventListener("gestureend",t=>t.preventDefault()),this.fullscreen.canvasesToResize[t].addEventListener("click",t=>t.preventDefault())}utils={interpolate:{canvasToWorld(t,e){return[(e/this.parent.canvasWidth-.5)*this.parent.worldWidth+this.parent.worldCenterX,(.5-t/this.parent.canvasHeight)*this.parent.worldHeight+this.parent.worldCenterY]},worldToCanvas(t,e){return[Math.floor((.5-(e-this.parent.worldCenterY)/this.parent.worldHeight)*this.parent.canvasHeight),Math.floor(((t-this.parent.worldCenterX)/this.parent.worldWidth+.5)*this.parent.canvasWidth)]}},hsvToRgb(e,a,s){function t(t){t=(t+6*e)%6;return s-s*a*Math.max(0,Math.min(t,Math.min(4-t,1)))}return[255*t(5),255*t(3),255*t(1)]}};render={drawFrame:null,renderType:null,lastImage:null,imgData:null,shaderProgram:null,shaderPrograms:[],texture:null,framebuffers:[],drawFrameCpu(t){this.parent.ctx.putImageData(new ImageData(t,this.parent.canvasWidth,this.parent.canvasHeight),0,0)},drawFrameHybrid(t){this.lastImage=t,this.parent.gl.texImage2D(this.parent.gl.TEXTURE_2D,0,this.parent.gl.RGBA,this.parent.canvasWidth,this.parent.canvasHeight,0,this.parent.gl.RGBA,this.parent.gl.UNSIGNED_BYTE,t),this.parent.gl.drawArrays(this.parent.gl.TRIANGLE_STRIP,0,4)},drawFrameGpu(){this.parent.gl.drawArrays(this.parent.gl.TRIANGLE_STRIP,0,4)},initWebglHybrid(){this.parent.gl=this.parent.canvas.getContext("webgl");var t=a(this.parent.gl,this.parent.gl.VERTEX_SHADER,`
				attribute vec3 position;
				varying vec2 uv;

				void main(void)
				{
					gl_Position = vec4(position, 1.0);

					//Interpolate quad coordinates in the fragment shader.
					uv = position.xy;
				}
			`),e=a(this.parent.gl,this.parent.gl.FRAGMENT_SHADER,`
				precision highp float;
				
				varying vec2 uv;
				
				uniform sampler2D uTexture;
				
				
				
				void main(void)
				{
					gl_FragColor = texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0);
				}
			`),t=(this.shaderProgram=this.parent.gl.createProgram(),this.parent.gl.attachShader(this.shaderProgram,t),this.parent.gl.attachShader(this.shaderProgram,e),this.parent.gl.linkProgram(this.shaderProgram),this.parent.gl.getProgramParameter(this.shaderProgram,this.parent.gl.LINK_STATUS)||(console.error("[Wilson] Couldn't link shader program: "+this.parent.gl.getShaderInfoLog(shader)),this.parent.gl.deleteProgram(this.shaderProgram)),this.parent.gl.useProgram(this.shaderProgram),this.parent.gl.createBuffer());function a(t,e,a){e=t.createShader(e);return t.shaderSource(e,a),t.compileShader(e),t.getShaderParameter(e,t.COMPILE_STATUS)||(console.error("[Wilson] Couldn't load shader: "+t.getProgramInfoLog(shaderProgram)),t.deleteShader(e)),e}this.parent.gl.bindBuffer(this.parent.gl.ARRAY_BUFFER,t),this.parent.gl.bufferData(this.parent.gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0]),this.parent.gl.STATIC_DRAW),this.shaderProgram.positionAttribute=this.parent.gl.getAttribLocation(this.shaderProgram,"position"),this.parent.gl.enableVertexAttribArray(this.shaderProgram.positionAttribute),this.parent.gl.vertexAttribPointer(this.shaderProgram.positionAttribute,3,this.parent.gl.FLOAT,!1,0,0),this.parent.gl.viewport(0,0,this.parent.canvasWidth,this.parent.canvasHeight),this.parent.gl.pixelStorei(this.parent.gl.UNPACK_ALIGNMENT,1),this.parent.gl.pixelStorei(this.parent.gl.UNPACK_FLIP_Y_WEBGL,1),this.texture=this.parent.gl.createTexture(),this.parent.gl.bindTexture(this.parent.gl.TEXTURE_2D,this.texture),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_S,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_T,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MAG_FILTER,this.parent.gl.NEAREST),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MIN_FILTER,this.parent.gl.NEAREST),this.parent.gl.disable(this.parent.gl.DEPTH_TEST)},loadNewShader(t){this.parent.gl=this.parent.canvas.getContext("webgl");var e=a(this.parent.gl,this.parent.gl.VERTEX_SHADER,`
				attribute vec3 position;
				varying vec2 uv;

				void main(void)
				{
					gl_Position = vec4(position, 1.0);

					//Interpolate quad coordinates in the fragment shader.
					uv = position.xy;
				}
			`),t=a(this.parent.gl,this.parent.gl.FRAGMENT_SHADER,t),e=(this.shaderProgram=this.parent.gl.createProgram(),this.parent.gl.attachShader(this.shaderProgram,e),this.parent.gl.attachShader(this.shaderProgram,t),this.parent.gl.linkProgram(this.shaderProgram),this.parent.gl.getProgramParameter(this.shaderProgram,this.parent.gl.LINK_STATUS)||(console.log("[Wilson] Couldn't link shader program: "+this.gl.getShaderInfoLog(shader)),this.parent.gl.deleteProgram(this.shaderProgram)),this.parent.gl.useProgram(this.shaderProgram),this.parent.gl.createBuffer());function a(t,e,a){e=t.createShader(e);return t.shaderSource(e,a),t.compileShader(e),t.getShaderParameter(e,t.COMPILE_STATUS)||(console.log("[Wilson] Couldn't load shader: "+t.getProgramInfoLog(shaderProgram)),t.deleteShader(e)),e}this.parent.gl.bindBuffer(this.parent.gl.ARRAY_BUFFER,e),this.parent.gl.bufferData(this.parent.gl.ARRAY_BUFFER,new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0]),this.parent.gl.STATIC_DRAW),this.shaderProgram.positionAttribute=this.parent.gl.getAttribLocation(this.shaderProgram,"position"),this.parent.gl.enableVertexAttribArray(this.shaderProgram.positionAttribute),this.parent.gl.vertexAttribPointer(this.shaderProgram.positionAttribute,3,this.parent.gl.FLOAT,!1,0,0),this.parent.gl.viewport(0,0,this.parent.canvasWidth,this.parent.canvasHeight),this.shaderPrograms.push(this.shaderProgram)},createFramebufferTexturePair(t=this.parent.gl.FLOAT){var e=this.parent.gl.createFramebuffer(),a=this.parent.gl.createTexture();this.parent.gl.bindTexture(this.parent.gl.TEXTURE_2D,a),this.parent.gl.texImage2D(this.parent.gl.TEXTURE_2D,0,this.parent.gl.RGBA,this.parent.canvasWidth,this.parent.canvasHeight,0,this.parent.gl.RGBA,t,null),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MAG_FILTER,this.parent.gl.NEAREST),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_MIN_FILTER,this.parent.gl.NEAREST),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_S,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.texParameteri(this.parent.gl.TEXTURE_2D,this.parent.gl.TEXTURE_WRAP_T,this.parent.gl.CLAMP_TO_EDGE),this.parent.gl.disable(this.parent.gl.DEPTH_TEST),this.parent.gl.bindFramebuffer(this.parent.gl.FRAMEBUFFER,e),this.parent.gl.framebufferTexture2D(this.parent.gl.FRAMEBUFFER,this.parent.gl.COLOR_ATTACHMENT0,this.parent.gl.TEXTURE_2D,a,0),this.framebuffers.push({framebuffer:e,texture:a})},initUniforms(e,a=-1){if(-1===a)for(let t=0;t<e.length;t++)this.parent.uniforms[e[t]]=this.parent.gl.getUniformLocation(this.shaderProgram,e[t]);else for(let t=0;t<e.length;t++)void 0===this.parent.uniforms[e[t]]&&(this.parent.uniforms[e[t]]={}),this.parent.uniforms[e[t]][a]=this.parent.gl.getUniformLocation(this.shaderPrograms[a],e[t])},getPixelData(){var t=new Uint8Array(this.parent.canvasWidth*this.parent.canvasHeight*4);return this.parent.gl.readPixels(0,0,this.parent.canvasWidth,this.parent.canvasHeight,this.parent.gl.RGBA,this.parent.gl.UNSIGNED_BYTE,t),t}};draggables={parent:null,container:null,containerWidth:null,containerHeight:null,restrictedWidth:null,restrictedHeight:null,draggables:[],worldCoordinates:[],autoAddContainer:!0,numDraggables:0,static:!1,draggableRadius:12,activeDraggable:-1,lastActiveDraggable:-1,mouseX:0,mouseY:0,mousedownCallback:null,mouseupCallback:null,mousemoveCallback:null,touchstartCallback:null,touchendCallback:null,touchmoveCallback:null,init(){0===document.querySelectorAll("#wilson-draggables-style").length&&((t=document.createElement("style")).textContent=`
					.wilson-output-canvas-container
					{
						position: relative;
						width: fit-content;
					}

					.wilson-output-canvas-container.wilson-fullscreen
					{
						width: 100%;
					}
					
					.wilson-draggables-container
					{
						position: absolute;
						
						-webkit-user-select: none;
						user-select: none;
					}

					.wilson-draggable
					{
						position: absolute;
						
						width: 20px;
						height: 20px;
						
						left: 0;
						top: 0;
						
						background-color: rgb(255, 255, 255);
						border: 2px solid rgb(64, 64, 64);
						border-radius: 50%;
						
						touch-action: none;
						-webkit-touch-callout: none;
						-webkit-user-select: none;
						user-select: none;
						
						cursor: pointer;
						
						transition: width .125s ease-in-out, height .125s ease-in-out, top .125s ease-in-out, left .125s ease-in-out;
					}

					.wilson-draggable:active
					{
						width: 16px;
						height: 16px;
						
						left: 2px;
						top: 2px;
					}
				`,t.id="wilson-draggables-style",document.head.appendChild(t)),this.containerWidth=this.container.offsetWidth,this.containerHeight=this.container.offsetHeight;var t=this.handleTouchstartEvent.bind(this),e=this.handleTouchendEvent.bind(this),a=this.handleTouchmoveEvent.bind(this),s=this.handleMousedownEvent.bind(this),n=this.handleMouseupEvent.bind(this),i=this.handleMousemoveEvent.bind(this),r=this.onResize.bind(this);this.static?console.log("[Wilson] Using non-draggable draggables -- is this really what you want to do?"):(addTemporaryListener({object:document.documentElement,event:"touchstart",callback:t}),addTemporaryListener({object:document.documentElement,event:"touchmove",callback:a}),addTemporaryListener({object:document.documentElement,event:"touchend",callback:e}),addTemporaryListener({object:document.documentElement,event:"mousedown",callback:s}),addTemporaryListener({object:document.documentElement,event:"mousemove",callback:i}),addTemporaryListener({object:document.documentElement,event:"mouseup",callback:n}),addTemporaryListener({object:window,event:"resize",callback:r}))},add(t,e){let a=Math.floor(this.restrictedHeight*(1-((e-this.parent.worldCenterY)/this.parent.worldHeight+.5)))+this.draggableRadius,s=Math.floor(this.restrictedWidth*((t-this.parent.worldCenterX)/this.parent.worldWidth+.5))+this.draggableRadius;(a=a<this.draggableRadius?this.draggableRadius:a)>this.containerHeight-this.draggableRadius&&(a=this.containerHeight-this.draggableRadius),(s=s<this.draggableRadius?this.draggableRadius:s)>this.containerWidth-this.draggableRadius&&(s=this.containerWidth-this.draggableRadius);var n=document.createElement("div");return n.classList.add("wilson-draggable"),n.classList.add("wilson-draggable-"+this.numDraggables),n.style.transform=`translate3d(${s-this.draggableRadius}px, ${a-this.draggableRadius}px, 0)`,this.numDraggables++,this.draggables.push(n),this.worldCoordinates.push([t,e]),this.container.appendChild(n),n},handleMousedownEvent(e){this.activeDraggable=-1;for(let t=0;t<this.numDraggables;t++)if(e.target.classList.contains("wilson-draggable-"+t)&&e.target.parentNode===this.container){e.preventDefault(),this.activeDraggable=t,this.currentlyDragging=!0,this.mouseX=e.clientX,this.mouseY=e.clientY;try{this.mousedownCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],e)}catch(t){}break}},handleMouseupEvent(t){if(-1!==this.activeDraggable){document.body.style.WebkitUserSelect="",this.lastActiveDraggable=this.activeDraggable;try{this.mouseupCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],t)}catch(t){}}this.activeDraggable=-1,this.currentlyDragging=!1},handleMousemoveEvent(a){if(this.currentlyDragging&&-1!==this.activeDraggable){a.preventDefault();var s=a.clientX,n=a.clientY,s=(this.mouseX,this.mouseY,this.mouseX=s,this.mouseY=n,this.container.getBoundingClientRect());let t=a.clientY-s.top,e=a.clientX-s.left;(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerHeight-this.draggableRadius&&(t=this.containerHeight-this.draggableRadius),(e=e<this.draggableRadius?this.draggableRadius:e)>this.containerWidth-this.draggableRadius&&(e=this.containerWidth-this.draggableRadius),this.draggables[this.activeDraggable].style.transform=`translate3d(${e-this.draggableRadius}px, ${t-this.draggableRadius}px, 0)`;n=(e-this.draggableRadius-this.restrictedWidth/2)/this.restrictedWidth*this.parent.worldWidth+this.parent.worldCenterX,s=-(t-this.draggableRadius-this.restrictedHeight/2)/this.restrictedHeight*this.parent.worldHeight+this.parent.worldCenterY;this.worldCoordinates[this.activeDraggable][0]=n,this.worldCoordinates[this.activeDraggable][1]=s;try{this.mousemoveCallback(this.activeDraggable,n,s,a)}catch(t){}}},handleTouchstartEvent(e){this.activeDraggable=-1;for(let t=0;t<this.numDraggables;t++)if(e.target.classList.contains("wilson-draggable-"+t)&&e.target.parentNode===this.container){e.preventDefault(),this.activeDraggable=t,this.currentlyDragging=!0,this.mouseX=e.touches[0].clientX,this.mouseY=e.touches[0].clientY;try{this.touchstartCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],e)}catch(t){}break}},handleTouchendEvent(t){if(-1!==this.activeDraggable){document.body.style.WebkitUserSelect="",this.lastActiveDraggable=this.activeDraggable;try{this.touchendCallback(this.activeDraggable,...this.worldCoordinates[this.activeDraggable],t)}catch(t){}}this.activeDraggable=-1,this.currentlyDragging=!1},handleTouchmoveEvent(a){if(this.currentlyDragging&&-1!==this.activeDraggable){a.preventDefault(),this.mouseX=a.touches[0].clientX,this.mouseY=a.touches[0].clientY;var s=this.container.getBoundingClientRect();let t=this.mouseY-s.top,e=this.mouseX-s.left;(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerHeight-this.draggableRadius&&(t=this.containerHeight-this.draggableRadius),(e=e<this.draggableRadius?this.draggableRadius:e)>this.containerWidth-this.draggableRadius&&(e=this.containerWidth-this.draggableRadius),this.draggables[this.activeDraggable].style.transform=`translate3d(${e-this.draggableRadius}px, ${t-this.draggableRadius}px, 0)`;var s=(e-this.draggableRadius-this.restrictedWidth/2)/this.restrictedWidth*this.parent.worldWidth+this.parent.worldCenterX,n=-(t-this.draggableRadius-this.restrictedHeight/2)/this.restrictedHeight*this.parent.worldHeight+this.parent.worldCenterY;this.worldCoordinates[this.activeDraggable][0]=s,this.worldCoordinates[this.activeDraggable][1]=n;try{this.touchmoveCallback(this.activeDraggable,s,n,a)}catch(t){}}},recalculateLocations(){for(let a=0;a<this.numDraggables;a++){let t=Math.floor(this.restrictedHeight*(1-((this.worldCoordinates[a][1]-this.parent.worldCenterY)/this.parent.worldHeight+.5)))+this.draggableRadius,e=Math.floor(this.restrictedWidth*((this.worldCoordinates[a][0]-this.parent.worldCenterX)/this.parent.worldWidth+.5))+this.draggableRadius;(t=t<this.draggableRadius?this.draggableRadius:t)>this.containerHeight-this.draggableRadius&&(t=this.containerHeight-this.draggableRadius),(e=e<this.draggableRadius?this.draggableRadius:e)>this.containerWidth-this.draggableRadius&&(e=this.containerWidth-this.draggableRadius),this.draggables[a].style.transform=`translate3d(${e-this.draggableRadius}px, ${t-this.draggableRadius}px, 0)`}},onResize(){var t=window.getComputedStyle(this.parent.canvas),e=this.parent.canvas.clientWidth-parseFloat(t.paddingLeft)-parseFloat(t.paddingRight),a=this.parent.canvas.clientHeight-parseFloat(t.paddingTop)-parseFloat(t.paddingBottom);this.container.style.width=e+2*this.draggableRadius+"px",this.container.style.height=a+2*this.draggableRadius+"px",this.containerWidth=e+2*this.draggableRadius,this.containerHeight=a+2*this.draggableRadius,this.restrictedWidth=e,this.restrictedHeight=a,this.container.style.marginTop=parseFloat(t.borderTopWidth)+parseFloat(t.paddingTop)-this.draggableRadius+"px",this.recalculateLocations()}};fullscreen={currentlyFullscreen:!1,currentlyAnimating:!1,canvasesToResize:[],trueFullscreen:!1,switchFullscreenCallback:null,fullscreenOldScroll:0,oldFooterButtonOffset:0,enterFullscreenButton:null,exitFullscreenButton:null,useFullscreenButton:!1,enterFullscreenButtonIconPath:null,exitFullscreenButtonIconPath:null,fullscreenComponentsContainerLocation:null,fullscreenComponentsContainer:null,init(){this.useFullscreenButton&&0===document.querySelectorAll("#wilson-fullscreen-button-style").length&&((t=document.createElement("style")).textContent=`
						.wilson-enter-fullscreen-button, .wilson-exit-fullscreen-button
						{
							width: 15px;
							
							background-color: rgb(255, 255, 255);
							
							border: 2px solid rgb(127, 127, 127);
							border-radius: 25%;
							padding: 5px;
							
							cursor: pointer;
							outline: none;
						}

						.wilson-enter-fullscreen-button
						{
							position: absolute;
							
							right: 10px;
							top: 10px;
							
							z-index: 100;
						}

						.wilson-exit-fullscreen-button
						{
							position: fixed;
							
							right: 10px;
							top: 10px;
							
							z-index: 100;
						}
					`,t.id="wilson-fullscreen-button-style",document.head.appendChild(t)),0===document.querySelectorAll("#wilson-fullscreen-style").length&&((t=document.createElement("style")).textContent=`
					.wilson-fullscreen-components-container.wilson-fullscreen
					{
						position: fixed !important;
						top: 0 !important;
						left: 0 !important;
						
						z-index: 100 !important;
					}
					
					.wilson-fullscreen-components-container.wilson-fullscreen .wilson-applet-canvas-container
					{
						margin-top: 0 !important;
						margin-bottom: 0 !important;
					}
					
					.wilson-fullscreen-components-container.wilson-fullscreen:not(.wilson-true-fullscreen-canvas) .wilson-output-canvas-container
					{
						margin-left: calc(50vw - 50vmin) !important;
					}
					
					.wilson-true-fullscreen-canvas
					{
						width: 100vw !important;
						height: calc(100% + 4px) !important;
						
						border: none !important;
						border-radius: 0 !important;
						padding: 0 !important;
					}

					.wilson-letterboxed-fullscreen-canvas
					{
						width: 100vmin !important;
						height: calc(100vmin + 4px) !important;
						
						border: none !important;
						border-radius: 0 !important;
						padding: 0 !important;
					}

					.wilson-letterboxed-canvas-background
					{
						width: 100vw;
						height: calc((100vh - 100vmin) / 2 + 4px);
						
						background-color: rgb(0, 0, 0);
					}

					.wilson-black-background
					{
						width: 100vw !important;
						height: calc(100% + 4px) !important;
						
						background-color: rgb(0, 0, 0) !important;
					}
					
					.wilson-center-content
					{
						display: flex;
						justify-content: center;
						margin: 0 auto;
					}
				`,t.id="wilson-fullscreen-style",document.head.appendChild(t)),this.useFullscreenButton&&(this.enterFullscreenButton=document.createElement("input"),this.enterFullscreenButton.type="image",this.enterFullscreenButton.classList.add("wilson-enter-fullscreen-button"),this.enterFullscreenButton.src=this.enterFullscreenButtonIconPath,this.enterFullscreenButton.alt="Enter Fullscreen",this.enterFullscreenButton.setAttribute("tabindex","-1"),this.parent.canvas.parentNode.appendChild(this.enterFullscreenButton),addHoverEventWithScale(this.enterFullscreenButton,1.1),this.enterFullscreenButton.addEventListener("click",()=>{this.switchFullscreen()}));var t=this.onResize.bind(this),t=(addTemporaryListener({object:window,event:"resize",callback:t}),this.onScroll.bind(this)),t=(addTemporaryListener({object:window,event:"scroll",callback:t}),this.onKeypress.bind(this));addTemporaryListener({object:document.documentElement,event:"keydown",callback:t})},switchFullscreen(){this.currentlyFullscreen?this.currentlyAnimating||(this.currentlyFullscreen=!1,this.currentlyAnimating=!0,anime({targets:metaThemeColorElement,content:this.oldMetaThemeColor,duration:opacityAnimationTime,easing:"cubicBezier(.42, 0, .58, 1)"}),changeOpacity(document.body,0),setTimeout(()=>{this.fullscreenComponentsContainerLocation.appendChild(this.fullscreenComponentsContainer);try{document.body.querySelector("#header").style.zIndex=110,document.body.querySelector("#header-container").style.zIndex=105}catch(t){}this.parent.canvas.classList.remove("wilson-fullscreen"),this.parent.canvas.parentNode.classList.remove("wilson-fullscreen"),this.fullscreenComponentsContainer.classList.remove("wilson-fullscreen"),document.documentElement.style.overflowY="visible",document.body.style.overflowY="visible",document.body.style.width="",document.body.style.height="",document.documentElement.style.userSelect="auto",document.documentElement.style.WebkitUserSelect="auto",document.removeEventListener("gesturestart",this.preventGestures),document.removeEventListener("gesturechange",this.preventGestures),document.removeEventListener("gestureend",this.preventGestures);try{this.exitFullscreenButton.remove()}catch(t){}this.useFullscreenButton&&(this.enterFullscreenButton=document.createElement("input"),this.enterFullscreenButton.type="image",this.enterFullscreenButton.classList.add("wilson-enter-fullscreen-button"),this.enterFullscreenButton.src=this.enterFullscreenButtonIconPath,this.enterFullscreenButton.alt="Enter Fullscreen",this.enterFullscreenButton.setAttribute("tabindex","-1"),this.parent.canvas.parentNode.appendChild(this.enterFullscreenButton),addHoverEventWithScale(this.enterFullscreenButton,1.1),this.enterFullscreenButton.addEventListener("click",()=>{this.switchFullscreen()})),this.fullscreenComponentsContainer.classList.remove("wilson-true-fullscreen-canvas");for(let t=0;t<this.canvasesToResize.length;t++){this.canvasesToResize[t].classList.remove("wilson-true-fullscreen-canvas"),this.canvasesToResize[t].classList.remove("wilson-letterboxed-fullscreen-canvas"),this.parent.canvas.parentNode.parentNode.classList.remove("wilson-black-background");try{var e=document.querySelectorAll(".wilson-letterboxed-canvas-background");for(let t=0;t<e.length;t++)e[t].remove()}catch(t){}try{this.switchFullscreenCallback()}catch(t){}this.parent.draggables.onResize()}this.parent.useDraggables&&this.parent.draggables.onResize(),setTimeout(()=>{window.scroll(0,this.fullscreenOldScroll),changeOpacity(document.body,1),setTimeout(()=>{this.currentlyAnimating=!1},opacityAnimationTime)},10)},opacityAnimationTime)):this.currentlyAnimating||(this.currentlyFullscreen=!0,this.currentlyAnimating=!0,this.fullscreenOldScroll=window.scrollY,changeOpacity(document.body,0),setTimeout(()=>{document.body.appendChild(this.fullscreenComponentsContainer);try{document.body.querySelector("#header").style.zIndex=90,document.body.querySelector("#header-container").style.zIndex=90}catch(t){}this.parent.canvas.classList.add("wilson-fullscreen"),this.parent.canvas.parentNode.classList.add("wilson-fullscreen"),this.fullscreenComponentsContainer.classList.add("wilson-fullscreen");try{this.enterFullscreenButton.remove()}catch(t){}if(this.useFullscreenButton&&(this.exitFullscreenButton=document.createElement("input"),this.exitFullscreenButton.type="image",this.exitFullscreenButton.classList.add("wilson-exit-fullscreen-button"),this.exitFullscreenButton.src=this.exitFullscreenButtonIconPath,this.exitFullscreenButton.alt="Exit Fullscreen",this.exitFullscreenButton.setAttribute("tabindex","-1"),document.body.appendChild(this.exitFullscreenButton),addHoverEventWithScale(this.exitFullscreenButton,1.1),this.exitFullscreenButton.addEventListener("click",()=>{this.switchFullscreen()})),this.oldMetaThemeColor=metaThemeColorElement.getAttribute("content"),document.documentElement.style.overflowY="hidden",document.body.style.overflowY="hidden",document.body.style.width="100vw",document.body.style.height="100%",document.documentElement.style.userSelect="none",document.documentElement.style.WebkitUserSelect="none",document.addEventListener("gesturestart",this.preventGestures),document.addEventListener("gesturechange",this.preventGestures),document.addEventListener("gestureend",this.preventGestures),anime({targets:metaThemeColorElement,content:"#000000",duration:opacityAnimationTime,easing:"cubicBezier(.42, 0, .58, 1)"}),this.trueFullscreen){this.fullscreenComponentsContainer.classList.add("wilson-true-fullscreen-canvas");for(let t=0;t<this.canvasesToResize.length;t++){this.canvasesToResize[t].classList.add("wilson-true-fullscreen-canvas"),this.parent.canvas.parentNode.parentNode.classList.add("wilson-black-background");try{this.switchFullscreenCallback()}catch(t){}this.parent.draggables.onResize()}window.scroll(0,0)}else{for(let t=0;t<this.canvasesToResize.length;t++){this.canvasesToResize[t].classList.add("wilson-letterboxed-fullscreen-canvas");try{this.switchFullscreenCallback()}catch(t){}this.parent.draggables.onResize()}this.parent.canvas.parentNode.parentNode.insertAdjacentHTML("beforebegin",'<div class="wilson-letterboxed-canvas-background"></div>'),this.parent.canvas.parentNode.parentNode.insertAdjacentHTML("afterend",'<div class="wilson-letterboxed-canvas-background"></div>'),this.parent.canvas.parentNode.parentNode.classList.add("wilson-black-background"),this.onResize()}this.parent.useDraggables&&this.parent.draggables.onResize(),changeOpacity(document.body,1),setTimeout(()=>{this.currentlyAnimating=!1,this.onResize()},opacityAnimationTime)},opacityAnimationTime))},onResize(){this.currentlyFullscreen&&(window.scroll(0,0),setTimeout(()=>{window.scroll(0,0)},500))},onScroll(){this.currentlyFullscreen&&window.scroll(0,this.fullscreenLockedScroll)},onKeypress(t){"Escape"===t.key&&this.currentlyFullscreen&&this.switchFullscreen()},preventGestures(t){t.preventDefault()}};input={mouseX:null,mouseY:null,lastRow1:-1,lastCol1:-1,lastRow2:-1,lastCol2:-1,currentlyDragging:!1,wasPinching:!1,mousedownCallback:null,mouseupCallback:null,mousemoveCallback:null,mousedragCallback:null,touchstartCallback:null,touchupCallback:null,touchmoveCallback:null,pinchCallback:null,wheelCallback:null,onMousedownBound:null,onMouseupBound:null,onMousemoveBound:null,onTouchstartBound:null,onTouchupBound:null,onTouchmoveBound:null,onWheelBound:null,init(){for(let t=0;t<this.parent.fullscreen.canvasesToResize.length;t++)this.onMousedownBound=this.onMousedown.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("mousedown",this.onMousedownBound),this.onMouseupBound=this.onMouseup.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("mouseup",this.onMouseupBound),this.onMousemoveBound=this.onMousemove.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("mousemove",this.onMousemoveBound),this.onTouchstartBound=this.onTouchstart.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("touchstart",this.onTouchstartBound),this.onTouchendBound=this.onTouchend.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("touchend",this.onTouchendBound),this.onTouchmoveBound=this.onTouchmove.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("touchmove",this.onTouchmoveBound),this.onWheelBound=this.onWheel.bind(this),this.parent.fullscreen.canvasesToResize[t].addEventListener("wheel",this.onWheelBound),this.parent.fullscreen.canvasesToResize[t].addEventListener("mouseleave",t=>{var e=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1);if(this.currentlyDragging){this.currentlyDragging=!1;try{this.mouseupCallback(...e,t)}catch(t){}}})},onMousedown(t){var e,a,s;t.target.classList.contains("wilson-draggable")||(this.mouseX=t.clientX,this.mouseY=t.clientY,this.currentlyDragging=!0,a=this.parent.canvas.getBoundingClientRect(),e=(this.mouseY-a.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,a=(this.mouseX-a.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,s=this.parent.utils.interpolate.canvasToWorld(e,a),this.lastRow1=e,this.lastCol1=a,null!==this.mousedownCallback&&(t.preventDefault(),this.mousedownCallback(...s,t)))},onMouseup(t){var e,a,s;t.target.classList.contains("wilson-draggable")||(t.preventDefault(),this.mouseX=t.clientX,this.mouseY=t.clientY,this.currentlyDragging=!1,null!==this.mouseupCallback&&(a=this.parent.canvas.getBoundingClientRect(),e=(this.mouseY-a.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,a=(this.mouseX-a.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,s=this.parent.utils.interpolate.canvasToWorld(e,a),this.mouseupCallback(...s,t),this.lastRow1=e,this.lastCol1=a))},onMousemove(t){var e,a,s,n;t.target.classList.contains("wilson-draggable")||(t.preventDefault(),this.mouseX=t.clientX,this.mouseY=t.clientY,a=this.parent.canvas.getBoundingClientRect(),e=(this.mouseY-a.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,a=(this.mouseX-a.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,s=this.parent.utils.interpolate.canvasToWorld(e,a),n=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),null!==this.mousedragCallback&&this.currentlyDragging?this.mousedragCallback(...s,s[0]-n[0],s[1]-n[1],t):null===this.mousemoveCallback||this.currentlyDragging||this.mousemoveCallback(...s,s[0]-n[0],s[1]-n[1],t),this.lastRow1=e,this.lastCol1=a)},onTouchstart(t){var e,a,s;t.target.classList.contains("wilson-draggable")||(this.mouseX=t.touches[0].clientX,this.mouseY=t.touches[0].clientY,a=this.parent.canvas.getBoundingClientRect(),e=(this.mouseY-a.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,a=(this.mouseX-a.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,s=this.parent.utils.interpolate.canvasToWorld(e,a),this.lastRow1=e,this.lastCol1=a,null!==this.touchstartCallback&&(t.preventDefault(),this.touchstartCallback(...s,t)))},onTouchend(t){var e;t.target.classList.contains("wilson-draggable")||(t.preventDefault(),this.touchDistance=-1,this.lastRow2=-1,this.lastCol2=-1,0===t.touches.length&&(this.wasPinching=!1),null!==this.touchendCallback&&-1!==this.lastRow1&&(e=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),this.touchendCallback(...e,t)))},onTouchmove(t){if(!t.target.classList.contains("wilson-draggable")){t.preventDefault();var e,a,s,n=this.parent.canvas.getBoundingClientRect();if(2<=t.touches.length&&null!==this.pinchCallback){this.wasPinching=!0;var i=(t.touches[0].clientY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,r=(t.touches[0].clientX-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,l=(t.touches[1].clientY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,o=(t.touches[1].clientX-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,i=this.parent.utils.interpolate.canvasToWorld(i,r),r=this.parent.utils.interpolate.canvasToWorld(l,o),l=i[0]-r[0],o=i[1]-r[1],l=Math.sqrt(l*l+o*o),o=(i[0]+r[0])/2,i=(i[1]+r[1])/2,r=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),h=this.parent.utils.interpolate.canvasToWorld(this.lastRow2,this.lastCol2),d=r[0]-h[0],r=r[1]-h[1],h=Math.sqrt(d*d+r*r);-1!==this.lastRow2&&this.pinchCallback(o,i,l-h,t)}else if(this.wasPinching)return;this.mouseX=t.touches[0].clientX,this.mouseY=t.touches[0].clientY,null!==this.touchmoveCallback&&(d=(this.mouseY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,r=(this.mouseX-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,o=this.parent.utils.interpolate.canvasToWorld(d,r),i=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),1===t.touches.length?this.touchmoveCallback(...o,o[0]-i[0],o[1]-i[1],t):(l=o[0]-i[0],h=o[1]-i[1],i=t.touches[1].clientX,e=(t.touches[1].clientY-n.top-this.parent.topBorder-this.parent.topPadding)*this.parent.canvasHeight/this.parent.draggables.restrictedHeight,i=(i-n.left-this.parent.leftBorder-this.parent.leftPadding)*this.parent.canvasWidth/this.parent.draggables.restrictedWidth,n=this.parent.utils.interpolate.canvasToWorld(e,i),s=this.parent.utils.interpolate.canvasToWorld(this.lastRow2,this.lastCol2),a=n[0]-s[0],s=n[1]-s[1],Math.abs(l-a)/this.parent.worldWidth<.005&&Math.abs(h-s)/this.parent.worldHeight<.005&&this.touchmoveCallback((o[0]+n[0])/2,(o[1]+n[1])/2,(l+a)/2,(h+s)/2,t),this.lastRow2=e,this.lastCol2=i),this.lastRow1=d,this.lastCol1=r)}},onWheel(t){var e;null!==this.wheelCallback&&(t.preventDefault(),-1!==this.lastRow1)&&(e=this.parent.utils.interpolate.canvasToWorld(this.lastRow1,this.lastCol1),this.wheelCallback(...e,t.deltaY,t))},getZoomedWorldCenter(t,e,a,s){return[t-(t-this.parent.worldCenterX)/this.parent.worldWidth*a,e-(e-this.parent.worldCenterY)/this.parent.worldHeight*s]}};changeCanvasSize(t,e){this.canvasWidth=t,this.canvasHeight=e,this.canvas.setAttribute("width",t),this.canvas.setAttribute("height",e),0!==this.render.renderType&&this.gl.viewport(0,0,t,e);t=window.getComputedStyle(this.canvas);this.topPadding=parseFloat(t.paddingTop),this.leftPadding=parseFloat(t.paddingLeft),this.topBorder=parseFloat(t.borderTopWidth),this.leftBorder=parseFloat(t.borderLeftWidth)}downloadFrame(a){1===this.render.renderType?this.render.drawFrame(this.render.lastImage):2===this.render.renderType&&this.render.drawFrame(),this.canvas.toBlob(t=>{var e=document.createElement("a");e.download=a,e.href=window.URL.createObjectURL(t),e.click(),e.remove()})}}export{Wilson};