class Applet{canvas;wilson;workers=[];timeoutIds=[];refreshIds=[];handlers=[];animationPaused=!1;constructor(a){this.canvas=a;this.pan.parent=this;this.zoom.parent=this;Page.currentApplets.push(this)}pause(){this.animationPaused=!0}resume(){this.animationPaused=!1}destroy(){this.animationPaused=!0;this.workers.forEach(a=>{try{a.terminate()}catch(c){}});this.timeoutIds.forEach(a=>{try{clearTimeout(a)}catch(c){}});this.refreshIds.forEach(a=>{try{clearTimeout(a)}catch(c){}});this.handlers.forEach(a=>
{try{a[0].removeEventListener(a[1],a[2])}catch(c){}});try{this.hiddenCanvasContainer.remove()}catch(a){}DEBUG&&console.log(`Destroyed an applet of type ${this.constructor.name}`)}listenToInputElements(a,c){a.forEach(b=>{b.addEventListener("keydown",d=>{13===d.keyCode&&(d.preventDefault(),c())})})}uncapEverything=!1;setInputCaps(a,c){a.forEach((b,d)=>{const f=c[d];d=b.nextElementSibling.innerHTML.split(" ");const e=document.createElement("p");e.classList.add("body-text");e.style.position="fixed";e.style.opacity=
0;e.style.top="-100vh";e.style.width="fit-content";e.textContent="";Page.element.appendChild(e);let h=0;for(let g=0;g<d.length;g++)e.textContent=`${e.textContent}${g===h?"":" "}${d[g]}`,100<=e.getBoundingClientRect().width&&(h=g,g--,e.textContent="");e.remove();b.nextElementSibling.innerHTML=`<span>${d.slice(0,h).join(" ")}</span>${0!==h?" ":""}<span style="white-space: nowrap">${d.slice(h).join(" ")}<span class="triangle">&#x25BC;</span></span>`;b.addEventListener("input",()=>{parseFloat(b.value)>
f&&!this.uncapEverything?(b.value=f,b.parentNode.classList.add("capped-input")):b.parentNode.classList.remove("capped-input")});b.nextElementSibling.addEventListener("click",()=>{b.parentNode.classList.contains("capped-input")&&(this.hideCapDialogs(),this.showCapDialog(b))})});a=(b=>{b.target.classList.contains("keep-dialog-open")||this.hideCapDialogs()}).bind(this);document.documentElement.addEventListener("pointerdown",a);this.handlers.push([document.documentElement,"pointerdown",a])}showCapDialog(a){const c=
document.createElement("div");c.classList.add("input-cap-dialog");c.classList.add("keep-dialog-open");c.style.opacity=0;c.style.transform="scale(1)";c.innerHTML='Higher values than this may take an extremely long time to compute, cause substantial lag, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!\n\t\t<div class="checkbox-row keep-dialog-open">\n\t\t\t<div class="checkbox-container click-on-child keep-dialog-open">\n\t\t\t\t<input type="checkbox" class="uncap-inputs-checkbox keep-dialog-open"/>\n\t\t\t\t<div class="checkbox keep-dialog-open"></div>\n\t\t\t</div>\n\t\t\t<div style="margin-left: 10px" class="keep-dialog-open">\n\t\t\t\t<p class="body-text checkbox-subtext keep-dialog-open">Uncap all inputs</p>\n\t\t\t</div>\n\t\t</div>';
Page.element.appendChild(c);const b=()=>this.updateCapDialogLocation(a,c);window.addEventListener("resize",b);this.handlers.push([window,"resize",b]);b();c.style.transform="scale(.95)";setTimeout(()=>{const d=c.querySelector(".uncap-inputs-checkbox");d.checked=this.uncapEverything;d.addEventListener("input",()=>{(this.uncapEverything=d.checked)&&$$(".capped-input").forEach(f=>f.classList.remove("capped-input"))});Page.Load.HoverEvents.addWithScale(d.parentNode,1.1);anime({targets:c,opacity:1,scale:1,
duration:250,easing:"easeOutQuad"})},16)}hideCapDialogs(){try{const a=$$(".input-cap-dialog");anime({targets:a,opacity:0,scale:.95,duration:250,easing:"easeOutQuad",complete:()=>{a.forEach(c=>c.remove())}})}catch(a){}}updateCapDialogLocation(a,c){try{const b=a.nextElementSibling.getBoundingClientRect(),d=c.getBoundingClientRect();c.style.top=`${window.scrollY+b.top+b.height+4}px`;c.style.left=`${Math.min(Math.max(b.left-(d.width+12-b.width)/2,12),window.innerWidth-12-d.width)}px`}catch(b){}}pauseWhenOffscreen(){const a=
()=>{const c=this.canvas.getBoundingClientRect(),b=c.top;b>=-c.height&&b<window.innerHeight?this.resume():this.pause()};window.addEventListener("scroll",a);this.handlers.push([window,"scroll",a]);a()}hiddenCanvasContainer=null;createHiddenCanvas(){const a=document.createElement("canvas");a.classList.add("hidden-canvas");null===this.hiddenCanvasContainer&&(this.hiddenCanvasContainer=document.createElement("div"),this.hiddenCanvasContainer.style.display="none",Page.element.appendChild(this.hiddenCanvasContainer));
this.hiddenCanvasContainer.appendChild(a);return a}onGrabCanvas(a,c,b){this.pan.onGrabCanvas();this.zoom.onGrabCanvas()}onDragCanvas(a,c,b,d,f){this.pan.onDragCanvas(a,c,b,d)}onReleaseCanvas(a,c,b){this.pan.onReleaseCanvas();this.zoom.onReleaseCanvas()}onWheelCanvas(a,c,b,d){this.zoom.onWheelCanvas(a,c,b)}onPinchCanvas(a,c,b,d){this.zoom.onPinchCanvas(a,c,b)}changeAspectRatio(a=!1,c=[this.wilson]){c.forEach(b=>{b.fullscreen.currentlyFullscreen?(this.aspectRatio=window.innerWidth/window.innerHeight,
1<=this.aspectRatio?(b.changeCanvasSize(this.resolution,Math.floor(this.resolution/this.aspectRatio)),a&&(b.worldWidth=3*Math.pow(2,this.zoom.level)*this.aspectRatio,b.worldHeight=3*Math.pow(2,this.zoom.level))):(b.changeCanvasSize(Math.floor(this.resolution*this.aspectRatio),this.resolution),a&&(b.worldWidth=3*Math.pow(2,this.zoom.level),b.worldHeight=3*Math.pow(2,this.zoom.level)/this.aspectRatio))):(this.aspectRatio=1,b.changeCanvasSize(this.resolution,this.resolution),a&&(b.worldWidth=3*Math.pow(2,
this.zoom.level),b.worldHeight=3*Math.pow(2,this.zoom.level)))});a&&this.zoom.clamp()}pan={parent:null,frame:0,minX:-Infinity,maxX:Infinity,minY:-Infinity,maxY:Infinity,velocityX:0,velocityY:0,nextVelocityX:0,nextVelocityY:0,velocityListLength:4,lastVelocitiesX:Array(this.velocityListLength),lastVelocitiesY:Array(this.velocityListLength),friction:.91,velocityStartThreshhold:.005,velocityStopThreshhold:5E-4,clamp:function(){this.parent.wilson.worldCenterX=Math.min(Math.max(this.parent.wilson.worldCenterX,
this.minX+this.parent.wilson.worldWidth/2),this.maxX-this.parent.wilson.worldWidth/2);this.parent.wilson.worldCenterY=Math.min(Math.max(this.parent.wilson.worldCenterY,this.minY+this.parent.wilson.worldHeight/2),this.maxY-this.parent.wilson.worldHeight/2)},onGrabCanvas:function(){this.velocityY=this.velocityX=0;for(let a=0;a<this.velocityListLength;a++)this.lastVelocitiesX[a]=0,this.lastVelocitiesY[a]=0;this.frame=0},onDragCanvas:function(a,c,b,d){this.parent.wilson.worldCenterX-=b;this.parent.wilson.worldCenterY-=
d;this.clamp();this.nextVelocityX=-b/this.parent.wilson.worldWidth;this.nextVelocityY=-d/this.parent.wilson.worldHeight},onReleaseCanvas:function(){for(var a=0;a<this.velocityListLength;a++)Math.abs(this.lastVelocitiesX[a])>Math.abs(this.velocityX)&&(this.velocityX=this.lastVelocitiesX[a]),Math.abs(this.lastVelocitiesY[a])>Math.abs(this.velocityY)&&(this.velocityY=this.lastVelocitiesY[a]);if(this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStartThreshhold*this.velocityStartThreshhold)for(this.nextVelocityY=
this.nextVelocityX=this.velocityY=this.velocityX=0,a=0;a<this.velocityListLength;a++)this.lastVelocitiesX[a]=0,this.lastVelocitiesY[a]=0},update:function(){this.lastVelocitiesX[this.frame]=this.nextVelocityX;this.lastVelocitiesY[this.frame]=this.nextVelocityY;this.frame=(this.frame+1)%this.velocityListLength;this.nextVelocityY=this.nextVelocityX=0;this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStopThreshhold*this.velocityStopThreshhold?this.velocityY=this.velocityX=0:(this.parent.wilson.worldCenterX+=
this.velocityX*this.parent.wilson.worldWidth,this.parent.wilson.worldCenterY+=this.velocityY*this.parent.wilson.worldHeight,this.clamp(),this.velocityX*=this.friction,this.velocityY*=this.friction);try{this.parent.wilson.draggables.recalculateLocations()}catch(a){}}};zoom={parent:null,frame:0,pinchMultiplier:9,level:0,minLevel:-Infinity,fixedPointX:0,fixedPointY:0,velocity:0,nextVelocity:0,velocityListLength:4,lastVelocities:Array(this.velocityListLength),friction:.88,velocityStartThreshhold:.001,
velocityStopThreshhold:.001,init:function(){this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)},clamp:function(){const a=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;this.parent.wilson.worldWidth>this.parent.pan.maxX-this.parent.pan.minX&&(this.parent.wilson.worldWidth=this.parent.pan.maxX-this.parent.pan.minX,this.parent.wilson.worldHeight=this.parent.wilson.worldWidth/a,this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/
3));this.parent.wilson.worldHeight>this.parent.pan.maxY-this.parent.pan.minY&&(this.parent.wilson.worldHeight=this.parent.pan.maxY-this.parent.pan.minY,this.parent.wilson.worldWidth=this.parent.wilson.worldHeight*a,this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3));this.level=Math.max(this.level,this.minLevel);this.parent.pan.clamp()},onGrabCanvas:function(){this.velocity=0;for(let a=0;a<this.velocityListLength;a++)this.lastVelocities[a]=0;this.frame=0},
onWheelCanvas:function(a,c,b){this.fixedPointX=a;this.fixedPointY=c;.3>Math.abs(b/100)?(this.level+=b/100,this.clamp()):this.velocity+=.085*Math.sign(b);this.zoomCanvas()},onDragCanvas:function(a,c,b,d){this.parent.wilson.worldCenterX-=b;this.parent.wilson.worldCenterY-=d;this.nextVelocityX=-b/this.parent.wilson.worldWidth;this.nextVelocityY=-d/this.parent.wilson.worldHeight},onPinchCanvas:function(a,c,b,d){this.parent.wilson.worldWidth>=this.parent.wilson.worldHeight?(this.level-=b/this.parent.wilson.worldWidth*
this.pinchMultiplier,this.clamp(),this.nextVelocity=-b/this.parent.wilson.worldWidth*this.pinchMultiplier):(this.level-=b/this.parent.wilson.worldHeight*this.pinchMultiplier,this.clamp(),this.nextVelocity=-b/this.parent.wilson.worldHeight*this.pinchMultiplier);this.fixedPointX=a;this.fixedPointY=c;this.zoomCanvas()},onReleaseCanvas:function(){for(var a=0;a<this.velocityListLength;a++)Math.abs(this.lastVelocities[a])>Math.abs(this.velocity)&&(this.velocity=this.lastVelocities[a]);if(Math.abs(this.velocity)<
this.velocityStartThreshhold)for(this.nextVelocity=this.velocity=0,a=0;a<this.velocityListLength;a++)this.lastVelocities[a]=0},zoomCanvas:function(){const a=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;if(1<=a){var c=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level)*a,3*Math.pow(2,this.level));this.parent.wilson.worldWidth=3*Math.pow(2,this.level)*a;this.parent.wilson.worldHeight=3*Math.pow(2,this.level);this.parent.wilson.worldCenterX=
c[0];this.parent.wilson.worldCenterY=c[1]}else c=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level),3*Math.pow(2,this.level)/a),this.parent.wilson.worldWidth=3*Math.pow(2,this.level),this.parent.wilson.worldHeight=3*Math.pow(2,this.level)/a,this.parent.wilson.worldCenterX=c[0],this.parent.wilson.worldCenterY=c[1];this.clamp()},update:function(){this.lastVelocities[this.frame]=this.nextVelocity;this.frame=(this.frame+1)%this.velocityListLength;
this.nextVelocity=0;Math.abs(this.velocity)<this.velocityStopThreshhold?this.velocity=0:(this.level+=this.velocity,this.zoomCanvas(),this.velocity*=this.friction);try{this.parent.wilson.draggables.recalculateLocations()}catch(a){}}};static loaded=[];static load(a){return new Promise(async(c,b)=>{Applet.loaded.includes(a)?DEBUG&&console.log(`Refusing to load duplicate ${a}`):(DEBUG&&console.log(`Loading ${a}`),await Site.loadScript(`/applets/${a}/scripts/class.${DEBUG?"":"min."}js`),Applet.loaded.push(a));
c()})}static parseNaturalGLSL(a){for(a=a.replaceAll(/\s/g,"");a.match(/([^\.0-9])([0-9]+)([^\.0-9])/g);)a=a.replaceAll(/([^\.0-9])([0-9]+)([^\.0-9])/g,(c,b,d,f)=>`${b}${d}.0${f}`);for(a=a.replaceAll(/([^0-9])(\.[0-9])/g,(c,b,d)=>`${b}0${d}`).replaceAll(/([0-9]\.)([^0-9])/g,(c,b,d)=>`${b}0${d}`).replaceAll(/([0-9\)])([a-z\(])/g,(c,b,d)=>`${b} * ${d}`);a.match(/([xyz])([xyz])/g);)a=a.replaceAll(/([xyz])([xyz])/g,(c,b,d)=>`${b} * ${d}`);return a.replaceAll(/([a-z0-9\.]+)\^([a-z0-9\.]+)/g,(c,b,d)=>`pow(${b}, ${d})`)}static doubleToDf(a){let c=
new Float32Array(2);var b=536870913*a;b-=b-a;c[0]=b;c[1]=a-b;return[c[0],c[1]]}}Page.currentApplets=[];
