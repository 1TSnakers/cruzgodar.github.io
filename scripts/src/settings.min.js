import anime from"../anime.min.js";import{currentlyLoadedApplets}from"../applets/applet.min.js";import{cardContainer,cardIsOpen}from"./cards.min.js";import{recreateDesmosGraphs}from"./desmos.min.js";import{darkThemeCheckbox,increaseContrastCheckbox,reduceMotionCheckbox}from"./header.min.js";import{addStyle,pageUrl}from"./main.min.js";import{getDisplayUrl}from"./navigation.min.js";import{animate}from"./utils.min.js";const forceThemePages={"/gallery":!0},rootElement=document.querySelector(":root"),metaThemeColorElement=document.querySelector("#theme-color-meta");let themeToggles=0;const params=new URLSearchParams(window.location.search),darkTheme=null===params.get("theme")?matchMedia("(prefers-color-scheme: dark)").matches:"1"===params.get("theme"),reduceMotion=null===params.get("reducemotion")?matchMedia("(prefers-reduced-motion: reduce)").matches:"1"===params.get("reducemotion"),increaseContrast=null===params.get("increasecontrast")?matchMedia("(prefers-contrast: more)").matches:"1"===params.get("increasecontrast"),siteSettings={darkTheme:darkTheme,reduceMotion:reduceMotion,increaseContrast:increaseContrast,capsuleHeader:"1"===params.get("capsuleheader"),scroll:parseInt(params.get("scroll")??0),card:params.get("card"),resolutionMultiplier:parseFloat(params.get("resmult")??"1")};let revertThemeTo=null;function setRevertThemeTo(newRevertThemeTo){revertThemeTo=newRevertThemeTo}let forcedTheme=!1;function setForcedTheme(newForcedTheme){forcedTheme=newForcedTheme,darkThemeCheckbox&&darkThemeCheckbox.setDisabled(!0)}function getQueryParams(){var e=new URLSearchParams(window.location.search);return e.delete("page"),forcedTheme||(siteSettings.darkTheme&&!matchMedia("(prefers-color-scheme: dark)").matches?e.set("theme","1"):!siteSettings.darkTheme&&matchMedia("(prefers-color-scheme: dark)").matches?e.set("theme","0"):e.delete("theme")),siteSettings.reduceMotion&&!matchMedia("(prefers-reduced-motion: reduce)").matches?e.set("reducemotion","1"):!siteSettings.reduceMotion&&matchMedia("(prefers-reduced-motion: reduce)").matches?e.set("reducemotion","0"):e.delete("reducemotion"),siteSettings.increaseContrast&&!matchMedia("(prefers-contrast: more)").matches?e.set("increasecontrast","1"):!siteSettings.increaseContrast&&matchMedia("(prefers-contrast: more)").matches?e.set("increasecontrast","0"):e.delete("increasecontrast"),siteSettings.capsuleHeader?e.set("capsuleheader","1"):e.delete("capsuleheader"),siteSettings.scroll?e.set("scroll",siteSettings.scroll):e.delete("scroll"),siteSettings.card?e.set("card",siteSettings.card):e.delete("card"),siteSettings.resolutionMultiplier&&1!==siteSettings.resolutionMultiplier?e.set("resmult",siteSettings.resolutionMultiplier):e.delete("resmult"),window.OFFLINE?e.set("debug","2"):window.DEBUG?e.set("debug","1"):e.delete("debug"),e.toString()}function initReduceMotion(){matchMedia("(prefers-reduced-motion: reduce)").addEventListener("change",e=>{siteSettings.reduceMotion=e.matches,reduceMotionCheckbox&&reduceMotionCheckbox.setChecked({newChecked:siteSettings.reduceMotion})})}function initIncreaseContrast(){matchMedia("(prefers-contrast: more)").addEventListener("change",e=>{e.matches!==siteSettings.increaseContrast&&(toggleIncreaseContrast({}),increaseContrastCheckbox)&&increaseContrastCheckbox.setChecked({newChecked:siteSettings.increaseContrast})}),siteSettings.increaseContrast&&toggleIncreaseContrast({noAnimation:!(siteSettings.increaseContrast=!1)})}async function initCapsuleHeader(){siteSettings.capsuleHeader&&(siteSettings.capsuleHeader=!1,toggleCapsuleHeader())}async function initDarkTheme(){matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{cardIsOpen||(e.matches&&!siteSettings.darkTheme||!e.matches&&siteSettings.darkTheme)&&toggleDarkTheme({})}),void 0!==forceThemePages[pageUrl]?forceThemePages[pageUrl]?(setForcedTheme(!0),setRevertThemeTo(siteSettings.darkTheme),siteSettings.darkTheme=!forceThemePages[pageUrl],await toggleDarkTheme({noAnimation:!0,force:!0})):forceThemePages[pageUrl]||revertTheme():siteSettings.darkTheme&&await toggleDarkTheme({noAnimation:!(siteSettings.darkTheme=!1)})}async function revertTheme(){forcedTheme=forcedTheme&&!1,darkThemeCheckbox&&darkThemeCheckbox.setDisabled(!1),null!==revertThemeTo&&(siteSettings.darkTheme!==revertThemeTo&&await toggleDarkTheme({force:!0,noAnimation:siteSettings.reduceMotion}),revertThemeTo=null)}let onThemeChange=()=>{};function setOnThemeChange(callback){onThemeChange=callback}async function toggleDarkTheme({noAnimation=!1,force=!1,duration=500}){if((force||!(pageUrl in forceThemePages))&&!handleEasterEgg())if(siteSettings.darkTheme=!siteSettings.darkTheme,darkThemeCheckbox&&darkThemeCheckbox.setChecked({newChecked:siteSettings.darkTheme}),recreateDesmosGraphs(),history.replaceState({url:pageUrl},document.title,getDisplayUrl()),onThemeChange(),noAnimation||!document.startViewTransition)metaThemeColorElement.setAttribute("content",siteSettings.darkTheme?"#181818":"#ffffff"),rootElement.style.setProperty("--theme",siteSettings.darkTheme?1:0);else{anime({targets:metaThemeColorElement,content:siteSettings.darkTheme?"#181818":"#ffffff",duration:duration,easing:"cubicBezier(.25, .1, .25, 1)"}).finished.then(()=>{metaThemeColorElement.setAttribute("content",siteSettings.darkTheme?"#181818":"#ffffff")});const e=addStyle(`
			::view-transition-old(root),
			::view-transition-new(root)
			{
				animation-duration: ${duration}ms;
				animation-timing-function: cubic-bezier(.25, .1, .25, 1);
			}
		`);document.startViewTransition(()=>{rootElement.style.setProperty("--theme",siteSettings.darkTheme?1:0)}),setTimeout(()=>e.remove(),duration)}}async function toggleReduceMotion(){document.startViewTransition?document.startViewTransition(()=>{siteSettings.reduceMotion=!siteSettings.reduceMotion}):siteSettings.reduceMotion=!siteSettings.reduceMotion;for(const t of currentlyLoadedApplets)for(const r of t.wilsons)r.reduceMotion=siteSettings.reduceMotion;var e=document.querySelector(".wilson-help-button");e&&(siteSettings.reduceMotion?e.style.removeProperty("view-transition-name"):e.style.setProperty("view-transition-name","wilson-help-button"+Math.random().toString(36).slice(2))),history.replaceState({url:pageUrl},document.title,getDisplayUrl())}async function toggleIncreaseContrast({noAnimation=!1,duration=250}){if(siteSettings.increaseContrast=!siteSettings.increaseContrast,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),noAnimation||!document.startViewTransition)rootElement.style.setProperty("--contrast",siteSettings.increaseContrast?1:0);else{const e=addStyle(`
			::view-transition-old(root),
			::view-transition-new(root)
			{
				animation-duration: ${duration}ms;
				animation-timing-function: cubic-bezier(.25, .1, .25, 1);
			}
		`);document.startViewTransition(()=>{rootElement.style.setProperty("--contrast",siteSettings.increaseContrast?1:0)}),setTimeout(()=>e.remove(),duration)}}async function toggleCapsuleHeader(){siteSettings.capsuleHeader=!siteSettings.capsuleHeader,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),document.body.classList.toggle("capsule-header",siteSettings.capsuleHeader)}let setScrollTimeout=void 0;async function setScroll(){void 0!==setScrollTimeout&&clearTimeout(setScrollTimeout),setScrollTimeout=setTimeout(()=>{siteSettings.scroll=cardIsOpen?cardContainer.scrollTop:window.scrollY,history.replaceState({url:pageUrl},document.title,getDisplayUrl())},100)}let timeoutId,shownEasterEgg=!1;function handleEasterEgg(){if(themeToggles++,clearTimeout(timeoutId),timeoutId=setTimeout(()=>themeToggles=0,300),8<=themeToggles&&!shownEasterEgg){shownEasterEgg=!0,clearTimeout(timeoutId),document.body.querySelector("#header-settings-button").innerHTML="boo",addStyle(`
			#banner, img, canvas
			{
				filter: brightness(max(calc(var(--extra-brightness) / 10), 1)) saturate(var(--extra-brightness)) contrast(var(--extra-brightness)) hue-rotate(calc(var(--extra-brightness) * 5deg));
			}
		`,!1);const e=siteSettings.darkTheme?"lch(8.25% 0 0)":"lch(100% 0 0)",r=siteSettings.darkTheme?"lch(100% 23.2 0)":"lch(0% 0 0)",s=siteSettings.darkTheme?"lch(83.48% 0 0)":"lch(27.09% 0 0)",o=siteSettings.darkTheme?"lch(74.78% 0 0)":"lch(40.73% 0 0)";document.documentElement.style.filter="brightness(1)",animate(t=>{rootElement.style.setProperty("--background",`color-mix(in lch, ${e} ${100*(1-t)}%, lch(46.62% 108.32 40.84))`),rootElement.style.setProperty("--high-contrast",`color-mix(in lch, ${r} ${100*(1-t)}%, lch(79.24% 134.33 134.57))`),rootElement.style.setProperty("--normal-contrast",`color-mix(in lch, ${s} ${100*(1-t)}%, lch(79.24% 134.33 134.57))`),rootElement.style.setProperty("--low-contrast",`color-mix(in lch, ${o} ${100*(1-t)}%, lch(79.24% 134.33 134.57))`),rootElement.style.setProperty("--extra-brightness",10*t+1)},2e3)}return shownEasterEgg}export{forceThemePages,metaThemeColorElement,siteSettings,setRevertThemeTo,setForcedTheme,getQueryParams,initReduceMotion,initIncreaseContrast,initCapsuleHeader,initDarkTheme,revertTheme,onThemeChange,setOnThemeChange,toggleDarkTheme,toggleReduceMotion,toggleIncreaseContrast,toggleCapsuleHeader,setScroll};