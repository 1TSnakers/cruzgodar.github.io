import{addHoverEventWithScale}from"./hoverEvents.min.js";import{InputElement}from"./inputElement.min.js";import{currentlyTouchDevice}from"./interaction.min.js";import{addStyle,addTemporaryListener,addTemporaryParam,pageUrl}from"./main.min.js";import{clamp}from"./utils.min.js";const trackWidth=170,thumbWidth=24;class Slider extends InputElement{trackElement;subtextElement;valueElement;tickElements=[];value;defaultValue;displayValue;lastValueElementTextContent;min;max;logMin;logMax;snapPoints;snapThreshhold;precision;logarithmic;integer;persistState;currentlyDragging=!1;dragOffset;onInput;constructor({element,name,value,min,max,snapThreshhold=.02,snapPoints=[],logarithmic=!1,integer=!1,persistState=!0,onInput=()=>{}}){super({element:element,name:name}),this.subtextElement=this.element.nextElementSibling,this.trackElement=this.element.previousElementSibling,this.logarithmic=logarithmic,this.integer=integer,this.value=parseFloat(value),this.defaultValue=this.value,this.min=parseFloat(min),this.max=parseFloat(max),this.logMin=Math.log(this.min),this.logMax=Math.log(this.max),this.snapPoints=snapPoints,this.snapThreshhold=snapThreshhold,this.persistState=persistState,this.onInput=onInput,this.precision=Math.max(0,3-Math.floor(Math.log10(this.max-this.min))),this.value=this.integer?Math.round(this.value):this.value,this.displayValue=this.integer?this.value:this.value.toFixed(this.precision),this.subtextElement.textContent=name+": ",this.valueElement=document.createElement("span"),this.valueElement.textContent=this.displayValue,this.lastValueElementTextContent=this.valueElement.textContent,this.valueElement.setAttribute("contenteditable","true"),this.subtextElement.appendChild(this.valueElement),this.valueElement.addEventListener("input",()=>{var t=getCaretCharacterOffsetWithin(this.valueElement);let e=0;this.valueElement.textContent=this.valueElement.textContent.replaceAll(/[^0-9.-]/g,match=>(e-=match.length,"")),this.lastValueElementTextContent=this.valueElement.textContent,setCaretPosition(this.valueElement,t+e),this.setValue(parseFloat(this.valueElement.textContent),!0,!1)}),this.valueElement.addEventListener("blur",()=>{""===this.valueElement.textContent&&this.setValue(this.defaultValue,!0)}),this.subtextElement.style.marginTop=currentlyTouchDevice?"16px":"12px",addHoverEventWithScale({element:this.element,scale:1.1}),this.element.addEventListener("pointerdown",e=>{this.onGrabThumb(),this.dragOffset=e.clientX-this.element.getBoundingClientRect().left-1.25}),addTemporaryListener({object:document.documentElement,event:"touchend",callback:this.onEndDrag.bind(this)}),addTemporaryListener({object:document.documentElement,event:"mouseup",callback:this.onEndDrag.bind(this)}),addTemporaryListener({object:document.documentElement,event:"mousemove",callback:e=>{var t,i;this.currentlyDragging&&(e.preventDefault(),t=this.trackElement.getBoundingClientRect(),i=e.clientX-t.left-this.dragOffset,t=t.width-thumbWidth-5,i=clamp(i,0,t),this.element.style.left=i+"px",this.setRawValue(i/t))},options:{passive:!1}}),addTemporaryListener({object:document.documentElement,event:"touchmove",callback:e=>{var t,i;this.currentlyDragging&&(e.preventDefault(),t=this.trackElement.getBoundingClientRect(),i=e.touches[0].clientX-t.left-this.dragOffset,t=t.width-thumbWidth-5,i=clamp(i,0,t),this.element.style.left=i+"px",this.setRawValue(i/t))},options:{passive:!1}}),this.addTickMarks(),setTimeout(()=>{var t;this.persistState?((t=new URLSearchParams(window.location.search).get(this.element.id))?this.setValue(parseFloat(decodeURIComponent(t)),!0):this.setValue(this.value),addTemporaryParam(this.element.id)):this.setValue(this.value),this.loadResolve()},10)}addTickMarks(){this.tickElements.forEach(tick=>tick.remove());var t=this.snapPoints.length?this.snapPoints:this.integer&&this.max-this.min<10?Array.from({length:this.max-this.min+1},(_,i)=>this.min+i):[],e=trackWidth-(thumbWidth+5);for(const n of t){var i=document.createElement("div"),s=(i.classList.add("slider-tick"),this.logarithmic?(Math.log(n)-this.logMin)/(this.logMax-this.logMin):(n-this.min)/(this.max-this.min)),s=s*e+(thumbWidth+5)/2-1.25;i.style.left=s+"px",this.element.parentElement.appendChild(i),this.tickElements.push(i)}}onGrabThumb(){this.currentlyDragging=!0,this.temporaryStyleElement=addStyle(`
			*
			{
				user-select: none;
				-webkit-user-select: none;
				cursor: pointer;
			}
		`);for(const t of this.tickElements)t.style.top="-2.5px",t.style.height="7.5px"}onReleaseThumb(){this.currentlyDragging=!1,this.temporaryStyleElement.remove();for(const t of this.tickElements)t.style.top="0px",t.style.height="2.5px"}onEndDrag(){var t;this.currentlyDragging&&(this.onReleaseThumb(),this.persistState)&&(t=new URLSearchParams(window.location.search),void 0!==this.value&&t.set(this.element.id,encodeURIComponent(this.value)),t=t.toString(),window.history.replaceState({url:pageUrl},"",pageUrl.replace(/\/home/,"")+"/"+(t?"?"+t:"")))}setRawValue(newValue){var t=this.value;this.value=this.logarithmic?Math.exp(parseFloat(this.logMin+newValue*(this.logMax-this.logMin))):parseFloat(this.min+newValue*(this.max-this.min));for(let i=0;i<this.snapPoints.length;i++){var e=this.logarithmic?(Math.log(this.snapPoints[i])-this.logMin)/(this.logMax-this.logMin):(this.snapPoints[i]-this.min)/(this.max-this.min);if(Math.abs(e-newValue)<this.snapThreshhold){this.value=this.snapPoints[i];break}}this.value=this.integer?Math.round(this.value):this.value,this.displayValue=this.integer?this.value:this.value.toFixed(this.precision),this.valueElement.textContent=this.displayValue,this.value=parseFloat(this.value),this.setValue(this.value,t!==this.value)}setValue(newValue,callOnInput=!1,updateValueElement=!0){this.value=newValue;var t=this.logarithmic?(Math.log(this.value)-this.logMin)/(this.logMax-this.logMin):(this.value-this.min)/(this.max-this.min),t=clamp(t,0,1),e=(this.trackElement.offsetWidth,trackWidth-thumbWidth-5);this.element.style.left=t*e+"px",this.displayValue=this.integer?this.value:this.value.toFixed(this.precision),updateValueElement&&(this.valueElement.textContent=this.displayValue),callOnInput&&this.onInput()}setBounds({min=this.min,max=this.max,callOnInput=!1}){if(max<min)throw new Error(`Minimum slider value of ${min} is larger than maximum of ${max}!`);this.min=min,this.max=max,this.logMin=Math.log(this.min),this.logMax=Math.log(this.max),this.precision=Math.max(0,3-Math.floor(Math.log10(this.max-this.min))),this.setValue(clamp(this.value,this.min,this.max),callOnInput),this.addTickMarks()}}function getCaretCharacterOffsetWithin(el){var t,e=window.getSelection();let i=0;return e.anchorNode&&el.contains(e.anchorNode)&&((t=(e=e.getRangeAt(0)).cloneRange()).selectNodeContents(el),t.setEnd(e.startContainer,e.startOffset),i=t.toString().length),i}function setCaretPosition(el,offset){var t=document.createRange(),e=window.getSelection();let i=0;for(var s,n=document.createTreeWalker(el,NodeFilter.SHOW_TEXT,null);s=n.nextNode();){var a=i+s.length;if(offset<=a)return t.setStart(s,offset-i),t.collapse(!0),e.removeAllRanges(),void e.addRange(t);i=a}}export{Slider};