import anime from"../anime.min.js";import{opacityAnimationTime}from"./animation.min.js";import{headerElement}from"./header.min.js";import{addHoverEvent}from"./hoverEvents.min.js";import{InputElement}from"./inputElement.min.js";const maxSingleColumnOptions=7;class Dropdown extends InputElement{value;options;onInput;buttonElement;optionContainerElement;optionElements;isOpen=!1;selectedItem=0;scale=1;boundClose;constructor({element,name,options,onInput=()=>{}}){super({element:element,name:name}),this.options=Object.assign({"":this.name},options),this.onInput=onInput,this.value="",this.buttonElement=this.element.previousElementSibling,this.boundClose=this.close.bind(this);var t=Object.keys(this.options).length;this.buttonElement.textContent=this.name,this.selectOptionElements=[];for(const n in this.options){var e=document.createElement("option");e.value=n,e.textContent=this.options[n],this.element.appendChild(e),this.selectOptionElements.push(e)}this.buttonElement.innerHTML="",this.buttonElement.parentNode.parentNode.style.gridTemplateColumns="repeat(auto-fit, 100%)",this.optionContainerElement=document.createElement("div"),this.optionContainerElement.classList.add("option-container"),t>maxSingleColumnOptions&&this.optionContainerElement.classList.add("two-column"),this.buttonElement.appendChild(this.optionContainerElement),this.optionElements=[],this.selectOptionElements.forEach((option,index)=>{var t=document.createElement("div");t.textContent=option.textContent,t.setAttribute("data-option-name",option.getAttribute("value")),t.setAttribute("data-option-index",index),this.optionElements.push(t),this.optionContainerElement.appendChild(t)}),setTimeout(()=>{this.optionElements.slice(1).forEach(element=>{addHoverEvent(element)}),this.optionElements[0].innerHTML+=' <span style="font-size: 12px; margin-right: -2px">&#x25BC;</span>',this.buttonElement.style.height=1.075*this.optionElements[this.selectedItem].getBoundingClientRect().height+"px",this.buttonElement.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",this.buttonElement.parentNode.parentNode.style.height=1.075*this.optionElements[this.selectedItem].getBoundingClientRect().height+"px",this.buttonElement.parentNode.parentNode.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",this.optionContainerElement.style.transform="translateY(-10px)",this.buttonElement.addEventListener("click",()=>{this.isOpen||this.open()})},16)}async open(animationTime=opacityAnimationTime){this.isOpen=!0,this.buttonElement.classList.add("expanded");let t=0,e=0,n=0;this.optionElements.forEach((element,index)=>{0===index?t=element.getBoundingClientRect().width:index%2==0?e=Math.max(e,element.getBoundingClientRect().width):n=Math.max(n,element.getBoundingClientRect().width)});var i=Math.max(this.optionContainerElement.classList.contains("two-column")?e+n:Math.max(e,n),t),o=this.optionContainerElement.getBoundingClientRect().height+4,s=headerElement.getBoundingClientRect().height,a=window.innerHeight-s-20,i=i+24,l=window.innerWidth-20,l=(this.scale=Math.min(l/i,Math.min(a/o,1)),o*this.scale),a=i*this.scale,h=this.buttonElement.getBoundingClientRect(),m=h.top+h.height/2-l/2,l=h.bottom-h.height/2+l/2,d=h.left+h.width/2-a/2,h=h.right-h.width/2+a/2;let p=0,r=(l>window.innerHeight-10?p=window.innerHeight-10-l:m<10+s&&(p=10+s-m),0);h>window.innerWidth-10?r=window.innerWidth-10-h:d<10&&(r=10-d),await Promise.all([anime({targets:this.buttonElement,height:o,width:i,translateY:p,translateX:r,scale:this.scale,easing:"easeOutQuad",duration:animationTime}).finished,anime({targets:this.optionContainerElement,translateY:0,translateX:0,easing:"easeOutQuad",duration:animationTime}).finished]),document.documentElement.addEventListener("click",this.boundClose)}async close(e){let t=document.elementFromPoint(e.clientX,e.clientY);for(;!t.hasAttribute("data-option-index")&&"HTML"!==t.tagName;)t=t.parentNode;await this.setValue(t.getAttribute("data-option-name"),opacityAnimationTime)}async setValue(newValue,animationTime=20){this.isOpen||await this.open(20),document.documentElement.removeEventListener("click",this.boundClose),this.isOpen=!1,this.buttonElement.classList.remove("expanded");var t=this.selectedItem,e=(newValue&&(e=this.optionContainerElement.querySelector(`[data-option-name=${newValue}]`),this.selectedItem=parseInt(e.getAttribute("data-option-index")??this.selectedItem)||this.selectedItem),this.element.value=this.selectOptionElements[this.selectedItem].value,this.value=this.element.value,t!==this.selectedItem&&this.onInput(),this.optionContainerElement.children[0].getBoundingClientRect()),t=this.optionContainerElement.children[this.selectedItem].getBoundingClientRect(),n=(e.top-t.top)/this.scale-10,e=-(-e.width/2+t.left-e.left+t.width/2)/this.scale;await Promise.all([anime({targets:[this.buttonElement,this.buttonElement.parentNode.parentNode],height:this.optionElements[this.selectedItem].getBoundingClientRect().height/this.scale+4,width:this.optionElements[this.selectedItem].getBoundingClientRect().width/this.scale+16,translateY:0,translateX:0,scale:1,easing:"easeOutQuad",duration:animationTime}).finished,anime({targets:this.optionContainerElement,translateY:n,translateX:e,easing:"easeOutQuad",duration:animationTime}).finished])}}export{Dropdown};