import anime from"../anime.min.js";import{opacityAnimationTime}from"./animation.min.js";import{headerElement}from"./header.min.js";import{addHoverEvent}from"./hoverEvents.min.js";import{InputElement}from"./inputElement.min.js";import{addTemporaryParam,pageUrl}from"./main.min.js";import{siteSettings}from"./settings.min.js";const maxSingleColumnOptions=7;class Dropdown extends InputElement{value;options;persistState;onInput;returnToTitleOnSelect;buttonElement;optionContainerElement;optionElements;isOpen=!1;selectedItem=0;scale=1;boundClose;constructor({element,name,roundCorners=!0,returnToTitleOnSelect=!1,persistState=!0,options,onInput=()=>{}}){super({element:element,name:name}),this.options=Object.assign({"":this.name},options),this.onInput=onInput,this.value="",this.persistState=persistState,this.returnToTitleOnSelect=returnToTitleOnSelect,this.buttonElement=this.element.previousElementSibling,this.boundClose=this.close.bind(this);var t,e,n=Object.keys(this.options).length;this.buttonElement.textContent=this.name,roundCorners||(this.buttonElement.style.borderRadius="10px"),this.selectOptionElements=[];for(const o in this.options){var i=document.createElement("option");i.value=o,i.textContent=this.options[o],this.element.appendChild(i),this.selectOptionElements.push(i)}this.buttonElement.innerHTML="",this.buttonElement.parentNode.parentNode.style.gridTemplateColumns="repeat(auto-fit, 100%)",this.optionContainerElement=document.createElement("div"),this.optionContainerElement.classList.add("option-container"),n>maxSingleColumnOptions&&this.optionContainerElement.classList.add("two-column"),this.buttonElement.appendChild(this.optionContainerElement),this.optionElements=[];for([t,e]of this.selectOptionElements.entries()){var s=document.createElement("div");s.textContent=e.textContent,s.setAttribute("data-option-name",0===t?"default":e.getAttribute("value")),s.setAttribute("data-option-index",t),this.optionElements.push(s),this.optionContainerElement.appendChild(s)}setTimeout(()=>{for(const t of this.optionElements.slice(1))addHoverEvent({element:t});if(this.optionElements[0].innerHTML+=' <span style="font-size: 12px; margin-right: -2px">&#x25BC;</span>',this.buttonElement.style.height=1.075*this.optionElements[this.selectedItem].getBoundingClientRect().height+"px",this.buttonElement.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",this.buttonElement.parentNode.parentNode.style.height=1.075*this.optionElements[this.selectedItem].getBoundingClientRect().height+"px",this.buttonElement.parentNode.parentNode.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",this.optionContainerElement.style.transform="translateY(-10px)",this.buttonElement.addEventListener("click",()=>{this.isOpen||(document.startViewTransition&&siteSettings.reduceMotion?document.startViewTransition(()=>this.open(0)):this.open())}),this.persistState){const e=new URLSearchParams(window.location.search).get(this.element.id);e?setTimeout(()=>{this.setValue({newValue:decodeURIComponent(e),instant:!0}),this.loadResolve()},10):this.loadResolve(),addTemporaryParam(this.element.id)}else this.loadResolve()},16)}async open(animationTime=opacityAnimationTime){this.isOpen=!0,this.buttonElement.classList.add("expanded"),this.buttonElement.classList.add("no-hover");var t,e,n=getComputedStyle(this.buttonElement).transform,i="none"===n?1:parseFloat(n.slice(n.indexOf("(")+1,n.indexOf(",")));let s=0,o=0,a=0;for([t,e]of this.optionElements.entries())0===t?s=e.getBoundingClientRect().width/i:t%2==0?o=Math.max(o,e.getBoundingClientRect().width/i):a=Math.max(a,e.getBoundingClientRect().width/i);var n=Math.max(this.optionContainerElement.classList.contains("two-column")?o+a:Math.max(o,a),s),l=this.optionContainerElement.getBoundingClientRect().height/i+4,r=headerElement.getBoundingClientRect().height,m=window.innerHeight-r-20,n=n+24,h=window.innerWidth-20,h=(this.scale=Math.min(h/n,Math.min(m/l,1)),l*this.scale),m=n*this.scale,d=this.buttonElement.getBoundingClientRect(),p=d.top+d.height/i/2-h/2,h=d.bottom-d.height/i/2+h/2,c=d.left+d.width/i/2-m/2,d=d.right-d.width/i/2+m/2,m=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-top").slice(0,-2)),u=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-bottom").slice(0,-2)),g=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-left").slice(0,-2)),E=parseFloat(window.getComputedStyle(document.documentElement).getPropertyValue("--safe-area-inset-right").slice(0,-2));let w=0,C=(h>window.innerHeight-10-u?w=window.innerHeight-10-u-h:p<10+r+m&&(w=10+r+m-p),0);d>window.innerWidth-10-E?C=window.innerWidth-10-E-d:c<10+g&&(C=10+g-c),animationTime?await Promise.all([anime({targets:this.buttonElement,height:l,width:n,translateY:w,translateX:C,scale:this.scale,easing:"easeOutQuad",duration:animationTime}).finished,anime({targets:this.optionContainerElement,translateY:0,translateX:0,easing:"easeOutQuad",duration:animationTime}).finished]):(this.buttonElement.style.height=l+"px",this.buttonElement.style.width=n+"px",this.buttonElement.style.transform=`translateY(${w}px) translateX(${C}px) scale(${this.scale})`,this.optionContainerElement.style.transform="translateX(0px) translateY(0px)"),document.documentElement.addEventListener("click",this.boundClose)}async close(e){let t=document.elementFromPoint(e.clientX,e.clientY);for(;!t.hasAttribute("data-option-index")&&"HTML"!==t.tagName;)t=t.parentNode;await this.setValue({newValue:t.getAttribute("data-option-name"),fromOnClickHandler:!0})}async setValue({newValue,instant=!1,fromOnClickHandler=!1}){document.startViewTransition&&siteSettings.reduceMotion?document.startViewTransition(()=>this.#setValue({newValue:newValue,instant:!0,fromOnClickHandler:fromOnClickHandler})):this.#setValue({newValue:newValue,instant:instant,fromOnClickHandler:fromOnClickHandler})}async#setValue({newValue,instant=!1,fromOnClickHandler=!1}){document.documentElement.removeEventListener("click",this.boundClose),this.isOpen=!1;var t=this.selectedItem;if(newValue&&(e=this.optionContainerElement.querySelector(`[data-option-name="${newValue}"]`),this.selectedItem=parseInt(e.getAttribute("data-option-index")??this.selectedItem),0===this.selectedItem)&&fromOnClickHandler&&(this.selectedItem=t),this.element.value=this.selectOptionElements[this.selectedItem].value,this.value=this.element.value,t!==this.selectedItem&&this.selectedItem)try{this.onInput(fromOnClickHandler)}catch(t){}this.returnToTitleOnSelect&&(this.selectedItem=0);var e=this.optionContainerElement.children[0].getBoundingClientRect(),t=this.optionContainerElement.children[this.selectedItem].getBoundingClientRect(),n=(e.top-t.top)/this.scale-10,e=-(-e.width/2+t.left-e.left+t.width/2)/this.scale;if(this.persistState&&(t=new URLSearchParams(window.location.search),0!==this.selectedItem?t.set(this.element.id,encodeURIComponent(this.optionElements[this.selectedItem].getAttribute("data-option-name"))):t.delete(this.element.id),t=t.toString(),window.history.replaceState({url:pageUrl},"",pageUrl.replace(/\/home/,"")+"/"+(t?"?"+t:""))),this.buttonElement.classList.remove("expanded"),instant){for(const i of[this.buttonElement,this.buttonElement.parentNode.parentNode])i.style.height=this.optionElements[this.selectedItem].getBoundingClientRect().height/this.scale+4+"px",i.style.width=this.optionElements[this.selectedItem].getBoundingClientRect().width+16+"px",i.style.transform="translateY(0px) translateX(0px) scale(1)";this.optionContainerElement.style.transform=`translateX(${e}px) translateY(${n}px)`}else await Promise.all([anime({targets:[this.buttonElement,this.buttonElement.parentNode.parentNode],height:this.optionElements[this.selectedItem].getBoundingClientRect().height/this.scale+4,width:this.optionElements[this.selectedItem].getBoundingClientRect().width/this.scale+16,translateY:0,translateX:0,scale:1,easing:"easeOutQuad",duration:opacityAnimationTime}).finished,anime({targets:this.optionContainerElement,translateY:n,translateX:e,easing:"easeOutQuad",duration:opacityAnimationTime}).finished]);this.buttonElement.classList.remove("no-hover")}}export{Dropdown};