import anime from"../anime.min.js";import{Checkbox}from"./checkboxes.min.js";import{addHoverEventWithScale}from"./hoverEvents.min.js";import{InputElement}from"./inputElement.min.js";import{$$,addTemporaryListener,pageElement}from"./main.min.js";import{siteSettings}from"./settings.min.js";import{clamp}from"./utils.min.js";let uncapEverything=!1;function splitHtmlBySpaces(element){const e=[];for(let n=0;n<element.childNodes.length;n++)t=element.childNodes[n],a=void 0,t.nodeType===Node.TEXT_NODE?(a=t.textContent.split(/\s+/).filter(word=>0<word.length).map(word=>document.createTextNode(word)),e.push(...a)):t.nodeType===Node.ELEMENT_NODE&&e.push(t);var t,a;return e}class CappedInputElement extends InputElement{min;max;labelElement;capClassElement;disableCaps=!1;constructor({element,name,min,max,labelElement,capClassElement}){super({element:element,name:name}),this.min=min,this.max=max,this.labelElement=labelElement,this.capClassElement=capClassElement}setCap(){var e=document.createElement("p"),a=(e.classList.add("body-text"),e.style.position="fixed",e.style.opacity=0,e.style.top="-100vh",e.style.width="fit-content",e.innerHTML="",pageElement.appendChild(e),splitHtmlBySpaces(this.labelElement)),t=this.labelElement.getBoundingClientRect().width;let n=0;for(let p=0;p<a.length;p++)e.appendChild(document.createTextNode(p===n?"":" ")),e.appendChild(a[p]),t<=e.getBoundingClientRect().width&&(p===n?n=p===a.length-1?p:p+1:(n=p,p--),e.innerHTML="");if(e.remove(),0===n){var i=document.createElement("span");i.style.whiteSpace="nowrap";for(let e=0;e<a.length;e++)i.appendChild(a[e]),e!==n-1&&i.appendChild(document.createTextNode(" "));var l=document.createElement("span");l.classList.add("cap-triangle"),l.innerHTML="&#x25BC;",i.appendChild(l),this.labelElement.innerHTML="",this.labelElement.appendChild(i)}else{var s=document.createElement("span"),o=document.createElement("span");o.style.whiteSpace="nowrap";for(let e=0;e<n;e++)s.appendChild(a[e]),e!==n-1&&s.appendChild(document.createTextNode(" "));for(let t=n;t<a.length;t++)o.appendChild(a[t]),t!==a.length-1&&o.appendChild(document.createTextNode(" "));l=document.createElement("span");l.classList.add("cap-triangle"),l.innerHTML="&#x25BC;",o.appendChild(l),this.labelElement.innerHTML="",this.labelElement.appendChild(s),this.labelElement.appendChild(o)}this.labelElement.addEventListener("click",e=>{e.target.isContentEditable||(this.capClassElement.classList.contains("capped-input-max")?(hideAllCapDialogs(),this.showCapDialog()):this.capClassElement.classList.contains("capped-input-min")&&(hideAllCapDialogs(),this.showCapDialog(!0)))});l=(e=>{e.target.classList.contains("keep-dialog-open")||hideAllCapDialogs()}).bind(this);addTemporaryListener({object:document.documentElement,event:"pointerdown",callback:l})}updateCaps(){this.disableCaps||uncapEverything||(this.value>=this.max?(this.value=this.max,this.capClassElement.classList.remove("capped-input-min"),this.capClassElement.classList.add("capped-input-max")):this.value<=this.min?(this.value=this.min,this.capClassElement.classList.remove("capped-input-max"),this.capClassElement.classList.add("capped-input-min")):(this.capClassElement.classList.remove("capped-input-max"),this.capClassElement.classList.remove("capped-input-min")),this.setValue(this.value))}showCapDialog(tooSmall=!1){const e=document.createElement("div");e.classList.add("input-cap-dialog"),e.classList.add("keep-dialog-open"),e.style.opacity=0,e.style.transform="scale(1)",e.innerHTML=tooSmall?`Smaller values than this may cause unexpected results, break the intended functionality of the applet, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!
			<div class="checkbox-row keep-dialog-open">
				<div class="checkbox-container keep-dialog-open" tabindex="1">
					<input type="checkbox" id="${this.element.id}-checkbox" class="uncap-inputs-checkbox keep-dialog-open">
					<div class="checkbox keep-dialog-open"></div>
				</div>
				
				<label for="${this.element.id}-checkbox" style="margin-left: 10px" class="keep-dialog-open">
					<p class="body-text checkbox-subtext keep-dialog-open"></p>
				</label>
			</div>`:`Larger values than this may take an extremely long time to compute, cause substantial lag, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!
			<div class="checkbox-row keep-dialog-open">
				<div class="checkbox-container keep-dialog-open" tabindex="1">
					<input type="checkbox" id="${this.element.id}-checkbox" class="uncap-inputs-checkbox keep-dialog-open">
					<div class="checkbox keep-dialog-open"></div>
				</div>
				
				<label for="${this.element.id}-checkbox" style="margin-left: 10px" class="keep-dialog-open">
					<p class="body-text checkbox-subtext keep-dialog-open"></p>
				</label>
			</div>`,pageElement.appendChild(e);var t=()=>this.updateCapDialogLocation(e);addTemporaryListener({object:window,event:"resize",callback:t}),t(),e.style.transform=siteSettings.reduceMotion?"scale(1)":"scale(.95)",setTimeout(()=>{const t=new Checkbox({element:e.querySelector(".uncap-inputs-checkbox"),name:"Uncap all inputs",checked:uncapEverything,persistState:!1,onInput:function(){if(uncapEverything=t.checked)for(const e of $$(".capped-input-max, .capped-input-min"))e.classList.remove("capped-input-max"),e.classList.remove("capped-input-min")}});addHoverEventWithScale({element:t.element.parentNode,scale:1.1,addBounceOnTouch:()=>!0}),anime({targets:e,opacity:1,scale:1,duration:250,easing:"easeOutQuad"})},16)}updateCapDialogLocation(dialog){var e=this.labelElement.getBoundingClientRect(),t=dialog.getBoundingClientRect(),e=(dialog.style.top=window.scrollY+e.top+e.height+4+"px",clamp(e.left-(t.width+12-e.width)/2,12,window.innerWidth-12-t.width));dialog.style.left=e+"px"}}function hideAllCapDialogs(){const t=$$(".input-cap-dialog");t&&anime({targets:t,opacity:0,scale:siteSettings.reduceMotion?1:.95,duration:250,easing:"easeOutQuad",complete:()=>{for(const e of t)e.remove()}})}export{uncapEverything,CappedInputElement,hideAllCapDialogs};