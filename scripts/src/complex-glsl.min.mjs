const glslFilenames=["equality","powers","trig","combinatorics","number-theory","gamma","hypergeometric","su3_character","lambert_w","hurwitz_zeta","zeta"],glslFiles={main:{dependencies:[],keywords:[]},constants:{dependencies:[],keywords:[]}};let doubleEmulationGlsl=null,doubleEncodingGlsl=null;function splitGlslFile(l,n){n=n.replaceAll("\r","");let e=0;for(;;){var i=n.indexOf("#function",e);if(-1===i)break;var t=n.indexOf("\n",i+10);if(-1===t)return void console.error("[GLSL bundling] Invalid function name in file "+l);let s=n.slice(i+10,t).split(" ");s=s.map(l=>l.replaceAll(" ",""));for(let l=0;l<s.length;l++)""===s[l]&&(s.splice(l,1),l--);var a=n.indexOf("#endfunction",t+1);if(-1===a)return void console.error("[GLSL bundling] Missing #endfunction in file "+l);glslFiles[s[0]]={keywords:s};i=n.indexOf("#requires",i);if(-1!==i&&i<a){var o=n.indexOf("\n",i+10);let e=n.slice(i+10,o).split(" ");e=e.map(l=>l.replaceAll(" ",""));for(let l=0;l<e.length;l++)""===e[l]&&(e.splice(l,1),l--);glslFiles[s[0]].dependencies=e,glslFiles[s[0]].content=n.slice(o+1,a)}else glslFiles[s[0]].dependencies=[],glslFiles[s[0]].content=n.slice(t+1,a);e=a+13}}const glslFilesByDepth=[];let loadedGlsl=!1;function loadGlsl(){return new Promise(async(s,l)=>{if(!loadedGlsl){var n=await(await fetch("/scripts/glsl/constants")).text();glslFiles.constants.content=n;n=await(await fetch("/scripts/glsl/main")).text();glslFiles.main.content=n;n=await(await fetch("/scripts/glsl/double_emulation")).text();doubleEmulationGlsl=n;n=await(await fetch("/scripts/glsl/double_encoding")).text();doubleEncodingGlsl=n;const i={};await Promise.all(glslFilenames.map(n=>new Promise(async(l,e)=>{var s=await fetch("/scripts/glsl/"+n);i[n]=await s.text(),l()}))),glslFilenames.forEach(l=>splitGlslFile(l,i[l]));n=Object.keys(glslFiles);n.forEach(l=>glslFiles[l].parents=[]),n.forEach(e=>{var l=glslFiles[e].dependencies;l.forEach(l=>glslFiles[l].parents.push(e)),0===l.length&&"main"!==e&&glslFiles.main.parents.push(e)});let l=["main"],e=0;for(;0!==l.length;){const t=[];glslFilesByDepth.push([]),l.forEach(l=>{void 0===glslFiles[l].depth?glslFiles[l].depth=e:glslFiles[l].depth=Math.max(glslFiles[l].depth,e),glslFiles[l].parents.forEach(l=>{t.includes(l)||t.push(l)})}),e++,l=t}n.forEach(l=>glslFilesByDepth[glslFiles[l].depth].push(l)),loadedGlsl=!0,s()}})}function getGlslBundle(l){const s=l.match(/[a-zA-Z_][a-zA-Z0-9_]*/g);let e="";l=Object.keys(glslFiles);const n={};l.forEach(l=>n[l]=!1),n.main=!0;let i="";l.forEach(e=>{n[e]||s.forEach(l=>{-1!==glslFiles[e].keywords.indexOf(l)&&(i="[GLSL bundling] Adding "+e,function e(l,s){n[l]||(n[l]=!0,0!==s&&(i+="\n                     "+"   ".repeat(s)+"â†³ "+l),glslFiles[l].dependencies.forEach(l=>e(l,s+1)))}(e,0),console.log(i))})}),e=glslFiles.constants.content+glslFiles.main.content;for(let l=1;l<glslFilesByDepth.length;l++)glslFilesByDepth[l].forEach(l=>{n[l]&&(e+=glslFiles[l].content)});return e}export{doubleEmulationGlsl,doubleEncodingGlsl,loadGlsl,getGlslBundle};