import{cardAnimationTime}from"./animation.min.js";import{browserIsIos}from"./browser.min.js";import{addHoverEvent}from"./hoverEvents.min.js";import{$$,pageElement,pageUrl}from"./main.min.js";import{getDisplayUrl}from"./navigation.min.js";import{metaThemeColorElement,siteSettings}from"./settings.min.js";import anime from"/scripts/anime.min.js";let cardIsOpen=!1,cardIsAnimating=!1;const easing="cubicBezier(.25, 1, .25, 1)",container=document.querySelector("#card-container");let currentCard;const closeButton=document.querySelector("#card-close-button");closeButton&&(addHoverEvent({element:closeButton}),closeButton.addEventListener("click",()=>hideCard()),document.documentElement.addEventListener("keydown",e=>{"Escape"===e.key&&cardIsOpen&&hideCard()}));let scrollBeforeCard=0;function initCards(){$$("[data-card-id]").forEach(element=>{element.addEventListener("click",e=>{e.metaKey||showCard({id:element.getAttribute("data-card-id"),fromElement:element})})})}async function showCard({id,animationTime=cardAnimationTime}){var e,t,n,i,r;cardIsOpen&&await hideCard(),cardIsAnimating||(cardIsAnimating=!0,scrollBeforeCard=window.scrollY,cardIsOpen=!0,siteSettings.card=id,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),container.style.display="flex",container.style.opacity=1,container.style.top="100vh",container.style.transform="",container.style.display="flex",currentCard=document.querySelector(`#${id}-card`),container.appendChild(currentCard),currentCard.insertBefore(closeButton,currentCard.firstElementChild),container.scroll(0,0),e=siteSettings.reduceMotion?1:.975,(r=currentCard.getBoundingClientRect()).height>window.innerHeight-32?container.style.justifyContent="flex-start":container.style.justifyContent="center",(i=currentCard.querySelector("img"))&&(t=i.getBoundingClientRect().height,n=window.innerWidth<=500?8:16,i.style.maxHeight=`calc(100vh - ${r.height-t+2*n}px)`),pageElement.style.filter="brightness(1)",document.querySelector("#header").style.filter="brightness(1)",document.querySelector("#header-container").style.filter="brightness(1)",pageElement.style.transformOrigin=browserIsIos?`50% calc(50vh + ${window.scrollY}px)`:"50% 50vh",document.documentElement.addEventListener("click",handleClickEvent),i=siteSettings.darkTheme?"rgb(12, 12, 12)":"rgb(127, 127, 127)",r=siteSettings.darkTheme?"#0c0c0c":"#7f7f7f",document.documentElement.style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",document.querySelector("#header-container").style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",browserIsIos||(window.scrollTo(0,0),pageElement.style.transform=`scale(1) translateY(-${scrollBeforeCard}px)`,pageElement.style.position="fixed"),siteSettings.reduceMotion&&(container.style.opacity=0,container.style.top=0),await Promise.all([anime({targets:container,top:0,opacity:1,duration:animationTime,easing:easing}).finished,anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(.5)",scale:e,duration:animationTime,easing:easing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:i,scale:e,duration:animationTime,easing:easing}).finished,anime({targets:metaThemeColorElement,content:r,duration:animationTime,easing:easing}).finished,anime({targets:document.documentElement,backgroundColor:i,duration:animationTime,easing:easing}).finished]),currentCard.setAttribute("tabindex","0"),currentCard.focus(),container.scrollTo(0,0),cardIsAnimating=!1)}async function hideCard(animationTime=cardAnimationTime){if(!cardIsAnimating){cardIsAnimating=!0,cardIsOpen=!1,siteSettings.card=void 0,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),await new Promise(resolve=>setTimeout(resolve,0));var e=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",t=siteSettings.darkTheme?"#181818":"#ffffff";browserIsIos&&(pageElement.style.transformOrigin=`50% calc(50vh + ${window.scrollY}px)`);const i={t:0},r=container.scrollTop,a=r+window.innerHeight+64;var n=(siteSettings.reduceMotion?anime({targets:container,opacity:0,duration:animationTime,easing:easing}):anime({targets:i,t:1,duration:animationTime,easing:easing,update:()=>{var e=i.t*a,t=Math.max(r-e,0),t=(container.scrollTo(0,t),Math.max(e-r,0));container.style.top=t+"px"}})).finished;await Promise.all([anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(1)",scale:1,duration:animationTime,easing:easing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:e,scale:1,duration:animationTime,easing:easing}).finished,anime({targets:metaThemeColorElement,content:t,duration:animationTime,easing:easing}).finished,anime({targets:document.documentElement,backgroundColor:e,duration:animationTime,easing:easing}).finished,n]),browserIsIos||(pageElement.style.position="relative",window.scrollTo(0,scrollBeforeCard),pageElement.style.transform=""),document.documentElement.style.backgroundColor="var(--background)",document.querySelector("#header-container").style.backgroundColor="var(--background)",container.style.display="none",pageElement.appendChild(currentCard),container.appendChild(closeButton),document.documentElement.removeEventListener("click",handleClickEvent),cardIsAnimating=!1}}let lastFromElement,lastToElement;async function getClosedContainerStyle({fromElement,toElement}){await new Promise(resolve=>setTimeout(resolve,0));var e=fromElement.getBoundingClientRect(),t=toElement.getBoundingClientRect(),n=getComputedStyle(fromElement).transform.split(",")[0].split("(")[1].split(")")[0],i=n*e.width/t.width,r=(container.style.transform=`scale(${i})`,await new Promise(resolve=>setTimeout(resolve,0)),t=toElement.getBoundingClientRect(),e.left-t.left-(n-1)/2*e.width),t=e.top-t.top-(n-1)/2*e.height;return container.style.transform="",[r,t,i]}async function showZoomCard({id,fromElement,toElement,animationTime=cardAnimationTime}){if(siteSettings.reduceMotion)return showCard({id:id,animationTime:animationTime});var e,t,n,i,r;cardIsOpen&&await hideCard(),cardIsAnimating||(cardIsAnimating=!0,scrollBeforeCard=window.scrollY,cardIsOpen=!0,siteSettings.card=id,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),container.style.display="flex",container.style.opacity=0,container.style.top=0,container.style.transform="",container.style.display="flex",currentCard=document.querySelector(`#${id}-card`),toElement=toElement||currentCard,container.appendChild(currentCard),currentCard.insertBefore(closeButton,currentCard.firstElementChild),container.scroll(0,0),(t=currentCard.getBoundingClientRect()).height>window.innerHeight-32?container.style.justifyContent="flex-start":container.style.justifyContent="center",(e=currentCard.querySelector("img"))&&(n=e.getBoundingClientRect().height,i=window.innerWidth<=500?8:16,e.style.maxHeight=`calc(100vh - ${t.height-n+2*i}px)`),pageElement.style.filter="brightness(1)",document.querySelector("#header").style.filter="brightness(1)",document.querySelector("#header-container").style.filter="brightness(1)",pageElement.style.transformOrigin=browserIsIos?`50% calc(50vh + ${window.scrollY}px)`:"50% 50vh",document.documentElement.addEventListener("click",handleClickEventZoom),e=siteSettings.darkTheme?"rgb(12, 12, 12)":"rgb(127, 127, 127)",t=siteSettings.darkTheme?"#0c0c0c":"#7f7f7f",[n,i,r]=(document.documentElement.style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",document.querySelector("#header-container").style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",browserIsIos||(window.scrollTo(0,0),pageElement.style.transform=`scale(1) translateY(-${scrollBeforeCard}px)`,pageElement.style.position="fixed"),await getClosedContainerStyle({fromElement:fromElement,toElement:toElement})),container.style.transform=`translateX(${n}px) translateY(${i}px) scale(${r})`,container.style.opacity=1,await Promise.all([anime({targets:container,opacity:1,scale:1,translateX:0,translateY:0,duration:animationTime,easing:easing}).finished,anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(.5)",scale:.975,duration:animationTime,easing:easing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:e,scale:.975,duration:animationTime,easing:easing}).finished,anime({targets:metaThemeColorElement,content:t,duration:animationTime,easing:easing}).finished,anime({targets:document.documentElement,backgroundColor:e,duration:animationTime,easing:easing}).finished]),currentCard.setAttribute("tabindex","0"),currentCard.focus(),container.scrollTo(0,0),cardIsAnimating=!1,lastFromElement=fromElement,lastToElement=toElement)}async function hideZoomCard(animationTime=cardAnimationTime){if(siteSettings.reduceMotion)return hideCard(animationTime);var e,t,n,i,r;cardIsAnimating||(cardIsAnimating=!0,cardIsOpen=!1,siteSettings.card=void 0,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),await new Promise(resolve=>setTimeout(resolve,0)),e=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",t=siteSettings.darkTheme?"#181818":"#ffffff",[n,i,r]=(browserIsIos&&(pageElement.style.transformOrigin=`50% calc(50vh + ${window.scrollY}px)`),await getClosedContainerStyle({fromElement:lastFromElement,toElement:lastToElement})),await Promise.all([anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(1)",scale:1,duration:animationTime,easing:easing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:e,scale:1,duration:animationTime,easing:easing}).finished,anime({targets:metaThemeColorElement,content:t,duration:animationTime,easing:easing}).finished,anime({targets:document.documentElement,backgroundColor:e,duration:animationTime,easing:easing}).finished,anime({targets:container,opacity:0,translateX:n,translateY:i,scale:r,duration:animationTime,easing:easing}).finished]),browserIsIos||(pageElement.style.position="relative",window.scrollTo(0,scrollBeforeCard),pageElement.style.transform=""),document.documentElement.style.backgroundColor="var(--background)",document.querySelector("#header-container").style.backgroundColor="var(--background)",container.style.display="none",pageElement.appendChild(currentCard),container.appendChild(closeButton),document.documentElement.removeEventListener("click",handleClickEventZoom),cardIsAnimating=!1)}function handleClickEvent(e){"card-container"===e.target.id&&hideCard()}function handleClickEventZoom(e){"card-container"===e.target.id&&hideZoomCard()}function resizeCard(){cardIsOpen&&(currentCard.getBoundingClientRect().height>window.innerHeight-32?container.style.justifyContent="flex-start":container.style.justifyContent="center")}export{cardIsOpen,cardIsAnimating,currentCard,scrollBeforeCard,initCards,showCard,hideCard,showZoomCard,hideZoomCard,resizeCard};