import{cardAnimationTime}from"./animation.min.js";import{browserIsIos}from"./browser.min.js";import{addHoverEvent}from"./hoverEvents.min.js";import{loadImages}from"./images.min.js";import{$$,pageElement,pageUrl}from"./main.min.js";import{typesetMath}from"./math.min.js";import{currentlyRedirecting,getDisplayUrl}from"./navigation.min.js";import{metaThemeColorElement,setScroll,siteSettings}from"./settings.min.js";import{animate,asyncFetch,sleep}from"./utils.min.js";import anime from"/scripts/anime.min.js";let cardIsOpen=!1,cardIsZoom=!1,cardIsAnimating=!1;const openEasing="cubicBezier(.2, 1, .25, 1)",closeEasing="cubicBezier(.25, 1, .3, 1)",cardContainer=document.querySelector("#card-container");let currentCard;const closeButton=document.querySelector("#card-close-button");closeButton&&(addHoverEvent({element:closeButton,addBounceOnTouch:()=>!0}),closeButton.addEventListener("click",()=>closeCard()),document.documentElement.addEventListener("keydown",e=>{"Escape"===e.key&&cardIsOpen&&closeCard()}));let scrollBeforeCard=0;function initCards(){for(const t of $$("[data-card-id]"))t.addEventListener("click",e=>{e.metaKey||openCard({id:t.getAttribute("data-card-id"),fromElement:t})});window.DEBUG&&cardContainer.addEventListener("scroll",()=>setScroll())}let onLoadExternalCard=(card,id)=>{};function setOnLoadExternalCard(callback){onLoadExternalCard=callback}async function openCard({id,animationTime=cardAnimationTime}){if(cardIsOpen&&await closeCard(),!cardIsAnimating){cardIsAnimating=!0,scrollBeforeCard=window.scrollY,cardIsOpen=!0,cardIsZoom=!1,siteSettings.card=id,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),(currentCard=document.querySelector(`#${id}-card`)).classList.contains("external-card")&&(t=(await asyncFetch(pageUrl+`/cards/${id}/data.html`)).replaceAll(/^<div.*?>/g,"").replaceAll(/<\/div>$/g,""),currentCard.innerHTML=t,await Promise.all([typesetMath(),loadImages()]),onLoadExternalCard(currentCard,id),await sleep(10)),cardContainer.style.display="flex",cardContainer.style.opacity=1,cardContainer.style.top="100vh",cardContainer.style.transform="",cardContainer.appendChild(currentCard),currentCard.insertBefore(closeButton,currentCard.firstElementChild),cardContainer.scroll(0,0);var e,t=siteSettings.reduceMotion?1:.975,n=currentCard.getBoundingClientRect();n.height>window.innerHeight-32?cardContainer.style.justifyContent="flex-start":cardContainer.style.justifyContent="center";const a=currentCard.querySelector("img.gallery-card-image");a&&(r=a.getBoundingClientRect().height,e=window.innerWidth<=500?8:16,a.style.width=`calc(100vh - ${n.height-r+2*e}px)`,a.complete&&a.naturalHeight?await sleep(100):await new Promise(resolve=>{a.onload=()=>setTimeout(resolve,100)})),pageElement.style.filter="brightness(1)",document.querySelector("#header").style.filter="brightness(1)",document.querySelector("#header-container").style.filter="brightness(1)",pageElement.style.transformOrigin=browserIsIos?`50% calc(50vh + ${window.scrollY}px)`:"50% 50vh",document.documentElement.addEventListener("click",handleClickEvent);var n=siteSettings.darkTheme?"rgb(12, 12, 12)":"rgb(127, 127, 127)",r=siteSettings.darkTheme?"#0c0c0c":"#7f7f7f";document.documentElement.style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",document.querySelector("#header-container").style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",browserIsIos||(window.scrollTo(0,0),pageElement.style.transform=`scale(1) translateY(-${scrollBeforeCard}px)`,pageElement.style.position="fixed"),siteSettings.reduceMotion&&(cardContainer.style.opacity=0,cardContainer.style.top=0),await Promise.all([anime({targets:cardContainer,top:0,opacity:1,duration:animationTime,easing:openEasing}).finished,anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(.5)",scale:t,...siteSettings.increaseContrast&&{opacity:0},duration:animationTime,easing:openEasing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:n,scale:t,...siteSettings.increaseContrast&&{opacity:0},duration:animationTime,easing:openEasing}).finished,anime({targets:metaThemeColorElement,content:r,duration:animationTime,easing:openEasing}).finished,anime({targets:document.documentElement,backgroundColor:n,duration:animationTime,easing:openEasing}).finished]),currentCard.setAttribute("tabindex","0"),currentCard.focus(),cardContainer.scrollTo(0,0),cardIsAnimating=!1,window.DEBUG&&setScroll()}}async function closeCard(animationTime=cardAnimationTime){if(cardIsZoom)return hideZoomCard(animationTime);if(!cardIsAnimating){cardIsAnimating=!0,cardIsOpen=!1,siteSettings.card=void 0,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),await sleep(0);var e=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",n=siteSettings.darkTheme?"#181818":"#ffffff";browserIsIos&&(pageElement.style.transformOrigin=`50% calc(50vh + ${window.scrollY}px)`);const a=cardContainer.scrollTop,i=a+window.innerHeight+32;var r=siteSettings.reduceMotion?anime({targets:cardContainer,opacity:0,duration:animationTime,easing:closeEasing}).finished:animate(t=>{var e=t*i,n=Math.max(a-e,0),n=(cardContainer.scrollTo(0,n),Math.max(e-a,0));cardContainer.style.top=n+"px"},animationTime,closeEasing);await Promise.all([anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(1)",scale:1,...siteSettings.increaseContrast&&!currentlyRedirecting&&{opacity:1},duration:animationTime,easing:closeEasing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:e,scale:1,...siteSettings.increaseContrast&&!currentlyRedirecting&&{opacity:1},duration:animationTime,easing:closeEasing}).finished,anime({targets:metaThemeColorElement,content:n,duration:animationTime,easing:closeEasing}).finished,anime({targets:document.documentElement,backgroundColor:e,duration:animationTime,easing:closeEasing}).finished,r]),browserIsIos||(pageElement.style.position="relative",window.scrollTo(0,scrollBeforeCard),pageElement.style.transform=""),document.documentElement.style.backgroundColor="var(--background)",document.querySelector("#header-container").style.backgroundColor="var(--background)",cardContainer.style.display="none",pageElement.appendChild(currentCard),cardContainer.appendChild(closeButton),document.documentElement.removeEventListener("click",handleClickEvent),cardIsAnimating=!1,window.DEBUG&&setScroll()}}async function getClosedContainerStyle({fromElement,toElement}){var e=fromElement.getBoundingClientRect(),t=toElement.getBoundingClientRect(),n=getComputedStyle(fromElement).transform.split(",")[0].split("(")[1].split(")")[0],r=n*e.width/t.width,a=(cardContainer.style.transform=`scale(${r})`,t=toElement.getBoundingClientRect(),e.left-t.left-(n-1)/2*e.width),t=e.top-t.top-(n-1)/2*e.height;return cardContainer.style.transform="translateX(0) translateY(0) scale(1)",await sleep(0),[a,t,r]}async function showZoomCard({id,fromElement,toElement,animationTime=.85*cardAnimationTime}){if(siteSettings.reduceMotion)return openCard({id:id,animationTime:animationTime});if(cardIsOpen&&await closeCard(),!cardIsAnimating){cardIsAnimating=!0,scrollBeforeCard=window.scrollY,cardIsOpen=!0,cardIsZoom=!0,siteSettings.card=id,history.replaceState({url:pageUrl},document.title,getDisplayUrl());cardContainer.style.display="flex",cardContainer.style.opacity=.002,cardContainer.style.top=0,cardContainer.style.transform="",currentCard=document.querySelector(`#${id}-card`),toElement=toElement||currentCard,cardContainer.appendChild(currentCard),currentCard.insertBefore(closeButton,currentCard.firstElementChild),cardContainer.scroll(0,0);var e=currentCard.getBoundingClientRect();e.height>window.innerHeight-32?cardContainer.style.justifyContent="flex-start":cardContainer.style.justifyContent="center";const i=currentCard.querySelector("img.gallery-card-image");i&&(t=i.getBoundingClientRect().height,n=window.innerWidth<=500?8:16,i.style.width=`calc(100vh - ${e.height-t+2*n}px)`,i.complete&&i.naturalHeight?await sleep(90):await new Promise(resolve=>{i.onload=()=>setTimeout(resolve,90)})),pageElement.style.filter="brightness(1)",document.querySelector("#header").style.filter="brightness(1)",document.querySelector("#header-container").style.filter="brightness(1)",pageElement.style.transformOrigin=browserIsIos?`50% calc(50vh + ${window.scrollY}px)`:"50% 50vh",document.documentElement.addEventListener("click",handleClickEventZoom);var e=siteSettings.darkTheme?"rgb(12, 12, 12)":"rgb(127, 127, 127)",t=siteSettings.darkTheme?"#0c0c0c":"#7f7f7f",[n,r,a]=(document.documentElement.style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",document.querySelector("#header-container").style.backgroundColor=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",browserIsIos||(window.scrollTo(0,0),pageElement.style.transform=`scale(1) translateY(-${scrollBeforeCard}px)`,pageElement.style.position="fixed"),await getClosedContainerStyle({fromElement:fromElement,toElement:toElement}));cardContainer.style.transform=`translateX(${n}px) translateY(${r}px) scale(${a})`,cardContainer.style.opacity=.75,await Promise.all([anime({targets:cardContainer,opacity:1,scale:1,translateX:0,translateY:0,duration:animationTime,easing:openEasing}).finished,anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(.5)",scale:.975,...siteSettings.increaseContrast&&{opacity:0},duration:animationTime,easing:openEasing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:e,scale:.975,...siteSettings.increaseContrast&&{opacity:0},duration:animationTime,easing:openEasing}).finished,anime({targets:metaThemeColorElement,content:t,duration:animationTime,easing:openEasing}).finished,anime({targets:document.documentElement,backgroundColor:e,duration:animationTime,easing:openEasing}).finished]),currentCard.setAttribute("tabindex","0"),currentCard.focus(),cardContainer.scrollTo(0,0),cardIsAnimating=!1}}async function hideZoomCard(animationTime=.75*cardAnimationTime){if(siteSettings.reduceMotion)return closeCard(animationTime);var e,t;cardIsAnimating||(cardIsAnimating=!0,cardIsOpen=!1,siteSettings.card=void 0,history.replaceState({url:pageUrl},document.title,getDisplayUrl()),await sleep(0),e=siteSettings.darkTheme?"rgb(24, 24, 24)":"rgb(255, 255, 255)",t=siteSettings.darkTheme?"#181818":"#ffffff",browserIsIos&&(pageElement.style.transformOrigin=`50% calc(50vh + ${window.scrollY}px)`),await Promise.all([anime({targets:[pageElement,document.querySelector("#header")],filter:"brightness(1)",scale:1,...siteSettings.increaseContrast&&!currentlyRedirecting&&{opacity:1},duration:animationTime,easing:closeEasing}).finished,anime({targets:document.querySelector("#header-container"),backgroundColor:e,scale:1,...siteSettings.increaseContrast&&!currentlyRedirecting&&{opacity:1},duration:animationTime,easing:closeEasing}).finished,anime({targets:metaThemeColorElement,content:t,duration:animationTime,easing:closeEasing}).finished,anime({targets:document.documentElement,backgroundColor:e,duration:animationTime,easing:closeEasing}).finished,anime({targets:cardContainer,opacity:0,scale:siteSettings.reduceMotion?1:.925,duration:animationTime,easing:closeEasing}).finished]),browserIsIos||(pageElement.style.position="relative",window.scrollTo(0,scrollBeforeCard),pageElement.style.transform=""),document.documentElement.style.backgroundColor="var(--background)",document.querySelector("#header-container").style.backgroundColor="var(--background)",cardContainer.style.display="none",pageElement.appendChild(currentCard),cardContainer.appendChild(closeButton),document.documentElement.removeEventListener("click",handleClickEventZoom),cardIsAnimating=!1)}function handleClickEvent(e){"card-container"===e.target.id&&closeCard()}function handleClickEventZoom(e){"card-container"===e.target.id&&hideZoomCard()}function resizeCard(){cardIsOpen&&(currentCard.getBoundingClientRect().height>window.innerHeight-32?cardContainer.style.justifyContent="flex-start":cardContainer.style.justifyContent="center")}export{cardIsOpen,cardIsZoom,cardIsAnimating,cardContainer,currentCard,scrollBeforeCard,initCards,setOnLoadExternalCard,openCard,closeCard,showZoomCard,hideZoomCard,resizeCard};