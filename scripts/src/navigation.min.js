import{Applet}from"../applets/applet.min.js";import{fadeDownOut,fadeLeftOut,fadeOut,fadeRightOut,fadeUpOut,opacityAnimationTime}from"./animation.min.js";import{bannerElement,loadBanner}from"./banners.min.js";import{cardIsOpen,hideCard}from"./cards.min.js";import{clearDesmosGraphs,desmosGraphs}from"./desmos.min.js";import{loadPage}from"./loadPage.min.js";import{clearTemporaryIntervals,clearTemporaryListeners,clearTemporaryWorkers,pageElement,pageUrl,setPageUrl,temporaryIntervals,temporaryListeners,temporaryWorkers}from"./main.min.js";import{forceThemePages,getQueryParams,setForcedTheme,setRevertThemeTo,siteSettings,toggleDarkTheme}from"./settings.min.js";import{sitemap}from"./sitemap.min.js";let currentlyRedirecting=!1;function setCurrentlyRedirecting(newCurrentlyRedirecting){currentlyRedirecting=newCurrentlyRedirecting}let lastPageScroll=0,navigationTransitionType=0;async function redirect({url,inNewTab=!1,noStatePush=!1,restoreScroll=!1,noFadeOut=!1}){if(!currentlyRedirecting&&url!==pageUrl)if(inNewTab||-1!==url.indexOf("."))window.open(url,"_blank");else{currentlyRedirecting=!0,cardIsOpen&&await hideCard();const e=window.scrollY;navigationTransitionType=getTransitionType(url),await fadeOutPage({url:url,noFadeOut:noFadeOut}),Promise.all([fetch(url+"data.html"),loadBanner()]).then(response=>{if(response[0].ok)return response[0].text();window.location.replace("/404.html")}).then(data=>{unloadPage(),document.body.firstElementChild.insertAdjacentHTML("beforebegin",`<div class="page"${opacityAnimationTime?'style="opacity: 0"':""}>${data}</div>`),setPageUrl(url),loadPage(),noStatePush?history.replaceState({url:url},document.title,getDisplayUrl()):history.pushState({url:url},document.title,getDisplayUrl()),document.documentElement.style.overflowY="scroll",document.body.style.overflowY="visible",document.body.style.userSelect="auto",document.body.style.WebkitUserSelect="auto",window.DEBUG?window.scrollTo(0,1e5):restoreScroll?window.scrollTo(0,lastPageScroll):window.scrollTo(0,0),lastPageScroll=e})}}function getTransitionType(url){if(!(url in sitemap&&url!==pageUrl&&pageUrl))return 0;let e=pageUrl;for(;""!==e;)if(url===(e=sitemap[e].parent))return-1;for(e=url;""!==e;)if(e=sitemap[e].parent,pageUrl===e)return 1;if(sitemap[url].parent!==sitemap[pageUrl].parent)return 0;{const e=sitemap[url].parent;return sitemap[e].children.indexOf(url)>sitemap[e].children.indexOf(pageUrl)?2:-2}}function getDisplayUrl(){return pageUrl.replace(/\/home\//,"/")+getQueryParams()}async function fadeOutPage({url,noFadeOut}){forceThemePages[url]&&siteSettings.darkTheme!==forceThemePages[url]&&(setRevertThemeTo(siteSettings.darkTheme),setForcedTheme(!0),toggleDarkTheme({force:!0})),opacityAnimationTime&&(noFadeOut?pageElement.style.opacity=0:await(1===navigationTransitionType?bannerElement?Promise.all([fadeUpOut({element:bannerElement,noOpacityChange:!0}),fadeUpOut({element:pageElement})]):fadeUpOut({element:pageElement}):-1===navigationTransitionType?bannerElement?Promise.all([fadeDownOut({element:bannerElement,noOpacityChange:!0}),fadeDownOut({element:pageElement})]):fadeDownOut({element:pageElement}):2===navigationTransitionType?bannerElement?Promise.all([fadeLeftOut({element:bannerElement,noOpacityChange:!0}),fadeLeftOut({element:pageElement})]):fadeLeftOut({element:pageElement}):-2===navigationTransitionType?bannerElement?Promise.all([fadeRightOut({element:bannerElement,noOpacityChange:!0}),fadeRightOut({element:pageElement})]):fadeRightOut({element:pageElement}):bannerElement?Promise.all([fadeOut({element:bannerElement,noOpacityChange:!0}),fadeOut({element:pageElement})]):fadeOut({element:pageElement})))}function unloadPage(){document.querySelectorAll("script, .temporary-style, .wilson-fullscreen-components-container").forEach(element=>element.remove()),temporaryListeners.forEach(temporaryListener=>{temporaryListener[0].removeEventListener(temporaryListener[1],temporaryListener[2])}),clearTemporaryListeners(),temporaryIntervals.forEach(refreshId=>clearInterval(refreshId)),clearTemporaryIntervals();for(const e in temporaryWorkers)temporaryWorkers[e]?.terminate&&temporaryWorkers[e].terminate();clearTemporaryWorkers();for(const t in desmosGraphs)desmosGraphs[t].destroy();clearDesmosGraphs(),Applet.current.forEach(applet=>{applet?.destroy&&applet.destroy()}),Applet.current=[],pageElement.remove()}export{setCurrentlyRedirecting,navigationTransitionType,redirect,getDisplayUrl};