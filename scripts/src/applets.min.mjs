import{addHoverEventWithScale}from"./hover-events.min.mjs";import{$$,addTemporaryListener,pageElement}from"./main.min.mjs";import anime from"/scripts/anime.min.js";class Applet{canvas;wilson;workers=[];timeoutIds=[];animationPaused=!1;constructor(canvas){this.canvas=canvas,(this.pan.parent=this).zoom.parent=this,Applet.current.push(this)}pause(){this.animationPaused=!0}resume(){this.animationPaused=!1}destroy(){this.animationPaused=!0,this.workers.forEach(worker=>{worker?.terminate&&worker?.terminate()}),this.timeoutIds.forEach(timeoutId=>{null!=timeoutId&&clearTimeout(timeoutId)}),this.hiddenCanvasContainer&&this.hiddenCanvasContainer.remove(),console.log("Destroyed an applet of type "+this.constructor.name)}listenToInputElements(elements,run){elements.forEach(element=>{element.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),run())})})}uncapEverything=!1;setInputCaps(elements,caps){elements.forEach((element,index)=>{const t=caps[index];var e=element.nextElementSibling.innerHTML.split(" "),i=document.createElement("p");i.classList.add("body-text"),i.style.position="fixed",i.style.opacity=0,i.style.top="-100vh",i.style.width="fit-content",i.textContent="",pageElement.appendChild(i);let s=0;for(let a=0;a<e.length;a++)i.textContent=""+i.textContent+(a===s?"":" ")+e[a],100<=i.getBoundingClientRect().width&&(s=a,a--,i.textContent="");i.remove(),element.nextElementSibling.innerHTML=`<span>${e.slice(0,s).join(" ")}</span>${0!==s?" ":""}<span style="white-space: nowrap">${e.slice(s).join(" ")}<span class="triangle">&#x25BC;</span></span>`,element.addEventListener("input",()=>{parseFloat(element.value)>t&&!this.uncapEverything?(element.value=t,element.parentNode.classList.add("capped-input")):element.parentNode.classList.remove("capped-input")}),element.nextElementSibling.addEventListener("click",()=>{element.parentNode.classList.contains("capped-input")&&(this.hideCapDialogs(),this.showCapDialog(element))})});var t=(e=>{e.target.classList.contains("keep-dialog-open")||this.hideCapDialogs()}).bind(this);addTemporaryListener({object:document.documentElement,event:"pointerdown",callback:t,log:!0})}showCapDialog(element){const e=document.createElement("div");e.classList.add("input-cap-dialog"),e.classList.add("keep-dialog-open"),e.style.opacity=0,e.style.transform="scale(1)",e.innerHTML=`Higher values than this may take an extremely long time to compute, cause substantial lag, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!
		<div class="checkbox-row keep-dialog-open">
			<div class="checkbox-container click-on-child keep-dialog-open">
				<input type="checkbox" class="uncap-inputs-checkbox keep-dialog-open"/>
				<div class="checkbox keep-dialog-open"></div>
			</div>
			<div style="margin-left: 10px" class="keep-dialog-open">
				<p class="body-text checkbox-subtext keep-dialog-open">Uncap all inputs</p>
			</div>
		</div>`,pageElement.appendChild(e);var t=()=>this.updateCapDialogLocation(element,e);addTemporaryListener({object:window,event:"resize",callback:t}),t(),e.style.transform="scale(.95)",setTimeout(()=>{const t=e.querySelector(".uncap-inputs-checkbox");t.checked=this.uncapEverything,t.addEventListener("input",()=>{this.uncapEverything=t.checked,this.uncapEverything&&$$(".capped-input").forEach(cappedInputElement=>{cappedInputElement.classList.remove("capped-input")})}),addHoverEventWithScale(t.parentNode,1.1),anime({targets:e,opacity:1,scale:1,duration:250,easing:"easeOutQuad"})},16)}hideCapDialogs(){const t=$$(".input-cap-dialog");t&&anime({targets:t,opacity:0,scale:.95,duration:250,easing:"easeOutQuad",complete:()=>{t.forEach(dialog=>dialog.remove())}})}updateCapDialogLocation(element,dialog){var t=element.nextElementSibling.getBoundingClientRect(),e=dialog.getBoundingClientRect();dialog.style.top=window.scrollY+t.top+t.height+4+"px",dialog.style.left=Math.min(Math.max(t.left-(e.width+12-t.width)/2,12),window.innerWidth-12-e.width)+"px"}pauseWhenOffscreen(){var t=()=>{var t=this.canvas.getBoundingClientRect(),e=t.top;-t.height<=e&&e<window.innerHeight?this.resume():this.pause()};addTemporaryListener({object:window,event:"scroll",callback:t}),t()}hiddenCanvasContainer=null;createHiddenCanvas(){var t=document.createElement("canvas");return t.classList.add("hidden-canvas"),null===this.hiddenCanvasContainer&&(this.hiddenCanvasContainer=document.createElement("div"),this.hiddenCanvasContainer.style.display="none",pageElement.appendChild(this.hiddenCanvasContainer)),this.hiddenCanvasContainer.appendChild(t),t}onGrabCanvas(){this.pan.onGrabCanvas(),this.zoom.onGrabCanvas()}onDragCanvas(x,y,xDelta,yDelta){this.pan.onDragCanvas(x,y,xDelta,yDelta)}onReleaseCanvas(){this.pan.onReleaseCanvas(),this.zoom.onReleaseCanvas()}onWheelCanvas(x,y,scrollAmount){this.zoom.onWheelCanvas(x,y,scrollAmount)}onPinchCanvas(x,y,touchDistanceDelta){this.zoom.onPinchCanvas(x,y,touchDistanceDelta)}changeAspectRatio(useZoomLevel=!1,wilsons=[this.wilson]){wilsons.forEach(wilson=>{wilson.fullscreen.currentlyFullscreen?(this.aspectRatio=window.innerWidth/window.innerHeight,1<=this.aspectRatio?(wilson.changeCanvasSize(this.resolution,Math.floor(this.resolution/this.aspectRatio)),useZoomLevel&&(wilson.worldWidth=3*Math.pow(2,this.zoom.level)*this.aspectRatio,wilson.worldHeight=3*Math.pow(2,this.zoom.level))):(wilson.changeCanvasSize(Math.floor(this.resolution*this.aspectRatio),this.resolution),useZoomLevel&&(wilson.worldWidth=3*Math.pow(2,this.zoom.level),wilson.worldHeight=3*Math.pow(2,this.zoom.level)/this.aspectRatio))):(this.aspectRatio=1,wilson.changeCanvasSize(this.resolution,this.resolution),useZoomLevel&&(wilson.worldWidth=3*Math.pow(2,this.zoom.level),wilson.worldHeight=3*Math.pow(2,this.zoom.level)))}),useZoomLevel&&this.zoom.clamp()}pan={parent:null,frame:0,minX:-1/0,maxX:1/0,minY:-1/0,maxY:1/0,velocityX:0,velocityY:0,nextVelocityX:0,nextVelocityY:0,velocityListLength:4,lastVelocitiesX:new Array(this.velocityListLength),lastVelocitiesY:new Array(this.velocityListLength),friction:.93,velocityStartThreshhold:.005,velocityStopThreshhold:5e-4,clamp:function(){this.parent.wilson.worldCenterX=Math.min(Math.max(this.parent.wilson.worldCenterX,this.minX+this.parent.wilson.worldWidth/2),this.maxX-this.parent.wilson.worldWidth/2),this.parent.wilson.worldCenterY=Math.min(Math.max(this.parent.wilson.worldCenterY,this.minY+this.parent.wilson.worldHeight/2),this.maxY-this.parent.wilson.worldHeight/2)},onGrabCanvas:function(){this.velocityX=0;for(let t=this.velocityY=0;t<this.velocityListLength;t++)this.lastVelocitiesX[t]=0,this.lastVelocitiesY[t]=0;this.frame=0},onDragCanvas:function(x,y,xDelta,yDelta){this.parent.wilson.worldCenterX-=xDelta,this.parent.wilson.worldCenterY-=yDelta,this.clamp(),this.nextVelocityX=-xDelta/this.parent.wilson.worldWidth,this.nextVelocityY=-yDelta/this.parent.wilson.worldHeight},onReleaseCanvas:function(){for(let t=0;t<this.velocityListLength;t++)Math.abs(this.lastVelocitiesX[t])>Math.abs(this.velocityX)&&(this.velocityX=this.lastVelocitiesX[t]),Math.abs(this.lastVelocitiesY[t])>Math.abs(this.velocityY)&&(this.velocityY=this.lastVelocitiesY[t]);if(this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStartThreshhold*this.velocityStartThreshhold){this.velocityX=0,this.velocityY=0,this.nextVelocityX=0;for(let t=this.nextVelocityY=0;t<this.velocityListLength;t++)this.lastVelocitiesX[t]=0,this.lastVelocitiesY[t]=0}},update:function(timeElapsed){this.lastVelocitiesX[this.frame]=this.nextVelocityX,this.lastVelocitiesY[this.frame]=this.nextVelocityY,this.frame=(this.frame+1)%this.velocityListLength,this.nextVelocityX=0,this.nextVelocityY=0,this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStopThreshhold*this.velocityStopThreshhold?(this.velocityX=0,this.velocityY=0):(this.parent.wilson.worldCenterX+=this.velocityX*this.parent.wilson.worldWidth*timeElapsed/6.944,this.parent.wilson.worldCenterY+=this.velocityY*this.parent.wilson.worldHeight*timeElapsed/6.944,this.clamp(),this.velocityX*=this.friction**(timeElapsed/6.944),this.velocityY*=this.friction**(timeElapsed/6.944)),this.parent?.wilson?.draggables?.recalculateLocations&&this.parent.wilson.draggables.recalculateLocations()}};zoom={parent:null,frame:0,pinchMultiplier:9,level:0,minLevel:-1/0,fixedPointX:0,fixedPointY:0,velocity:0,nextVelocity:0,velocityListLength:4,lastVelocities:new Array(this.velocityListLength),friction:.9,velocityStartThreshhold:.001,velocityStopThreshhold:.001,init:function(){this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)},clamp:function(){var t=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;this.parent.wilson.worldWidth>this.parent.pan.maxX-this.parent.pan.minX&&(this.parent.wilson.worldWidth=this.parent.pan.maxX-this.parent.pan.minX,this.parent.wilson.worldHeight=this.parent.wilson.worldWidth/t,this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)),this.parent.wilson.worldHeight>this.parent.pan.maxY-this.parent.pan.minY&&(this.parent.wilson.worldHeight=this.parent.pan.maxY-this.parent.pan.minY,this.parent.wilson.worldWidth=this.parent.wilson.worldHeight*t,this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)),this.level=Math.max(this.level,this.minLevel),this.parent.pan.clamp()},onGrabCanvas:function(){for(let t=this.velocity=0;t<this.velocityListLength;t++)this.lastVelocities[t]=0;this.frame=0},onWheelCanvas:function(x,y,scrollAmount){this.fixedPointX=x,this.fixedPointY=y,Math.abs(scrollAmount/100)<.3?(this.level+=scrollAmount/100,this.clamp()):this.velocity+=.085*Math.sign(scrollAmount),this.zoomCanvas()},onDragCanvas:function(x,y,xDelta,yDelta){this.parent.wilson.worldCenterX-=xDelta,this.parent.wilson.worldCenterY-=yDelta,this.nextVelocityX=-xDelta/this.parent.wilson.worldWidth,this.nextVelocityY=-yDelta/this.parent.wilson.worldHeight},onPinchCanvas:function(x,y,touchDistanceDelta){this.parent.wilson.worldWidth>=this.parent.wilson.worldHeight?(this.level-=touchDistanceDelta/this.parent.wilson.worldWidth*this.pinchMultiplier,this.clamp(),this.nextVelocity=-touchDistanceDelta/this.parent.wilson.worldWidth*this.pinchMultiplier):(this.level-=touchDistanceDelta/this.parent.wilson.worldHeight*this.pinchMultiplier,this.clamp(),this.nextVelocity=-touchDistanceDelta/this.parent.wilson.worldHeight*this.pinchMultiplier),this.fixedPointX=x,this.fixedPointY=y,this.zoomCanvas()},onReleaseCanvas:function(){for(let t=0;t<this.velocityListLength;t++)Math.abs(this.lastVelocities[t])>Math.abs(this.velocity)&&(this.velocity=this.lastVelocities[t]);if(Math.abs(this.velocity)<this.velocityStartThreshhold){this.velocity=0;for(let t=this.nextVelocity=0;t<this.velocityListLength;t++)this.lastVelocities[t]=0}},zoomCanvas:function(){var t,e=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;1<=e?(t=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level)*e,3*Math.pow(2,this.level)),this.parent.wilson.worldWidth=3*Math.pow(2,this.level)*e,this.parent.wilson.worldHeight=3*Math.pow(2,this.level),this.parent.wilson.worldCenterX=t[0],this.parent.wilson.worldCenterY=t[1]):(t=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level),3*Math.pow(2,this.level)/e),this.parent.wilson.worldWidth=3*Math.pow(2,this.level),this.parent.wilson.worldHeight=3*Math.pow(2,this.level)/e,this.parent.wilson.worldCenterX=t[0],this.parent.wilson.worldCenterY=t[1]),this.clamp()},update:function(timeElapsed){this.lastVelocities[this.frame]=this.nextVelocity,this.frame=(this.frame+1)%this.velocityListLength,this.nextVelocity=0,Math.abs(this.velocity)<this.velocityStopThreshhold?this.velocity=0:(this.level+=this.velocity*timeElapsed/6.944,this.zoomCanvas(),this.velocity*=this.friction**(timeElapsed/6.944)),this.parent?.wilson?.draggables?.recalculateLocations&&this.parent.wilson.draggables.recalculateLocations()}};static current=[];static parseNaturalGLSL(GLSL){let t=GLSL.replaceAll(/\s/g,"");for(;t.match(/([^.0-9])([0-9]+)([^.0-9])/g);)t=t.replaceAll(/([^.0-9])([0-9]+)([^.0-9])/g,(match,$1,$2,$3)=>""+$1+$2+".0"+$3);for(t=t.replaceAll(/([^0-9])(\.[0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9]\.)([^0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9)])([a-z(])/g,(match,$1,$2)=>$1+" * "+$2);t.match(/([xyz])([xyz])/g);)t=t.replaceAll(/([xyz])([xyz])/g,(match,$1,$2)=>$1+" * "+$2);return t=t.replaceAll(/([a-z0-9.]+)\^([a-z0-9.]+)/g,(match,$1,$2)=>`pow(${$1}, ${$2})`),console.log(t),t}static doubleToDf(d){var t=new Float32Array(2),e=536870913*d,e=e-(e-d),i=d-e;return t[0]=e,t[1]=i,[t[0],t[1]]}}class RaymarchApplet extends Applet{movingForwardKeyboard=!1;movingBackwardKeyboard=!1;movingRightKeyboard=!1;movingLeftKeyboard=!1;movingForwardTouch=!1;movingBackwardTouch=!1;wasMovingTouch=!1;movingSpeed=0;nextMoveVelocity=[0,0,0];moveVelocity=[0,0,0];moveFriction=.91;moveVelocityStopThreshhold=5e-4;distanceToScene=1;lastTimestamp=-1;theta=4.6601;phi=2.272;nextThetaVelocity=0;nextPhiVelocity=0;thetaVelocity=0;phiVelocity=0;panFriction=.88;panVelocityStartThreshhold=.005;panVelocityStopThreshhold=5e-4;imageSize=500;imageWidth=500;imageHeight=500;maxIterations=16;maxMarches=100;imagePlaneCenterPos=[];forwardVec=[];rightVec=[];upVec=[];cameraPos=[.0828,2.17,1.8925];focalLength=2;lightPos=[0,0,5];constructor(canvas){super(canvas)}calculateVectors(){this.forwardVec=[Math.cos(this.theta)*Math.sin(this.phi),Math.sin(this.theta)*Math.sin(this.phi),Math.cos(this.phi)],this.rightVec=RaymarchApplet.normalize([this.forwardVec[1],-this.forwardVec[0],0]),this.upVec=RaymarchApplet.crossProduct(this.rightVec,this.forwardVec),this.distanceToScene=this.distanceEstimator(this.cameraPos[0],this.cameraPos[1],this.cameraPos[2]),this.focalLength=this.distanceToScene/2,this.rightVec[0]*=this.focalLength/2,this.rightVec[1]*=this.focalLength/2,this.upVec[0]*=this.focalLength/2,this.upVec[1]*=this.focalLength/2,this.upVec[2]*=this.focalLength/2,this.imagePlaneCenterPos=[this.cameraPos[0]+this.focalLength*this.forwardVec[0],this.cameraPos[1]+this.focalLength*this.forwardVec[1],this.cameraPos[2]+this.focalLength*this.forwardVec[2]],this.wilson.gl.uniform3fv(this.wilson.uniforms.cameraPos,this.cameraPos),this.wilson.gl.uniform3fv(this.wilson.uniforms.imagePlaneCenterPos,this.imagePlaneCenterPos),this.wilson.gl.uniform3fv(this.wilson.uniforms.forwardVec,this.forwardVec),this.wilson.gl.uniform3fv(this.wilson.uniforms.rightVec,this.rightVec),this.wilson.gl.uniform3fv(this.wilson.uniforms.upVec,this.upVec),this.wilson.gl.uniform1f(this.wilson.uniforms.focalLength,this.focalLength)}handleKeydownEvent(e){"INPUT"===document.activeElement.tagName||"w"!==e.key&&"s"!==e.key&&"d"!==e.key&&"a"!==e.key||(this.nextMoveVelocity=[0,0,0],this.moveVelocity=[0,0,0],"w"===e.key?this.movingForwardKeyboard=!0:"s"===e.key&&(this.movingBackwardKeyboard=!0),"d"===e.key?this.movingRightKeyboard=!0:"a"===e.key&&(this.movingLeftKeyboard=!0))}handleKeyupEvent(e){"INPUT"===document.activeElement.tagName||"w"!==e.key&&"s"!==e.key&&"d"!==e.key&&"a"!==e.key||(0===this.moveVelocity[0]&&0===this.moveVelocity[1]&&0===this.moveVelocity[2]&&(this.moveVelocity[0]=this.nextMoveVelocity[0],this.moveVelocity[1]=this.nextMoveVelocity[1],this.moveVelocity[2]=this.nextMoveVelocity[2],this.nextMoveVelocity[0]=0,this.nextMoveVelocity[1]=0,this.nextMoveVelocity[2]=0),"w"===e.key?this.movingForwardKeyboard=!1:"s"===e.key&&(this.movingBackwardKeyboard=!1),"d"===e.key?this.movingRightKeyboard=!1:"a"===e.key&&(this.movingLeftKeyboard=!1))}updateCameraParameters(){this.movingSpeed=Math.min(Math.max(1e-6,this.distanceToScene/20),.02);var t=[...this.cameraPos];this.movingForwardKeyboard||this.movingForwardTouch?(this.cameraPos[0]+=this.movingSpeed*this.forwardVec[0],this.cameraPos[1]+=this.movingSpeed*this.forwardVec[1],this.cameraPos[2]+=this.movingSpeed*this.forwardVec[2]):(this.movingBackwardKeyboard||this.movingBackwardTouch)&&(this.cameraPos[0]-=this.movingSpeed*this.forwardVec[0],this.cameraPos[1]-=this.movingSpeed*this.forwardVec[1],this.cameraPos[2]-=this.movingSpeed*this.forwardVec[2]),this.movingRightKeyboard?(this.cameraPos[0]+=this.movingSpeed*this.rightVec[0]/this.focalLength,this.cameraPos[1]+=this.movingSpeed*this.rightVec[1]/this.focalLength,this.cameraPos[2]+=this.movingSpeed*this.rightVec[2]/this.focalLength):this.movingLeftKeyboard&&(this.cameraPos[0]-=this.movingSpeed*this.rightVec[0]/this.focalLength,this.cameraPos[1]-=this.movingSpeed*this.rightVec[1]/this.focalLength,this.cameraPos[2]-=this.movingSpeed*this.rightVec[2]/this.focalLength),this.nextMoveVelocity[0]=this.cameraPos[0]-t[0],this.nextMoveVelocity[1]=this.cameraPos[1]-t[1],this.nextMoveVelocity[2]=this.cameraPos[2]-t[2],this.calculateVectors()}static dotProduct(vec1,vec2){return vec1[0]*vec2[0]+vec1[1]*vec2[1]+vec1[2]*vec2[2]}static crossProduct(vec1,vec2){return[vec1[1]*vec2[2]-vec1[2]*vec2[1],vec1[2]*vec2[0]-vec1[0]*vec2[2],vec1[0]*vec2[1]-vec1[1]*vec2[0]]}static matMul(mat1,mat2){return[[mat1[0][0]*mat2[0][0]+mat1[0][1]*mat2[1][0]+mat1[0][2]*mat2[2][0],mat1[0][0]*mat2[0][1]+mat1[0][1]*mat2[1][1]+mat1[0][2]*mat2[2][1],mat1[0][0]*mat2[0][2]+mat1[0][1]*mat2[1][2]+mat1[0][2]*mat2[2][2]],[mat1[1][0]*mat2[0][0]+mat1[1][1]*mat2[1][0]+mat1[1][2]*mat2[2][0],mat1[1][0]*mat2[0][1]+mat1[1][1]*mat2[1][1]+mat1[1][2]*mat2[2][1],mat1[1][0]*mat2[0][2]+mat1[1][1]*mat2[1][2]+mat1[1][2]*mat2[2][2]],[mat1[2][0]*mat2[0][0]+mat1[2][1]*mat2[1][0]+mat1[2][2]*mat2[2][0],mat1[2][0]*mat2[0][1]+mat1[2][1]*mat2[1][1]+mat1[2][2]*mat2[2][1],mat1[2][0]*mat2[0][2]+mat1[2][1]*mat2[1][2]+mat1[2][2]*mat2[2][2]]]}static normalize(vec){var t=Math.sqrt(vec[0]*vec[0]+vec[1]*vec[1]+vec[2]*vec[2]);return[vec[0]/t,vec[1]/t,vec[2]/t]}}export{Applet,RaymarchApplet};