import{addHoverEventWithScale}from"./hover-events.min.mjs";import{$$,addTemporaryListener,pageElement}from"./main.min.mjs";import anime from"/scripts/anime.min.js";class Applet{canvas;wilson;workers=[];timeoutIds=[];animationPaused=!1;constructor(t){this.canvas=t,(this.pan.parent=this).zoom.parent=this,Applet.current.push(this)}pause(){this.animationPaused=!0}resume(){this.animationPaused=!1}destroy(){this.animationPaused=!0,this.workers.forEach(t=>{t?.terminate&&t?.terminate()}),this.timeoutIds.forEach(t=>{null!=t&&clearTimeout(t)}),this.hiddenCanvasContainer&&this.hiddenCanvasContainer.remove(),console.log("Destroyed an applet of type "+this.constructor.name)}listenToInputElements(t,i){t.forEach(t=>{t.addEventListener("keydown",t=>{"Enter"===t.key&&(t.preventDefault(),i())})})}uncapEverything=!1;setInputCaps(t,o){t.forEach((t,i)=>{const e=o[i];var s=t.nextElementSibling.innerHTML.split(" "),n=document.createElement("p");n.classList.add("body-text"),n.style.position="fixed",n.style.opacity=0,n.style.top="-100vh",n.style.width="fit-content",n.textContent="",pageElement.appendChild(n);let a=0;for(let t=0;t<s.length;t++)n.textContent=""+n.textContent+(t===a?"":" ")+s[t],100<=n.getBoundingClientRect().width&&(a=t,t--,n.textContent="");n.remove(),t.nextElementSibling.innerHTML=`<span>${s.slice(0,a).join(" ")}</span>${0!==a?" ":""}<span style="white-space: nowrap">${s.slice(a).join(" ")}<span class="triangle">&#x25BC;</span></span>`,t.addEventListener("input",()=>{parseFloat(t.value)>e&&!this.uncapEverything?(t.value=e,t.parentNode.classList.add("capped-input")):t.parentNode.classList.remove("capped-input")}),t.nextElementSibling.addEventListener("click",()=>{t.parentNode.classList.contains("capped-input")&&(this.hideCapDialogs(),this.showCapDialog(t))})});t=(t=>{t.target.classList.contains("keep-dialog-open")||this.hideCapDialogs()}).bind(this);addTemporaryListener({object:document.documentElement,event:"pointerdown",callback:t,log:!0})}showCapDialog(t){const i=document.createElement("div");i.classList.add("input-cap-dialog"),i.classList.add("keep-dialog-open"),i.style.opacity=0,i.style.transform="scale(1)",i.innerHTML=`Higher values than this may take an extremely long time to compute, cause substantial lag, or crash the tab or entire browser. Only continue if you know what you&#x2019;re doing!
		<div class="checkbox-row keep-dialog-open">
			<div class="checkbox-container click-on-child keep-dialog-open">
				<input type="checkbox" class="uncap-inputs-checkbox keep-dialog-open"/>
				<div class="checkbox keep-dialog-open"></div>
			</div>
			<div style="margin-left: 10px" class="keep-dialog-open">
				<p class="body-text checkbox-subtext keep-dialog-open">Uncap all inputs</p>
			</div>
		</div>`,pageElement.appendChild(i);var e=()=>this.updateCapDialogLocation(t,i);addTemporaryListener({object:window,event:"resize",callback:e}),e(),i.style.transform="scale(.95)",setTimeout(()=>{const t=i.querySelector(".uncap-inputs-checkbox");t.checked=this.uncapEverything,t.addEventListener("input",()=>{this.uncapEverything=t.checked,this.uncapEverything&&$$(".capped-input").forEach(t=>t.classList.remove("capped-input"))}),addHoverEventWithScale(t.parentNode,1.1),anime({targets:i,opacity:1,scale:1,duration:250,easing:"easeOutQuad"})},16)}hideCapDialogs(){const t=$$(".input-cap-dialog");t&&anime({targets:t,opacity:0,scale:.95,duration:250,easing:"easeOutQuad",complete:()=>{t.forEach(t=>t.remove())}})}updateCapDialogLocation(t,i){var t=t.nextElementSibling.getBoundingClientRect(),e=i.getBoundingClientRect();i.style.top=window.scrollY+t.top+t.height+4+"px",i.style.left=Math.min(Math.max(t.left-(e.width+12-t.width)/2,12),window.innerWidth-12-e.width)+"px"}pauseWhenOffscreen(){var t=()=>{var t=this.canvas.getBoundingClientRect(),i=t.top;-t.height<=i&&i<window.innerHeight?this.resume():this.pause()};addTemporaryListener({object:window,event:"scroll",callback:t}),t()}hiddenCanvasContainer=null;createHiddenCanvas(){var t=document.createElement("canvas");return t.classList.add("hidden-canvas"),null===this.hiddenCanvasContainer&&(this.hiddenCanvasContainer=document.createElement("div"),this.hiddenCanvasContainer.style.display="none",pageElement.appendChild(this.hiddenCanvasContainer)),this.hiddenCanvasContainer.appendChild(t),t}onGrabCanvas(){this.pan.onGrabCanvas(),this.zoom.onGrabCanvas()}onDragCanvas(t,i,e,s){this.pan.onDragCanvas(t,i,e,s)}onReleaseCanvas(){this.pan.onReleaseCanvas(),this.zoom.onReleaseCanvas()}onWheelCanvas(t,i,e){this.zoom.onWheelCanvas(t,i,e)}onPinchCanvas(t,i,e){this.zoom.onPinchCanvas(t,i,e)}changeAspectRatio(i=!1,t=[this.wilson]){t.forEach(t=>{t.fullscreen.currentlyFullscreen?(this.aspectRatio=window.innerWidth/window.innerHeight,1<=this.aspectRatio?(t.changeCanvasSize(this.resolution,Math.floor(this.resolution/this.aspectRatio)),i&&(t.worldWidth=3*Math.pow(2,this.zoom.level)*this.aspectRatio,t.worldHeight=3*Math.pow(2,this.zoom.level))):(t.changeCanvasSize(Math.floor(this.resolution*this.aspectRatio),this.resolution),i&&(t.worldWidth=3*Math.pow(2,this.zoom.level),t.worldHeight=3*Math.pow(2,this.zoom.level)/this.aspectRatio))):(this.aspectRatio=1,t.changeCanvasSize(this.resolution,this.resolution),i&&(t.worldWidth=3*Math.pow(2,this.zoom.level),t.worldHeight=3*Math.pow(2,this.zoom.level)))}),i&&this.zoom.clamp()}pan={parent:null,frame:0,minX:-1/0,maxX:1/0,minY:-1/0,maxY:1/0,velocityX:0,velocityY:0,nextVelocityX:0,nextVelocityY:0,velocityListLength:4,lastVelocitiesX:new Array(this.velocityListLength),lastVelocitiesY:new Array(this.velocityListLength),friction:.91,velocityStartThreshhold:.005,velocityStopThreshhold:5e-4,clamp:function(){this.parent.wilson.worldCenterX=Math.min(Math.max(this.parent.wilson.worldCenterX,this.minX+this.parent.wilson.worldWidth/2),this.maxX-this.parent.wilson.worldWidth/2),this.parent.wilson.worldCenterY=Math.min(Math.max(this.parent.wilson.worldCenterY,this.minY+this.parent.wilson.worldHeight/2),this.maxY-this.parent.wilson.worldHeight/2)},onGrabCanvas:function(){this.velocityX=0;for(let t=this.velocityY=0;t<this.velocityListLength;t++)this.lastVelocitiesX[t]=0,this.lastVelocitiesY[t]=0;this.frame=0},onDragCanvas:function(t,i,e,s){this.parent.wilson.worldCenterX-=e,this.parent.wilson.worldCenterY-=s,this.clamp(),this.nextVelocityX=-e/this.parent.wilson.worldWidth,this.nextVelocityY=-s/this.parent.wilson.worldHeight},onReleaseCanvas:function(){for(let t=0;t<this.velocityListLength;t++)Math.abs(this.lastVelocitiesX[t])>Math.abs(this.velocityX)&&(this.velocityX=this.lastVelocitiesX[t]),Math.abs(this.lastVelocitiesY[t])>Math.abs(this.velocityY)&&(this.velocityY=this.lastVelocitiesY[t]);if(this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStartThreshhold*this.velocityStartThreshhold){this.velocityX=0,this.velocityY=0,this.nextVelocityX=0;for(let t=this.nextVelocityY=0;t<this.velocityListLength;t++)this.lastVelocitiesX[t]=0,this.lastVelocitiesY[t]=0}},update:function(){this.lastVelocitiesX[this.frame]=this.nextVelocityX,this.lastVelocitiesY[this.frame]=this.nextVelocityY,this.frame=(this.frame+1)%this.velocityListLength,this.nextVelocityX=0,this.nextVelocityY=0,this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStopThreshhold*this.velocityStopThreshhold?(this.velocityX=0,this.velocityY=0):(this.parent.wilson.worldCenterX+=this.velocityX*this.parent.wilson.worldWidth,this.parent.wilson.worldCenterY+=this.velocityY*this.parent.wilson.worldHeight,this.clamp(),this.velocityX*=this.friction,this.velocityY*=this.friction),this.parent?.wilson?.draggables?.recalculateLocations&&this.parent.wilson.draggables.recalculateLocations()}};zoom={parent:null,frame:0,pinchMultiplier:9,level:0,minLevel:-1/0,fixedPointX:0,fixedPointY:0,velocity:0,nextVelocity:0,velocityListLength:4,lastVelocities:new Array(this.velocityListLength),friction:.88,velocityStartThreshhold:.001,velocityStopThreshhold:.001,init:function(){this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)},clamp:function(){var t=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;this.parent.wilson.worldWidth>this.parent.pan.maxX-this.parent.pan.minX&&(this.parent.wilson.worldWidth=this.parent.pan.maxX-this.parent.pan.minX,this.parent.wilson.worldHeight=this.parent.wilson.worldWidth/t,this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)),this.parent.wilson.worldHeight>this.parent.pan.maxY-this.parent.pan.minY&&(this.parent.wilson.worldHeight=this.parent.pan.maxY-this.parent.pan.minY,this.parent.wilson.worldWidth=this.parent.wilson.worldHeight*t,this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)),this.level=Math.max(this.level,this.minLevel),this.parent.pan.clamp()},onGrabCanvas:function(){for(let t=this.velocity=0;t<this.velocityListLength;t++)this.lastVelocities[t]=0;this.frame=0},onWheelCanvas:function(t,i,e){this.fixedPointX=t,this.fixedPointY=i,Math.abs(e/100)<.3?(this.level+=e/100,this.clamp()):this.velocity+=.085*Math.sign(e),this.zoomCanvas()},onDragCanvas:function(t,i,e,s){this.parent.wilson.worldCenterX-=e,this.parent.wilson.worldCenterY-=s,this.nextVelocityX=-e/this.parent.wilson.worldWidth,this.nextVelocityY=-s/this.parent.wilson.worldHeight},onPinchCanvas:function(t,i,e){this.parent.wilson.worldWidth>=this.parent.wilson.worldHeight?(this.level-=e/this.parent.wilson.worldWidth*this.pinchMultiplier,this.clamp(),this.nextVelocity=-e/this.parent.wilson.worldWidth*this.pinchMultiplier):(this.level-=e/this.parent.wilson.worldHeight*this.pinchMultiplier,this.clamp(),this.nextVelocity=-e/this.parent.wilson.worldHeight*this.pinchMultiplier),this.fixedPointX=t,this.fixedPointY=i,this.zoomCanvas()},onReleaseCanvas:function(){for(let t=0;t<this.velocityListLength;t++)Math.abs(this.lastVelocities[t])>Math.abs(this.velocity)&&(this.velocity=this.lastVelocities[t]);if(Math.abs(this.velocity)<this.velocityStartThreshhold){this.velocity=0;for(let t=this.nextVelocity=0;t<this.velocityListLength;t++)this.lastVelocities[t]=0}},zoomCanvas:function(){var t,i=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;1<=i?(t=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level)*i,3*Math.pow(2,this.level)),this.parent.wilson.worldWidth=3*Math.pow(2,this.level)*i,this.parent.wilson.worldHeight=3*Math.pow(2,this.level),this.parent.wilson.worldCenterX=t[0],this.parent.wilson.worldCenterY=t[1]):(t=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level),3*Math.pow(2,this.level)/i),this.parent.wilson.worldWidth=3*Math.pow(2,this.level),this.parent.wilson.worldHeight=3*Math.pow(2,this.level)/i,this.parent.wilson.worldCenterX=t[0],this.parent.wilson.worldCenterY=t[1]),this.clamp()},update:function(){this.lastVelocities[this.frame]=this.nextVelocity,this.frame=(this.frame+1)%this.velocityListLength,this.nextVelocity=0,Math.abs(this.velocity)<this.velocityStopThreshhold?this.velocity=0:(this.level+=this.velocity,this.zoomCanvas(),this.velocity*=this.friction),this.parent?.wilson?.draggables?.recalculateLocations&&this.parent.wilson.draggables.recalculateLocations()}};static current=[];static parseNaturalGLSL(t){let i=t.replaceAll(/\s/g,"");for(;i.match(/([^.0-9])([0-9]+)([^.0-9])/g);)i=i.replaceAll(/([^.0-9])([0-9]+)([^.0-9])/g,(t,i,e,s)=>""+i+e+".0"+s);for(i=i.replaceAll(/([^0-9])(\.[0-9])/g,(t,i,e)=>i+"0"+e).replaceAll(/([0-9]\.)([^0-9])/g,(t,i,e)=>i+"0"+e).replaceAll(/([0-9)])([a-z(])/g,(t,i,e)=>i+" * "+e);i.match(/([xyz])([xyz])/g);)i=i.replaceAll(/([xyz])([xyz])/g,(t,i,e)=>i+" * "+e);return i=i.replaceAll(/([a-z0-9.]+)\^([a-z0-9.]+)/g,(t,i,e)=>`pow(${i}, ${e})`),console.log(i),i}static doubleToDf(t){var i=new Float32Array(2),e=536870913*t,e=e-(e-t),t=t-e;return i[0]=e,i[1]=t,[i[0],i[1]]}}export{Applet};