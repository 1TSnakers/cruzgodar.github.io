import{addTemporaryListener,pageElement,pageUrl}from"../src/main.min.js";import loadMP4Module from"https://unpkg.com/mp4-wasm@1.0.6";const glslFunctions={cadd:["vec2","vec2","vec2"],csub:["vec2","vec2","vec2"],cmul:["vec2","vec2","vec2"],cdiv:["vec2","vec2","vec2"],cexp:["vec2","vec2"],csin:["vec2","vec2"],ccos:["vec2","vec2"]};class Applet{canvas;wilson;allowFullscreenWithKeyboard=!0;fpsDisplayCtx;workers=[];timeoutIds=[];keysPressed={};numTouches=0;needNewFrame=!1;aspectRatio=1;state={};defaultState={};constructor(canvas){this.canvas=canvas,(this.pan.parent=this).zoom.parent=this,window.DEBUG&&setTimeout(()=>this.addFpsDisplay(),500),addTemporaryListener({object:document.documentElement,event:"keydown",callback:e=>{"f"===e.key&&this.allowFullscreenWithKeyboard&&"INPUT"!==document.activeElement.tagName&&"TEXTAREA"!==document.activeElement.tagName&&this.wilson.fullscreen.switchFullscreen()}}),Applet.current.push(this)}destroy(){this.animationPaused=!0,this.workers.forEach(worker=>{worker?.terminate&&worker?.terminate()}),this.timeoutIds.forEach(timeoutId=>{null!=timeoutId&&clearTimeout(timeoutId)}),this.hiddenCanvasContainer&&this.hiddenCanvasContainer.remove();var t=new URLSearchParams(window.location.search);for(const i in this.state)t.delete(i);var e=t.toString(),e=(window.history.replaceState({url:pageUrl},document.title,pageUrl.replace(/\/home\//,"/")+(e?"?"+e:"")),["a","e","i","o","u","y"].includes(this.constructor.name[0].toLowerCase())?"n":"");console.log(`Destroyed a${e} ${this.constructor.name} applet`)}initState(){var t=new URLSearchParams(window.location.search);for(const e in this.defaultState)this.state[e]=t.get(e)}setState(key,value){this.state[key]=value;var t=new URLSearchParams(window.location.search),t=(t.set(key,value),t.toString());window.history.replaceState({url:pageUrl},"",pageUrl.replace(/\/home\//,"/")+(t?"?"+t:""))}runWhenOnscreen(data){let i=!1;var t=()=>{var t,e;i||(e=(t=this.canvas.getBoundingClientRect()).top,-t.height<=e&&e<window.innerHeight&&(i=!0,setTimeout(()=>this.run(data),250)))};addTemporaryListener({object:window,event:"scroll",callback:t}),t()}addFpsDisplay(){var t=document.createElement("canvas");t.classList.add("fps-canvas"),t.setAttribute("width","100"),t.setAttribute("height","100"),this.canvas.parentNode.insertBefore(t,this.canvas.nextElementSibling),this.fpsDisplayCtx=t.getContext("2d"),requestAnimationFrame(this.updateFpsDisplay.bind(this))}lastFpsDisplayTimestamp;fpsTimestampHistory=new Array(100);updateFpsDisplay(timestamp){var e=timestamp-this.lastFpsDisplayTimestamp;if(e&&this.lastFpsDisplayTimestamp){this.lastFpsDisplayTimestamp=timestamp,this.fpsTimestampHistory.push(e),this.fpsTimestampHistory.shift(),this.fpsDisplayCtx.clearRect(0,0,100,100);for(let t=0;t<100;t++){var i=this.fpsTimestampHistory[t],a=hsvToRgb(Math.max(.3333-(this.fpsTimestampHistory[t]-6)/50,0),1,1);this.fpsDisplayCtx.fillStyle=`rgb(${a[0]}, ${a[1]}, ${a[2]})`,this.fpsDisplayCtx.fillRect(t,100-i,1,i)}this.fpsDisplayCtx.fillStyle="rgb(127, 127, 127)",this.fpsDisplayCtx.fillRect(0,93.056,100,2),this.fpsDisplayCtx.fillRect(0,83.333,100,2),this.fpsDisplayCtx.fillRect(0,66.667,100,2)}else this.lastFpsDisplayTimestamp=timestamp;requestAnimationFrame(this.updateFpsDisplay.bind(this))}hiddenCanvasContainer;createHiddenCanvas(){var t=document.createElement("canvas");return t.classList.add("hidden-canvas"),this.hiddenCanvasContainer||(this.hiddenCanvasContainer=document.createElement("div"),this.hiddenCanvasContainer.style.display="none",pageElement.appendChild(this.hiddenCanvasContainer)),this.hiddenCanvasContainer.appendChild(t),t}onGrabCanvas(){this.pan.onGrabCanvas(),this.zoom.onGrabCanvas()}onDragCanvas(x,y,xDelta,yDelta){this.pan.onDragCanvas(x,y,xDelta,yDelta)}onReleaseCanvas(){this.pan.onReleaseCanvas(),this.zoom.onReleaseCanvas()}onWheelCanvas(x,y,scrollAmount){this.zoom.onWheelCanvas(x,y,scrollAmount)}onPinchCanvas(x,y,touchDistanceDelta){this.zoom.onPinchCanvas(x,y,touchDistanceDelta)}handleKeydownEvent(e){var t=e.key.toLowerCase();Object.prototype.hasOwnProperty.call(this.keysPressed,t)&&(e.preventDefault(),this.keysPressed[t]=!0)}handleKeyupEvent(e){var t=e.key.toLowerCase();Object.prototype.hasOwnProperty.call(this.keysPressed,t)&&(e.preventDefault(),this.keysPressed[t]=!1)}handleTouchStartEvent(e){this.numTouches=e.touches.length}handleTouchEndEvent(e){3<=this.numTouches&&2===e.touches.length?this.numTouches=1:this.numTouches=e.touches.length}listenForKeysPressed(keys){keys.forEach(key=>this.keysPressed[key]=!1),addTemporaryListener({object:document.documentElement,event:"keydown",callback:this.handleKeydownEvent.bind(this)}),addTemporaryListener({object:document.documentElement,event:"keyup",callback:this.handleKeyupEvent.bind(this)})}listenForNumTouches(){addTemporaryListener({object:this.canvas.parentNode.nextElementSibling,event:"touchstart",callback:this.handleTouchStartEvent.bind(this)}),addTemporaryListener({object:this.canvas.parentNode.nextElementSibling,event:"touchend",callback:this.handleTouchEndEvent.bind(this)})}changeAspectRatio(useZoomLevel=!1,wilsons=[this.wilson]){wilsons.forEach(wilson=>{wilson.fullscreen.currentlyFullscreen?(wilson.changeCanvasSize(...Applet.getEqualPixelFullScreen(this.resolution)),this.aspectRatio=window.innerWidth/window.innerHeight,1<=this.aspectRatio?useZoomLevel&&(wilson.worldWidth=3*Math.pow(2,this.zoom.level)*this.aspectRatio,wilson.worldHeight=3*Math.pow(2,this.zoom.level)):useZoomLevel&&(wilson.worldWidth=3*Math.pow(2,this.zoom.level),wilson.worldHeight=3*Math.pow(2,this.zoom.level)/this.aspectRatio)):(this.aspectRatio=1,wilson.changeCanvasSize(this.resolution,this.resolution),useZoomLevel&&(wilson.worldWidth=3*Math.pow(2,this.zoom.level),wilson.worldHeight=3*Math.pow(2,this.zoom.level)))}),useZoomLevel&&this.zoom.clamp(),this.needNewFrame=!0}makeVideo(time){var t=(()=>{const i=[];return new Promise(resolve=>{var t=this.canvas.captureStream(120);const e=new MediaRecorder(t,{mimeType:"video/mp4",videoBitsPerSecond:1/0});e.start(time||4e3),e.ondataavailable=function(event){i.push(event.data),"recording"===e.state&&e.stop()},e.onstop=function(){var t=new Blob(i,{type:"video/mp4"}),t=URL.createObjectURL(t);resolve(t)}})})();const e=document.createElement("video"),i=(pageElement.appendChild(e),t.then(url=>e.setAttribute("src",url)),document.createElement("a"));i.setAttribute("download","recordingVideo"),t.then(url=>{i.setAttribute("href",url),i.click()})}pan={parent:null,frame:0,minX:-1/0,maxX:1/0,minY:-1/0,maxY:1/0,velocityX:0,velocityY:0,nextVelocityX:0,nextVelocityY:0,velocityListLength:4,lastVelocitiesX:new Array(this.velocityListLength),lastVelocitiesY:new Array(this.velocityListLength),friction:.93,velocityStartThreshhold:.005,velocityStopThreshhold:5e-4,setBounds({minX,maxX,minY,maxY}){this.minX=minX,this.maxX=maxX,this.minY=minY,this.maxY=maxY,this.parent.zoom.maxLevel=Math.log2(Math.min(this.maxX-this.minX,this.maxY-this.minY)/3),this.parent.zoom.clamp()},clamp(){var t,e;this.parent.wilson.worldWidth>this.maxX-this.minX?this.parent.wilson.worldCenterX=(this.maxX+this.minX)/2:(t=this.minX+this.parent.wilson.worldWidth/2,e=this.maxX-this.parent.wilson.worldWidth/2,this.parent.wilson.worldCenterX=Math.min(Math.max(this.parent.wilson.worldCenterX,t),e)),this.parent.wilson.worldHeight>this.maxY-this.minY?this.parent.wilson.worldCenterY=(this.maxY+this.minY)/2:(t=this.minY+this.parent.wilson.worldHeight/2,e=this.maxY-this.parent.wilson.worldHeight/2,this.parent.wilson.worldCenterY=Math.min(Math.max(this.parent.wilson.worldCenterY,t),e))},onGrabCanvas(){this.velocityX=0;for(let t=this.velocityY=0;t<this.velocityListLength;t++)this.lastVelocitiesX[t]=0,this.lastVelocitiesY[t]=0;this.frame=0},onDragCanvas(x,y,xDelta,yDelta){this.parent.wilson.worldCenterX-=xDelta,this.parent.wilson.worldCenterY-=yDelta,this.parent.needNewFrame=!0,this.clamp(),this.nextVelocityX=-xDelta/this.parent.wilson.worldWidth,this.nextVelocityY=-yDelta/this.parent.wilson.worldHeight},onReleaseCanvas(){for(let t=0;t<this.velocityListLength;t++)Math.abs(this.lastVelocitiesX[t])>Math.abs(this.velocityX)&&(this.velocityX=this.lastVelocitiesX[t]),Math.abs(this.lastVelocitiesY[t])>Math.abs(this.velocityY)&&(this.velocityY=this.lastVelocitiesY[t]);if(this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStartThreshhold*this.velocityStartThreshhold){this.velocityX=0,this.velocityY=0,this.nextVelocityX=0;for(let t=this.nextVelocityY=0;t<this.velocityListLength;t++)this.lastVelocitiesX[t]=0,this.lastVelocitiesY[t]=0}},update(timeElapsed){this.lastVelocitiesX[this.frame]=this.nextVelocityX,this.lastVelocitiesY[this.frame]=this.nextVelocityY,this.frame=(this.frame+1)%this.velocityListLength,this.nextVelocityX=0,this.nextVelocityY=0,this.velocityX*this.velocityX+this.velocityY*this.velocityY<this.velocityStopThreshhold*this.velocityStopThreshhold?(this.velocityX=0,this.velocityY=0):(this.parent.needNewFrame=!0,this.parent.wilson.worldCenterX+=this.velocityX*this.parent.wilson.worldWidth*timeElapsed/6.944,this.parent.wilson.worldCenterY+=this.velocityY*this.parent.wilson.worldHeight*timeElapsed/6.944,this.clamp(),this.velocityX*=this.friction**(timeElapsed/6.944),this.velocityY*=this.friction**(timeElapsed/6.944)),this.parent?.wilson?.draggables?.recalculateLocations&&this.parent.wilson.draggables.recalculateLocations()}};zoom={parent:null,frame:0,pinchMultiplier:9,level:0,maxLevel:1/0,minLevel:-1/0,fixedPointX:0,fixedPointY:0,velocity:0,nextVelocity:0,velocityListLength:4,lastVelocities:new Array(this.velocityListLength),friction:.9,velocityStartThreshhold:.001,velocityStopThreshhold:.001,init(){this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)},clamp(){var t=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight,e=this.parent.pan.maxX-this.parent.pan.minX,i=this.parent.pan.maxY-this.parent.pan.minY;this.parent.wilson.worldWidth>e&&this.parent.wilson.worldHeight>i&&(1<=t?(this.parent.wilson.worldWidth=e,this.parent.wilson.worldHeight=this.parent.wilson.worldWidth/t):(this.parent.wilson.worldHeight=i,this.parent.wilson.worldWidth=this.parent.wilson.worldHeight*t),this.level=Math.log2(Math.min(this.parent.wilson.worldWidth,this.parent.wilson.worldHeight)/3)),this.level=Math.min(Math.max(this.level,this.minLevel),this.maxLevel),this.parent.pan.clamp()},onGrabCanvas(){for(let t=this.velocity=0;t<this.velocityListLength;t++)this.lastVelocities[t]=0;this.frame=0},onWheelCanvas(x,y,scrollAmount){this.parent.needNewFrame=!0,this.fixedPointX=x,this.fixedPointY=y,Math.abs(scrollAmount/100)<.3?this.level+=scrollAmount/100:this.velocity+=.085*Math.sign(scrollAmount),this.zoomCanvas()},onPinchCanvas(x,y,touchDistanceDelta){this.parent.needNewFrame=!0,this.parent.wilson.worldWidth>=this.parent.wilson.worldHeight?(this.level-=touchDistanceDelta/this.parent.wilson.worldWidth*this.pinchMultiplier,this.nextVelocity=-touchDistanceDelta/this.parent.wilson.worldWidth*this.pinchMultiplier):(this.level-=touchDistanceDelta/this.parent.wilson.worldHeight*this.pinchMultiplier,this.nextVelocity=-touchDistanceDelta/this.parent.wilson.worldHeight*this.pinchMultiplier),this.fixedPointX=x,this.fixedPointY=y,this.zoomCanvas()},onReleaseCanvas(){for(let t=0;t<this.velocityListLength;t++)Math.abs(this.lastVelocities[t])>Math.abs(this.velocity)&&(this.velocity=this.lastVelocities[t]);if(Math.abs(this.velocity)<this.velocityStartThreshhold){this.velocity=0;for(let t=this.nextVelocity=0;t<this.velocityListLength;t++)this.lastVelocities[t]=0}},zoomCanvas(){this.clamp();var t,e=this.parent.wilson.worldWidth/this.parent.wilson.worldHeight;1<=e?(t=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level)*e,3*Math.pow(2,this.level)),this.parent.wilson.worldWidth=3*Math.pow(2,this.level)*e,this.parent.wilson.worldHeight=3*Math.pow(2,this.level),this.parent.wilson.worldCenterX=t[0],this.parent.wilson.worldCenterY=t[1]):(t=this.parent.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,3*Math.pow(2,this.level),3*Math.pow(2,this.level)/e),this.parent.wilson.worldWidth=3*Math.pow(2,this.level),this.parent.wilson.worldHeight=3*Math.pow(2,this.level)/e,this.parent.wilson.worldCenterX=t[0],this.parent.wilson.worldCenterY=t[1])},update(timeElapsed){this.lastVelocities[this.frame]=this.nextVelocity,this.frame=(this.frame+1)%this.velocityListLength,this.nextVelocity=0,Math.abs(this.velocity)<this.velocityStopThreshhold?this.velocity=0:(this.level+=this.velocity*timeElapsed/6.944,this.zoomCanvas(),this.velocity*=this.friction**(timeElapsed/6.944),this.parent.needNewFrame=!0),this.parent?.wilson?.draggables?.recalculateLocations&&this.parent.wilson.draggables.recalculateLocations()}};async createVideo({perFrameCallback,totalFrames,fps}){const o=(await loadMP4Module()).createWebCodecsEncoder({width:this.wilson.canvasWidth,height:this.wilson.canvasHeight,fps:fps,bitrate:5e7});let r=0;async function h(){var t,e,i,a,s,n,l;r<totalFrames?(console.log(`Encoding frame ${r+1} of `+totalFrames),perFrameCallback(r),t=await createImageBitmap(this.canvas),await o.addFrame(t),r++,requestAnimationFrame(h.bind(this))):(t=await o.end(),e=this.wilson.canvasWidth,i=this.wilson.canvasHeight,a=URL.createObjectURL(new Blob([t],{type:"video/mp4"})),(s=document.createElement("video")).setAttribute("muted","muted"),s.setAttribute("autoplay","autoplay"),s.setAttribute("controls","controls"),n=Math.min(e,window.innerWidth,window.innerHeight),l=e/i,n*=.75,s.style.width=n+"px",s.style.height=n/l+"px",pageElement.appendChild(s),s.src=a,n=document.createElement("div"),l=document.createElement("a"),n.appendChild(l),l.href=a,l.id="download",l.textContent="Click here to download MP4 file...",l.download="download.mp4",pageElement.appendChild(n))}requestAnimationFrame(h.bind(this))}static current=[];static listenToInputElements(elements,run){elements.forEach(element=>{element.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),run())})})}static parseNaturalGlsl(glsl){let t=glsl.replaceAll(/\s/g,"");for(;t.match(/([^.0-9])([0-9]+)([^.0-9])/g);)t=t.replaceAll(/([^.0-9])([0-9]+)([^.0-9])/g,(match,$1,$2,$3)=>""+$1+$2+".0"+$3);for(t=t.replaceAll(/([^0-9])(\.[0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9]\.)([^0-9])/g,(match,$1,$2)=>$1+"0"+$2).replaceAll(/([0-9)])([a-z(])/g,(match,$1,$2)=>$1+" * "+$2);t.match(/([xyz])([xyz])/g);)t=t.replaceAll(/([xyz])([xyz])/g,(match,$1,$2)=>$1+" * "+$2);return t=t.replaceAll(/([a-z0-9.]+)\^([a-z0-9.]+)/g,(match,$1,$2)=>`pow(${$1}, ${$2})`),window.DEBUG&&console.log(t),t}static getRandomGlsl({depth=0,maxDepth,variables=[],returnType="vec2"}){var t;return(maxDepth=maxDepth||Math.floor(3*Math.random())+2)<=depth?Math.random()<.8?variables[Math.floor(Math.random()*variables.length)]:`vec2(${Math.random()<.99?variables[Math.floor(Math.random()*variables.length)]+"."+(Math.random()<.5?"x":"y"):""+Math.round(100*Math.random())/100}, ${Math.random()<.99?variables[Math.floor(Math.random()*variables.length)]+"."+(Math.random()<.5?"x":"y"):""+Math.round(100*Math.random())/100})`:`${t=(t=Object.keys(glslFunctions).filter(key=>glslFunctions[key][0]===returnType))[Math.floor(Math.random()*t.length)]}(${glslFunctions[t].slice(1).map(type=>Applet.getRandomGlsl({depth:depth+1,maxDepth:maxDepth,variables:variables,returnType:type})).join(",")})`}static doubleToDf(d){var t=new Float32Array(2),e=536870913*d,e=e-(e-d),i=d-e;return t[0]=e,t[1]=i,[t[0],t[1]]}static hexToRgb(hex){var t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}static componentToHex(c){var t=Math.floor(c).toString(16);return 1==t.length?"0"+t:t}static rgbToHex(r,g,b){return"#"+Applet.componentToHex(r)+Applet.componentToHex(g)+Applet.componentToHex(b)}static getEqualPixelFullScreen(resolution){var t=Math.sqrt(window.innerWidth/window.innerHeight);return[Math.round(resolution*t),Math.round(resolution/t)]}}function hsvToRgb(h,s,v){function t(n){var t=(n+6*h)%6;return v-v*s*Math.max(0,Math.min(t,Math.min(4-t,1)))}return[255*t(5),255*t(3),255*t(1)]}function getMinGlslString(varName,numVars,functionName="min"){var t=Math.ceil(Math.log2(numVars));let e=new Array(numVars);for(let a=0;a<numVars;a++)e[a]=""+varName+(a+1);for(let s=0;s<t;s++){var i=new Array(Math.ceil(e.length/2));for(let t=0;t<e.length;t+=2)i[t/2]=`${functionName}(${e[t]}, ${e[t+1]})`;e.length%2==1&&(i[i.length-1]=e[e.length-1]),e=i}return e[0]}function getMaxGlslString(varName,numVars){return getMinGlslString(varName,numVars,"max")}function getColorGlslString(varName,minVarName,colors){let t="";for(let e=0;e<colors.length;e++)t+=`if (${minVarName} == ${varName}${e+1}) { return vec3(${colors[e][0]/255}, ${colors[e][1]/255}, ${colors[e][2]/255}); }
		`;return t}function getFloatGlsl(float){return"string"==typeof float||float!==Math.floor(float)?float:`float(${float})`}function getVectorGlsl(vector){return 2===vector.length?`vec2(${vector[0]}, ${vector[1]})`:3===vector.length?`vec3(${vector[0]}, ${vector[1]}, ${vector[2]})`:4===vector.length?`vec4(${vector[0]}, ${vector[1]}, ${vector[2]}, ${vector[3]})`:(console.error("Invalid vector length!"),"")}function getMatrixGlsl(matrix){return 2===matrix.length?`mat2(
			${matrix[0][0]}, ${matrix[1][0]},
			${matrix[0][1]}, ${matrix[1][1]}
		)`:3===matrix.length?`mat3(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}
		)`:4===matrix.length?`mat4(
			${matrix[0][0]}, ${matrix[1][0]}, ${matrix[2][0]}, ${matrix[3][0]},
			${matrix[0][1]}, ${matrix[1][1]}, ${matrix[2][1]}, ${matrix[3][1]},
			${matrix[0][2]}, ${matrix[1][2]}, ${matrix[2][2]}, ${matrix[3][2]},
			${matrix[0][3]}, ${matrix[1][3]}, ${matrix[2][3]}, ${matrix[3][3]}
		)`:(console.error("Invalid matrix shape!"),"")}export{Applet,getMinGlslString,getMaxGlslString,getColorGlslString,getFloatGlsl,getVectorGlsl,getMatrixGlsl};