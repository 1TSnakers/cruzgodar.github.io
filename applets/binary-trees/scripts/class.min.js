class BinaryTree extends Applet{root=[];branchPoints=[];numPreviewIterations=5;webWorker=null;constructor(a){super(a);const d={renderer:"cpu",canvasWidth:2E3,canvasHeight:2E3,useDraggables:!0,draggablesMousedownCallback:this.onGrabDraggable.bind(this),draggablesTouchstartCallback:this.onGrabDraggable.bind(this),draggablesMousemoveCallback:this.onDragDraggable.bind(this),draggablesTouchmoveCallback:this.onDragDraggable.bind(this),draggablesMouseupCallback:this.onReleaseDraggable.bind(this),draggablesTouchendCallback:this.onReleaseDraggable.bind(this),
useFullscreen:!0,trueFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",switchFullscreenCallback:()=>this.changeAspectRatio()};this.wilson=new Wilson(a,d);this.wilson.ctx.fillStyle="rgb(0, 0, 0)";this.wilson.ctx.fillRect(0,0,this.wilson.canvasWidth,this.wilson.canvasHeight);this.initBranchMarkers()}preview(a,d){this.root=a;this.branchPoints=d;this.wilson.ctx.fillStyle=
"rgb(0, 0, 0)";this.wilson.ctx.fillRect(0,0,this.wilson.canvasWidth,this.wilson.canvasHeight);a=[Math.atan2(this.branchPoints[0][0]-this.root[0],this.branchPoints[0][1]-this.root[1]),Math.atan2(this.branchPoints[1][0]-this.root[0],this.branchPoints[1][1]-this.root[1])];d=(a[0]-a[1])/2;let b=[Math.sqrt((this.branchPoints[0][0]-this.root[0])*(this.branchPoints[0][0]-this.root[0])+(this.branchPoints[0][1]-this.root[1])*(this.branchPoints[0][1]-this.root[1])),Math.sqrt((this.branchPoints[1][0]-this.root[0])*
(this.branchPoints[1][0]-this.root[0])+(this.branchPoints[1][1]-this.root[1])*(this.branchPoints[1][1]-this.root[1]))],g=[this.root],e=1;for(let f=0;f<this.numPreviewIterations;f++){let h=[],k=[];this.wilson.ctx.lineWidth=20*e+1;this.wilson.ctx.strokeStyle=`rgb(${139*Math.sqrt(e)}, ${69*Math.sqrt(e)+128*(1-Math.sqrt(e))}, ${19*Math.sqrt(e)})`;for(let c=0;c<g.length;c++){let n=g[c][1],p=g[c][0],l=g[c][1]+b[0]*e*Math.cos(a[2*c]),m=g[c][0]+b[0]*e*Math.sin(a[2*c]);this.wilson.ctx.beginPath();this.wilson.ctx.moveTo(n,
p);this.wilson.ctx.lineTo(l,m);this.wilson.ctx.stroke();h.push([m,l]);k.push(a[2*c]-d);k.push(a[2*c]+d);n=g[c][1];p=g[c][0];l=g[c][1]+b[1]*e*Math.cos(a[2*c+1]);m=g[c][0]+b[1]*e*Math.sin(a[2*c+1]);this.wilson.ctx.beginPath();this.wilson.ctx.moveTo(n,p);this.wilson.ctx.lineTo(l,m);this.wilson.ctx.stroke();h.push([m,l]);k.push(a[2*c+1]-d);k.push(a[2*c+1]+d)}g=h;a=k;e*=.675}}animate(a,d){this.root=a;this.branchPoints=d;try{this.webWorker.terminate()}catch(b){}this.webWorker=new Worker(`/applets/binary-trees/scripts/worker.${DEBUG?
"":"min."}js`);this.workers.push(this.webWorker);this.webWorker.onmessage=b=>{"done"===b.data[0]?(b=setTimeout(()=>{Page.setElementStyles(".wilson-draggable","opacity",1)},500),this.timeoutIds.push(b)):(this.wilson.ctx.strokeStyle=b.data[4],this.wilson.ctx.lineWidth=b.data[5],this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(b.data[0],b.data[1]),this.wilson.ctx.lineTo(b.data[2],b.data[3]),this.wilson.ctx.stroke())};this.webWorker.postMessage([this.root,this.branchPoints])}initBranchMarkers(){this.wilson.draggables.add(-1/
7,-1/3);this.wilson.draggables.add(1/7,-1/3);this.root=this.wilson.utils.interpolate.worldToCanvas(0,-.8);this.branchPoints[0]=this.wilson.utils.interpolate.worldToCanvas(-1/7,-1/3);this.branchPoints[1]=this.wilson.utils.interpolate.worldToCanvas(1/7,-1/3);this.preview(this.root,this.branchPoints)}onGrabDraggable(a,d,b,g){try{this.webWorker.terminate()}catch(e){}Page.setElementStyles(".wilson-draggable","opacity",1);this.wilson.ctx.fillStyle="rgb(0, 0, 0)";this.wilson.ctx.fillRect(0,0,this.wilson.canvasWidth,
this.wilson.canvasHeight);this.preview(this.root,this.branchPoints)}onDragDraggable(a,d,b,g){this.branchPoints[a]=this.wilson.utils.interpolate.worldToCanvas(d,b);this.preview(this.root,this.branchPoints)}onReleaseDraggable(a,d,b,g){document.body.style.WebkitUserSelect="";Page.setElementStyles(".wilson-draggable","opacity",0);let e=0;const f=this,h=setInterval(()=>{f.wilson.ctx.fillStyle=`rgba(0, 0, 0, ${e/37})`;f.wilson.ctx.fillRect(0,0,f.wilson.canvasWidth,f.wilson.canvasHeight);e++},8);this.refreshIds.push(h);
a=setTimeout(()=>{clearInterval(h);f.wilson.ctx.fillStyle="rgb(0, 0, 0)";f.wilson.ctx.fillRect(0,0,f.wilson.canvasWidth,f.wilson.canvasHeight);f.animate(f.root,f.branchPoints)},Site.opacityAnimationTime);this.timeoutIds.push(a)}changeAspectRatio(){try{this.webWorker.terminate()}catch(a){}Page.setElementStyles(".wilson-draggable","opacity",1);this.wilson.fullscreen.currentlyFullscreen?1<=Page.Layout.aspectRatio?this.wilson.changeCanvasSize(2E3,2E3/Page.Layout.aspectRatio):this.wilson.changeCanvasSize(2E3*
Page.Layout.aspectRatio,2E3):this.wilson.changeCanvasSize(2E3,2E3);this.wilson.draggables.recalculateLocations();this.root=this.wilson.utils.interpolate.worldToCanvas(0,-.8);this.branchPoints[0]=this.wilson.utils.interpolate.worldToCanvas(...this.wilson.draggables.worldCoordinates[0]);this.branchPoints[1]=this.wilson.utils.interpolate.worldToCanvas(...this.wilson.draggables.worldCoordinates[1]);this.preview(this.root,this.branchPoints)}};
