"use strict";class ComplexMap extends Applet{load_promise=null;generating_code="";uniform_code="";aspect_ratio=1;zoom_level=-.585;past_brightness_scales=[];resolution=500;black_point=1;white_point=1;fixed_point_x=0;fixed_point_y=0;draggable_callback=null;next_pan_velocity_x=0;next_pan_velocity_y=0;next_zoom_velocity=0;pan_velocity_x=0;pan_velocity_y=0;zoom_velocity=0;pan_friction=.96;pan_velocity_start_threshhold=.0025;pan_velocity_stop_threshhold=25e-5;zoom_friction=.93;zoom_velocity_start_threshhold=.01;zoom_velocity_stop_threshhold=.001;last_timestamp=-1;add_indicator_draggable=!1;use_selector_mode=!1;total_benchmark_time=0;benchmarks_left=0;benchmark_cycles=10;benchmark_resolution=4e3;constructor(i,t,o="",e=0,s=0,l=-.585,n=!1,a=null,h=!1){super(i);let r={renderer:"gpu",shader:"precision highp float; varying vec2 uv; void main(void) { gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0); }",canvas_width:this.resolution,canvas_height:this.resolution,use_draggables:!0,draggables_mousemove_callback:this.on_drag_draggable.bind(this),draggables_touchmove_callback:this.on_drag_draggable.bind(this),use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png",switch_fullscreen_callback:this.change_aspect_ratio.bind(this),mousedown_callback:this.on_grab_canvas.bind(this),touchstart_callback:this.on_grab_canvas.bind(this),mousedrag_callback:this.on_drag_canvas.bind(this),touchmove_callback:this.on_drag_canvas.bind(this),mouseup_callback:this.on_release_canvas.bind(this),touchend_callback:this.on_release_canvas.bind(this),wheel_callback:this.on_wheel_canvas.bind(this),pinch_callback:this.on_pinch_canvas.bind(this)};this.wilson=new Wilson(i,r);let c=this.change_aspect_ratio.bind(this);window.addEventListener("resize",c),this.handlers.push([window,"resize",c]),this.load_promise=new Promise(async(i,r)=>{await Site.load_glsl(),this.run(t,o,e,s,l,n,a,h),i()})}run(i,t="",o=0,e=0,s=-.585,l=!1,n=null,a=!1){this.generating_code=i,this.uniform_code=t,this.zoom_level=s,this.wilson.world_width=3*Math.pow(2,this.zoom_level),this.wilson.world_height=this.wilson.world_width,this.wilson.world_center_x=o,this.wilson.world_center_y=e,this.add_indicator_draggable=l,this.draggable_callback=n;let h="";a&&(h=`
    image_z.x += 127.0;
    image_z.y += 127.0;
    
    float whole_1 = floor(image_z.x);
    float whole_2 = floor(image_z.y);
    
    float fract_1 = (image_z.x - whole_1);
    float fract_2 = (image_z.y - whole_2);
    
    gl_FragColor = vec4(whole_1 / 256.0, fract_1, whole_2 / 256.0, fract_2);
    
    return;
   `);let r=`
   precision highp float;
   
   varying vec2 uv;
   
   uniform float aspect_ratio;
   
   uniform float world_center_x;
   uniform float world_center_y;
   uniform float world_size;
   
   uniform float black_point;
   uniform float white_point;
   
   uniform vec2 draggable_arg;
   
   ${t}
   
   
   
   ${Site.get_glsl_bundle(i)}
   
   
   
   vec3 hsv2rgb(vec3 c)
   {
    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
   }
   
   
   
   //Returns f(z) for a polynomial f with given roots.
   vec2 f(vec2 z)
   {
    return ${i};
   }
   
   
   
   void main(void)
   {
    vec2 z;
    
    if (aspect_ratio >= 1.0)
    {
     z = vec2(uv.x * aspect_ratio * world_size + world_center_x, uv.y * world_size + world_center_y);
    }
    
    else
    {
     z = vec2(uv.x * world_size + world_center_x, uv.y / aspect_ratio * world_size + world_center_y);
    }
    
    
    
    vec2 image_z = f(z);
    
    
    
    ${h}
    
    
    
    float modulus = length(image_z);
    
    float h = atan(image_z.y, image_z.x) / 6.283;
    float s = clamp(1.0 / (1.0 + .01 * (modulus / white_point / white_point)), 0.0, 1.0);
    float v = clamp(1.0 / (1.0 + .01 / (modulus * black_point * black_point)), 0.0, 1.0);
    
    gl_FragColor = vec4(hsv2rgb(vec3(h, s, v)), 1.0);
   }
  `;this.wilson.render.shader_programs=[],this.wilson.render.load_new_shader(r),this.wilson.gl.useProgram(this.wilson.render.shader_programs[0]),this.wilson.render.init_uniforms(["aspect_ratio","world_center_x","world_center_y","world_size","black_point","white_point","draggable_arg"]),this.wilson.gl.uniform1f(this.wilson.uniforms.aspect_ratio,1),this.next_pan_velocity_x=0,this.next_pan_velocity_y=0,this.next_zoom_velocity=0,this.pan_velocity_x=0,this.pan_velocity_y=0,this.zoom_velocity=0;let c=l||-1!==i.indexOf("draggable_arg");c&&0===this.wilson.draggables.num_draggables?(this.wilson.draggables.add(.5,.5,!l),this.wilson.gl.uniform2f(this.wilson.uniforms.draggable_arg,.5,.5)):c||0===this.wilson.draggables.num_draggables||(this.wilson.draggables.num_draggables--,this.wilson.draggables.draggables[0].remove(),this.wilson.draggables=[]),window.requestAnimationFrame(this.draw_frame.bind(this))}on_grab_canvas(i,t,o){if(this.pan_velocity_x=0,this.pan_velocity_y=0,this.zoom_velocity=0,this.next_pan_velocity_x=0,this.next_pan_velocity_y=0,this.next_zoom_velocity=0,this.use_selector_mode){this.run(this.generating_code,this.uniform_code,this.wilson.world_center_x,this.wilson.world_center_y,this.zoom_level,this.force_add_draggable,!0);let e=setTimeout(()=>{this.wilson.render.draw_frame();let o=this.wilson.utils.interpolate.world_to_canvas(i,t),e=new Uint8Array(4);this.wilson.gl.readPixels(o[1],this.wilson.canvas_height-o[0],1,1,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,e);let s=e[0]-127+e[1]/256,l=e[2]-127+e[3]/256,n="+";t<0&&(n="-");let a="+";l<0&&(a="-"),console.log(`${i} ${n} ${Math.abs(t)}i |---> ${s} ${a} ${Math.abs(l)}i`),this.run(this.generating_code,this.uniform_code,this.wilson.world_center_x,this.wilson.world_center_y,this.zoom_level,this.force_add_draggable,!1),this.use_selector_mode=!1},20);this.timeout_ids.push(e)}}on_drag_canvas(i,t,o,e,s){this.wilson.world_center_x-=o,this.wilson.world_center_y-=e,this.next_pan_velocity_x=-o/this.wilson.world_width,this.next_pan_velocity_y=-e/this.wilson.world_height;try{this.wilson.draggables.recalculate_locations()}catch(l){}window.requestAnimationFrame(this.draw_frame.bind(this))}on_release_canvas(i,t,o){Math.sqrt(this.next_pan_velocity_x*this.next_pan_velocity_x+this.next_pan_velocity_y*this.next_pan_velocity_y)>=this.pan_velocity_start_threshhold&&(this.pan_velocity_x=this.next_pan_velocity_x,this.pan_velocity_y=this.next_pan_velocity_y),Math.abs(this.next_zoom_velocity)>=this.zoom_velocity_start_threshhold&&(this.zoom_velocity=this.next_zoom_velocity),window.requestAnimationFrame(this.draw_frame.bind(this))}on_wheel_canvas(i,t,o,e){this.fixed_point_x=i,this.fixed_point_y=t,.3>Math.abs(o/100)?this.zoom_level+=o/100:this.zoom_velocity+=.05*Math.sign(o),this.zoom_canvas()}on_pinch_canvas(i,t,o,e){this.aspect_ratio>=1?(this.zoom_level-=o/this.wilson.world_width*10,this.next_zoom_velocity=-o/this.wilson.world_width*10):(this.zoom_level-=o/this.wilson.world_height*10,this.next_zoom_velocity=-o/this.wilson.world_height*10),this.fixed_point_x=i,this.fixed_point_y=t,this.zoom_canvas()}zoom_canvas(){if(this.aspect_ratio>=1){let i=this.wilson.input.get_zoomed_world_center(this.fixed_point_x,this.fixed_point_y,3*Math.pow(2,this.zoom_level)*this.aspect_ratio,3*Math.pow(2,this.zoom_level));this.wilson.world_width=3*Math.pow(2,this.zoom_level)*this.aspect_ratio,this.wilson.world_height=3*Math.pow(2,this.zoom_level),this.wilson.world_center_x=i[0],this.wilson.world_center_y=i[1]}else{let t=this.wilson.input.get_zoomed_world_center(this.fixed_point_x,this.fixed_point_y,3*Math.pow(2,this.zoom_level),3*Math.pow(2,this.zoom_level)/this.aspect_ratio);this.wilson.world_width=3*Math.pow(2,this.zoom_level),this.wilson.world_height=3*Math.pow(2,this.zoom_level)/this.aspect_ratio,this.wilson.world_center_x=t[0],this.wilson.world_center_y=t[1]}try{this.wilson.draggables.recalculate_locations()}catch(o){}window.requestAnimationFrame(this.draw_frame.bind(this))}on_drag_draggable(i,t,o,e){try{this.draggable_callback(i,t,o,e)}catch(s){}this.wilson.gl.uniform2f(this.wilson.uniforms.draggable_arg,t,o),window.requestAnimationFrame(this.draw_frame.bind(this))}draw_frame(i){let t=i-this.last_timestamp;this.last_timestamp=i,0!==t&&(this.wilson.gl.uniform1f(this.wilson.uniforms.aspect_ratio,this.aspect_ratio),this.wilson.gl.uniform1f(this.wilson.uniforms.world_center_x,this.wilson.world_center_x),this.wilson.gl.uniform1f(this.wilson.uniforms.world_center_y,this.wilson.world_center_y),this.wilson.gl.uniform1f(this.wilson.uniforms.world_size,Math.min(this.wilson.world_height,this.wilson.world_width)/2),this.wilson.gl.uniform1f(this.wilson.uniforms.black_point,this.black_point),this.wilson.gl.uniform1f(this.wilson.uniforms.white_point,this.white_point),this.wilson.render.draw_frame(),t>=50&&(this.pan_velocity_x=0,this.pan_velocity_y=0,this.zoom_velocity=0,this.next_pan_velocity_x=0,this.next_pan_velocity_y=0,this.next_zoom_velocity=0),(0!==this.pan_velocity_x||0!==this.pan_velocity_y||0!==this.zoom_velocity)&&(this.wilson.world_center_x+=this.pan_velocity_x*this.wilson.world_width,this.wilson.world_center_y+=this.pan_velocity_y*this.wilson.world_height,this.pan_velocity_x*=this.pan_friction,this.pan_velocity_y*=this.pan_friction,Math.sqrt(this.pan_velocity_x*this.pan_velocity_x+this.pan_velocity_y*this.pan_velocity_y)<this.pan_velocity_stop_threshhold&&(this.pan_velocity_x=0,this.pan_velocity_y=0),this.zoom_level+=this.zoom_velocity,this.zoom_canvas(this.fixed_point_x,this.fixed_point_y),this.zoom_velocity*=this.zoom_friction,Math.abs(this.zoom_velocity)<this.zoom_velocity_stop_threshhold&&(this.zoom_velocity=0),window.requestAnimationFrame(this.draw_frame.bind(this))))}change_aspect_ratio(){this.wilson.fullscreen.currently_fullscreen?(this.aspect_ratio=window.innerWidth/window.innerHeight,this.aspect_ratio>=1?(this.wilson.change_canvas_size(this.resolution,Math.floor(this.resolution/this.aspect_ratio)),this.wilson.world_width=3*Math.pow(2,this.zoom_level)*this.aspect_ratio,this.wilson.world_height=3*Math.pow(2,this.zoom_level)):(this.wilson.change_canvas_size(Math.floor(this.resolution*this.aspect_ratio),this.resolution),this.wilson.world_width=3*Math.pow(2,this.zoom_level),this.wilson.world_height=3*Math.pow(2,this.zoom_level)/this.aspect_ratio)):(this.aspect_ratio=1,this.wilson.change_canvas_size(this.resolution,this.resolution),this.wilson.world_width=3*Math.pow(2,this.zoom_level),this.wilson.world_height=3*Math.pow(2,this.zoom_level)),window.requestAnimationFrame(this.draw_frame.bind(this))}run_benchmark(){this.wilson.change_canvas_size(this.benchmark_resolution,this.benchmark_resolution);let i=Date.now(),t=new Uint8Array(4);for(let o=0;o<this.benchmark_cycles;o++)this.wilson.render.draw_frame(),this.wilson.gl.readPixels(0,0,1,1,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,t);let e=(Date.now()-i)/this.benchmark_cycles;console.log(`Finished benchmark --- average time to draw a ${this.benchmark_resolution}x${this.benchmark_resolution} frame is ${e}ms`),this.wilson.change_canvas_size(this.resolution,this.resolution),this.wilson.render.draw_frame()}}