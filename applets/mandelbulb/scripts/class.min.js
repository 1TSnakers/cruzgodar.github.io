import{magnitude,mat3TimesVector,RaymarchApplet}from"/scripts/applets/raymarchApplet.min.js";import{animate}from"/scripts/src/utils.min.js";class Mandelbulb extends RaymarchApplet{constructor({canvas}){super({canvas:canvas,resolution:400,distanceEstimatorGlsl:`
			vec3 z = pos;
			
			float r = length(z);
			float dr = 1.0;
			
			for (int iteration = 0; iteration < 16; iteration++)
			{
				if (r > 16.0)
				{
					break;
				}
				
				float theta = acos(clamp(z.z / r, -1.0, 1.0));
				
				float phi = atan(z.y, z.x);
				
				dr = pow(r, power - 1.0) * power * dr + 1.0;
				
				theta *= power;
				
				phi *= power;
				
				z = pow(r, power) * vec3(sin(theta)*cos(phi), sin(phi)*sin(theta), cos(theta));
				
				z += mix(pos, c, juliaProportion);
				
				z = rotationMatrix * z;
				
				r = length(z);
			}
			
			return .5 * log(r) * r / dr;
		`,getColorGlsl:`
			vec3 z = pos;
			
			float r = length(z);
			float dr = 1.0;
			
			vec3 color = vec3(1.0, 1.0, 1.0);
			float colorScale = .5;
			
			for (int iteration = 0; iteration < 8; iteration++)
			{
				if (r > 16.0)
				{
					break;
				}
				
				float theta = acos(z.z / r);
				
				float phi = atan(z.y, z.x);
				
				dr = pow(r, power - 1.0) * power * dr + 1.0;
				
				theta *= power;
				
				phi *= power;
				
				z = pow(r, power) * vec3(sin(theta)*cos(phi), sin(phi)*sin(theta), cos(theta));
				
				z += mix(pos, c, juliaProportion);
				
				z = rotationMatrix * z;
				
				r = length(z);
				
				color = mix(color, abs(z / r), colorScale);
				
				colorScale *= .5;
			}
			
			color /= max(max(color.x, color.y), color.z);
			
			return color;
		`,uniformsGlsl:`
			uniform float power;
			uniform vec3 c;
			uniform float juliaProportion;
			uniform mat3 rotationMatrix;
		`,uniforms:{power:8,c:[0,0,0],juliaProportion:0,rotationMatrix:[[1,0,0],[0,1,0],[0,0,1]]},theta:4.6601,phi:2.272,cameraPos:[.084365,1.91102,1.69388],lightPos:[-10,0,15],lightBrightness:1.2})}distanceEstimator(x,y,z){let t=[x,y,z],o=0,r=1;var a=this.uniforms.c,i=this.uniforms.juliaProportion,e=this.uniforms.power,s=this.uniforms.rotationMatrix;for(let p=0;p<16&&!(16<(o=magnitude(t)));p++){var n=Math.acos(t[2]/o),l=Math.atan2(t[1],t[0]),c=(r=Math.pow(o,e-1)*e*r+1,n*=e,l*=e,Math.pow(o,e));t[0]=c*Math.sin(n)*Math.cos(l)+((1-i)*x+i*a[0]),t[1]=c*Math.sin(n)*Math.sin(l)+((1-i)*y+i*a[1]),t[2]=c*Math.cos(n)+((1-i)*z+i*a[2]),t=mat3TimesVector(s,t)}return.5*Math.log(o)*o/r}switchBulb(instant){const o=this.uniforms.juliaProportion,r=0===this.uniforms.juliaProportion?1:0;animate(t=>{this.setUniforms({juliaProportion:(1-t)*o+t*r}),this.needNewFrame=!0},instant?0:650,"easeOutQuad")}}export{Mandelbulb};