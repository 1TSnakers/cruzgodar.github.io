"use strict";class FractalSounds extends Applet{load_promise=null;wilson_hidden=null;wilson_line_drawer=null;julia_mode=0;aspect_ratio=1;num_iterations=200;exposure=1;zoom_level=0;past_brightness_scales=[];resolution=500;resolution_hidden=200;need_to_clear=!1;fixed_point_x=0;fixed_point_y=0;num_touches=0;moved=0;last_x=0;last_y=0;zooming_with_mouse=!1;next_pan_velocity_x=0;next_pan_velocity_y=0;next_zoom_velocity=0;pan_velocity_x=0;pan_velocity_y=0;zoom_velocity=0;pan_friction=.96;pan_velocity_start_threshhold=.0025;pan_velocity_stop_threshhold=25e-5;zoom_friction=.93;zoom_velocity_start_threshhold=.01;zoom_velocity_stop_threshhold=.001;last_timestamp=-1;constructor(e,i){super(e);let t="precision highp float; varying vec2 uv; void main(void) { gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0); }",s={renderer:"gpu",shader:t,canvas_width:this.resolution,canvas_height:this.resolution,world_width:4,world_height:4,world_center_x:0,world_center_y:0,use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png",switch_fullscreen_callback:this.switch_fullscreen.bind(this)};this.wilson=new Wilson(e,s);let o=this.create_hidden_canvas(),l={renderer:"gpu",shader:t,canvas_width:this.resolution_hidden,canvas_height:this.resolution_hidden};this.wilson_hidden=new Wilson(o,l);let n={renderer:"cpu",canvas_width:this.resolution,canvas_height:this.resolution,world_width:4,world_height:4,world_center_x:0,world_center_y:0,mousemove_callback:this.on_hover_canvas.bind(this),mousedown_callback:this.on_grab_canvas.bind(this),touchstart_callback:this.on_grab_canvas.bind(this),mousedrag_callback:this.on_drag_canvas.bind(this),touchmove_callback:this.on_drag_canvas.bind(this),mouseup_callback:this.on_release_canvas.bind(this),touchend_callback:this.on_release_canvas.bind(this),wheel_callback:this.on_wheel_canvas.bind(this),pinch_callback:this.on_pinch_canvas.bind(this),use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!1};this.wilson_line_drawer=new Wilson(i,n);let r=Page.element.querySelectorAll(".wilson-fullscreen-components-container");r[0].style.setProperty("z-index",200,"important"),r[1].style.setProperty("z-index",300,"important"),this.wilson_line_drawer.ctx.lineWidth=40;let h=this.change_aspect_ratio.bind(this);window.addEventListener("resize",h),this.handlers.push([window,"resize",h]),this.load_promise=new Promise(async(e,i)=>{await Site.load_glsl(),e()})}run(e,i,t,s,o){this.current_fractal_function=i,this.resolution=t,this.exposure=s,this.num_iterations=o;let l=`
   precision highp float;
   
   varying vec2 uv;
   
   uniform float aspect_ratio;
   
   uniform float world_center_x;
   uniform float world_center_y;
   uniform float world_size;
   
   uniform float exposure;
   uniform int num_iterations;
   uniform float brightness_scale;
   
   const float hue_multiplier = 100.0;
   
   const vec3 color_1 = vec3(1.0, 0.0, 0.0);
   const vec3 color_2 = vec3(1.0, .4157, 0.0);
   const vec3 color_3 = vec3(1.0, .8471, 0.0);
   const vec3 color_4 = vec3(.7333, 1.0, 0.0);
   const vec3 color_5 = vec3(.2980, 1.0, 0.0);
   const vec3 color_6 = vec3(0.0, 1.0, .1137);
   const vec3 color_7 = vec3(0.0, 1.0, .5490);
   const vec3 color_8 = vec3(0.0, 1.0, .9647);
   const vec3 color_9 = vec3(0.0, .6, 1.0);
   const vec3 color_10 = vec3(0.0, .1804, 1.0);
   const vec3 color_11 = vec3(.2471, 0.0, 1.0);
   const vec3 color_12 = vec3(.6667, 0.0, 1.0);
   const vec3 color_13 = vec3(1.0, 0.0, .8980);
   
   
   
   ${Site.get_glsl_bundle(e)}
   
   
   
   vec3 hsv2rgb(vec3 c)
   {
    vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
    vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
    return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
   }
   
   
   
   void main(void)
   {
    vec2 z;
    
    if (aspect_ratio >= 1.0)
    {
     z = vec2(uv.x * aspect_ratio * world_size + world_center_x, uv.y * world_size + world_center_y);
    }
    
    else
    {
     z = vec2(uv.x * world_size + world_center_x, uv.y / aspect_ratio * world_size + world_center_y);
    }
    
    float brightness = exp(-max(length(z), .5));
    
    vec2 c = z;
    
    gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
    
    
    
    vec2 last_z_1 = vec2(0.0, 0.0);
    vec2 last_z_2 = vec2(0.0, 0.0);
    vec2 last_z_3 = vec2(0.0, 0.0);
    vec2 last_z_4 = vec2(0.0, 0.0);
    vec2 last_z_5 = vec2(0.0, 0.0);
    vec2 last_z_6 = vec2(0.0, 0.0);
    vec2 last_z_7 = vec2(0.0, 0.0);
    vec2 last_z_8 = vec2(0.0, 0.0);
    vec2 last_z_9 = vec2(0.0, 0.0);
    vec2 last_z_10 = vec2(0.0, 0.0);
    vec2 last_z_11 = vec2(0.0, 0.0);
    vec2 last_z_12 = vec2(0.0, 0.0);
    vec2 last_z_13 = vec2(0.0, 0.0);
    
    float hue_1 = 0.0;
    float hue_2 = 0.0;
    float hue_3 = 0.0;
    float hue_4 = 0.0;
    float hue_5 = 0.0;
    float hue_6 = 0.0;
    float hue_7 = 0.0;
    float hue_8 = 0.0;
    float hue_9 = 0.0;
    float hue_10 = 0.0;
    float hue_11 = 0.0;
    float hue_12 = 0.0;
    float hue_13 = 0.0;
    
    
    
    for (int iteration = 0; iteration < 3001; iteration++)
    {
     if (iteration == num_iterations)
     {
      vec3 color = hue_1 * color_1 + hue_2 * color_2 + hue_3 * color_3 + hue_4 * color_4 + hue_5 * color_5 + hue_6 * color_6 + hue_7 * color_7 + hue_8 * color_8 + hue_9 * color_9 + hue_10 * color_10 + hue_11 * color_11 + hue_12 * color_12 + hue_13 * color_13;
      gl_FragColor = vec4(brightness / brightness_scale * exposure * normalize(color), 1.0);
      return;
     }
     
     if (length(z) >= 10.0)
     {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
     }
     
     last_z_13 = last_z_12;
     last_z_12 = last_z_11;
     last_z_11 = last_z_10;
     last_z_10 = last_z_9;
     last_z_9 = last_z_8;
     last_z_8 = last_z_7;
     last_z_7 = last_z_6;
     last_z_6 = last_z_5;
     last_z_5 = last_z_4;
     last_z_4 = last_z_3;
     last_z_3 = last_z_2;
     last_z_2 = last_z_1;
     last_z_1 = z;
     z = ${e};
     
     
     
     brightness += exp(-max(length(z), .5));
     
     hue_1 += exp(-hue_multiplier * length(z - last_z_1));
     hue_2 += exp(-hue_multiplier * length(z - last_z_2));
     hue_3 += exp(-hue_multiplier * length(z - last_z_3));
     hue_4 += exp(-hue_multiplier * length(z - last_z_4));
     hue_5 += exp(-hue_multiplier * length(z - last_z_5));
     hue_6 += exp(-hue_multiplier * length(z - last_z_6));
     hue_7 += exp(-hue_multiplier * length(z - last_z_7));
     hue_8 += exp(-hue_multiplier * length(z - last_z_8));
     hue_9 += exp(-hue_multiplier * length(z - last_z_9));
     hue_10 += exp(-hue_multiplier * length(z - last_z_10));
     hue_11 += exp(-hue_multiplier * length(z - last_z_11));
     hue_12 += exp(-hue_multiplier * length(z - last_z_12));
     hue_13 += exp(-hue_multiplier * length(z - last_z_13));
    }
   }
  `;this.wilson.render.shader_programs=[],this.wilson.render.load_new_shader(l),this.wilson.gl.useProgram(this.wilson.render.shader_programs[0]),this.wilson.render.init_uniforms(["julia_mode","aspect_ratio","world_center_x","world_center_y","world_size","a","b","num_iterations","exposure","brightness_scale"],0),this.wilson_hidden.render.shader_programs=[],this.wilson_hidden.render.load_new_shader(l),this.wilson_hidden.gl.useProgram(this.wilson_hidden.render.shader_programs[0]),this.wilson_hidden.render.init_uniforms(["julia_mode","aspect_ratio","world_center_x","world_center_y","world_size","a","b","num_iterations","exposure","brightness_scale"],0),this.julia_mode=0,this.zoom_level=0,this.past_brightness_scales=[],this.wilson_line_drawer.world_width=4,this.wilson_line_drawer.world_height=4,this.wilson_line_drawer.world_center_x=0,this.wilson_line_drawer.world_center_y=0,this.wilson.gl.uniform1f(this.wilson.uniforms.aspect_ratio[0],1),this.wilson_hidden.gl.uniform1f(this.wilson_hidden.uniforms.aspect_ratio[0],1),window.requestAnimationFrame(this.draw_frame.bind(this))}on_grab_canvas(e,i,t){this.pan_velocity_x=0,this.pan_velocity_y=0,this.zoom_velocity=0,this.next_pan_velocity_x=0,this.next_pan_velocity_y=0,this.next_zoom_velocity=0,this.wilson_line_drawer.canvas.style.opacity=1,"touchstart"===t.type?(this.num_touches=t.touches.length,1===this.num_touches&&(this.show_orbit(e,i),this.play_sound(e,i))):(this.moved=0,this.show_orbit(e,i))}on_drag_canvas(e,i,t,s,o){"mousemove"===o.type||this.num_touches>=2?((this.num_touches>=2||Math.abs(t)>0||Math.abs(s)>0)&&this.wilson_line_drawer.ctx.clearRect(0,0,this.resolution,this.resolution),this.wilson_line_drawer.world_center_x-=t,this.wilson_line_drawer.world_center_y-=s,this.next_pan_velocity_x=-t/this.wilson.world_width,this.next_pan_velocity_y=-s/this.wilson.world_height,this.wilson_line_drawer.world_center_x=Math.min(Math.max(this.wilson_line_drawer.world_center_x,-2),2),this.wilson_line_drawer.world_center_y=Math.min(Math.max(this.wilson_line_drawer.world_center_y,-2),2),this.moved++,window.requestAnimationFrame(this.draw_frame.bind(this))):this.show_orbit(e,i)}on_hover_canvas(e,i,t,s,o){this.show_orbit(e,i),this.moved=0}on_release_canvas(e,i,t){"mouseup"===t.type||this.num_touches>=2?(this.next_pan_velocity_x*this.next_pan_velocity_x+this.next_pan_velocity_y*this.next_pan_velocity_y>=this.pan_velocity_start_threshhold*this.pan_velocity_start_threshhold&&(this.pan_velocity_x=this.next_pan_velocity_x,this.pan_velocity_y=this.next_pan_velocity_y,this.moved=10),Math.abs(this.next_zoom_velocity)>=this.zoom_velocity_start_threshhold&&(this.zoom_velocity=this.next_zoom_velocity,this.moved=10),this.moved<10&&"mouseup"===t.type&&this.play_sound(e,i)):anime({targets:this.wilson_line_drawer.canvas,opacity:0,easing:"linear",duration:300}),setTimeout(()=>this.num_touches=0,50),this.moved=0}show_orbit(e,i){this.wilson_line_drawer.ctx.lineWidth=2,this.wilson_line_drawer.canvas.style.opacity=1,this.wilson_line_drawer.ctx.strokeStyle="rgb(255, 255, 255)",this.wilson_line_drawer.ctx.clearRect(0,0,this.resolution,this.resolution),this.wilson_line_drawer.ctx.beginPath();let t=this.wilson_line_drawer.utils.interpolate.world_to_canvas(e,i);this.wilson_line_drawer.ctx.moveTo(t[1],t[0]);let s=e,o=i,l=e,n=i,r=this.current_fractal_function(s,o,l,n);s=0,o=0;for(let h=0;h<300;h++){if(Math.abs(r[0])>10||Math.abs(r[1])>10)return;s=r[0],o=r[1],r=this.current_fractal_function(s,o,l,n),t=this.wilson_line_drawer.utils.interpolate.world_to_canvas(s,o),this.wilson_line_drawer.ctx.lineTo(t[1],t[0])}this.wilson_line_drawer.ctx.stroke()}play_sound(e,i){let t=new AudioContext,s=Math.floor(3675),o=e,l=i,n=e,r=i,h=this.current_fractal_function(o,l,n,r);o=0,l=0;let a=0,c=Array(s),d=Array(s),w=t.createBuffer(2,44100,44100),$=w.getChannelData(0),u=w.getChannelData(1);for(let v=0;v<s;v++){if(Math.abs(h[0])>100||Math.abs(h[1])>100)return;Math.abs(h[0])>a&&(a=Math.abs(h[0])),Math.abs(h[1])>a&&(a=Math.abs(h[1])),c[v]=o,d[v]=l,o=h[0],l=h[1],h=this.current_fractal_function(o,l,n,r)}for(let m=0;m<s;m++)c[m]/=a,d[m]/=a;for(let p=0;p<s-1;p++)for(let _=0;_<12;_++){let f=.5+.5*Math.sin(Math.PI*_/12-Math.PI/2);$[12*p+_]=(1-f)*(c[p]/2)+f*(c[p+1]/2),u[12*p+_]=(1-f)*(d[p]/2)+f*(d[p+1]/2)}let z=t.createBufferSource();z.buffer=w;let y=t.createGain();z.connect(y),y.connect(t.destination),z.start(0),y.gain.exponentialRampToValueAtTime(1e-4,1)}on_wheel_canvas(e,i,t,s){this.fixed_point_x=e,this.fixed_point_y=i,.3>Math.abs(t/100)?(this.zoom_level+=t/100,this.zoom_level=Math.min(this.zoom_level,1)):this.zoom_velocity+=.05*Math.sign(t),this.last_x=e,this.last_y=i,this.zooming_with_mouse=!0,this.zoom_canvas()}on_pinch_canvas(e,i,t,s){2!==this.julia_mode&&(this.aspect_ratio>=1?(this.zoom_level-=t/this.wilson_line_drawer.world_width*10,this.next_zoom_velocity=-t/this.wilson_line_drawer.world_width*10):(this.zoom_level-=t/this.wilson_line_drawer.world_height*10,this.next_zoom_velocity=-t/this.wilson_line_drawer.world_height*10),this.zoom_level=Math.min(this.zoom_level,1),this.fixed_point_x=e,this.fixed_point_y=i,this.zooming_with_mouse=!1,this.zoom_canvas())}zoom_canvas(){if(this.aspect_ratio>=1){let e=this.wilson_line_drawer.input.get_zoomed_world_center(this.fixed_point_x,this.fixed_point_y,4*Math.pow(2,this.zoom_level)*this.aspect_ratio,4*Math.pow(2,this.zoom_level));this.wilson_line_drawer.world_width=4*Math.pow(2,this.zoom_level)*this.aspect_ratio,this.wilson_line_drawer.world_height=4*Math.pow(2,this.zoom_level),this.wilson_line_drawer.world_center_x=e[0],this.wilson_line_drawer.world_center_y=e[1]}else this.wilson_line_drawer.input.get_zoomed_world_center(this.fixed_point_x,this.fixed_point_y,4*Math.pow(2,this.zoom_level),4*Math.pow(2,this.zoom_level)/this.aspect_ratio),this.wilson_line_drawer.world_width=4*Math.pow(2,this.zoom_level),this.wilson_line_drawer.world_height=4*Math.pow(2,this.zoom_level)/this.aspect_ratio,this.wilson_line_drawer.world_center_x=this.new_world_center[0],this.wilson_line_drawer.world_center_y=this.new_world_center[1];this.zooming_with_mouse&&this.show_orbit(this.last_x,this.last_y),window.requestAnimationFrame(this.draw_frame.bind(this))}draw_frame(e){let i=e-this.last_timestamp;if(this.last_timestamp=e,0===i)return;this.wilson_hidden.gl.uniform1f(this.wilson_hidden.uniforms.world_center_x[0],this.wilson_line_drawer.world_center_x),this.wilson_hidden.gl.uniform1f(this.wilson_hidden.uniforms.world_center_y[0],this.wilson_line_drawer.world_center_y),this.wilson_hidden.gl.uniform1f(this.wilson_hidden.uniforms.world_size[0],Math.min(this.wilson_line_drawer.world_height,this.wilson_line_drawer.world_width)/2),this.wilson_hidden.gl.uniform1i(this.wilson_hidden.uniforms.num_iterations[0],this.num_iterations),this.wilson_hidden.gl.uniform1f(this.wilson_hidden.uniforms.exposure[0],1),this.wilson_hidden.gl.uniform1f(this.wilson_hidden.uniforms.brightness_scale[0],20*(Math.abs(this.zoom_level)+1)),this.wilson_hidden.render.draw_frame();let t=this.wilson_hidden.render.get_pixel_data(),s=Array(this.resolution_hidden*this.resolution_hidden);for(let o=0;o<this.resolution_hidden*this.resolution_hidden;o++)s[o]=t[4*o]+t[4*o+1]+t[4*o+2];s.sort((e,i)=>e-i);let l=(s[Math.floor(this.resolution_hidden*this.resolution_hidden*.96)]+s[Math.floor(this.resolution_hidden*this.resolution_hidden*.98)])/255*15*(Math.abs(this.zoom_level/2)+1);this.past_brightness_scales.push(l);let n=this.past_brightness_scales.length;n>10&&this.past_brightness_scales.shift(),l=Math.max(this.past_brightness_scales.reduce((e,i)=>e+i)/n,.5),this.wilson.gl.uniform1f(this.wilson.uniforms.aspect_ratio[0],this.aspect_ratio),this.wilson.gl.uniform1f(this.wilson.uniforms.world_center_x[0],this.wilson_line_drawer.world_center_x),this.wilson.gl.uniform1f(this.wilson.uniforms.world_center_y[0],this.wilson_line_drawer.world_center_y),this.wilson.gl.uniform1f(this.wilson.uniforms.world_size[0],Math.min(this.wilson_line_drawer.world_height,this.wilson_line_drawer.world_width)/2),this.wilson.gl.uniform1i(this.wilson.uniforms.num_iterations[0],this.num_iterations),this.wilson.gl.uniform1f(this.wilson.uniforms.exposure[0],this.exposure),this.wilson.gl.uniform1f(this.wilson.uniforms.brightness_scale[0],l),this.wilson.render.draw_frame(),i>=50&&(this.pan_velocity_x=0,this.pan_velocity_y=0,this.zoom_velocity=0,this.next_pan_velocity_x=0,this.next_pan_velocity_y=0,this.next_zoom_velocity=0),(0!==this.pan_velocity_x||0!==this.pan_velocity_y||0!==this.zoom_velocity)&&(this.wilson_line_drawer.world_center_x+=this.pan_velocity_x*this.wilson_line_drawer.world_width,this.wilson_line_drawer.world_center_y+=this.pan_velocity_y*this.wilson_line_drawer.world_height,this.wilson_line_drawer.world_center_x=Math.min(Math.max(this.wilson_line_drawer.world_center_x,-2),2),this.wilson_line_drawer.world_center_y=Math.min(Math.max(this.wilson_line_drawer.world_center_y,-2),2),this.pan_velocity_x*=this.pan_friction,this.pan_velocity_y*=this.pan_friction,this.pan_velocity_x*this.pan_velocity_x+this.pan_velocity_y*this.pan_velocity_y<this.pan_velocity_stop_threshhold*this.pan_velocity_stop_threshhold&&(this.pan_velocity_x=0,this.pan_velocity_y=0),this.zoom_level+=this.zoom_velocity,this.zoom_level=Math.min(this.zoom_level,1),this.zoom_canvas(),this.zoom_velocity*=this.zoom_friction,Math.abs(this.zoom_velocity)<this.zoom_velocity_stop_threshhold&&(this.zoom_velocity=0),window.requestAnimationFrame(this.draw_frame.bind(this)))}switch_fullscreen(){this.change_aspect_ratio();try{document.body.querySelectorAll(".wilson-applet-canvas-container").forEach(e=>e.style.setProperty("background-color","rgba(0, 0, 0, 0)","important")),document.body.querySelector(".wilson-exit-fullscreen-button").style.setProperty("z-index","300","important")}catch(e){}this.wilson_line_drawer.fullscreen.switch_fullscreen()}change_aspect_ratio(){this.wilson.fullscreen.currently_fullscreen?(this.aspect_ratio=window.innerWidth/window.innerHeight,this.aspect_ratio>=1?(this.wilson_line_drawer.change_canvas_size(this.resolution,Math.floor(this.resolution/this.aspect_ratio)),this.wilson.change_canvas_size(this.resolution,Math.floor(this.resolution/this.aspect_ratio)),this.wilson_line_drawer.world_width=4*Math.pow(2,this.zoom_level)*this.aspect_ratio,this.wilson_line_drawer.world_height=4*Math.pow(2,this.zoom_level)):(this.wilson_line_drawer.change_canvas_size(Math.floor(this.resolution*this.aspect_ratio),this.resolution),this.wilson.change_canvas_size(Math.floor(this.resolution*this.aspect_ratio),this.resolution),this.wilson_line_drawer.world_width=4*Math.pow(2,this.zoom_level),this.wilson_line_drawer.world_height=4*Math.pow(2,this.zoom_level)/this.aspect_ratio)):(this.aspect_ratio=1,this.wilson_line_drawer.change_canvas_size(this.resolution,this.resolution),this.wilson.change_canvas_size(this.resolution,this.resolution),this.wilson_line_drawer.world_width=4*Math.pow(2,this.zoom_level),this.wilson_line_drawer.world_height=4*Math.pow(2,this.zoom_level)),window.requestAnimationFrame(this.draw_frame.bind(this))}}