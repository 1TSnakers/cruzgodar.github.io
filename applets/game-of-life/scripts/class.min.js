import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{Wilson}from"/scripts/wilson.min.js";class GameOfLife extends AnimationFrameApplet{wilsonUpscale=null;gridSize=100;resolution=1e3;framesPerUpdate=10;updatesPerFrame=1;frame=0;currentFramebuffer=0;constructor({canvas}){super(canvas);var e=this.createHiddenCanvas(),i={renderer:"gpu",shader:`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			void main(void)
			{
				if (abs(uv.y) < 0.01 || abs(uv.x) < 0.01)
				{
					gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);
					return;
				}

				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		`,canvasWidth:this.resolution,canvasHeight:this.resolution},e=(this.wilsonHidden=new Wilson(e,i),this.wilsonHidden.render.loadNewShader(`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			uniform float step;

			const float glowChangeSpeed = 0.15;
			
			
			
			void main(void)
			{
				vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
				
				if (center.x <= step || center.x >= 1.0 - step || center.y <= step || center.y >= 1.0 - step)
				{
					gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
					return;
				}

				vec4 thisPixel = texture2D(uTexture, center);

				float state = thisPixel.z;

				float surroundingState = (
					texture2D(uTexture, center + vec2(step, 0.0)).z
					+ texture2D(uTexture, center + vec2(-step, 0.0)).z
					+ texture2D(uTexture, center + vec2(0.0, step)).z
					+ texture2D(uTexture, center + vec2(0.0, -step)).z
					+ texture2D(uTexture, center + vec2(step, step)).z
					+ texture2D(uTexture, center + vec2(step, -step)).z
					+ texture2D(uTexture, center + vec2(-step, step)).z
					+ texture2D(uTexture, center + vec2(-step, -step)).z
				);

				if (state < 0.5)
				{
					if (surroundingState >= 2.5 && surroundingState <= 3.5)
					{
						// Becoming alive
						gl_FragColor = vec4(0.0, 1.0, 1.0, 1.0);
						return;
					}
					
					// Staying dead
					gl_FragColor = vec4(max(thisPixel.x - glowChangeSpeed, 0.0), 0.0, 0.0, 1.0);
					return;
				}

				if (surroundingState <= 1.5 || surroundingState >= 3.5)
				{
					// Becoming dead
					gl_FragColor = vec4(1.0, 0.0, 0.0, 1.0);
					return;
				}

				// Staying alive
				gl_FragColor = vec4(0.0, max(thisPixel.y - glowChangeSpeed, 0.0), 1.0, 1.0);
				return;
			}
		`),this.wilsonHidden.render.initUniforms(["step"],1),this.wilsonHidden.render.createFramebufferTexturePair(this.wilsonHidden.gl.UNSIGNED_BYTE),this.wilsonHidden.render.createFramebufferTexturePair(this.wilsonHidden.gl.UNSIGNED_BYTE),this.wilsonHidden.gl.bindTexture(this.wilsonHidden.gl.TEXTURE_2D,this.wilsonHidden.render.framebuffers[0].texture),this.wilsonHidden.gl.bindFramebuffer(this.wilsonHidden.gl.FRAMEBUFFER,null),{renderer:"gpu",shader:`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;

			uniform vec2 worldCenter;
			uniform float worldRadius;

			const vec4 aliveColor = vec4(1.0, 1.0, 1.0, 1.0);
			const vec4 growingColor = vec4(0.5, 0.0, 1.0, 1.0);
			const vec4 dyingColor = vec4(0.0, 0.0, 1.0, 1.0);
			const vec4 deadColor = vec4(0.0, 0.0, 0.0, 1.0);
			
			void main(void)
			{
				vec2 xy = (uv + (worldCenter + vec2(1.0, 1.0)) / worldRadius) * worldRadius / 2.0;

				if (max(xy.x, xy.y) >= 1.0 || min(xy.x, xy.y) <= 0.0)
				{
					gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
					return;
				}

				gl_FragColor = texture2D(uTexture, xy);

				if (gl_FragColor.w == 0.0)
				{
					gl_FragColor = vec4(0.5, 0.5, 0.5, 1.0);
					return;
				}

				// Convert red to blue and green to purple.
				if (gl_FragColor.z > 0.5)
				{
					gl_FragColor = mix(aliveColor, growingColor, gl_FragColor.y);
					return;
				}

				gl_FragColor = mix(deadColor, dyingColor, gl_FragColor.x);
				return;
			}
		`,canvasWidth:this.resolution,canvasHeight:this.resolution,useFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",mousedownCallback:this.onGrabCanvas.bind(this),touchstartCallback:this.onGrabCanvas.bind(this),mousedragCallback:this.onDragCanvas.bind(this),touchmoveCallback:this.onDragCanvas.bind(this),mouseupCallback:this.onReleaseCanvas.bind(this),touchendCallback:this.onReleaseCanvas.bind(this),wheelCallback:this.onWheelCanvas.bind(this),pinchCallback:this.onPinchCanvas.bind(this)});this.wilson=new Wilson(canvas,e),this.wilson.render.initUniforms(["worldCenter","worldRadius"]),this.zoom.init(),this.wilson.render.createFramebufferTexturePair(this.wilson.gl.UNSIGNED_BYTE)}run({resolution=1e3,gridSize=100}){this.resolution=resolution,this.gridSize=gridSize,this.wilsonHidden.gl.useProgram(this.wilsonHidden.render.shaderPrograms[0]),this.wilsonHidden.gl.useProgram(this.wilsonHidden.render.shaderPrograms[1]),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.step[1],1/this.gridSize),this.wilsonHidden.changeCanvasSize(this.gridSize,this.gridSize),this.wilson.changeCanvasSize(this.resolution,this.resolution),this.wilsonHidden.gl.bindTexture(this.wilsonHidden.gl.TEXTURE_2D,this.wilsonHidden.render.framebuffers[0].texture),this.wilsonHidden.gl.texImage2D(this.wilsonHidden.gl.TEXTURE_2D,0,this.wilsonHidden.gl.RGBA,this.wilsonHidden.canvasWidth,this.wilsonHidden.canvasHeight,0,this.wilsonHidden.gl.RGBA,this.wilsonHidden.gl.UNSIGNED_BYTE,null),this.wilsonHidden.gl.bindTexture(this.wilsonHidden.gl.TEXTURE_2D,this.wilsonHidden.render.framebuffers[1].texture),this.wilsonHidden.gl.texImage2D(this.wilsonHidden.gl.TEXTURE_2D,0,this.wilsonHidden.gl.RGBA,this.wilsonHidden.canvasWidth,this.wilsonHidden.canvasHeight,0,this.wilsonHidden.gl.RGBA,this.wilsonHidden.gl.UNSIGNED_BYTE,null),this.wilsonHidden.gl.useProgram(this.wilsonHidden.render.shaderPrograms[0]),this.wilsonHidden.gl.bindTexture(this.wilsonHidden.gl.TEXTURE_2D,this.wilsonHidden.render.framebuffers[0].texture),this.wilsonHidden.gl.bindFramebuffer(this.wilsonHidden.gl.FRAMEBUFFER,this.wilsonHidden.render.framebuffers[0].framebuffer),this.wilsonHidden.render.drawFrame(),this.wilsonHidden.gl.useProgram(this.wilsonHidden.render.shaderPrograms[1]),this.frame=0,this.currentFramebuffer=1,this.resume()}prepareFrame(timeElapsed){this.pan.update(timeElapsed),this.zoom.update(timeElapsed)}drawFrame(){this.frame%this.framesPerUpdate==0&&this.updateGame(),this.wilson.gl.uniform2f(this.wilson.uniforms.worldCenter,this.wilson.worldCenterX,this.wilson.worldCenterY),this.wilson.gl.uniform1f(this.wilson.uniforms.worldRadius,this.wilson.worldWidth/2),this.wilson.render.drawFrame(),this.frame++,this.needNewFrame=!0}updateGame(){if(!this.animationPaused){for(let e=0;e<this.updatesPerFrame;e++)this.wilsonHidden.gl.bindFramebuffer(this.wilsonHidden.gl.FRAMEBUFFER,this.wilsonHidden.render.framebuffers[this.currentFramebuffer].framebuffer),this.wilsonHidden.render.drawFrame(),this.wilsonHidden.gl.bindTexture(this.wilsonHidden.gl.TEXTURE_2D,this.wilsonHidden.render.framebuffers[this.currentFramebuffer].texture),this.currentFramebuffer=1-this.currentFramebuffer;this.wilsonHidden.gl.bindFramebuffer(this.wilsonHidden.gl.FRAMEBUFFER,null),this.wilsonHidden.render.drawFrame();var i=this.wilsonHidden.render.getPixelData();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.wilsonHidden.canvasWidth,this.wilsonHidden.canvasHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,i),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null)}}}export{GameOfLife};