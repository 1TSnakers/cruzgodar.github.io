import{Applet}from"/scripts/src/applets.min.mjs";import{addTemporaryWorker}from"/scripts/src/main.min.mjs";import{Wilson}from"/scripts/wilson.min.mjs";class MagicCarpet extends Applet{gridSize=null;maxCageSize=null;uniqueSolution=null;cages=[];currentlyDrawing=!1;cellSize=200;webWorker=null;constructor(canvas){super(canvas);this.wilson=new Wilson(canvas,{renderer:"cpu",canvasWidth:500,canvasHeight:500}),this.run()}async run({gridSize=8,maxCageSize=16,uniqueSolution=!0}){this.currentlyDrawing||(this.gridSize=gridSize,this.maxCageSize=maxCageSize,this.cellSize=Math.min(200,Math.floor(4e3/this.gridSize)),gridSize=this.gridSize*this.cellSize+9,this.wilson.changeCanvasSize(gridSize,gridSize),this.wilson.ctx.clearRect(0,0,gridSize,gridSize),this.webWorker=addTemporaryWorker("/applets/magic-carpets/scripts/worker.js"),this.webWorker.onmessage=e=>{this.cages=e.data[0],this.drawGrid()},this.webWorker.postMessage([this.gridSize,this.maxCageSize,uniqueSolution]))}drawGrid(rectanglesOnly=!1){var canvasSize=this.gridSize*this.cellSize+9;if(rectanglesOnly?this.wilson.ctx.clearRect(0,0,canvasSize,canvasSize):(this.wilson.ctx.fillStyle="rgb(255, 255, 255)",this.wilson.ctx.fillRect(0,0,canvasSize,canvasSize)),this.wilson.ctx.fillStyle="rgb(0, 0, 0)",!rectanglesOnly)for(let i=0;i<=this.gridSize;i++)this.wilson.ctx.fillRect(this.cellSize*i+3,0,4,9+canvasSize),this.wilson.ctx.fillRect(0,this.cellSize*i+3,9+canvasSize,4);if(this.wilson.ctx.fillRect(0,0,this.cellSize*this.gridSize+10,10),this.wilson.ctx.fillRect(0,this.cellSize*this.gridSize,this.cellSize*this.gridSize+10,10),this.wilson.ctx.fillRect(0,0,10,this.cellSize*this.gridSize+10),this.wilson.ctx.fillRect(this.cellSize*this.gridSize,0,10,this.cellSize*this.gridSize+10),!rectanglesOnly){this.wilson.ctx.font=.6*this.cellSize+"px sans-serif";for(let i=0;i<this.cages.length;i++)this.drawNumber(i)}this.currentlyDrawing=!1}drawNumber(i){var row=this.cages[i][0]+this.cages[i][4],col=this.cages[i][1]+this.cages[i][5],i=""+this.cages[i][2]*this.cages[i][3],measurement=this.wilson.ctx.measureText(i);this.wilson.ctx.fillText(i,this.cellSize*col+(this.cellSize-measurement.width)/2+5,this.cellSize*(row+1)-(this.cellSize-measurement.actualBoundingBoxAscent-measurement.actualBoundingBoxDescent)/2+4)}drawSolution(rectanglesOnly=!1){var canvasSize;this.currentlyDrawing||(this.currentlyDrawing=!0,canvasSize=this.gridSize*this.cellSize+9,rectanglesOnly?this.wilson.ctx.clearRect(0,0,canvasSize,canvasSize):(this.wilson.ctx.fillStyle="rgb(255, 255, 255)",this.wilson.ctx.fillRect(0,0,canvasSize,canvasSize)),this.drawGrid(rectanglesOnly),canvasSize=500/this.cages.length,this.drawCage(0,canvasSize,rectanglesOnly))}drawCage(index,delay,rectanglesOnly){var row,col,height,width,rgb,colAdjust,heightAdjust,widthAdjust,heightAdjust2,widthAdjust2;index===this.cages.length?this.currentlyDrawing=!1:(rgb=this.wilson.utils.hsvToRgb(index/this.cages.length*6/7,1,1),this.wilson.ctx.fillStyle=`rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, ${rectanglesOnly?.5:.2})`,row=this.cages[index][0]*this.cellSize,col=this.cages[index][1]*this.cellSize,height=this.cages[index][2]*this.cellSize,width=this.cages[index][3]*this.cellSize,this.wilson.ctx.fillRect(10+col,10+row,width-10,height-10),rgb=this.wilson.utils.hsvToRgb(index/this.cages.length*6/7,1,.9),this.wilson.ctx.fillStyle=`rgba(${rgb[0]}, ${rgb[1]}, ${rgb[2]}, 1)`,rgb=0===this.cages[index][0]?0:5,colAdjust=0===this.cages[index][1]?0:5,heightAdjust=this.cages[index][0]+this.cages[index][2]===this.gridSize||0===this.cages[index][0]?0:5,widthAdjust=this.cages[index][1]+this.cages[index][3]===this.gridSize||0===this.cages[index][1]?0:5,heightAdjust2=this.cages[index][0]+this.cages[index][2]===this.gridSize&&0===this.cages[index][0]?5:0,widthAdjust2=this.cages[index][1]+this.cages[index][3]===this.gridSize&&0===this.cages[index][1]?5:0,this.wilson.ctx.fillRect(10+col-colAdjust,10+row-rgb,width-5+widthAdjust-widthAdjust2,10),this.wilson.ctx.fillRect(10+col-colAdjust,10+row-rgb,10,height-5+heightAdjust-heightAdjust2),this.wilson.ctx.fillRect(col+width-5-colAdjust+widthAdjust-widthAdjust2,10+row-rgb,10,height-5+heightAdjust-heightAdjust2),this.wilson.ctx.fillRect(10+col-colAdjust+widthAdjust,row+height-5-rgb+heightAdjust-heightAdjust2,width-5-widthAdjust2,10),setTimeout(()=>this.drawCage(index+1,delay,rectanglesOnly),delay))}}export{MagicCarpet};