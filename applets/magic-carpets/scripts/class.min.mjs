import{Applet}from"/scripts/src/applets.mjs";class MagicCarpet extends Applet{gridSize=null;maxCageSize=null;uniqueSolution=null;cages=[];currentlyDrawing=!1;cellSize=200;webWorker=null;constructor(i){super(i);this.wilson=new Wilson(i,{renderer:"cpu",canvasWidth:500,canvasHeight:500}),this.run()}async run(i=8,s=16,t=!0){if(!this.currentlyDrawing){this.gridSize=i,this.maxCageSize=s,this.cellSize=Math.min(200,Math.floor(4e3/this.gridSize));i=this.gridSize*this.cellSize+9;this.wilson.changeCanvasSize(i,i),this.wilson.ctx.clearRect(0,0,i,i);try{this.webWorker.terminate()}catch(i){}this.webWorker=new Worker("/applets/magic-carpets/scripts/worker.min.js"),this.workers.push(this.webWorker),this.webWorker.onmessage=i=>{this.cages=i.data[0],this.drawGrid()},this.webWorker.postMessage([this.gridSize,this.maxCageSize,t])}}drawGrid(i=!1){var s=this.gridSize*this.cellSize+9;if(i?this.wilson.ctx.clearRect(0,0,s,s):(this.wilson.ctx.fillStyle="rgb(255, 255, 255)",this.wilson.ctx.fillRect(0,0,s,s)),this.wilson.ctx.fillStyle="rgb(0, 0, 0)",!i)for(let i=0;i<=this.gridSize;i++)this.wilson.ctx.fillRect(this.cellSize*i+3,0,4,9+s),this.wilson.ctx.fillRect(0,this.cellSize*i+3,9+s,4);if(this.wilson.ctx.fillRect(0,0,this.cellSize*this.gridSize+10,10),this.wilson.ctx.fillRect(0,this.cellSize*this.gridSize,this.cellSize*this.gridSize+10,10),this.wilson.ctx.fillRect(0,0,10,this.cellSize*this.gridSize+10),this.wilson.ctx.fillRect(this.cellSize*this.gridSize,0,10,this.cellSize*this.gridSize+10),!i){this.wilson.ctx.font=.6*this.cellSize+"px sans-serif";for(let i=0;i<this.cages.length;i++)this.drawNumber(i)}this.currentlyDrawing=!1}drawNumber(i){var s=this.cages[i][0]+this.cages[i][4],t=this.cages[i][1]+this.cages[i][5],i=""+this.cages[i][2]*this.cages[i][3],e=this.wilson.ctx.measureText(i);this.wilson.ctx.fillText(i,this.cellSize*t+(this.cellSize-e.width)/2+5,this.cellSize*(s+1)-(this.cellSize-e.actualBoundingBoxAscent-e.actualBoundingBoxDescent)/2+4)}drawSolution(i=!1){var s;this.currentlyDrawing||(this.currentlyDrawing=!0,s=this.gridSize*this.cellSize+9,i?this.wilson.ctx.clearRect(0,0,s,s):(this.wilson.ctx.fillStyle="rgb(255, 255, 255)",this.wilson.ctx.fillRect(0,0,s,s)),this.drawGrid(i),s=500/this.cages.length,this.drawCage(0,s,i))}drawCage(i,s,t){var e,l,h,c,r,a,g,n,o,w;i===this.cages.length?this.currentlyDrawing=!1:(r=this.wilson.utils.hsvToRgb(i/this.cages.length*6/7,1,1),this.wilson.ctx.fillStyle=`rgba(${r[0]}, ${r[1]}, ${r[2]}, ${t?.5:.2})`,e=this.cages[i][0]*this.cellSize,l=this.cages[i][1]*this.cellSize,h=this.cages[i][2]*this.cellSize,c=this.cages[i][3]*this.cellSize,this.wilson.ctx.fillRect(10+l,10+e,c-10,h-10),r=this.wilson.utils.hsvToRgb(i/this.cages.length*6/7,1,.9),this.wilson.ctx.fillStyle=`rgba(${r[0]}, ${r[1]}, ${r[2]}, 1)`,r=0===this.cages[i][0]?0:5,a=0===this.cages[i][1]?0:5,g=this.cages[i][0]+this.cages[i][2]===this.gridSize||0===this.cages[i][0]?0:5,n=this.cages[i][1]+this.cages[i][3]===this.gridSize||0===this.cages[i][1]?0:5,o=this.cages[i][0]+this.cages[i][2]===this.gridSize&&0===this.cages[i][0]?5:0,w=this.cages[i][1]+this.cages[i][3]===this.gridSize&&0===this.cages[i][1]?5:0,this.wilson.ctx.fillRect(10+l-a,10+e-r,c-5+n-w,10),this.wilson.ctx.fillRect(10+l-a,10+e-r,10,h-5+g-o),this.wilson.ctx.fillRect(l+c-5-a+n-w,10+e-r,10,h-5+g-o),this.wilson.ctx.fillRect(10+l-a+n,e+h-5-r+g-o,c-5-w,10),setTimeout(()=>this.drawCage(i+1,s,t),s))}}export{MagicCarpet};