"use strict";class MagicCarpet extends Applet{grid_size=null;max_cage_size=null;unique_solution=null;cages=[];currently_drawing=!1;cell_size=200;web_worker=null;constructor(i){super(i);let s={renderer:"cpu",canvas_width:500,canvas_height:500};this.wilson=new Wilson(i,s),this.run()}async run(i=8,s=16,t=!0){if(this.currently_drawing)return;this.grid_size=i,this.max_cage_size=s,this.cell_size=Math.min(200,Math.floor(4e3/this.grid_size));let e=this.grid_size*this.cell_size+9;this.wilson.change_canvas_size(e,e),this.wilson.ctx.clearRect(0,0,e,e);try{this.web_worker.terminate()}catch(l){}this.web_worker=new Worker(`/applets/magic-carpets/scripts/worker.${DEBUG?"":"min."}js`),this.workers.push(this.web_worker),this.web_worker.onmessage=i=>{this.cages=i.data[0],this.draw_grid()},this.web_worker.postMessage([this.grid_size,this.max_cage_size,t])}draw_grid(i=!1){let s=this.grid_size*this.cell_size+9;if(i?this.wilson.ctx.clearRect(0,0,s,s):(this.wilson.ctx.fillStyle="rgb(255, 255, 255)",this.wilson.ctx.fillRect(0,0,s,s)),this.wilson.ctx.fillStyle="rgb(0, 0, 0)",!i)for(let t=0;t<=this.grid_size;t++)this.wilson.ctx.fillRect(this.cell_size*t+3,0,4,s+9),this.wilson.ctx.fillRect(0,this.cell_size*t+3,s+9,4);if(this.wilson.ctx.fillRect(0,0,this.cell_size*this.grid_size+10,10),this.wilson.ctx.fillRect(0,this.cell_size*this.grid_size,this.cell_size*this.grid_size+10,10),this.wilson.ctx.fillRect(0,0,10,this.cell_size*this.grid_size+10),this.wilson.ctx.fillRect(this.cell_size*this.grid_size,0,10,this.cell_size*this.grid_size+10),!i){this.wilson.ctx.font=`${.6*this.cell_size}px sans-serif`;for(let e=0;e<this.cages.length;e++)this.draw_number(e)}this.currently_drawing=!1}draw_number(i){let s=this.cages[i][0]+this.cages[i][4],t=this.cages[i][1]+this.cages[i][5],e=`${this.cages[i][2]*this.cages[i][3]}`,l=this.wilson.ctx.measureText(e);this.wilson.ctx.fillText(e,this.cell_size*t+(this.cell_size-l.width)/2+5,this.cell_size*(s+1)-(this.cell_size-l.actualBoundingBoxAscent-l.actualBoundingBoxDescent)/2+4)}draw_solution(i=!1){if(this.currently_drawing)return;this.currently_drawing=!0;let s=this.grid_size*this.cell_size+9;i?this.wilson.ctx.clearRect(0,0,s,s):(this.wilson.ctx.fillStyle="rgb(255, 255, 255)",this.wilson.ctx.fillRect(0,0,s,s)),this.draw_grid(i);let t=500/this.cages.length;this.draw_cage(0,t,i)}draw_cage(i,s,t){if(i===this.cages.length){this.currently_drawing=!1;return}let e=this.wilson.utils.hsv_to_rgb(i/this.cages.length*6/7,1,1);this.wilson.ctx.fillStyle=`rgba(${e[0]}, ${e[1]}, ${e[2]}, ${t?.5:.2})`;let l=this.cages[i][0]*this.cell_size,h=this.cages[i][1]*this.cell_size,c=this.cages[i][2]*this.cell_size,r=this.cages[i][3]*this.cell_size;this.wilson.ctx.fillRect(h+10,l+10,r-10,c-10),e=this.wilson.utils.hsv_to_rgb(i/this.cages.length*6/7,1,.9),this.wilson.ctx.fillStyle=`rgba(${e[0]}, ${e[1]}, ${e[2]}, 1)`;let a=0===this.cages[i][0]?0:5,g=0===this.cages[i][1]?0:5,$=this.cages[i][0]+this.cages[i][2]===this.grid_size||0===this.cages[i][0]?0:5,n=this.cages[i][1]+this.cages[i][3]===this.grid_size||0===this.cages[i][1]?0:5,w=this.cages[i][0]+this.cages[i][2]===this.grid_size&&0===this.cages[i][0]?5:0,o=this.cages[i][1]+this.cages[i][3]===this.grid_size&&0===this.cages[i][1]?5:0;this.wilson.ctx.fillRect(h+10-g,l+10-a,r-5+n-o,10),this.wilson.ctx.fillRect(h+10-g,l+10-a,10,c-5+$-w),this.wilson.ctx.fillRect(h+r-5-g+n-o,l+10-a,10,c-5+$-w),this.wilson.ctx.fillRect(h+10-g+n,l+c-5-a+$-w,r-5-o,10),setTimeout(()=>this.draw_cage(i+1,s,t),s)}}