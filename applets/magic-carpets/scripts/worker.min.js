"use strict";onmessage=function(e){grid_size=e.data[0],max_cage_size=e.data[1],unique_solution=e.data[2],generate_magic_carpet()};let grid_size=null,max_cage_size=null,unique_solution=null,cages=[],cages_by_location=[],num_solutions_found=0;function generate_magic_carpet(){cages=[],cages_by_location=[],initialize_grid();let e=JSON.parse(JSON.stringify(cages)),i=JSON.parse(JSON.stringify(cages_by_location));for(;;){let s=!1,g=shuffle_array([...Array(cages.length).keys()]);g.sort((e,i)=>cages[e][2]*cages[e][3]-cages[i][2]*cages[i][3]);for(let a=0;a<g.length;a++){let t=g[a];if(expand_cage(t)){for(let r=0;r<g.length;r++)g[r]>=cages.length&&g[r]--;unique_solution?1!==(num_solutions_found=solve_puzzle())?(cages=JSON.parse(JSON.stringify(e)),cages_by_location=JSON.parse(JSON.stringify(i)),num_solutions_found=1):(s=!0,e=JSON.parse(JSON.stringify(cages)),i=JSON.parse(JSON.stringify(cages_by_location))):s=!0}}if(!s||cages.length<=grid_size){postMessage([cages.sort((e,i)=>i[3]*grid_size+i[2]-(e[3]*grid_size+e[2]))]);return}}}function print_grid(){let e="",i=Array(grid_size);for(let s=0;s<grid_size;s++){i[s]=Array(grid_size);for(let g=0;g<grid_size;g++)i[s][g]=0}for(let a=0;a<cages.length;a++){let t=cages[a][0]+cages[a][4],r=cages[a][1]+cages[a][5];i[t][r]=cages[a][2]*cages[a][3]}for(let l=0;l<grid_size;l++){for(let c=0;c<grid_size;c++)e+=`${0!==i[l][c]?i[l][c]:" "} `;e+="\n"}postMessage(e)}function initialize_grid(){cages=Array(grid_size*grid_size),cages_by_location=Array(grid_size);let e=0;for(let i=0;i<grid_size;i++){cages_by_location[i]=Array(grid_size);for(let s=0;s<grid_size;s++)cages[e]=[i,s,1,1,0,0],cages_by_location[i][s]=e,e++}}function shuffle_array(e){let i=e.length;for(;0!==i;){let s=Math.floor(Math.random()*i);i--;let g=e[i];e[i]=e[s],e[s]=g}return e}function expand_cage(e){let i=cages[e],s=i[0],g=i[1],a=i[2],t=i[3],r=i[4],l=i[5],c=[];if(0!==s){let o=cages[cages_by_location[s-1][g]];o[1]===g&&o[3]===t&&o[2]*o[3]+t*a<=max_cage_size&&c.push([1,0])}if(0!==g){let n=cages[cages_by_location[s][g-1]];n[0]===s&&n[2]===a&&n[2]*n[3]+t*a<=max_cage_size&&c.push([0,1])}if(0===c.length)return!1;let f=c[Math.floor(Math.random()*c.length)],$=cages_by_location[s-f[0]][g-f[1]];.5>Math.random()&&(cages[$][4]=cages[$][2]*f[0]+r,cages[$][5]=cages[$][3]*f[1]+l),cages[$][2]+=a*f[0],cages[$][3]+=t*f[1],cages.splice(e,1);for(let u=0;u<grid_size;u++)for(let z=0;z<grid_size;z++)cages_by_location[u][z]===e&&(cages_by_location[u][z]=$),cages_by_location[u][z]>e&&cages_by_location[u][z]--;return!0}function solve_puzzle(){let e=Array(grid_size);for(let i=0;i<grid_size;i++){e[i]=Array(grid_size);for(let s=0;s<grid_size;s++)e[i][s]=!1}for(let g=0;g<cages.length;g++){let a=cages[g][0]+cages[g][4],t=cages[g][1]+cages[g][5];e[a][t]=!0}return solve_puzzle_step(0,e)}function solve_puzzle_step(e,i){if(e===cages.length)return 1;let s=cages[e][0]+cages[e][4],g=cages[e][1]+cages[e][5],a=cages[e][2]*cages[e][3];if(1===a)return solve_puzzle_step(e+1,i);let t=0,r=[];for(let l=1;l<=Math.sqrt(a);l++)a%l==0&&!(l>grid_size)&&!(a/l>grid_size)&&(r.push(l),a/l!==l&&r.push(a/l));return r.forEach(r=>{let l=a/r,c=Math.max(s-r+1,0),o=Math.min(s,grid_size-r),n=Math.max(g-l+1,0),f=Math.min(g,grid_size-l);for(let $=c;$<=o;$++)for(let u=n;u<=f;u++){let z=!1;for(let d=0;d<r;d++){for(let _=0;_<l;_++)if(i[$+d][u+_]&&!($+d===s&&u+_===g)){z=!0;break}if(z)break}if(!z){let p=Array(grid_size);for(let y=0;y<grid_size;y++){p[y]=Array(grid_size);for(let h=0;h<grid_size;h++)p[y][h]=i[y][h]}for(let b=0;b<r;b++)for(let m=0;m<l;m++)p[$+b][u+m]=!0;t+=solve_puzzle_step(e+1,p)}}}),t}