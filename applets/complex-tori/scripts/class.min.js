class EllipticCurve extends Applet{resolution=500;g2=-2;g3=0;lastTimestamp=-1;constructor(a){super(a);this.wilson=new Wilson(a,{renderer:"gpu",shader:"\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform float step;\n\t\t\t\n\t\t\tuniform float g2Arg;\n\t\t\tuniform float g3Arg;\n\t\t\t\n\t\t\tconst int maxIterations = 200;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tfloat f(vec2 z)\n\t\t\t{\n\t\t\t\treturn z.y * z.y   -   z.x * z.x * z.x   -   g2Arg * z.x   -   g3Arg;\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\tfloat threshhold = 4.0 * 1000.0;\n\t\t\t\t\n\t\t\t\tvec2 z = uv * 4.0;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tfor (int i = 0; i < maxIterations; i++)\n\t\t\t\t{\n\t\t\t\t\tfloat score = abs(f(z)) / threshhold;\n\t\t\t\t\t\n\t\t\t\t\tif (score < 1.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tfloat adjacentScore = (abs(f(z + vec2(step, 0.0))) + abs(f(z - vec2(step, 0.0))) + abs(f(z + vec2(0.0, step))) + abs(f(z - vec2(0.0, step)))) / threshhold;\n\t\t\t\t\t\t\n\t\t\t\t\t\tif (adjacentScore >= 6.0)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tgl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n\t\t\t\t\t\t\t\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\t\n\t\t\t\t\tthreshhold /= 1.25;\n\t\t\t\t}\n\t\t\t}\n\t\t",
canvasWidth:this.resolution,canvasHeight:this.resolution,worldWidth:8,worldHeight:8,worldCenterX:0,worldCenterY:0});this.wilson.render.initUniforms(["step","g2Arg","g3Arg"]);this.wilson.gl.uniform1f(this.wilson.uniforms.step,this.wilson.worldWidth/this.resolution);this.wilson.render.loadNewShader("\n\t\t\tprecision highp float;\n\t\t\tprecision highp sampler2D;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform sampler2D uTexture;\n\t\t\t\n\t\t\tuniform float textureStep;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\t//Dilate the pixels to make a thicker line.\n\t\t\t\tvec2 center = (uv + vec2(1.0, 1.0)) / 2.0;\n\t\t\t\t\n\t\t\t\tfloat state = (4.0 * texture2D(uTexture, center).y +\n\t\t\t\t\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, 0.0)).y +\n\t\t\t\t\ttexture2D(uTexture, center - vec2(textureStep, 0.0)).y +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(0.0, textureStep)).y +\n\t\t\t\t\ttexture2D(uTexture, center - vec2(0.0, textureStep)).y +\n\t\t\t\t\t\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, textureStep)).y +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, -textureStep)).y +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(-textureStep, textureStep)).y +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(-textureStep, -textureStep)).y\n\t\t\t\t) / 2.0;\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(state, state, state, 1.0);\n\t\t\t}\n\t\t");
this.wilson.render.initUniforms(["textureStep"]);this.wilson.gl.uniform1f(this.wilson.uniforms.textureStep,1/this.resolution);this.wilson.render.createFramebufferTexturePair();this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null);window.requestAnimationFrame(this.drawFrame.bind(this))}run(a,b){this.g2=a;this.g3=b;window.requestAnimationFrame(this.drawFrame.bind(this))}drawFrame(a){var b=a-this.lastTimestamp;this.lastTimestamp=a;if(0!==b){this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]);
this.wilson.gl.uniform1f(this.wilson.uniforms.g2Arg,this.g2);this.wilson.gl.uniform1f(this.wilson.uniforms.g3Arg,this.g3);this.wilson.render.drawFrame();a=this.wilson.render.getPixelData();b=[];var d=this.resolution,p=this.wilson.canvasWidth;for(var c=2;c<this.wilson.canvasHeight-2;c++)for(var m=2;m<d-2;m++){var e=d*c+m;0!==a[4*e]&&255>=a[4*(e-1)]+a[4*(e+1)]+a[4*(e-d)]+a[4*(e+d)]+a[4*(e-1-d)]+a[4*(e+1-d)]+a[4*(e-1+d)]+a[4*(e+1+d)]&&(0===a[4*(e-2*d-2)]+a[4*(e-2*d-1)]+a[4*(e-2*d)]+a[4*(e-2*d+1)]+a[4*
(e-2*d+2)]+a[4*(e+2*d-2)]+a[4*(e+2*d-1)]+a[4*(e+2*d)]+a[4*(e+2*d+1)]+a[4*(e+2*d+2)]+a[4*(e-d-2)]+a[4*(e-2)]+a[4*(e+d-2)]+a[4*(e-d+2)]+a[4*(e+2)]+a[4*(e+d+2)]?b.push([c,m,!0]):b.push([c,m,!1]))}for(c=0;c<b.length;c++)if(!(b[c][0]<this.wilson.canvasWidth/20||b[c][1]<this.wilson.canvasHeight/20||b[c][0]>19*this.wilson.canvasWidth/20||b[c][1]>19*this.wilson.canvasHeight/20)){m=-1;e=p;b[c][2]||(e=p/20);for(var g=0;g<b.length;g++)if(g!==c){var h=Math.sqrt((b[c][0]-b[g][0])*(b[c][0]-b[g][0])+(b[c][1]-b[g][1])*
(b[c][1]-b[g][1]));if(h<e&&2<=h){let k=(b[g][0]-b[c][0])/h*1.414214,l=(b[g][1]-b[c][1])/h*1.414214;k=Math.sign(k)*Math.floor(Math.abs(k));l=Math.sign(l)*Math.floor(Math.abs(l));let n=0;if(0===k){var f=d*(b[c][0]+k)+(b[c][1]+l);n+=a[4*f];f=d*(b[c][0]+k+1)+(b[c][1]+l);n+=a[4*f];f=d*(b[c][0]+k-1)+(b[c][1]+l);n+=a[4*f]}else 0===l?(f=d*(b[c][0]+k)+(b[c][1]+l),n+=a[4*f],f=d*(b[c][0]+k)+(b[c][1]+l+1),n+=a[4*f],f=d*(b[c][0]+k)+(b[c][1]+l-1),n+=a[4*f]):(f=d*(b[c][0]+k)+(b[c][1]+l),n+=a[4*f],f=d*b[c][0]+(b[c][1]+
l),n+=a[4*f],f=d*(b[c][0]+k)+b[c][1],n+=a[4*f]);0===n&&(m=g,e=h)}}if(-1!==m)for(g=1;g<2*e;g++)h=g/(2*e),h=d*Math.round((1-h)*b[c][0]+h*b[m][0])+Math.round((1-h)*b[c][1]+h*b[m][1]),a[4*h]=0,a[4*h+1]=255,a[4*h+2]=0}this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.wilson.canvasWidth,this.wilson.canvasHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,a);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]);this.wilson.render.drawFrame(a)}}changeResolution(a){this.resolution=
a;this.wilson.changeCanvasSize(this.resolution,this.resolution);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]);this.wilson.gl.uniform1f(this.wilson.uniforms.step,this.wilson.worldWidth/this.resolution);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]);this.wilson.gl.uniform1f(this.wilson.uniforms.textureStep,1/this.resolution);window.requestAnimationFrame(this.drawFrame.bind(this))}};
