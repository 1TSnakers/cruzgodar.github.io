import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{hsvToRgb}from"/scripts/applets/applet.min.js";import{convertColor}from"/scripts/src/browser.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";class Boids extends AnimationFrameApplet{resolution=2e3;numBoids;numBoidsOfPrey;boids=[];boidsOfPrey=[];boidSize=.015;minVelocity;maxVelocity;alignmentRange;alignmentFactor;avoidRange;avoidFactor;centeringFactor;turnFactor;fearFactor;fearRange;preyFactor;preyRange;margin=.02;avoidCycle=0;numAvoidCycles;alignCycle=0;numAlignCycles;frame=0;lastTimeElapseds=Array(16).fill(0);lastTimeElapsed=0;usingCursorAsPredator=!1;cursorPredatorLocation=[0,0];constructor({canvas}){super(canvas);var i={canvasWidth:this.resolution,interactionOptions:{callbacks:{mousedown:this.onGrabCanvas.bind(this),touchstart:this.onGrabCanvas.bind(this),mousedrag:this.onGrabCanvas.bind(this),touchmove:this.onGrabCanvas.bind(this),mouseup:this.onReleaseCanvas.bind(this),touchend:this.onReleaseCanvas.bind(this)}},fullscreenOptions:{fillScreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"},verbose:window.DEBUG};this.wilson=new WilsonCPU(canvas,i)}run({resolution=2e3,numBoids=1e3,numBoidsOfPrey=0,minVelocity=.002,maxVelocity=.004,alignmentRange=.1,alignmentFactor=.05,avoidRange=.0075,avoidFactor=.1,centeringFactor=5e-4,turnFactor=1e-4,fearFactor=.01,fearRange=.1,preyFactor=5e-4,preyRange=.1}){this.resolution=resolution,this.numBoids=numBoids,this.numBoidsOfPrey=numBoidsOfPrey,this.minVelocity=minVelocity,this.maxVelocity=maxVelocity,this.alignmentRange=alignmentRange,this.alignmentFactor=alignmentFactor,this.avoidRange=avoidRange,this.avoidFactor=avoidFactor,this.centeringFactor=centeringFactor,this.turnFactor=turnFactor,this.fearFactor=fearFactor,this.fearRange=fearRange,this.preyFactor=preyFactor,this.preyRange=preyRange,this.setResolution(resolution),this.setNumBoids(numBoids),this.setNumBoidsOfPrey(numBoidsOfPrey),this.resume()}setResolution(resolution){this.resolution=resolution,this.wilson.resizeCanvas({width:this.resolution})}setNumBoids(numBoids){if(this.numBoids=numBoids,this.boids.length>this.numBoids)this.boids.splice(this.numBoids,this.boids.length-this.numBoids);else if(this.boids.length<this.numBoids)for(let i=this.boids.length;i<this.numBoids;i++){var t=this.minVelocity+Math.random()*(this.maxVelocity-this.minVelocity),s=2*Math.random()*Math.PI;this.boids.push({x:(Math.random()-.5)*this.wilson.worldWidth,y:(Math.random()-.5)*this.wilson.worldHeight,vx:Math.cos(s)*t,vy:Math.sin(s)*t})}this.numAvoidCycles=Math.ceil(this.numBoids/200),this.numAlignCycles=Math.ceil(this.numBoids/100)}setNumBoidsOfPrey(numBoidsOfPrey){if(this.numBoidsOfPrey=numBoidsOfPrey,this.boidsOfPrey.length>this.numBoidsOfPrey)this.boidsOfPrey.splice(this.numBoidsOfPrey,this.boidsOfPrey.length-this.numBoidsOfPrey);else if(this.boidsOfPrey.length<this.numBoidsOfPrey)for(let i=this.boidsOfPrey.length;i<this.numBoidsOfPrey;i++){var t=this.minVelocity+Math.random()*(this.maxVelocity-this.minVelocity),s=2*Math.random()*Math.PI;this.boidsOfPrey.push({x:(Math.random()-.5)*this.wilson.worldWidth,y:(Math.random()-.5)*this.wilson.worldHeight,vx:Math.cos(s)*t,vy:Math.sin(s)*t})}}prepareFrame(timeElapsed){this.frame=(this.frame+1)%this.lastTimeElapseds.length,this.lastTimeElapseds[this.frame]=Math.min(timeElapsed,50);for(let i=this.lastTimeElapsed=0;i<this.lastTimeElapseds.length;i++)this.lastTimeElapsed+=this.lastTimeElapseds[i];this.lastTimeElapsed/=this.lastTimeElapseds.length}drawFrame(){this.avoidCycle=(this.avoidCycle+1)%this.numAvoidCycles,this.alignCycle=(this.alignCycle+1)%this.numAlignCycles,this.updateBoids(),this.updateBoidsOfPrey(),this.wilson.ctx.fillStyle="rgb(0, 0, 0)",this.wilson.ctx.fillRect(0,0,this.wilson.canvasWidth,this.wilson.canvasHeight);for(let i=0;i<this.numBoids;i++)this.drawBoid(this.boids[i]);for(let t=0;t<this.numBoidsOfPrey;t++)this.drawBoid(this.boidsOfPrey[t],!0);this.needNewFrame=!0}drawBoid(boid,predator=!1){var i=boid.x,t=boid.y,s=Math.atan2(boid.vy,boid.vx),e=boid.vx*boid.vx+boid.vy*boid.vy,o=predator?2.5:1,a=s/(2*Math.PI)+.5,a=hsvToRgb(predator?.5+a:a,e/(this.maxVelocity*this.maxVelocity),1),e=(this.wilson.ctx.fillStyle=convertColor(...a),s+2*Math.PI/3),a=s+4*Math.PI/3,h=i+2*Math.cos(s)*this.boidSize*o,s=t+2*Math.sin(s)*this.boidSize*o,n=i+Math.cos(e)*this.boidSize*o,e=t+Math.sin(e)*this.boidSize*o,r=i+Math.cos(a)*this.boidSize*o,a=t+Math.sin(a)*this.boidSize*o,o=this.wilson.interpolateWorldToCanvas([i,t]),i=this.wilson.interpolateWorldToCanvas([h,s]),t=this.wilson.interpolateWorldToCanvas([n,e]),h=this.wilson.interpolateWorldToCanvas([r,a]);this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(i[1],i[0]),this.wilson.ctx.lineTo(t[1],t[0]),this.wilson.ctx.lineTo(o[1],o[0]),this.wilson.ctx.lineTo(h[1],h[0]),this.wilson.ctx.closePath(),this.wilson.ctx.fill()}updateBoids(){for(let B=0;B<this.numBoids;B++){var d,c,y,m,v,u=this.boids[B];let i=0,t=0;for(let n=this.avoidCycle;n<this.numBoids;n+=this.numAvoidCycles)B!==n&&(d=u.x-this.boids[n].x,c=u.y-this.boids[n].y,y=Math.sqrt(d*d+c*c),i+=d*Math.exp(-y/this.avoidRange),t+=c*Math.exp(-y/this.avoidRange));u.vx+=i*this.avoidFactor,u.vy+=t*this.avoidFactor,i=0;for(let r=t=0;r<this.numBoidsOfPrey;r++){var x=u.x-this.boidsOfPrey[r].x,g=u.y-this.boidsOfPrey[r].y,p=Math.sqrt(x*x+g*g);i+=x*Math.exp(-p/this.fearRange),t+=g*Math.exp(-p/this.fearRange)}this.usingCursorAsPredator&&(b=u.x-this.cursorPredatorLocation[0],M=u.y-this.cursorPredatorLocation[1],P=Math.sqrt(b*b+M*M),i+=b*Math.exp(-P/this.fearRange),t+=M*Math.exp(-P/this.fearRange)),u.vx+=i*this.fearFactor,u.vy+=t*this.fearFactor;let s=0,e=0,o=0,a=0,h=0;for(let l=this.alignCycle;l<this.numBoids;l+=this.numAlignCycles)B!==l&&(m=u.x-this.boids[l].x,v=u.y-this.boids[l].y,m=Math.sqrt(m*m+v*v),v=Math.exp(-m/this.alignmentRange),s+=this.boids[l].x*v,e+=this.boids[l].y*v,o+=this.boids[l].vx*v,a+=this.boids[l].vy*v,h+=v);0<h&&(u.x+=(s/h-u.x)*this.centeringFactor,u.y+=(e/h-u.y)*this.centeringFactor,u.vx+=(o/h-u.vx)*this.alignmentFactor,u.vy+=(a/h-u.vy)*this.alignmentFactor);var f,b=Math.exp(15*(Math.abs(u.x)-(this.wilson.worldWidth/2-.075))),M=Math.exp(15*(Math.abs(u.y)-(this.wilson.worldHeight/2-.075))),P=(u.vx-=Math.sign(u.x)*b*this.turnFactor,u.vy-=Math.sign(u.y)*M*this.turnFactor,u.vx*u.vx+u.vy*u.vy);P>this.maxVelocity*this.maxVelocity?(f=Math.sqrt(P),u.vx=this.maxVelocity*u.vx/f,u.vy=this.maxVelocity*u.vy/f):P<this.minVelocity*this.minVelocity&&(f=Math.sqrt(P),u.vx=this.minVelocity*u.vx/f,u.vy=this.minVelocity*u.vy/f),u.x+=u.vx*(this.lastTimeElapsed/6.944),u.y+=u.vy*(this.lastTimeElapsed/6.944)}}updateBoidsOfPrey(){for(let w=0;w<this.numBoidsOfPrey;w++){var l,d,c,y,m,v,u,x,g=this.boidsOfPrey[w];let i=0,t=0;for(let a=this.avoidCycle;a<this.numBoids;a+=this.numAvoidCycles){var p=g.x-this.boids[a].x,f=g.y-this.boids[a].y,b=Math.sqrt(p*p+f*f);i+=p*Math.exp(-b/this.preyRange),t+=f*Math.exp(-b/this.preyRange)}g.vx-=i*this.preyFactor,g.vy-=t*this.preyFactor,i=0;for(let h=t=0;h<this.numBoidsOfPrey;h++)w!==h&&(l=g.x-this.boidsOfPrey[h].x,d=g.y-this.boidsOfPrey[h].y,c=Math.sqrt(l*l+d*d),i+=l*Math.exp(-c/this.avoidRange),t+=d*Math.exp(-c/this.avoidRange));g.vx+=i*this.avoidFactor,g.vy+=t*this.avoidFactor,i=0;for(let n=t=0;n<this.numBoidsOfPrey;n++)w!==n&&(y=g.x-this.boidsOfPrey[n].x,m=g.y-this.boidsOfPrey[n].y,v=Math.sqrt(y*y+m*m),i+=y*Math.exp(-v/this.fearRange),t+=m*Math.exp(-v/this.fearRange));this.usingCursorAsPredator&&(P=g.x-this.cursorPredatorLocation[0],B=g.y-this.cursorPredatorLocation[1],F=Math.sqrt(P*P+B*B),i+=P*Math.exp(-F/this.fearRange),t+=B*Math.exp(-F/this.fearRange)),g.vx+=i*this.fearFactor*.05,g.vy+=t*this.fearFactor*.05;let s=0,e=0,o=0;for(let r=this.alignCycle;r<this.numBoids;r+=this.numAlignCycles)w!==r&&(u=g.x-this.boids[r].x,x=g.y-this.boids[r].y,u=Math.sqrt(u*u+x*x),x=Math.exp(-u/(5*this.alignmentRange)),s+=this.boids[r].x*x,e+=this.boids[r].y*x,o+=x);0<o&&(g.x+=(s/o-g.x)*this.centeringFactor*3,g.y+=(e/o-g.y)*this.centeringFactor*3);var M,P=Math.exp(15*(Math.abs(g.x)-(this.wilson.worldWidth/2-.075))),B=Math.exp(15*(Math.abs(g.y)-(this.wilson.worldHeight/2-.075))),F=(g.vx-=Math.sign(g.x)*P*this.turnFactor,g.vy-=Math.sign(g.y)*B*this.turnFactor,g.vx*g.vx+g.vy*g.vy);F>this.maxVelocity*this.maxVelocity?(M=Math.sqrt(F),g.vx=this.maxVelocity*g.vx/M,g.vy=this.maxVelocity*g.vy/M):F<this.minVelocity*this.minVelocity&&(M=Math.sqrt(F),g.vx=this.minVelocity*g.vx/M,g.vy=this.minVelocity*g.vy/M),g.x+=g.vx*(this.lastTimeElapsed/6.944),g.y+=g.vy*(this.lastTimeElapsed/6.944)}}onGrabCanvas({x,y,event}){event.preventDefault(),this.usingCursorAsPredator=!0,this.cursorPredatorLocation=[x,y]}onReleaseCanvas(){this.usingCursorAsPredator=!1}}export{Boids};