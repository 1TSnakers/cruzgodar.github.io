import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{hsvToRgb}from"/scripts/applets/applet.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";class Boids extends AnimationFrameApplet{resolution=2e3;numBoids=500;boids=[];boidSize=.01;minVelocity;maxVelocity;alignmentRange;alignmentFactor;avoidRange;avoidFactor;centeringFactor;turnFactor;margin=.02;avoidCycle=0;numAvoidCycles;alignCycle=0;numAlignCycles;lastTimeElapsed;constructor({canvas}){super(canvas);var i={canvasWidth:this.resolution,fullscreenOptions:{fillScreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}};this.wilson=new WilsonCPU(canvas,i),this.run({}),this.resume()}run({resolution=2e3,numBoids=500,minVelocity=.002,maxVelocity=.004,alignmentRange=.1,alignmentFactor=.05,avoidRange=.01,avoidFactor=.05,centeringFactor=5e-4,turnFactor=4e-5}){this.resolution=resolution,this.numBoids=numBoids,this.minVelocity=minVelocity,this.maxVelocity=maxVelocity,this.alignmentRange=alignmentRange,this.alignmentFactor=alignmentFactor,this.avoidRange=avoidRange,this.avoidFactor=avoidFactor,this.centeringFactor=centeringFactor,this.turnFactor=turnFactor,this.setResolution(resolution),this.setNumBoids(numBoids)}setResolution(resolution){this.resolution=resolution,this.wilson.resizeCanvas({width:this.resolution})}setNumBoids(numBoids){if(this.numBoids=numBoids,this.boids.length>this.numBoids)this.boids.splice(this.numBoids,this.boids.length-this.numBoids);else if(this.boids.length<this.numBoids)for(let i=this.boids.length;i<this.numBoids;i++){var t=this.minVelocity+Math.random()*(this.maxVelocity-this.minVelocity),s=2*Math.random()*Math.PI;this.boids.push({x:(Math.random()-.5)*this.wilson.worldWidth,y:(Math.random()-.5)*this.wilson.worldHeight,vx:Math.cos(s)*t,vy:Math.sin(s)*t})}this.numAvoidCycles=Math.ceil(this.numBoids/200),this.numAlignCycles=Math.ceil(this.numBoids/100)}prepareFrame(timeElapsed){this.lastTimeElapsed=timeElapsed}drawFrame(){this.avoidCycle=(this.avoidCycle+1)%this.numAvoidCycles,this.alignCycle=(this.alignCycle+1)%this.numAlignCycles,this.updateBoids(),this.wilson.ctx.fillStyle="rgb(0, 0, 0)",this.wilson.ctx.fillRect(0,0,this.wilson.canvasWidth,this.wilson.canvasHeight);for(let l=0;l<this.numBoids;l++){var i=this.boids[l],t=i.x,s=i.y,o=Math.atan2(i.vy,i.vx),i=i.vx*i.vx+i.vy*i.vy,i=hsvToRgb(o/(2*Math.PI)+.5,i/(this.maxVelocity*this.maxVelocity),1),i=(this.wilson.ctx.fillStyle=`rgb(${i[0]}, ${i[1]}, ${i[2]})`,o+2*Math.PI/3),e=o+4*Math.PI/3,n=t+2*Math.cos(o)*this.boidSize,o=s+2*Math.sin(o)*this.boidSize,a=t+Math.cos(i)*this.boidSize,i=s+Math.sin(i)*this.boidSize,h=t+Math.cos(e)*this.boidSize,e=s+Math.sin(e)*this.boidSize,t=this.wilson.interpolateWorldToCanvas([t,s]),s=this.wilson.interpolateWorldToCanvas([n,o]),n=this.wilson.interpolateWorldToCanvas([a,i]),o=this.wilson.interpolateWorldToCanvas([h,e]);this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(s[1],s[0]),this.wilson.ctx.lineTo(n[1],n[0]),this.wilson.ctx.lineTo(t[1],t[0]),this.wilson.ctx.lineTo(o[1],o[0]),this.wilson.ctx.closePath(),this.wilson.ctx.fill()}this.needNewFrame=!0}updateBoids(){for(let g=0;g<this.numBoids;g++){var r,c,d,m,v,y=this.boids[g];let i=0,t=0;for(let h=this.avoidCycle;h<this.numBoids;h+=this.numAvoidCycles)g!==h&&(r=y.x-this.boids[h].x,c=y.y-this.boids[h].y,d=Math.sqrt(r*r+c*c),i+=r*Math.exp(-d/this.avoidRange),t+=c*Math.exp(-d/this.avoidRange));y.vx+=i*this.avoidFactor,y.vy+=t*this.avoidFactor;let s=0,o=0,e=0,n=0,a=0;for(let l=this.alignCycle;l<this.numBoids;l+=this.numAlignCycles)g!==l&&(m=y.x-this.boids[l].x,v=y.y-this.boids[l].y,m=Math.sqrt(m*m+v*v),v=Math.exp(-m/this.alignmentRange),s+=this.boids[l].x*v,o+=this.boids[l].y*v,e+=this.boids[l].vx*v,n+=this.boids[l].vy*v,a+=v);0<a&&(y.x+=(s/a-y.x)*this.centeringFactor,y.y+=(o/a-y.y)*this.centeringFactor,y.vx+=(e/a-y.vx)*this.alignmentFactor,y.vy+=(n/a-y.vy)*this.alignmentFactor);var u=Math.exp(50*(Math.abs(y.x)-(this.wilson.worldWidth/2-.075))),x=Math.exp(50*(Math.abs(y.y)-(this.wilson.worldHeight/2-.075))),u=(y.vx-=Math.sign(y.x)*u*this.turnFactor,y.vy-=Math.sign(y.y)*x*this.turnFactor,y.vx*y.vx+y.vy*y.vy);u>this.maxVelocity*this.maxVelocity?(x=Math.sqrt(u),y.vx=this.maxVelocity*y.vx/x,y.vy=this.maxVelocity*y.vy/x):u<this.minVelocity*this.minVelocity&&(x=Math.sqrt(u),y.vx=this.minVelocity*y.vx/x,y.vy=this.minVelocity*y.vy/x),y.x+=y.vx*(this.lastTimeElapsed/6.944),y.y+=y.vy*(this.lastTimeElapsed/6.944)}}}export{Boids};