import{Applet}from"../../../scripts/applets/applet.min.js";import{convertColor}from"/scripts/src/browser.min.js";import{addTemporaryWorker}from"/scripts/src/main.min.js";import{Wilson}from"/scripts/wilson.min.js";class FiniteSubdivision extends Applet{resolution=1e3;numVertices=6;numIterations=5;webWorker;polygons;constructor({canvas}){super(canvas);var s={renderer:"cpu",canvasWidth:this.resolution,canvasHeight:this.resolution,useDraggables:!0,draggablesMousemoveCallback:this.onDragDraggable.bind(this),draggablesTouchmoveCallback:this.onDragDraggable.bind(this),draggablesMouseupCallback:this.onReleaseDraggable.bind(this),draggablesTouchendCallback:this.onReleaseDraggable.bind(this),useFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"};this.wilson=new Wilson(canvas,s)}run({numVertices,numIterations,maximumSpeed}){try{this.webWorker.terminate()}catch(s){}this.numVertices=numVertices,this.numIterations=Math.min(numIterations,9),this.resolution=3e3,this.maximumSpeed=maximumSpeed,this.wilson.changeCanvasSize(this.resolution,this.resolution),this.wilson.ctx.lineWidth=10-this.numIterations;for(const s of this.wilson.draggables.draggables)s.remove();this.wilson.draggables.numDraggables=0,this.wilson.draggables.draggables=[],this.polygons=this.getDefaultPolygons();for(const t of this.polygons[0])this.wilson.draggables.add(...this.wilson.utils.interpolate.canvasToWorld(t[0],t[1]));this.drawOuterPolygon(),this.onReleaseDraggable()}onDragDraggable(activeDraggable,x,y){try{this.webWorker.terminate()}catch(s){}this.polygons[0][activeDraggable]=this.wilson.utils.interpolate.worldToCanvas(x,y),this.drawOuterPolygon()}onReleaseDraggable(){this.webWorker=addTemporaryWorker("/applets/finite-subdivisions/scripts/worker.js"),this.webWorker.onmessage=e=>{this.wilson.ctx.strokeStyle=convertColor(...e.data[4]),this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(e.data[1],e.data[0]),this.wilson.ctx.lineTo(e.data[3],e.data[2]),this.wilson.ctx.stroke()},this.webWorker.postMessage([this.numIterations,this.maximumSpeed,this.polygons])}getDefaultPolygons(){var s=[[]],t=2*Math.floor(this.numVertices/2)*Math.PI/this.numVertices,e=this.resolution/2-this.resolution/2.5,t=this.resolution/2-this.resolution/2.5*Math.cos(t),e=e+(this.resolution-t),i=Math.floor(e/2+this.resolution/2.5),o=Math.floor(this.resolution/2);for(let a=0;a<this.numVertices;a++){var r=a/this.numVertices*2*Math.PI,n=Math.floor(-Math.cos(r)*this.resolution/2.5+i),r=Math.floor(Math.sin(r)*this.resolution/2.5+o);s[0].push([n,r])}return s}drawOuterPolygon(){this.wilson.ctx.fillStyle=convertColor(0,0,0),this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution);for(let t=0;t<this.numVertices;t++){var s=this.wilson.utils.hsvToRgb((2*t+1)/(2*this.numVertices),1,1);this.wilson.ctx.strokeStyle=convertColor(...s),this.wilson.ctx.beginPath(),this.wilson.ctx.moveTo(this.polygons[0][t][1],this.polygons[0][t][0]),this.wilson.ctx.lineTo(this.polygons[0][(t+1)%this.numVertices][1],this.polygons[0][(t+1)%this.numVertices][0]),this.wilson.ctx.stroke()}}}export{FiniteSubdivision};