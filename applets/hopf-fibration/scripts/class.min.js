import anime from"/scripts/anime.min.js";import{tempShader}from"/scripts/applets/applet.min.js";import{magnitude}from"/scripts/applets/raymarchApplet.min.js";import{ThreeApplet}from"/scripts/applets/threeApplet.min.js";import*as THREE from"/scripts/three.js";import{WilsonGPU}from"/scripts/wilson.min.js";function hsvToRgb(h,s,v){function t(n){var t=(n+6*h)%6;return v-v*s*Math.max(0,Math.min(t,Math.min(4-t,1)))}return[255*t(5),255*t(3),255*t(1)]}class Fiber extends THREE.Curve{p;v;center;s3P;s3V;compression;constructor({p,v,center,s3P,s3V,compression}){super(),this.p=p,this.v=v,this.center=center,this.s3P=s3P,this.s3V=s3V,this.compression=compression}getPoint(t,optionalTarget=new THREE.Vector3){var e=Math.cos(2*Math.PI*t),s=Math.sin(2*Math.PI*t),i=e*this.p[0]+s*this.v[0]+this.center[0],n=e*this.p[1]+s*this.v[1]+this.center[1],a=e*this.p[2]+s*this.v[2]+this.center[2],r=e*this.s3P[3]+s*this.s3V[3],r=Math.acos(r)/(Math.PI*Math.sqrt(1-r*r)),o=r*(e*this.s3P[0]+s*this.s3V[0]),h=r*(e*this.s3P[1]+s*this.s3V[1]),r=r*(e*this.s3P[2]+s*this.s3V[2]),e=(1-this.compression)*i+this.compression*o,s=(1-this.compression)*n+this.compression*h,i=(1-this.compression)*a+this.compression*r;return optionalTarget.set(i,s,e)}}class HopfFibration extends ThreeApplet{theta=Math.PI/2;phi=Math.PI/2;worldSize=1.5;movingSpeed=.01;imageSize=1e3;compression=0;numLatitudes=3;numLongitudesPerLatitude=50;numLongitudesShown=37.5;fibers=[];needDownload=!1;constructor({canvas}){super({canvas:canvas,cameraPos:[0,-4,0]});var t={shader:tempShader,canvasWidth:this.imageSize,worldWidth:this.worldSize,worldHeight:this.worldSize,worldCenterX:this.theta,worldCenterY:this.phi,minWorldY:.001-this.worldSize/2,maxWorldY:Math.PI-.001+this.worldSize/2,onResizeCanvas:this.onResizeCanvas.bind(this),interactionOptions:{useForPanAndZoom:!0,disallowZooming:!0,onPanAndZoom:()=>this.needNewFrame=!0},fullscreenOptions:{fillScreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}},t=(this.wilson=new WilsonGPU(canvas,t),this.initThree(),new THREE.PointLight(16777215,1,1e4)),t=(t.position.set(-750,-1e3,500),this.scene.add(t),new THREE.PointLight(16777215,.5,1e4));t.position.set(750,1e3,500),this.scene.add(t),this.toggleCompression(!0),this.resume()}createFiber(theta,phi){var t=[Math.sin(phi)*Math.cos(theta),Math.sin(phi)*Math.sin(theta),Math.cos(phi)],e=1/Math.sqrt(2*(t[2]+1)),s=[0,e*t[0],e*t[1],e*(1+t[2])],i=[s[0]/(1-s[3]),s[1]/(1-s[3]),s[2]/(1-s[3])],n=[-s[0]/(1+s[3]),-s[1]/(1+s[3]),-s[2]/(1+s[3])],n=[(i[0]+n[0])/2,(i[1]+n[1])/2,(i[2]+n[2])/2],a=Math.sqrt((i[0]-n[0])**2+(i[1]-n[1])**2+(i[2]-n[2])**2),e=[e*(1+t[2]),-e*t[1],e*t[0],0],t=[e[0]/(1-e[3]),e[1]/(1-e[3]),e[2]/(1-e[3])],i=[i[0]-n[0],i[1]-n[1],i[2]-n[2]],t=[t[0]-n[0],t[1]-n[1],t[2]-n[2]],r=(t[0]*i[0]+t[1]*i[1]+t[2]*i[2])/(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),t=[t[0]-r*i[0],t[1]-r*i[1],t[2]-r*i[2]],r=Math.sqrt(t[0]**2+t[1]**2+t[2]**2),a=[a/r*t[0],a/r*t[1],a/r*t[2]],r=new Fiber({p:i,v:a,center:n,s3P:s,s3V:e,compression:this.compression}),t=.05*(1-this.compression)+this.compression*(.115/Math.sqrt(this.numLatitudes*this.numLongitudesPerLatitude)),i=.2+.7*Math.abs((theta+Math.PI/2)%Math.PI-Math.PI/2)/(Math.PI/2),a=hsvToRgb(phi/Math.PI,i,1),n=new THREE.TubeGeometry(r,100,t,20,!1),s=new THREE.MeshStandardMaterial({color:new THREE.Color(a[0]/255,a[1]/255,a[2]/255)}),e=(s.transparent=!0,new THREE.Mesh(n,s));return this.scene.add(e),e}createLongitudinalConnector(radius,startAngle,endAngle,addCaps=!1){var t=.05*(1-this.compression)+this.compression*(.115/Math.sqrt(this.numLatitudes*this.numLongitudesPerLatitude)),e=[];for(let r=0;r<=64;r++){var s=startAngle+r/64*(endAngle-startAngle);e.push(new THREE.Vector3(Math.cos(s)*radius,Math.sin(s)*radius,0))}var i=new THREE.CatmullRomCurve3(e,!1),i=new THREE.TubeGeometry(i,64,t,8,!1),n=new THREE.MeshStandardMaterial({color:255}),i=new THREE.Mesh(i,n),n=new THREE.MeshStandardMaterial({color:255}),t=new THREE.CylinderGeometry(t,t,.1,32),a=new THREE.Mesh(t,n),t=(a.position.copy(e[0]),a.lookAt(e[1]),new THREE.Mesh(t,n));t.position.copy(e[e.length-1]),t.lookAt(e[e.length-2]),addCaps&&(this.scene.add(a),this.scene.add(t)),this.scene.add(i)}createDepthConnector(startDistance,endDistance,angle){var t=new THREE.Vector3(startDistance*Math.sin(angle),startDistance*Math.cos(angle),0),e=new THREE.Vector3(endDistance*Math.sin(angle),endDistance*Math.cos(angle),0),t=new THREE.LineCurve3(t,e),e=.05*(1-this.compression)+this.compression*(.115/Math.sqrt(this.numLatitudes*this.numLongitudesPerLatitude)),t=new THREE.TubeGeometry(t,64,e,8,!1),e=new THREE.MeshStandardMaterial({color:16711680}),t=new THREE.Mesh(t,e);this.scene.add(t)}createAllFibers(){for(const t of this.fibers)t.geometry.dispose(),t.material.dispose(),this.scene.remove(t);this.fibers=[];var e=Math.floor((this.numLongitudesPerLatitude-this.numLongitudesShown)/2);for(let n=0;n<this.numLatitudes;n++){var s,i=(n+1)/(this.numLatitudes+1)*Math.PI;for(let t=0;t<this.numLongitudesPerLatitude;t++)t<e||t>=this.numLongitudesPerLatitude-e||(s=(t+.5)/this.numLongitudesPerLatitude*2*Math.PI,s=this.createFiber(s,i),this.fibers.push(s))}this.createLongitudinalConnector(.875,-2*Math.PI*.125+.09,2*Math.PI*.625-.09,!1),this.createLongitudinalConnector(.75,-2*Math.PI*.125+.09,2*Math.PI*.625-.09,!1),this.createLongitudinalConnector(.625,-2*Math.PI*.125+.09,2*Math.PI*.625-.09,!1),this.createDepthConnector(.875,.625,-Math.PI/12+2*Math.PI/25*1),this.createDepthConnector(.875,.625,-Math.PI/12+2*Math.PI/25*7),this.createDepthConnector(.875,.625,-Math.PI/12+2*Math.PI/25*-5),this.needNewFrame=!0}async toggleCompression(instant){const t={t:0},e=this.compression,s=0===this.compression?1:0;var i=Math.sqrt(this.cameraPos[0]**2+this.cameraPos[1]**2+this.cameraPos[2]**2),i=0===this.compression?1.32/i:4/i;const n=[...this.cameraPos],a=[this.cameraPos[0]*i,this.cameraPos[1]*i,this.cameraPos[2]*i];await anime({targets:t,t:1,duration:instant?0:750,easing:"easeOutQuad",update:()=>{this.compression=(1-t.t)*e+t.t*s,this.cameraPos=[(1-t.t)*n[0]+t.t*a[0],(1-t.t)*n[1]+t.t*a[1],(1-t.t)*n[2]+t.t*a[2]],this.distanceFromOrigin=magnitude(this.cameraPos),this.createAllFibers(),this.needNewFrame=!0},complete:()=>{this.compression=s,this.cameraPos=a,this.distanceFromOrigin=magnitude(this.cameraPos),this.createAllFibers(),this.needNewFrame=!0}}).finished}prepareFrame(timeElapsed){this.moveUpdate(timeElapsed)}drawFrame(){this.theta=this.lockedOnOrigin?this.wilson.worldCenterX:2*Math.PI-this.wilson.worldCenterX,this.phi=this.lockedOnOrigin?this.wilson.worldCenterY:Math.PI-this.wilson.worldCenterY,this.renderer.render(this.scene,this.camera),this.needDownload&&(this.needDownload=!1,this.wilson.canvas.toBlob(blob=>{var t=document.createElement("a");t.download="the-hopf-fibration.png",t.href=window.URL.createObjectURL(blob),t.click(),t.remove()}))}onResizeCanvas(){this.renderer.setSize(this.wilson.canvasWidth,this.wilson.canvasHeight,!1),this.camera.aspect=this.wilson.canvasWidth/this.wilson.canvasHeight,this.camera.updateProjectionMatrix(),this.wilson.resizeWorld({minWorldY:.001-this.wilson.worldHeight/2,maxWorldY:Math.PI-.001+this.wilson.worldHeight/2}),this.needNewFrame=!0}}export{HopfFibration};