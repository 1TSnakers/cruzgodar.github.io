import{Applet}from"../../../scripts/applets/applet.min.js";import anime from"/scripts/anime.min.js";import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{changeOpacity}from"/scripts/src/animation.min.js";import{addTemporaryListener}from"/scripts/src/main.min.js";import{Wilson}from"/scripts/wilson.min.js";class NewtonsMethod extends AnimationFrameApplet{wilsonHidden;rootSetterElement;rootAInput;rootBInput;colorSetterElement;a=[1,0];c=[0,0];colors=[];currentRoots=[];lastActiveRoot=0;numRoots=0;aspectRatio=1;numIterations=100;secantProportion=0;pastBrightnessScales=[];resolution=500;resolutionHidden=100;constructor({canvas,rootSetterElement,rootAInput,rootBInput,colorSetterElement}){super(canvas),this.rootSetterElement=rootSetterElement,this.rootAInput=rootAInput,this.rootBInput=rootBInput,this.colorSetterElement=colorSetterElement;var t=this.createHiddenCanvas(),o=`
			precision highp float;
			
			varying vec2 uv;
			
			uniform float aspectRatio;
			
			uniform float worldCenterX;
			uniform float worldCenterY;
			uniform float worldSize;
			
			uniform int numRoots;
			
			uniform vec2 roots[11];
			
			uniform vec3 colors[11];
			
			uniform vec2 a;
			uniform vec2 c;
			
			uniform float brightnessScale;

			uniform float secantProportion;
			
			const float derivativePrecision = 6.0;
			
			const float threshhold = .05;
			
			
			
			//Returns z1 * z2.
			vec2 cmul(vec2 z1, vec2 z2)
			{
				return vec2(z1.x * z2.x - z1.y * z2.y, z1.x * z2.y + z1.y * z2.x);
			}
			
			
			
			//Returns 1/z.
			vec2 cinv(vec2 z)
			{
				float magnitude = z.x*z.x + z.y*z.y;
				
				return vec2(z.x / magnitude, -z.y / magnitude);
			}
			
			
			
			//Returns f(z) for a polynomial f with given roots.
			vec2 cpoly(vec2 z)
			{
				vec2 result = vec2(1.0, 0.0);
				
				for (int i = 0; i <= 11; i++)
				{
					if (i == numRoots)
					{
						return result;
					}
					
					result = cmul(result, z - roots[i]);
				}
			}
			
			
			
			//Approximates f'(z) for a polynomial f with given roots.
			vec2 cderiv(vec2 z)
			{
				return derivativePrecision * (cpoly(z + vec2(1.0 / (2.0*derivativePrecision), 0.0)) - cpoly(z - vec2(1.0 / (2.0*derivativePrecision), 0.0)));
			}
			
			
			
			void main(void)
			{
				vec2 z;
				vec2 lastZ = vec2(0.0, 0.0);
				
				if (aspectRatio >= 1.0)
				{
					z = vec2(uv.x * aspectRatio * worldSize + worldCenterX, uv.y * worldSize + worldCenterY);
				}
				
				else
				{
					z = vec2(uv.x * worldSize + worldCenterX, uv.y / aspectRatio * worldSize + worldCenterY);
				}
				
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
				
				
				
				for (int iteration = 0; iteration < 100; iteration++)
				{
					vec2 temp = mix(
						cmul(cmul(cpoly(z), cinv(cderiv(z))), a) + c,
						cmul(cmul(cpoly(z), cmul(z - lastZ, cinv(cpoly(z) - cpoly(lastZ)))), a) + c,
						secantProportion
					);
					
					lastZ = z;
					
					z -= temp;
					
					
					
					for (int i = 0; i <= 11; i++)
					{
						if (i == numRoots)
						{
							break;
						}
						
						float d0 = length(z - roots[i]);
						
						if (d0 < threshhold)
						{
							float d1 = length(lastZ - roots[i]);
							
							float brightnessAdjust = (log(threshhold) - log(d0)) / (log(d1) - log(d0));
							
							float brightness = 1.0 - (float(iteration) - brightnessAdjust) / brightnessScale;
							
							gl_FragColor = vec4(colors[i] * brightness, 1.0);
							
							return;
						}
					}
				}
			}
		`,s={renderer:"gpu",shader:o,canvasWidth:500,canvasHeight:500,worldWidth:3,worldHeight:3,worldCenterX:0,worldCenterY:0,useDraggables:!0,draggablesMousemoveCallback:this.onDragDraggable.bind(this),draggablesTouchmoveCallback:this.onDragDraggable.bind(this),draggablesMouseupCallback:this.onReleaseDraggable.bind(this),draggablesTouchendCallback:this.onReleaseDraggable.bind(this),useFullscreen:!0,trueFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",switchFullscreenCallback:()=>this.changeAspectRatio(!0),mousedownCallback:this.onGrabCanvas.bind(this),touchstartCallback:this.onGrabCanvas.bind(this),mousedragCallback:this.onDragCanvas.bind(this),touchmoveCallback:this.onDragCanvas.bind(this),mouseupCallback:this.onReleaseCanvas.bind(this),touchendCallback:this.onReleaseCanvas.bind(this),wheelCallback:this.onWheelCanvas.bind(this),pinchCallback:this.onPinchCanvas.bind(this)},o={renderer:"gpu",shader:o,canvasWidth:this.resolutionHidden,canvasHeight:this.resolutionHidden};this.wilson=new Wilson(canvas,s),this.wilson.render.initUniforms(["aspectRatio","worldCenterX","worldCenterY","worldSize","numRoots","roots","colors","a","c","brightnessScale","secantProportion"]),this.wilsonHidden=new Wilson(t,o),this.wilsonHidden.render.initUniforms(["aspectRatio","worldCenterX","worldCenterY","worldSize","numRoots","roots","colors","a","c","brightnessScale","secantProportion"]);addTemporaryListener({object:window,event:"resize",callback:()=>this.changeAspectRatio(!0)});let i=this.wilson.draggables.add(1,0);i.classList.add("a-marker"),(i=this.wilson.draggables.add(0,0)).classList.add("c-marker"),this.addRoot(),this.addRoot(),this.addRoot(),this.spreadRoots(!0),this.zoom.init(),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatio,1),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.aspectRatio,1),this.colors=[216/255,1/255,42/255,1,139/255,56/255,249/255,239/255,20/255,27/255,181/255,61/255,0,86/255,195/255,154/255,82/255,164/255,32/255,32/255,32/255,155/255,92/255,15/255,182/255,228/255,254/255,250/255,195/255,218/255,1,1,1],this.wilson.gl.uniform3fv(this.wilson.uniforms.colors,this.colors),this.wilsonHidden.gl.uniform3fv(this.wilsonHidden.uniforms.colors,this.colors),this.resume()}switchMethod(){const t={t:this.secantProportion};var o=0===this.secantProportion?1:0;anime({targets:t,t:o,duration:1e3,easing:"easeInOutQuad",update:()=>{this.secantProportion=t.t,this.needNewFrame=!0}})}addRoot(){var t,o;11!==this.numRoots&&(t=3*Math.random()-1.5,o=3*Math.random()-1.5,this.wilson.draggables.add(t,o),this.currentRoots.push(t),this.currentRoots.push(o),this.numRoots++,this.needNewFrame=!0)}removeRoot(){1!==this.numRoots&&(this.numRoots--,this.currentRoots.pop(),this.currentRoots.pop(),this.wilson.draggables.draggables[this.numRoots+2].remove(),this.wilson.draggables.draggables.pop(),this.wilson.draggables.worldCoordinates.pop(),this.wilson.draggables.numDraggables--,this.needNewFrame=!0)}spreadRoots(noAnimation=!1,randomize=!1){const o=[...this.currentRoots],s=new Array(2*this.numRoots);for(let e=0;e<this.numRoots;e++){var t=1+.75*randomize*Math.random();s[2*e]=t*Math.cos(2*Math.PI*e/this.numRoots),s[2*e+1]=t*Math.sin(2*Math.PI*e/this.numRoots)}const i={t:0};anime({targets:i,t:1,duration:1e3*!noAnimation,easing:"easeInOutQuad",update:()=>{for(let t=0;t<this.numRoots;t++)this.currentRoots[2*t]=(1-i.t)*o[2*t]+i.t*s[2*t],this.currentRoots[2*t+1]=(1-i.t)*o[2*t+1]+i.t*s[2*t+1],this.wilson.draggables.worldCoordinates[t+2]=[this.currentRoots[2*t],this.currentRoots[2*t+1]];this.needNewFrame=!0},complete:()=>{for(let t=0;t<this.numRoots;t++)this.currentRoots[2*t]=s[2*t],this.currentRoots[2*t+1]=s[2*t+1],this.wilson.draggables.worldCoordinates[t+2]=[this.currentRoots[2*t],this.currentRoots[2*t+1]];this.needNewFrame=!0}})}setRoot(x,y){0===this.lastActiveRoot?(this.a[0]=x,this.a[1]=y,this.wilson.draggables.worldCoordinates[0]=[this.a[0],this.a[1]]):1===this.lastActiveRoot?(this.c[0]=x,this.c[1]=y,this.wilson.draggables.worldCoordinates[1]=[this.c[0],this.c[1]]):(this.currentRoots[2*(this.lastActiveRoot-2)]=x,this.currentRoots[2*(this.lastActiveRoot-2)+1]=y,this.wilson.draggables.worldCoordinates[this.lastActiveRoot]=[this.currentRoots[2*(this.lastActiveRoot-2)],this.currentRoots[2*(this.lastActiveRoot-2)+1]]),this.wilson.draggables.recalculateLocations(),this.needNewFrame=!0}setColor(hex){if(!(this.lastActiveRoot<2)){const i=this.lastActiveRoot-2,e=Applet.hexToRgb(hex);var t=e.r/255,o=e.g/255,s=e.b/255;e.r=this.colors[3*i],e.g=this.colors[3*i+1],e.b=this.colors[3*i+2],anime({targets:e,r:t,g:o,b:s,easing:"easeInOutQuad",duration:250,update:()=>{this.colors[3*i]=e.r,this.colors[3*i+1]=e.g,this.colors[3*i+2]=e.b,this.wilson.gl.uniform3fv(this.wilson.uniforms.colors,this.colors),this.wilsonHidden.gl.uniform3fv(this.wilsonHidden.uniforms.colors,this.colors),this.needNewFrame=!0}})}}onDragDraggable(activeDraggable,x,y){0===activeDraggable?this.a=[x,y]:1===activeDraggable?this.c=[x,y]:(this.currentRoots[2*(activeDraggable-2)]=x,this.currentRoots[2*(activeDraggable-2)+1]=y),this.needNewFrame=!0}async onReleaseDraggable(activeDraggable){var t;this.lastActiveRoot=activeDraggable,this.rootSetterElement&&this.colorSetterElement&&(await Promise.all([changeOpacity(this.rootSetterElement,0),changeOpacity(this.colorSetterElement,0)]),0===this.lastActiveRoot?(this.rootAInput.setValue(Math.round(1e3*this.a[0])/1e3,!1),this.rootBInput.setValue(Math.round(1e3*this.a[1])/1e3,!1)):1===this.lastActiveRoot?(this.rootAInput.setValue(Math.round(1e3*this.c[0])/1e4,!1),this.rootBInput.setValue(Math.round(1e3*this.c[1])/1e4,!1)):(t=this.lastActiveRoot-2,this.rootAInput.setValue(Math.round(1e3*this.currentRoots[2*t])/1e3,!1),this.rootBInput.setValue(Math.round(1e3*this.currentRoots[2*t+1])/1e3,!1),this.colorSetterElement.value=Applet.rgbToHex(255*this.colors[3*t],255*this.colors[3*t+1],255*this.colors[3*t+2])),changeOpacity(this.rootSetterElement,1),changeOpacity(this.colorSetterElement,1))}prepareFrame(timeElapsed){this.pan.update(timeElapsed),this.zoom.update(timeElapsed)}drawFrame(){this.wilson.draggables.recalculateLocations(),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.aspectRatio,this.aspectRatio),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.worldCenterX,this.wilson.worldCenterX),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.worldCenterY,this.wilson.worldCenterY),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.worldSize,Math.min(this.wilson.worldHeight,this.wilson.worldWidth)/2),this.wilsonHidden.gl.uniform1i(this.wilsonHidden.uniforms.numRoots,this.numRoots),this.wilsonHidden.gl.uniform2fv(this.wilsonHidden.uniforms.roots,this.currentRoots),this.wilsonHidden.gl.uniform2fv(this.wilsonHidden.uniforms.a,this.a),this.wilsonHidden.gl.uniform2f(this.wilsonHidden.uniforms.c,this.c[0]/10,this.c[1]/10),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.brightnessScale,30),this.wilsonHidden.gl.uniform1f(this.wilsonHidden.uniforms.secantProportion,this.secantProportion),this.wilsonHidden.render.drawFrame();var t=this.wilsonHidden.render.getPixelData(),o=new Array(this.resolutionHidden*this.resolutionHidden);for(let e=0;e<this.resolutionHidden*this.resolutionHidden;e++)o[e]=Math.max(Math.max(t[4*e],t[4*e+1]),t[4*e+2]);o.sort((a,b)=>a-b);var s=Math.min(1e4/(o[Math.floor(this.resolutionHidden*this.resolutionHidden*.96)]+o[Math.floor(this.resolutionHidden*this.resolutionHidden*.98)]),200),i=(this.pastBrightnessScales.push(s),this.pastBrightnessScales.length);10<i&&this.pastBrightnessScales.shift(),s=Math.max(this.pastBrightnessScales.reduce((a,b)=>a+b)/i,.5),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatio,this.aspectRatio),this.wilson.gl.uniform1f(this.wilson.uniforms.worldCenterX,this.wilson.worldCenterX),this.wilson.gl.uniform1f(this.wilson.uniforms.worldCenterY,this.wilson.worldCenterY),this.wilson.gl.uniform1f(this.wilson.uniforms.worldSize,Math.min(this.wilson.worldHeight,this.wilson.worldWidth)/2),this.wilson.gl.uniform1i(this.wilson.uniforms.numRoots,this.numRoots),this.wilson.gl.uniform2fv(this.wilson.uniforms.roots,this.currentRoots),this.wilson.gl.uniform2fv(this.wilson.uniforms.a,this.a),this.wilson.gl.uniform2f(this.wilson.uniforms.c,this.c[0]/10,this.c[1]/10),this.wilson.gl.uniform1f(this.wilson.uniforms.brightnessScale,s),this.wilson.gl.uniform1f(this.wilson.uniforms.secantProportion,this.secantProportion),this.wilson.render.drawFrame()}}export{NewtonsMethod};