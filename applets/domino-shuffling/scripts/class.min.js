class DominoShuffling extends Applet{resolution=2e3;diamond_size=20;use_smooth_colors=!0;margin_size=.05;aztec_diamond=[];new_diamond=[];hue=[];new_hue=[];age=[];new_age=[];current_diamond_size=1;frame=0;frames_per_animation_step=1;draw_diamond_with_holes=!0;last_timestamp=-1;starting_process_id=null;constructor(i){super(i);let s={renderer:"cpu",canvas_width:this.resolution,canvas_height:this.resolution,use_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png"};this.wilson=new Wilson(this.canvas,s)}run(i,s,t){this.starting_process_id=Site.applet_process_id,this.resolution=i,this.wilson.change_canvas_size(this.resolution,this.resolution),this.diamond_size=s,this.frames_per_animation_step=Math.ceil(100/this.diamond_size),this.diamond_size>30?this.draw_diamond_with_holes=!1:this.draw_diamond_with_holes=!0,this.use_smooth_colors=t,this.aztec_diamond=Array(2*this.diamond_size),this.new_diamond=Array(2*this.diamond_size),this.age=Array(2*this.diamond_size),this.new_age=Array(2*this.diamond_size),this.hue=Array(2*this.diamond_size),this.new_hue=Array(2*this.diamond_size);for(let e=0;e<2*this.diamond_size;e++){this.aztec_diamond[e]=Array(2*this.diamond_size),this.new_diamond[e]=Array(2*this.diamond_size),this.age[e]=Array(2*this.diamond_size),this.new_age[e]=Array(2*this.diamond_size),this.hue[e]=Array(2*this.diamond_size),this.new_hue[e]=Array(2*this.diamond_size);for(let d=0;d<2*this.diamond_size;d++)this.aztec_diamond[e][d]=0,this.age[e][d]=0,this.hue[e][d]=0}.5>Math.random()?(this.aztec_diamond[this.diamond_size-1][this.diamond_size-1]=-1,this.aztec_diamond[this.diamond_size][this.diamond_size-1]=1,this.age[this.diamond_size-1][this.diamond_size-1]=1,this.age[this.diamond_size][this.diamond_size-1]=1,this.use_smooth_colors?(this.hue[this.diamond_size-1][this.diamond_size-1]=.75-Math.atan2(-.5,-.5)/(2*Math.PI),this.hue[this.diamond_size][this.diamond_size-1]=.75-Math.atan2(.5,-.5)/(2*Math.PI)):(this.hue[this.diamond_size-1][this.diamond_size-1]=0,this.hue[this.diamond_size][this.diamond_size-1]=.5)):(this.aztec_diamond[this.diamond_size-1][this.diamond_size-1]=-2,this.aztec_diamond[this.diamond_size-1][this.diamond_size]=2,this.age[this.diamond_size-1][this.diamond_size-1]=1,this.age[this.diamond_size-1][this.diamond_size]=1,this.use_smooth_colors?(this.hue[this.diamond_size-1][this.diamond_size-1]=.75-Math.atan2(-.5,-.5)/(2*Math.PI),this.hue[this.diamond_size-1][this.diamond_size]=.75-Math.atan2(-.5,.5)/(2*Math.PI)):(this.hue[this.diamond_size-1][this.diamond_size-1]=.25,this.hue[this.diamond_size-1][this.diamond_size]=.75)),this.current_diamond_size=1,this.frame=this.frames_per_animation_step-1,window.requestAnimationFrame(this.draw_frame.bind(this))}draw_frame(i){let s=i-this.last_timestamp;if(this.last_timestamp=i,0!==s){if(this.frame++,this.frame===this.frames_per_animation_step&&(this.frame=0,this.move_dominos(),this.fill_spaces(),this.wilson.ctx.fillStyle="rgb(0, 0, 0)",this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution),this.draw_diamond()),this.starting_process_id!==Site.applet_process_id){console.log("Terminated applet process");return}if(0===this.frame&&this.current_diamond_size===this.diamond_size-1){this.wilson.ctx.fillStyle="rgb(0, 0, 0)",this.wilson.ctx.fillRect(0,0,this.resolution,this.resolution),this.draw_diamond();return}window.requestAnimationFrame(this.draw_frame.bind(this))}}draw_diamond(){for(let i=-this.current_diamond_size;i<this.current_diamond_size;i++)for(let s=-this.current_diamond_size;s<this.current_diamond_size;s++){let t=i+this.diamond_size,e=s+this.diamond_size;0!==this.aztec_diamond[t][e]&&(1===Math.abs(this.aztec_diamond[t][e])?this.draw_domino(t,e,!0):this.draw_domino(t,e,!1))}}draw_domino(i,s,t){let e=this.hue[i][s],d=1-.8*Math.pow((this.age[i][s]-1)/this.current_diamond_size,4),a=this.wilson.utils.hsv_to_rgb(e,d,1);this.wilson.ctx.fillStyle=`rgb(${a[0]}, ${a[1]}, ${a[2]})`;let h=this.resolution*(.1+(s+this.margin_size)/(2*this.diamond_size)*.8),n=this.resolution*(.1+(i+this.margin_size)/(2*this.diamond_size)*.8);t?this.wilson.ctx.fillRect(h,n,this.resolution*(2-2*this.margin_size)/(2*this.diamond_size)*.8,this.resolution*(1-2*this.margin_size)/(2*this.diamond_size)*.8):this.wilson.ctx.fillRect(h,n,this.resolution*(1-2*this.margin_size)/(2*this.diamond_size)*.8,this.resolution*(2-2*this.margin_size)/(2*this.diamond_size)*.8)}move_dominos(){for(let i=0;i<2*this.diamond_size;i++)for(let s=0;s<2*this.diamond_size;s++)this.new_diamond[i][s]=0,this.new_age[i][s]=0,this.new_hue[i][s]=0;for(let t=0;t<2*this.diamond_size;t++)for(let e=0;e<2*this.diamond_size;e++)0!==this.aztec_diamond[t][e]&&(1===Math.abs(this.aztec_diamond[t][e])?this.aztec_diamond[t+this.aztec_diamond[t][e]][e]===-this.aztec_diamond[t][e]&&(this.aztec_diamond[t+this.aztec_diamond[t][e]][e]=0,this.aztec_diamond[t][e]=0):this.aztec_diamond[t][e+Math.sign(this.aztec_diamond[t][e])]===-this.aztec_diamond[t][e]&&(this.aztec_diamond[t][e+Math.sign(this.aztec_diamond[t][e])]=0,this.aztec_diamond[t][e]=0));for(let d=0;d<2*this.diamond_size;d++)for(let a=0;a<2*this.diamond_size;a++)0!==this.aztec_diamond[d][a]&&(1===Math.abs(this.aztec_diamond[d][a])?(this.new_diamond[d+this.aztec_diamond[d][a]][a]=this.aztec_diamond[d][a],this.new_age[d+this.aztec_diamond[d][a]][a]=this.age[d][a],this.new_hue[d+this.aztec_diamond[d][a]][a]=this.hue[d][a]):(this.new_diamond[d][a+Math.sign(this.aztec_diamond[d][a])]=this.aztec_diamond[d][a],this.new_age[d][a+Math.sign(this.aztec_diamond[d][a])]=this.age[d][a],this.new_hue[d][a+Math.sign(this.aztec_diamond[d][a])]=this.hue[d][a]));for(let h=0;h<2*this.diamond_size;h++)for(let n=0;n<2*this.diamond_size;n++)this.aztec_diamond[h][n]=this.new_diamond[h][n],this.age[h][n]=this.new_age[h][n],this.hue[h][n]=this.new_hue[h][n];this.current_diamond_size++}fill_spaces(){for(let i=-this.current_diamond_size;i<this.current_diamond_size;i++)for(let s=-this.current_diamond_size;s<this.current_diamond_size;s++)if(Math.abs(i+.5)+Math.abs(s+.5)<=this.current_diamond_size&&Math.abs(i+1.5)+Math.abs(s+.5)<=this.current_diamond_size&&Math.abs(i+.5)+Math.abs(s+1.5)<=this.current_diamond_size&&Math.abs(i+1.5)+Math.abs(s+1.5)<=this.current_diamond_size){let t=i+this.diamond_size,e=s+this.diamond_size;0===this.aztec_diamond[t][e]&&0===this.aztec_diamond[t+1][e]&&0===this.aztec_diamond[t][e+1]&&0===this.aztec_diamond[t+1][e+1]&&2!==Math.abs(this.aztec_diamond[t-1][e])&&2!==Math.abs(this.aztec_diamond[t-1][e+1])&&1!==Math.abs(this.aztec_diamond[t][e-1])&&1!==Math.abs(this.aztec_diamond[t+1][e-1])&&this.fill_space(t,e)}}fill_space(i,s){.5>Math.random()?(this.aztec_diamond[i][s]=-1,this.aztec_diamond[i+1][s]=1,this.age[i][s]=this.current_diamond_size,this.age[i+1][s]=this.current_diamond_size,this.use_smooth_colors?(this.hue[i][s]=.75-Math.atan2(i+.5-this.diamond_size,s+.5-this.diamond_size)/(2*Math.PI),this.hue[i+1][s]=.75-Math.atan2(i+1.5-this.diamond_size,s+.5-this.diamond_size)/(2*Math.PI)):(this.hue[i][s]=0,this.hue[i+1][s]=.5)):(this.aztec_diamond[i][s]=-2,this.aztec_diamond[i][s+1]=2,this.age[i][s]=this.current_diamond_size,this.age[i][s+1]=this.current_diamond_size,this.use_smooth_colors?(this.hue[i][s]=.75-Math.atan2(i+.5-this.diamond_size,s+.5-this.diamond_size)/(2*Math.PI),this.hue[i][s+1]=.75-Math.atan2(i+.5-this.diamond_size,s+1.5-this.diamond_size)/(2*Math.PI)):(this.hue[i][s]=.25,this.hue[i][s+1]=.75))}}