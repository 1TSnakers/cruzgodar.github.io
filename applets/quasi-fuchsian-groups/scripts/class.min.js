"use strict";class QuasiFuchsianGroups extends Applet{load_promise=null;resolution_small=300;resolution_large=900;image_size=this.resolution_small;image_width=this.resolution_small;image_height=this.resolution_small;box_size=4;web_worker=null;last_timestamp=-1;t=[[2,0],[2,0]];coefficients=[[[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,0],[0,0],[0,0]],[],[]];draw_another_frame=!1;need_to_restart=!0;max_depth=20;max_pixel_brightness=10;x=0;y=0;hue=null;brightness=null;image=null;constructor(i){super(i);let t={renderer:"hybrid",canvas_width:this.resolution_small,canvas_height:this.resolution_small,world_width:1,world_height:4,world_center_x:2,world_center_y:0,use_draggables:!0,draggables_mousedown_callback:this.on_grab_draggable.bind(this),draggables_touchstart_callback:this.on_grab_draggable.bind(this),draggables_mousemove_callback:this.on_drag_draggable.bind(this),draggables_touchmove_callback:this.on_drag_draggable.bind(this),draggables_mouseup_callback:this.on_release_draggable.bind(this),draggables_touchend_callback:this.on_release_draggable.bind(this),use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png",switch_fullscreen_callback:this.change_aspect_ratio.bind(this)};this.wilson=new Wilson(i,t),this.regenerate_hue_and_brightness(),this.load_promise=new Promise(async(i,t)=>{Site.scripts_loaded.complexjs||(await Site.load_script("/scripts/complex.min.js"),Site.scripts_loaded.complexjs=!0),this.init_draggables(),i()})}draw_frame(i){let t=i-this.last_timestamp;if(this.last_timestamp=i,0===t)return;let s=new Complex(this.wilson.draggables.world_coordinates[0][0],this.wilson.draggables.world_coordinates[0][1]),e=new Complex(this.wilson.draggables.world_coordinates[1][0],this.wilson.draggables.world_coordinates[1][1]),h=s.mul(e),a=s.mul(s).add(e.mul(e)),g=h.mul(h).sub(a.mul(4)),r=g.arg()>0?h.sub(g.sqrt()).div(2):h.add(g.sqrt()).div(2),n=r.sub(2).mul(e).div(e.mul(r).sub(s.mul(2)).add(r.mul(new Complex([0,2])))),o=s.div(2),l=s.mul(r).sub(e.mul(2)).add(new Complex([0,4])).div(r.mul(2).add(4).mul(n)),m=s.mul(r).sub(e.mul(2)).sub(new Complex([0,4])).mul(n).div(r.mul(2).sub(4)),d=e.sub(new Complex([0,2])).div(2),c=e.div(2),f=e.add(new Complex([0,2])).div(2);this.coefficients[0][0][0]=o.re,this.coefficients[0][0][1]=o.im,this.coefficients[0][1][0]=l.re,this.coefficients[0][1][1]=l.im,this.coefficients[0][2][0]=m.re,this.coefficients[0][2][1]=m.im,this.coefficients[0][3][0]=o.re,this.coefficients[0][3][1]=o.im,this.coefficients[1][0][0]=d.re,this.coefficients[1][0][1]=d.im,this.coefficients[1][1][0]=c.re,this.coefficients[1][1][1]=c.im,this.coefficients[1][2][0]=c.re,this.coefficients[1][2][1]=c.im,this.coefficients[1][3][0]=f.re,this.coefficients[1][3][1]=f.im;for(let w=0;w<2;w++){let u=this.coefficients[w][0][0],b=this.coefficients[w][0][1],$=this.coefficients[w][1][0],_=this.coefficients[w][1][1],p=this.coefficients[w][2][0],x=this.coefficients[w][2][1],z=this.coefficients[w][3][0],y=this.coefficients[w][3][1];this.coefficients[w+2]=[[z,y],[-$,-_],[-p,-x],[u,b]]}for(let v=0;v<4;v++)this.search_step(0,0,v,-1,-1,1);let k=this.brightness.slice().sort((i,t)=>i-t),L=k[k.length-1];if(this.image_size!==this.resolution_small)for(let q=1;q<this.image_height-1;q++)for(let F=1;F<this.image_width-1;F++)0!==this.brightness[this.image_width*q+F]&&0===this.brightness[this.image_width*(q-1)+F]&&0===this.brightness[this.image_width*(q-1)+(F+1)]&&0===this.brightness[this.image_width*q+(F+1)]&&0===this.brightness[this.image_width*(q+1)+(F+1)]&&0===this.brightness[this.image_width*(q+1)+F]&&0===this.brightness[this.image_width*(q+1)+(F-1)]&&0===this.brightness[this.image_width*q+(F-1)]&&0===this.brightness[this.image_width*(q-1)+(F-1)]&&(this.brightness[this.image_width*q+F]=0);for(let A=0;A<this.image_height;A++)for(let j=0;j<this.image_width;j++){let I=4*A*this.image_width+4*j,P=this.wilson.utils.hsv_to_rgb(this.hue[this.image_width*A+j],1,Math.pow(this.brightness[this.image_width*A+j]/L,.25));this.image[I]=P[0],this.image[I+1]=P[1],this.image[I+2]=P[2],this.image[I+3]=255}this.wilson.render.draw_frame(this.image)}search_step(i,t,s,e,h,a){if(a!==this.max_depth)for(let g=3;g<6;g++){this.x=i,this.y=t;let r=(s+g)%4;this.apply_transformation(r);let n=this.image_width>=this.image_height?Math.floor((-this.y+this.box_size/2)/this.box_size*this.image_height):Math.floor((-this.y*(this.image_width/this.image_height)+this.box_size/2)/this.box_size*this.image_height),o=this.image_width>=this.image_height?Math.floor((this.x/(this.image_width/this.image_height)+this.box_size/2)/this.box_size*this.image_width):Math.floor((this.x+this.box_size/2)/this.box_size*this.image_width);if(n>=0&&n<this.image_height&&o>=0&&o<this.image_width){if(this.brightness[this.image_width*n+o]===this.max_pixel_brightness)continue;(a>10||this.image_size!==this.resolution_small)&&this.brightness[this.image_width*n+o]++}this.search_step(this.x,this.y,r,n,o,a+1)}}apply_transformation(i){let t=this.coefficients[i][0][0],s=this.coefficients[i][0][1],e=this.coefficients[i][1][0],h=this.coefficients[i][1][1],a=this.coefficients[i][2][0],g=this.coefficients[i][2][1],r=this.coefficients[i][3][0],n=this.coefficients[i][3][1],o=t*this.x-s*this.y+e,l=t*this.y+s*this.x+h,m=a*this.x-g*this.y+r,d=a*this.y+g*this.x+n,c=m*m+d*d;this.x=(o*m+l*d)/c,this.y=(l*m-o*d)/c}init_draggables(){this.wilson.draggables.add(2,0),this.wilson.draggables.add(2,0),window.requestAnimationFrame(this.draw_frame.bind(this))}on_grab_draggable(i,t,s,e){this.image_size=this.resolution_small,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.max_depth=20,this.max_pixel_brightness=10,this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}on_release_draggable(i,t,s,e){this.image_size=this.resolution_large,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.max_depth=100,this.max_pixel_brightness=50,this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}on_drag_draggable(i,t,s,e){for(let h=0;h<this.image_height;h++)for(let a=0;a<this.image_width;a++)this.brightness[this.image_width*h+a]=0;window.requestAnimationFrame(this.draw_frame.bind(this))}request_high_res_frame(i,t,s){return new Promise((e,h)=>{this.image_size=i,this.max_depth=t,this.max_pixel_brightness=s,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.regenerate_hue_and_brightness();try{this.web_worker.terminate()}catch(a){}this.web_worker=new Worker(`/applets/quasi-fuchsian-groups/scripts/worker.${DEBUG?"":"min."}js`),this.workers.push(this.web_worker),this.web_worker.onmessage=i=>{this.brightness=i.data[0],this.wilson.change_canvas_size(this.image_width,this.image_height);for(let t=0;t<this.image_height;t++)for(let s=0;s<this.image_width;s++){let h=4*t*this.image_width+4*s,a=this.wilson.utils.hsv_to_rgb(this.hue[this.image_width*t+s],1,this.brightness[this.image_width*t+s]);this.image[h]=a[0],this.image[h+1]=a[1],this.image[h+2]=a[2],this.image[h+3]=255}this.wilson.render.draw_frame(this.image),e()},this.web_worker.postMessage([this.image_width,this.image_height,this.max_depth,this.max_pixel_brightness,this.box_size,this.coefficients])})}regenerate_hue_and_brightness(){this.hue=Array(this.image_width*this.image_height),this.brightness=Array(this.image_width*this.image_height),this.image=new Uint8ClampedArray(this.image_width*this.image_height*4);for(let i=0;i<this.image_height;i++)for(let t=0;t<this.image_width;t++)this.x=i/this.image_height*this.box_size-this.box_size/2,this.y=this.box_size/2-t/this.image_width*this.box_size,this.hue[this.image_width*i+t]=(Math.atan2(-this.y,-this.x)+Math.PI)/(2*Math.PI),this.brightness[this.image_width*i+t]=0}change_aspect_ratio(){this.image_size=this.resolution_small,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}}