"use strict";class QuasiFuchsianGroups extends Applet{load_promise=null;wilson_hidden=null;resolution_small=500;resolution_large=1500;image_size=this.resolution_small;image_width=this.resolution_small;image_height=this.resolution_small;box_size=4;web_worker=null;last_timestamp=-1;t=[[2,0],[2,0]];coefficients=[[[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,0],[0,0],[0,0]],[],[]];draw_another_frame=!1;need_to_restart=!0;max_depth=200;max_pixel_brightness=50;x=0;y=0;brightness=null;image=null;constructor(e){super(e);let i=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D u_texture;
   
   uniform float texture_step;
   
   
   
   void main(void)
   {
    //remove isolated pixels.
    vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
    
    float brightness =
     texture2D(u_texture, center + vec2(texture_step, 0.0)).z +
     texture2D(u_texture, center - vec2(texture_step, 0.0)).z +
     texture2D(u_texture, center + vec2(0.0, texture_step)).z +
     texture2D(u_texture, center - vec2(0.0, texture_step)).z +
     texture2D(u_texture, center + vec2(texture_step, texture_step)).z +
     texture2D(u_texture, center + vec2(texture_step, -texture_step)).z +
     texture2D(u_texture, center + vec2(-texture_step, texture_step)).z +
     texture2D(u_texture, center + vec2(-texture_step, -texture_step)).z;
    
    if (brightness < 0.1)
    {
     gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
     
     return;
    }
    
    
    gl_FragColor = vec4(0.0, 0.0, texture2D(u_texture, center).z, 1.0);
   }
  `,t=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D u_texture;
   
   uniform float texture_step;
   
   
   
   void main(void)
   {
    //Dilate the pixels to make a thicker line.
    vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
    
    float brightness =
     max(max(max(texture2D(u_texture, center + vec2(texture_step, 0.0)).z,
     texture2D(u_texture, center - vec2(texture_step, 0.0)).z),
     max(texture2D(u_texture, center + vec2(0.0, texture_step)).z,
     texture2D(u_texture, center - vec2(0.0, texture_step)).z)),
     
     max(max(texture2D(u_texture, center + vec2(texture_step, texture_step)).z,
     texture2D(u_texture, center + vec2(texture_step, -texture_step)).z),
     max(texture2D(u_texture, center + vec2(-texture_step, texture_step)).z,
     texture2D(u_texture, center + vec2(-texture_step, -texture_step)).z)));
     
    brightness = max(brightness, texture2D(u_texture, center).z);
    
    gl_FragColor = vec4(0.0, 0.0, brightness, 1.0);
   }
  `,s=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D u_texture;
   
   void main(void)
   {
    //Dilate the pixels to make a thicker line.
    vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
    
    vec2 z = 3.0 * uv;
    vec3 color = 1.5 * normalize(vec3(abs(z.x + z.y) / 2.0, abs(z.x) / 2.0, abs(z.y) / 2.0) + .1 / length(z) * vec3(1.0, 1.0, 1.0));
    
    gl_FragColor = vec4(color * texture2D(u_texture, center).z, 1.0);
   }
  `,h={renderer:"gpu",shader:i,canvas_width:this.resolution_small,canvas_height:this.resolution_small,world_width:1,world_height:4,world_center_x:2,world_center_y:0,use_draggables:!0,draggables_mousedown_callback:this.on_grab_draggable.bind(this),draggables_touchstart_callback:this.on_grab_draggable.bind(this),draggables_mousemove_callback:this.on_drag_draggable.bind(this),draggables_touchmove_callback:this.on_drag_draggable.bind(this),draggables_mouseup_callback:this.on_release_draggable.bind(this),draggables_touchend_callback:this.on_release_draggable.bind(this),use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png",switch_fullscreen_callback:this.change_aspect_ratio.bind(this)};this.wilson=new Wilson(e,h),this.wilson.render.load_new_shader(t),this.wilson.render.load_new_shader(s),this.wilson.gl.useProgram(this.wilson.render.shader_programs[0]),this.wilson.render.init_uniforms(["texture_step"],0),this.wilson.gl.useProgram(this.wilson.render.shader_programs[1]),this.wilson.render.init_uniforms(["texture_step"],1),this.wilson.render.create_framebuffer_texture_pair(),this.wilson.render.create_framebuffer_texture_pair(this.wilson.gl.UNSIGNED_BYTE),this.image=new Float32Array(this.image_width*this.image_height*4),this.regenerate_hue_and_brightness(),this.load_promise=new Promise(async(e,i)=>{Site.scripts_loaded.complexjs||(await Site.load_script("/scripts/complex.min.js"),Site.scripts_loaded.complexjs=!0),this.init_draggables(),e()})}bake_coefficients(e=this.wilson.draggables.world_coordinates[0][0],i=this.wilson.draggables.world_coordinates[0][1],t=this.wilson.draggables.world_coordinates[1][0],s=this.wilson.draggables.world_coordinates[1][1]){let h=new Complex(e,i),r=new Complex(t,s),a=h.mul(r),n=h.mul(h).add(r.mul(r)),l=a.mul(a).sub(n.mul(4)),o=l.arg()>0?a.sub(l.sqrt()).div(2):a.add(l.sqrt()).div(2),g=o.sub(2).mul(r).div(r.mul(o).sub(h.mul(2)).add(o.mul(new Complex([0,2])))),m=h.div(2),u=h.mul(o).sub(r.mul(2)).add(new Complex([0,4])).div(o.mul(2).add(4).mul(g)),c=h.mul(o).sub(r.mul(2)).sub(new Complex([0,4])).mul(g).div(o.mul(2).sub(4)),d=r.sub(new Complex([0,2])).div(2),$=r.div(2),f=r.add(new Complex([0,2])).div(2);this.coefficients[0][0][0]=m.re,this.coefficients[0][0][1]=m.im,this.coefficients[0][1][0]=u.re,this.coefficients[0][1][1]=u.im,this.coefficients[0][2][0]=c.re,this.coefficients[0][2][1]=c.im,this.coefficients[0][3][0]=m.re,this.coefficients[0][3][1]=m.im,this.coefficients[1][0][0]=d.re,this.coefficients[1][0][1]=d.im,this.coefficients[1][1][0]=$.re,this.coefficients[1][1][1]=$.im,this.coefficients[1][2][0]=$.re,this.coefficients[1][2][1]=$.im,this.coefficients[1][3][0]=f.re,this.coefficients[1][3][1]=f.im;for(let w=0;w<2;w++){let x=this.coefficients[w][0][0],p=this.coefficients[w][0][1],b=this.coefficients[w][1][0],_=this.coefficients[w][1][1],z=this.coefficients[w][2][0],v=this.coefficients[w][2][1],D=this.coefficients[w][3][0],y=this.coefficients[w][3][1];this.coefficients[w+2]=[[D,y],[-b,-_],[-z,-v],[x,p]]}}draw_frame(e){let i=e-this.last_timestamp;if(this.last_timestamp=e,0===i)return;this.bake_coefficients();for(let t=0;t<4;t++)this.search_step(0,0,t,-1,-1,1);let s=0;for(let h=0;h<this.brightness.length;h++)s=Math.max(s,this.brightness[h]);for(let r=0;r<this.image_height;r++)for(let a=0;a<this.image_width;a++){let n=r*this.image_width+a;this.image[4*n]=0,this.image[4*n+1]=1,this.image[4*n+2]=Math.pow(this.brightness[n]/s,.15),this.image[4*n+3]=1}this.render_shader_stack()}render_shader_stack(){this.wilson.gl.useProgram(this.wilson.render.shader_programs[0]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.image_width,this.image_height,0,this.wilson.gl.RGBA,this.wilson.gl.FLOAT,this.image),this.wilson.render.draw_frame(),this.wilson.gl.useProgram(this.wilson.render.shader_programs[1]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);let e=this.image_size>=1e3?1:0;for(let i=0;i<e;i++){let t=this.wilson.render.get_pixel_data();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.image_width,this.image_height,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,t),this.wilson.render.draw_frame()}this.wilson.gl.useProgram(this.wilson.render.shader_programs[2]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);let s=this.wilson.render.get_pixel_data();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.image_width,this.image_height,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,s),this.wilson.render.draw_frame()}search_step(e,i,t,s,h,r){if(r!==this.max_depth)for(let a=3;a<6;a++){this.x=e,this.y=i;let n=(t+a)%4;this.apply_transformation(n);let l=this.image_width>=this.image_height?Math.floor((-this.y+this.box_size/2)/this.box_size*this.image_height):Math.floor((-this.y*(this.image_width/this.image_height)+this.box_size/2)/this.box_size*this.image_height),o=this.image_width>=this.image_height?Math.floor((this.x/(this.image_width/this.image_height)+this.box_size/2)/this.box_size*this.image_width):Math.floor((this.x+this.box_size/2)/this.box_size*this.image_width);if(l>=0&&l<this.image_height&&o>=0&&o<this.image_width){if(this.brightness[this.image_width*l+o]===this.max_pixel_brightness)continue;(r>10||this.image_size!==this.resolution_small)&&this.brightness[this.image_width*l+o]++}this.search_step(this.x,this.y,n,l,o,r+1)}}apply_transformation(e){let i=this.coefficients[e][0][0],t=this.coefficients[e][0][1],s=this.coefficients[e][1][0],h=this.coefficients[e][1][1],r=this.coefficients[e][2][0],a=this.coefficients[e][2][1],n=this.coefficients[e][3][0],l=this.coefficients[e][3][1],o=i*this.x-t*this.y+s,g=i*this.y+t*this.x+h,m=r*this.x-a*this.y+n,u=r*this.y+a*this.x+l,c=m*m+u*u;this.x=(o*m+g*u)/c,this.y=(g*m-o*u)/c}init_draggables(){this.wilson.draggables.add(2,0),this.wilson.draggables.add(2,0),window.requestAnimationFrame(this.draw_frame.bind(this))}on_grab_draggable(e,i,t,s){this.image_size=this.resolution_small,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.max_depth=200,this.max_pixel_brightness=50,this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}on_release_draggable(e,i,t,s){DEBUG&&console.log(e,i,t),this.image_size=this.resolution_large,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.max_depth=200,this.max_pixel_brightness=50,this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}on_drag_draggable(e,i,t,s){for(let h=0;h<this.image_height;h++)for(let r=0;r<this.image_width;r++)this.brightness[this.image_width*h+r]=0;window.requestAnimationFrame(this.draw_frame.bind(this))}request_high_res_frame(e,i,t,s=this.box_size){return new Promise((h,r)=>{this.image_size=e,this.max_depth=i,this.max_pixel_brightness=t,this.box_size=s,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.regenerate_hue_and_brightness();try{this.web_worker.terminate()}catch(a){}this.web_worker=new Worker(`/applets/quasi-fuchsian-groups/scripts/worker.${DEBUG?"":"min."}js`),this.workers.push(this.web_worker),this.web_worker.onmessage=e=>{this.brightness=e.data[0],this.wilson.change_canvas_size(this.image_width,this.image_height);for(let i=0;i<this.image_height;i++)for(let t=0;t<this.image_width;t++){let s=i*this.image_width+t;this.image[4*s]=0,this.image[4*s+1]=0,this.image[4*s+2]=this.brightness[s],this.image[4*s+3]=0}this.render_shader_stack(),h()},this.web_worker.postMessage([this.image_width,this.image_height,this.max_depth,this.max_pixel_brightness,this.box_size,this.coefficients])})}regenerate_hue_and_brightness(){this.brightness=new Float32Array(this.image_width*this.image_height),this.image=new Float32Array(this.image_width*this.image_height*4),this.wilson.gl.useProgram(this.wilson.render.shader_programs[0]),this.wilson.gl.uniform1f(this.wilson.uniforms.texture_step[0],1/this.image_size),this.wilson.gl.useProgram(this.wilson.render.shader_programs[1]),this.wilson.gl.uniform1f(this.wilson.uniforms.texture_step[1],1/this.image_size);for(let e=0;e<this.image_height;e++)for(let i=0;i<this.image_width;i++)this.brightness[this.image_width*e+i]=0}change_aspect_ratio(){this.image_size=this.resolution_small,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}}