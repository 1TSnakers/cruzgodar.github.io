class QuasiFuchsianGroups extends Applet{loadPromise=null;wilsonHidden=null;resolutionSmall=400;resolutionLarge=1200;imageSize=this.resolutionSmall;imageWidth=this.resolutionSmall;imageHeight=this.resolutionSmall;boxSize=4;webWorker=null;lastTimestamp=-1;t=[[2,0],[2,0]];coefficients=[[[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,0],[0,0],[0,0]],[],[]];drawAnotherFrame=!1;needToRestart=!0;maxDepth=200;maxPixelBrightness=50;x=0;y=0;brightness=null;image=null;constructor(a){super(a);const c={renderer:"gpu",shader:"\n\t\t\tprecision highp float;\n\t\t\tprecision highp sampler2D;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform sampler2D uTexture;\n\t\t\t\n\t\t\tuniform float textureStep;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\t//remove isolated pixels.\n\t\t\t\tvec2 center = (uv + vec2(1.0, 1.0)) / 2.0;\n\t\t\t\t\n\t\t\t\tfloat brightness =\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, 0.0)).z +\n\t\t\t\t\ttexture2D(uTexture, center - vec2(textureStep, 0.0)).z +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(0.0, textureStep)).z +\n\t\t\t\t\ttexture2D(uTexture, center - vec2(0.0, textureStep)).z +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, textureStep)).z +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, -textureStep)).z +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(-textureStep, textureStep)).z +\n\t\t\t\t\ttexture2D(uTexture, center + vec2(-textureStep, -textureStep)).z;\n\t\t\t\t\n\t\t\t\tif (brightness < 0.1)\n\t\t\t\t{\n\t\t\t\t\tgl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);\n\t\t\t\t\t\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, texture2D(uTexture, center).z, 1.0);\n\t\t\t}\n\t\t",
canvasWidth:this.resolutionSmall,canvasHeight:this.resolutionSmall,worldWidth:1,worldHeight:4,worldCenterX:2,worldCenterY:0,useDraggables:!0,draggablesMousedownCallback:this.onGrabDraggable.bind(this),draggablesTouchstartCallback:this.onGrabDraggable.bind(this),draggablesMousemoveCallback:this.onDragDraggable.bind(this),draggablesTouchmoveCallback:this.onDragDraggable.bind(this),draggablesMouseupCallback:this.onReleaseDraggable.bind(this),draggablesTouchendCallback:this.onReleaseDraggable.bind(this),
useFullscreen:!0,trueFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",switchFullscreenCallback:this.changeAspectRatio.bind(this)};this.wilson=new Wilson(a,c);this.wilson.render.loadNewShader("\n\t\t\tprecision highp float;\n\t\t\tprecision highp sampler2D;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform sampler2D uTexture;\n\t\t\t\n\t\t\tuniform float textureStep;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\t//Dilate the pixels to make a thicker line.\n\t\t\t\tvec2 center = (uv + vec2(1.0, 1.0)) / 2.0;\n\t\t\t\t\n\t\t\t\tfloat brightness =\n\t\t\t\t\tmax(max(max(texture2D(uTexture, center + vec2(textureStep, 0.0)).z,\n\t\t\t\t\ttexture2D(uTexture, center - vec2(textureStep, 0.0)).z),\n\t\t\t\t\tmax(texture2D(uTexture, center + vec2(0.0, textureStep)).z,\n\t\t\t\t\ttexture2D(uTexture, center - vec2(0.0, textureStep)).z)),\n\t\t\t\t\t\n\t\t\t\t\tmax(max(texture2D(uTexture, center + vec2(textureStep, textureStep)).z,\n\t\t\t\t\ttexture2D(uTexture, center + vec2(textureStep, -textureStep)).z),\n\t\t\t\t\tmax(texture2D(uTexture, center + vec2(-textureStep, textureStep)).z,\n\t\t\t\t\ttexture2D(uTexture, center + vec2(-textureStep, -textureStep)).z)));\n\t\t\t\t\t\n\t\t\t\tbrightness = max(brightness, texture2D(uTexture, center).z);\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(0.0, 0.0, brightness, 1.0);\n\t\t\t}\n\t\t");
this.wilson.render.loadNewShader("\n\t\t\tprecision highp float;\n\t\t\tprecision highp sampler2D;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform sampler2D uTexture;\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\t//Dilate the pixels to make a thicker line.\n\t\t\t\tvec2 center = (uv + vec2(1.0, 1.0)) / 2.0;\n\t\t\t\t\n\t\t\t\tvec2 z = 3.0 * uv;\n\t\t\t\tvec3 color = 1.5 * normalize(vec3(abs(z.x + z.y) / 2.0, abs(z.x) / 2.0, abs(z.y) / 2.0) + .1 / length(z) * vec3(1.0, 1.0, 1.0));\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(color * texture2D(uTexture, center).z, 1.0);\n\t\t\t}\n\t\t");
this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]);this.wilson.render.initUniforms(["textureStep"],0);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]);this.wilson.render.initUniforms(["textureStep"],1);this.wilson.render.createFramebufferTexturePair();this.wilson.render.createFramebufferTexturePair(this.wilson.gl.UNSIGNED_BYTE);this.image=new Float32Array(this.imageWidth*this.imageHeight*4);this.regenerateHueAndBrightness();this.loadPromise=new Promise(async(b,d)=>{Site.scriptsLoaded.complexjs||
(await Site.loadScript("/scripts/complex.min.js"),Site.scriptsLoaded.complexjs=!0);this.initDraggables();this.changeRecipe(0);b()})}grandmaCoefficients(a=this.wilson.draggables.worldCoordinates[0][0],c=this.wilson.draggables.worldCoordinates[0][1],b=this.wilson.draggables.worldCoordinates[1][0],d=this.wilson.draggables.worldCoordinates[1][1]){a=new Complex(a,c);b=new Complex(b,d);d=a.mul(b);c=a.mul(a).add(b.mul(b));c=d.mul(d).sub(c.mul(4));var f=0<c.arg()?d.sub(c.sqrt()).div(2):d.add(c.sqrt()).div(2),
e=f.sub(2).mul(b).div(b.mul(f).sub(a.mul(2)).add(f.mul(new Complex([0,2]))));d=a.div(2);c=a.mul(f).sub(b.mul(2)).add(new Complex([0,4])).div(f.mul(2).add(4).mul(e));a=a.mul(f).sub(b.mul(2)).sub(new Complex([0,4])).mul(e).div(f.mul(2).sub(4));f=b.sub(new Complex([0,2])).div(2);e=b.div(2);b=b.add(new Complex([0,2])).div(2);this.coefficients[0][0][0]=d.re;this.coefficients[0][0][1]=d.im;this.coefficients[0][1][0]=c.re;this.coefficients[0][1][1]=c.im;this.coefficients[0][2][0]=a.re;this.coefficients[0][2][1]=
a.im;this.coefficients[0][3][0]=d.re;this.coefficients[0][3][1]=d.im;this.coefficients[1][0][0]=f.re;this.coefficients[1][0][1]=f.im;this.coefficients[1][1][0]=e.re;this.coefficients[1][1][1]=e.im;this.coefficients[1][2][0]=e.re;this.coefficients[1][2][1]=e.im;this.coefficients[1][3][0]=b.re;this.coefficients[1][3][1]=b.im;for(b=0;2>b;b++)this.coefficients[b+2]=[[this.coefficients[b][3][0],this.coefficients[b][3][1]],[-this.coefficients[b][1][0],-this.coefficients[b][1][1]],[-this.coefficients[b][2][0],
-this.coefficients[b][2][1]],[this.coefficients[b][0][0],this.coefficients[b][0][1]]]}rileyCoefficients(a=this.wilson.draggables.worldCoordinates[0][0],c=this.wilson.draggables.worldCoordinates[0][1]){this.coefficients[0][0][0]=1;this.coefficients[0][0][1]=0;this.coefficients[0][1][0]=0;this.coefficients[0][1][1]=0;this.coefficients[0][2][0]=a;this.coefficients[0][2][1]=c;this.coefficients[0][3][0]=1;this.coefficients[0][3][1]=0;this.coefficients[1][0][0]=1;this.coefficients[1][0][1]=0;this.coefficients[1][1][0]=
2;this.coefficients[1][1][1]=0;this.coefficients[1][2][0]=0;this.coefficients[1][2][1]=0;this.coefficients[1][3][0]=1;this.coefficients[1][3][1]=0;for(a=0;2>a;a++)this.coefficients[a+2]=[[this.coefficients[a][3][0],this.coefficients[a][3][1]],[-this.coefficients[a][1][0],-this.coefficients[a][1][1]],[-this.coefficients[a][2][0],-this.coefficients[a][2][1]],[this.coefficients[a][0][0],this.coefficients[a][0][1]]]}grandmaSpecialCoefficients(a=this.wilson.draggables.worldCoordinates[0][0],c=this.wilson.draggables.worldCoordinates[0][1],
b=this.wilson.draggables.worldCoordinates[1][0],d=this.wilson.draggables.worldCoordinates[1][1],f=this.wilson.draggables.worldCoordinates[2][0],e=this.wilson.draggables.worldCoordinates[2][1]){a=new Complex(a,c);b=new Complex(b,d);e=new Complex(f,e);f=new Complex(0,1);d=new Complex(2,0);c=a.mul(a).add(b.mul(b)).add(e.mul(e)).sub(a.mul(b).mul(e)).sub(2);d=d.sub(c).sqrt();var g=c.add(f.mul(d).mul(c.add(2).sqrt())).abs();c=c.add(2).sqrt().mul(2<=g?1:-1);const h=e.sub(2).mul(b.add(c)).div(b.mul(e).sub(a.mul(2)).add(f.mul(d).mul(e)));
c=a.div(2);g=a.mul(e).sub(b.mul(2)).add(f.mul(d).mul(2)).div(h.mul(e.mul(2).add(4)));const k=h.mul(a.mul(e).sub(b.mul(2)).sub(f.mul(2).mul(d))).div(e.mul(2).sub(4)),l=b.sub(f.mul(d)).div(2),m=b.mul(e).sub(a.mul(2)).add(f.mul(d).mul(e)).div(h.mul(e.mul(2).add(4)));a=b.mul(e).sub(a.mul(2)).sub(f.mul(d).mul(e)).mul(h).div(e.mul(2).sub(4));b=b.add(f.mul(d)).div(2);this.coefficients[0][0][0]=c.re;this.coefficients[0][0][1]=c.im;this.coefficients[0][1][0]=g.re;this.coefficients[0][1][1]=g.im;this.coefficients[0][2][0]=
k.re;this.coefficients[0][2][1]=k.im;this.coefficients[0][3][0]=c.re;this.coefficients[0][3][1]=c.im;this.coefficients[1][0][0]=l.re;this.coefficients[1][0][1]=l.im;this.coefficients[1][1][0]=m.re;this.coefficients[1][1][1]=m.im;this.coefficients[1][2][0]=a.re;this.coefficients[1][2][1]=a.im;this.coefficients[1][3][0]=b.re;this.coefficients[1][3][1]=b.im;for(a=0;2>a;a++)this.coefficients[a+2]=[[this.coefficients[a][3][0],this.coefficients[a][3][1]],[-this.coefficients[a][1][0],-this.coefficients[a][1][1]],
[-this.coefficients[a][2][0],-this.coefficients[a][2][1]],[this.coefficients[a][0][0],this.coefficients[a][0][1]]]}bakeCoefficients=this.grandmaCoefficients;changeRecipe(a){0===a?(this.bakeCoefficients=this.grandmaCoefficients,this.wilson.draggables.draggables[1].style.display="block",this.wilson.draggables.draggables[2].style.display="none"):1===a?(this.bakeCoefficients=this.rileyCoefficients,this.wilson.draggables.draggables[1].style.display="none",this.wilson.draggables.draggables[2].style.display=
"none"):2===a&&(this.bakeCoefficients=this.grandmaSpecialCoefficients,this.wilson.draggables.draggables[1].style.display="block",this.wilson.draggables.draggables[2].style.display="block")}drawFrame(a){var c=a-this.lastTimestamp;this.lastTimestamp=a;if(0!==c){this.bakeCoefficients();for(a=0;4>a;a++)this.searchStep(0,0,a,-1,-1,1);a=0;for(c=0;c<this.brightness.length;c++)a=Math.max(a,this.brightness[c]);for(c=0;c<this.imageHeight;c++)for(let b=0;b<this.imageWidth;b++){const d=c*this.imageWidth+b;this.image[4*
d]=0;this.image[4*d+1]=1;this.image[4*d+2]=Math.pow(this.brightness[d]/a,.15);this.image[4*d+3]=1}this.renderShaderStack()}}renderShaderStack(){this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]);this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture);this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null);this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.imageWidth,this.imageHeight,0,this.wilson.gl.RGBA,this.wilson.gl.FLOAT,
this.image);this.wilson.render.drawFrame();this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]);this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);var a=1E3<=this.imageSize?1:0;for(let c=0;c<a;c++){const b=this.wilson.render.getPixelData();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.imageWidth,this.imageHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,b);this.wilson.render.drawFrame()}this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]);
this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);a=this.wilson.render.getPixelData();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.imageWidth,this.imageHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,a);this.wilson.render.drawFrame()}searchStep(a,c,b,d,f,e){if(e!==this.maxDepth)for(d=3;6>d;d++){this.x=a;this.y=c;f=(b+d)%4;this.applyTransformation(f);const g=this.imageWidth>=this.imageHeight?Math.floor((-this.y+
this.boxSize/2)/this.boxSize*this.imageHeight):Math.floor((this.imageWidth/this.imageHeight*-this.y+this.boxSize/2)/this.boxSize*this.imageHeight),h=this.imageWidth>=this.imageHeight?Math.floor((this.x/(this.imageWidth/this.imageHeight)+this.boxSize/2)/this.boxSize*this.imageWidth):Math.floor((this.x+this.boxSize/2)/this.boxSize*this.imageWidth);if(0<=g&&g<this.imageHeight&&0<=h&&h<this.imageWidth){if(this.brightness[this.imageWidth*g+h]===this.maxPixelBrightness)continue;(10<e||this.imageSize!==
this.resolutionSmall)&&this.brightness[this.imageWidth*g+h]++}this.searchStep(this.x,this.y,f,g,h,e+1)}}applyTransformation(a){var c=this.coefficients[a][0][0],b=this.coefficients[a][0][1],d=this.coefficients[a][2][0];const f=this.coefficients[a][2][1],e=c*this.x-b*this.y+this.coefficients[a][1][0];c=c*this.y+b*this.x+this.coefficients[a][1][1];b=d*this.x-f*this.y+this.coefficients[a][3][0];a=d*this.y+f*this.x+this.coefficients[a][3][1];d=b*b+a*a;this.x=(e*b+c*a)/d;this.y=(c*b-e*a)/d}initDraggables(){this.wilson.draggables.add(2,
0);this.wilson.draggables.add(2,0);this.wilson.draggables.add(2,-2);window.requestAnimationFrame(this.drawFrame.bind(this))}onGrabDraggable(a,c,b,d){this.imageSize=this.resolutionSmall;this.wilson.fullscreen.currentlyFullscreen?1<=Page.Layout.aspectRatio?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):this.imageHeight=this.imageWidth=this.imageSize;
this.maxDepth=200;this.maxPixelBrightness=50;this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight);this.regenerateHueAndBrightness();window.requestAnimationFrame(this.drawFrame.bind(this))}onReleaseDraggable(a,c,b,d){this.imageSize=this.resolutionLarge;this.wilson.fullscreen.currentlyFullscreen?1<=Page.Layout.aspectRatio?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/
Page.Layout.aspectRatio)):this.imageHeight=this.imageWidth=this.imageSize;this.maxDepth=200;this.maxPixelBrightness=50;this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight);this.regenerateHueAndBrightness();window.requestAnimationFrame(this.drawFrame.bind(this))}onDragDraggable(a,c,b,d){for(a=0;a<this.imageHeight;a++)for(c=0;c<this.imageWidth;c++)this.brightness[this.imageWidth*a+c]=0;window.requestAnimationFrame(this.drawFrame.bind(this))}requestHighResFrame(a,c,b,d=this.boxSize){return new Promise((f,
e)=>{this.imageSize=a;this.maxDepth=c;this.maxPixelBrightness=b;this.boxSize=d;this.wilson.fullscreen.currentlyFullscreen?1<=Page.Layout.aspectRatio?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):this.imageHeight=this.imageWidth=this.imageSize;this.regenerateHueAndBrightness();try{this.webWorker.terminate()}catch(g){}this.webWorker=new Worker(`/applets/quasi-fuchsian-groups/scripts/worker.${DEBUG?
"":"min."}js`);this.workers.push(this.webWorker);this.webWorker.onmessage=g=>{this.brightness=g.data[0];this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight);for(g=0;g<this.imageHeight;g++)for(let h=0;h<this.imageWidth;h++){const k=g*this.imageWidth+h;this.image[4*k]=0;this.image[4*k+1]=0;this.image[4*k+2]=this.brightness[k];this.image[4*k+3]=0}this.renderShaderStack();f()};this.webWorker.postMessage([this.imageWidth,this.imageHeight,this.maxDepth,this.maxPixelBrightness,this.boxSize,this.coefficients])})}regenerateHueAndBrightness(){this.brightness=
new Float32Array(this.imageWidth*this.imageHeight);this.image=new Float32Array(this.imageWidth*this.imageHeight*4);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]);this.wilson.gl.uniform1f(this.wilson.uniforms.textureStep[0],1/this.imageSize);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]);this.wilson.gl.uniform1f(this.wilson.uniforms.textureStep[1],1/this.imageSize);for(let a=0;a<this.imageHeight;a++)for(let c=0;c<this.imageWidth;c++)this.brightness[this.imageWidth*
a+c]=0}changeAspectRatio(){this.imageSize=this.resolutionSmall;this.wilson.fullscreen.currentlyFullscreen?1<=Page.Layout.aspectRatio?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):this.imageHeight=this.imageWidth=this.imageSize;this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight);this.regenerateHueAndBrightness();window.requestAnimationFrame(this.drawFrame.bind(this))}}
;
