"use strict";class QuasiFuchsianGroups extends Applet{loadPromise=null;wilsonHidden=null;resolutionSmall=400;resolutionLarge=1200;imageSize=this.resolutionSmall;imageWidth=this.resolutionSmall;imageHeight=this.resolutionSmall;boxSize=4;webWorker=null;lastTimestamp=-1;t=[[2,0],[2,0]];coefficients=[[[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,0],[0,0],[0,0]],[],[]];drawAnotherFrame=!1;needToRestart=!0;maxDepth=200;maxPixelBrightness=50;x=0;y=0;brightness=null;image=null;constructor(e){super(e);let i=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D uTexture;
   
   uniform float textureStep;
   
   
   
   void main(void)
   {
    //remove isolated pixels.
    vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
    
    float brightness =
     texture2D(uTexture, center + vec2(textureStep, 0.0)).z +
     texture2D(uTexture, center - vec2(textureStep, 0.0)).z +
     texture2D(uTexture, center + vec2(0.0, textureStep)).z +
     texture2D(uTexture, center - vec2(0.0, textureStep)).z +
     texture2D(uTexture, center + vec2(textureStep, textureStep)).z +
     texture2D(uTexture, center + vec2(textureStep, -textureStep)).z +
     texture2D(uTexture, center + vec2(-textureStep, textureStep)).z +
     texture2D(uTexture, center + vec2(-textureStep, -textureStep)).z;
    
    if (brightness < 0.1)
    {
     gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
     
     return;
    }
    
    
    gl_FragColor = vec4(0.0, 0.0, texture2D(uTexture, center).z, 1.0);
   }
  `,t=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D uTexture;
   
   uniform float textureStep;
   
   
   
   void main(void)
   {
    //Dilate the pixels to make a thicker line.
    vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
    
    float brightness =
     max(max(max(texture2D(uTexture, center + vec2(textureStep, 0.0)).z,
     texture2D(uTexture, center - vec2(textureStep, 0.0)).z),
     max(texture2D(uTexture, center + vec2(0.0, textureStep)).z,
     texture2D(uTexture, center - vec2(0.0, textureStep)).z)),
     
     max(max(texture2D(uTexture, center + vec2(textureStep, textureStep)).z,
     texture2D(uTexture, center + vec2(textureStep, -textureStep)).z),
     max(texture2D(uTexture, center + vec2(-textureStep, textureStep)).z,
     texture2D(uTexture, center + vec2(-textureStep, -textureStep)).z)));
     
    brightness = max(brightness, texture2D(uTexture, center).z);
    
    gl_FragColor = vec4(0.0, 0.0, brightness, 1.0);
   }
  `,s=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D uTexture;
   
   void main(void)
   {
    //Dilate the pixels to make a thicker line.
    vec2 center = (uv + vec2(1.0, 1.0)) / 2.0;
    
    vec2 z = 3.0 * uv;
    vec3 color = 1.5 * normalize(vec3(abs(z.x + z.y) / 2.0, abs(z.x) / 2.0, abs(z.y) / 2.0) + .1 / length(z) * vec3(1.0, 1.0, 1.0));
    
    gl_FragColor = vec4(color * texture2D(uTexture, center).z, 1.0);
   }
  `,h={renderer:"gpu",shader:i,canvasWidth:this.resolutionSmall,canvasHeight:this.resolutionSmall,worldWidth:1,worldHeight:4,worldCenterX:2,worldCenterY:0,useDraggables:!0,draggablesMousedownCallback:this.onGrabDraggable.bind(this),draggablesTouchstartCallback:this.onGrabDraggable.bind(this),draggablesMousemoveCallback:this.onDragDraggable.bind(this),draggablesTouchmoveCallback:this.onDragDraggable.bind(this),draggablesMouseupCallback:this.onReleaseDraggable.bind(this),draggablesTouchendCallback:this.onReleaseDraggable.bind(this),useFullscreen:!0,trueFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",switchFullscreenCallback:this.changeAspectRatio.bind(this)};this.wilson=new Wilson(e,h),this.wilson.render.loadNewShader(t),this.wilson.render.loadNewShader(s),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]),this.wilson.render.initUniforms(["textureStep"],0),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.render.initUniforms(["textureStep"],1),this.wilson.render.createFramebufferTexturePair(),this.wilson.render.createFramebufferTexturePair(this.wilson.gl.UNSIGNED_BYTE),this.image=new Float32Array(this.imageWidth*this.imageHeight*4),this.regenerateHueAndBrightness(),this.loadPromise=new Promise(async(e,i)=>{Site.scriptsLoaded.complexjs||(await Site.loadScript("/scripts/complex.min.js"),Site.scriptsLoaded.complexjs=!0),this.initDraggables(),this.changeRecipe(0),e()})}grandmaCoefficients(e=this.wilson.draggables.worldCoordinates[0][0],i=this.wilson.draggables.worldCoordinates[0][1],t=this.wilson.draggables.worldCoordinates[1][0],s=this.wilson.draggables.worldCoordinates[1][1]){let h=new Complex(e,i),r=new Complex(t,s),a=h.mul(r),n=h.mul(h).add(r.mul(r)),o=a.mul(a).sub(n.mul(4)),l=o.arg()>0?a.sub(o.sqrt()).div(2):a.add(o.sqrt()).div(2),g=l.sub(2).mul(r).div(r.mul(l).sub(h.mul(2)).add(l.mul(new Complex([0,2])))),c=h.div(2),m=h.mul(l).sub(r.mul(2)).add(new Complex([0,4])).div(l.mul(2).add(4).mul(g)),u=h.mul(l).sub(r.mul(2)).sub(new Complex([0,4])).mul(g).div(l.mul(2).sub(4)),f=r.sub(new Complex([0,2])).div(2),d=r.div(2),$=r.add(new Complex([0,2])).div(2);this.coefficients[0][0][0]=c.re,this.coefficients[0][0][1]=c.im,this.coefficients[0][1][0]=m.re,this.coefficients[0][1][1]=m.im,this.coefficients[0][2][0]=u.re,this.coefficients[0][2][1]=u.im,this.coefficients[0][3][0]=c.re,this.coefficients[0][3][1]=c.im,this.coefficients[1][0][0]=f.re,this.coefficients[1][0][1]=f.im,this.coefficients[1][1][0]=d.re,this.coefficients[1][1][1]=d.im,this.coefficients[1][2][0]=d.re,this.coefficients[1][2][1]=d.im,this.coefficients[1][3][0]=$.re,this.coefficients[1][3][1]=$.im;for(let _=0;_<2;_++){let b=this.coefficients[_][0][0],w=this.coefficients[_][0][1],x=this.coefficients[_][1][0],p=this.coefficients[_][1][1],S=this.coefficients[_][2][0],v=this.coefficients[_][2][1],z=this.coefficients[_][3][0],D=this.coefficients[_][3][1];this.coefficients[_+2]=[[z,D],[-x,-p],[-S,-v],[b,w]]}}rileyCoefficients(e=this.wilson.draggables.worldCoordinates[0][0],i=this.wilson.draggables.worldCoordinates[0][1]){this.coefficients[0][0][0]=1,this.coefficients[0][0][1]=0,this.coefficients[0][1][0]=0,this.coefficients[0][1][1]=0,this.coefficients[0][2][0]=e,this.coefficients[0][2][1]=i,this.coefficients[0][3][0]=1,this.coefficients[0][3][1]=0,this.coefficients[1][0][0]=1,this.coefficients[1][0][1]=0,this.coefficients[1][1][0]=2,this.coefficients[1][1][1]=0,this.coefficients[1][2][0]=0,this.coefficients[1][2][1]=0,this.coefficients[1][3][0]=1,this.coefficients[1][3][1]=0;for(let t=0;t<2;t++){let s=this.coefficients[t][0][0],h=this.coefficients[t][0][1],r=this.coefficients[t][1][0],a=this.coefficients[t][1][1],n=this.coefficients[t][2][0],o=this.coefficients[t][2][1],l=this.coefficients[t][3][0],g=this.coefficients[t][3][1];this.coefficients[t+2]=[[l,g],[-r,-a],[-n,-o],[s,h]]}}grandmaSpecialCoefficients(e=this.wilson.draggables.worldCoordinates[0][0],i=this.wilson.draggables.worldCoordinates[0][1],t=this.wilson.draggables.worldCoordinates[1][0],s=this.wilson.draggables.worldCoordinates[1][1],h=this.wilson.draggables.worldCoordinates[2][0],r=this.wilson.draggables.worldCoordinates[2][1]){let a=new Complex(e,i),n=new Complex(t,s),o=new Complex(h,r),l=new Complex(0,1),g=new Complex(2,0),c=a.mul(a).add(n.mul(n)).add(o.mul(o)).sub(a.mul(n).mul(o)).sub(2),m=g.sub(c).sqrt(),u=c.add(l.mul(m).mul(c.add(2).sqrt())).abs(),f=c.add(2).sqrt().mul(u>=2?1:-1),d=o.sub(2).mul(n.add(f)).div(n.mul(o).sub(a.mul(2)).add(l.mul(m).mul(o))),$=a.div(2),_=a.mul(o).sub(n.mul(2)).add(l.mul(m).mul(2)).div(d.mul(o.mul(2).add(4))),b=d.mul(a.mul(o).sub(n.mul(2)).sub(l.mul(2).mul(m))).div(o.mul(2).sub(4)),w=n.sub(l.mul(m)).div(2),x=n.mul(o).sub(a.mul(2)).add(l.mul(m).mul(o)).div(d.mul(o.mul(2).add(4))),p=n.mul(o).sub(a.mul(2)).sub(l.mul(m).mul(o)).mul(d).div(o.mul(2).sub(4)),S=n.add(l.mul(m)).div(2);this.coefficients[0][0][0]=$.re,this.coefficients[0][0][1]=$.im,this.coefficients[0][1][0]=_.re,this.coefficients[0][1][1]=_.im,this.coefficients[0][2][0]=b.re,this.coefficients[0][2][1]=b.im,this.coefficients[0][3][0]=$.re,this.coefficients[0][3][1]=$.im,this.coefficients[1][0][0]=w.re,this.coefficients[1][0][1]=w.im,this.coefficients[1][1][0]=x.re,this.coefficients[1][1][1]=x.im,this.coefficients[1][2][0]=p.re,this.coefficients[1][2][1]=p.im,this.coefficients[1][3][0]=S.re,this.coefficients[1][3][1]=S.im;for(let v=0;v<2;v++){let z=this.coefficients[v][0][0],D=this.coefficients[v][0][1],T=this.coefficients[v][1][0],y=this.coefficients[v][1][1],W=this.coefficients[v][2][0],H=this.coefficients[v][2][1],C=this.coefficients[v][3][0],F=this.coefficients[v][3][1];this.coefficients[v+2]=[[C,F],[-T,-y],[-W,-H],[z,D]]}}bakeCoefficients=this.grandmaCoefficients;changeRecipe(e){0===e?(this.bakeCoefficients=this.grandmaCoefficients,this.wilson.draggables.draggables[1].style.display="block",this.wilson.draggables.draggables[2].style.display="none"):1===e?(this.bakeCoefficients=this.rileyCoefficients,this.wilson.draggables.draggables[1].style.display="none",this.wilson.draggables.draggables[2].style.display="none"):2===e&&(this.bakeCoefficients=this.grandmaSpecialCoefficients,this.wilson.draggables.draggables[1].style.display="block",this.wilson.draggables.draggables[2].style.display="block")}drawFrame(e){let i=e-this.lastTimestamp;if(this.lastTimestamp=e,0===i)return;this.bakeCoefficients();for(let t=0;t<4;t++)this.searchStep(0,0,t,-1,-1,1);let s=0;for(let h=0;h<this.brightness.length;h++)s=Math.max(s,this.brightness[h]);for(let r=0;r<this.imageHeight;r++)for(let a=0;a<this.imageWidth;a++){let n=r*this.imageWidth+a;this.image[4*n]=0,this.image[4*n+1]=1,this.image[4*n+2]=Math.pow(this.brightness[n]/s,.15),this.image[4*n+3]=1}this.renderShaderStack()}renderShaderStack(){this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.imageWidth,this.imageHeight,0,this.wilson.gl.RGBA,this.wilson.gl.FLOAT,this.image),this.wilson.render.drawFrame(),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);let e=this.imageSize>=1e3?1:0;for(let i=0;i<e;i++){let t=this.wilson.render.getPixelData();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.imageWidth,this.imageHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,t),this.wilson.render.drawFrame()}this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);let s=this.wilson.render.getPixelData();this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.imageWidth,this.imageHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,s),this.wilson.render.drawFrame()}searchStep(e,i,t,s,h,r){if(r!==this.maxDepth)for(let a=3;a<6;a++){this.x=e,this.y=i;let n=(t+a)%4;this.applyTransformation(n);let o=this.imageWidth>=this.imageHeight?Math.floor((-this.y+this.boxSize/2)/this.boxSize*this.imageHeight):Math.floor((-this.y*(this.imageWidth/this.imageHeight)+this.boxSize/2)/this.boxSize*this.imageHeight),l=this.imageWidth>=this.imageHeight?Math.floor((this.x/(this.imageWidth/this.imageHeight)+this.boxSize/2)/this.boxSize*this.imageWidth):Math.floor((this.x+this.boxSize/2)/this.boxSize*this.imageWidth);if(o>=0&&o<this.imageHeight&&l>=0&&l<this.imageWidth){if(this.brightness[this.imageWidth*o+l]===this.maxPixelBrightness)continue;(r>10||this.imageSize!==this.resolutionSmall)&&this.brightness[this.imageWidth*o+l]++}this.searchStep(this.x,this.y,n,o,l,r+1)}}applyTransformation(e){let i=this.coefficients[e][0][0],t=this.coefficients[e][0][1],s=this.coefficients[e][1][0],h=this.coefficients[e][1][1],r=this.coefficients[e][2][0],a=this.coefficients[e][2][1],n=this.coefficients[e][3][0],o=this.coefficients[e][3][1],l=i*this.x-t*this.y+s,g=i*this.y+t*this.x+h,c=r*this.x-a*this.y+n,m=r*this.y+a*this.x+o,u=c*c+m*m;this.x=(l*c+g*m)/u,this.y=(g*c-l*m)/u}initDraggables(){this.wilson.draggables.add(2,0),this.wilson.draggables.add(2,0),this.wilson.draggables.add(2,-2),window.requestAnimationFrame(this.drawFrame.bind(this))}onGrabDraggable(e,i,t,s){this.imageSize=this.resolutionSmall,this.wilson.fullscreen.currentlyFullscreen?Page.Layout.aspectRatio>=1?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):(this.imageWidth=this.imageSize,this.imageHeight=this.imageSize),this.maxDepth=200,this.maxPixelBrightness=50,this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight),this.regenerateHueAndBrightness(),window.requestAnimationFrame(this.drawFrame.bind(this))}onReleaseDraggable(e,i,t,s){this.imageSize=this.resolutionLarge,this.wilson.fullscreen.currentlyFullscreen?Page.Layout.aspectRatio>=1?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):(this.imageWidth=this.imageSize,this.imageHeight=this.imageSize),this.maxDepth=200,this.maxPixelBrightness=50,this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight),this.regenerateHueAndBrightness(),window.requestAnimationFrame(this.drawFrame.bind(this))}onDragDraggable(e,i,t,s){for(let h=0;h<this.imageHeight;h++)for(let r=0;r<this.imageWidth;r++)this.brightness[this.imageWidth*h+r]=0;window.requestAnimationFrame(this.drawFrame.bind(this))}requestHighResFrame(e,i,t,s=this.boxSize){return new Promise((h,r)=>{this.imageSize=e,this.maxDepth=i,this.maxPixelBrightness=t,this.boxSize=s,this.wilson.fullscreen.currentlyFullscreen?Page.Layout.aspectRatio>=1?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):(this.imageWidth=this.imageSize,this.imageHeight=this.imageSize),this.regenerateHueAndBrightness();try{this.webWorker.terminate()}catch(a){}this.webWorker=new Worker(`/applets/quasi-fuchsian-groups/scripts/worker.${DEBUG?"":"min."}js`),this.workers.push(this.webWorker),this.webWorker.onmessage=e=>{this.brightness=e.data[0],this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight);for(let i=0;i<this.imageHeight;i++)for(let t=0;t<this.imageWidth;t++){let s=i*this.imageWidth+t;this.image[4*s]=0,this.image[4*s+1]=0,this.image[4*s+2]=this.brightness[s],this.image[4*s+3]=0}this.renderShaderStack(),h()},this.webWorker.postMessage([this.imageWidth,this.imageHeight,this.maxDepth,this.maxPixelBrightness,this.boxSize,this.coefficients])})}regenerateHueAndBrightness(){this.brightness=new Float32Array(this.imageWidth*this.imageHeight),this.image=new Float32Array(this.imageWidth*this.imageHeight*4),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]),this.wilson.gl.uniform1f(this.wilson.uniforms.textureStep[0],1/this.imageSize),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.gl.uniform1f(this.wilson.uniforms.textureStep[1],1/this.imageSize);for(let e=0;e<this.imageHeight;e++)for(let i=0;i<this.imageWidth;i++)this.brightness[this.imageWidth*e+i]=0}changeAspectRatio(){this.imageSize=this.resolutionSmall,this.wilson.fullscreen.currentlyFullscreen?Page.Layout.aspectRatio>=1?(this.imageWidth=Math.floor(this.imageSize*Page.Layout.aspectRatio),this.imageHeight=this.imageSize):(this.imageWidth=this.imageSize,this.imageHeight=Math.floor(this.imageSize/Page.Layout.aspectRatio)):(this.imageWidth=this.imageSize,this.imageHeight=this.imageSize),this.wilson.changeCanvasSize(this.imageWidth,this.imageHeight),this.regenerateHueAndBrightness(),window.requestAnimationFrame(this.drawFrame.bind(this))}}