"use strict";class QuasiFuchsianGroups extends Applet{load_promise=null;resolution_small=300;resolution_large=900;image_size=this.resolution_small;image_width=this.resolution_small;image_height=this.resolution_small;box_size=4;web_worker=null;last_timestamp=-1;t=[[2,0],[2,0]];coefficients=[[[0,0],[0,0],[0,0],[0,0]],[[0,0],[0,0],[0,0],[0,0]],[],[]];draw_another_frame=!1;need_to_restart=!0;max_depth=20;max_pixel_brightness=10;x=0;y=0;hue=null;brightness=null;image=null;constructor(i){super(i);let t={renderer:"hybrid",canvas_width:this.resolution_small,canvas_height:this.resolution_small,world_width:1,world_height:4,world_center_x:2,world_center_y:0,use_draggables:!0,draggables_mousedown_callback:this.on_grab_draggable.bind(this),draggables_touchstart_callback:this.on_grab_draggable.bind(this),draggables_mousemove_callback:this.on_drag_draggable.bind(this),draggables_touchmove_callback:this.on_drag_draggable.bind(this),draggables_mouseup_callback:this.on_release_draggable.bind(this),draggables_touchend_callback:this.on_release_draggable.bind(this),use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png",switch_fullscreen_callback:this.change_aspect_ratio.bind(this)};this.wilson=new Wilson(i,t),this.regenerate_hue_and_brightness(),this.load_promise=new Promise(async(i,t)=>{Site.scripts_loaded.complexjs||(await Site.load_script("/scripts/complex.min.js"),Site.scripts_loaded.complexjs=!0),this.init_draggables(),i()})}bake_coefficients(i=this.wilson.draggables.world_coordinates[0][0],t=this.wilson.draggables.world_coordinates[0][1],s=this.wilson.draggables.world_coordinates[1][0],e=this.wilson.draggables.world_coordinates[1][1]){let h=new Complex(i,t),a=new Complex(s,e),g=h.mul(a),r=h.mul(h).add(a.mul(a)),o=g.mul(g).sub(r.mul(4)),n=o.arg()>0?g.sub(o.sqrt()).div(2):g.add(o.sqrt()).div(2),l=n.sub(2).mul(a).div(a.mul(n).sub(h.mul(2)).add(n.mul(new Complex([0,2])))),m=h.div(2),c=h.mul(n).sub(a.mul(2)).add(new Complex([0,4])).div(n.mul(2).add(4).mul(l)),d=h.mul(n).sub(a.mul(2)).sub(new Complex([0,4])).mul(l).div(n.mul(2).sub(4)),f=a.sub(new Complex([0,2])).div(2),w=a.div(2),u=a.add(new Complex([0,2])).div(2);this.coefficients[0][0][0]=m.re,this.coefficients[0][0][1]=m.im,this.coefficients[0][1][0]=c.re,this.coefficients[0][1][1]=c.im,this.coefficients[0][2][0]=d.re,this.coefficients[0][2][1]=d.im,this.coefficients[0][3][0]=m.re,this.coefficients[0][3][1]=m.im,this.coefficients[1][0][0]=f.re,this.coefficients[1][0][1]=f.im,this.coefficients[1][1][0]=w.re,this.coefficients[1][1][1]=w.im,this.coefficients[1][2][0]=w.re,this.coefficients[1][2][1]=w.im,this.coefficients[1][3][0]=u.re,this.coefficients[1][3][1]=u.im;for(let b=0;b<2;b++){let $=this.coefficients[b][0][0],_=this.coefficients[b][0][1],p=this.coefficients[b][1][0],x=this.coefficients[b][1][1],z=this.coefficients[b][2][0],y=this.coefficients[b][2][1],v=this.coefficients[b][3][0],k=this.coefficients[b][3][1];this.coefficients[b+2]=[[v,k],[-p,-x],[-z,-y],[$,_]]}}draw_frame(i){let t=i-this.last_timestamp;if(this.last_timestamp=i,0===t)return;this.bake_coefficients();for(let s=0;s<4;s++)this.search_step(0,0,s,-1,-1,1);let e=this.brightness.slice().sort((i,t)=>i-t),h=e[e.length-1];if(this.image_size!==this.resolution_small)for(let a=1;a<this.image_height-1;a++)for(let g=1;g<this.image_width-1;g++)0!==this.brightness[this.image_width*a+g]&&0===this.brightness[this.image_width*(a-1)+g]&&0===this.brightness[this.image_width*(a-1)+(g+1)]&&0===this.brightness[this.image_width*a+(g+1)]&&0===this.brightness[this.image_width*(a+1)+(g+1)]&&0===this.brightness[this.image_width*(a+1)+g]&&0===this.brightness[this.image_width*(a+1)+(g-1)]&&0===this.brightness[this.image_width*a+(g-1)]&&0===this.brightness[this.image_width*(a-1)+(g-1)]&&(this.brightness[this.image_width*a+g]=0);for(let r=0;r<this.image_height;r++)for(let o=0;o<this.image_width;o++){let n=4*r*this.image_width+4*o,l=this.wilson.utils.hsv_to_rgb(this.hue[this.image_width*r+o],1,Math.pow(this.brightness[this.image_width*r+o]/h,.25));this.image[n]=l[0],this.image[n+1]=l[1],this.image[n+2]=l[2],this.image[n+3]=255}this.wilson.render.draw_frame(this.image)}search_step(i,t,s,e,h,a){if(a!==this.max_depth)for(let g=3;g<6;g++){this.x=i,this.y=t;let r=(s+g)%4;this.apply_transformation(r);let o=this.image_width>=this.image_height?Math.floor((-this.y+this.box_size/2)/this.box_size*this.image_height):Math.floor((-this.y*(this.image_width/this.image_height)+this.box_size/2)/this.box_size*this.image_height),n=this.image_width>=this.image_height?Math.floor((this.x/(this.image_width/this.image_height)+this.box_size/2)/this.box_size*this.image_width):Math.floor((this.x+this.box_size/2)/this.box_size*this.image_width);if(o>=0&&o<this.image_height&&n>=0&&n<this.image_width){if(this.brightness[this.image_width*o+n]===this.max_pixel_brightness)continue;(a>10||this.image_size!==this.resolution_small)&&this.brightness[this.image_width*o+n]++}this.search_step(this.x,this.y,r,o,n,a+1)}}apply_transformation(i){let t=this.coefficients[i][0][0],s=this.coefficients[i][0][1],e=this.coefficients[i][1][0],h=this.coefficients[i][1][1],a=this.coefficients[i][2][0],g=this.coefficients[i][2][1],r=this.coefficients[i][3][0],o=this.coefficients[i][3][1],n=t*this.x-s*this.y+e,l=t*this.y+s*this.x+h,m=a*this.x-g*this.y+r,c=a*this.y+g*this.x+o,d=m*m+c*c;this.x=(n*m+l*c)/d,this.y=(l*m-n*c)/d}init_draggables(){this.wilson.draggables.add(2,0),this.wilson.draggables.add(2,0),window.requestAnimationFrame(this.draw_frame.bind(this))}on_grab_draggable(i,t,s,e){this.image_size=this.resolution_small,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.max_depth=20,this.max_pixel_brightness=10,this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}on_release_draggable(i,t,s,e){DEBUG&&console.log(i,t,s),this.image_size=this.resolution_large,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.max_depth=100,this.max_pixel_brightness=50,this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}on_drag_draggable(i,t,s,e){for(let h=0;h<this.image_height;h++)for(let a=0;a<this.image_width;a++)this.brightness[this.image_width*h+a]=0;window.requestAnimationFrame(this.draw_frame.bind(this))}request_high_res_frame(i,t,s,e=this.box_size){return new Promise((h,a)=>{this.image_size=i,this.max_depth=t,this.max_pixel_brightness=s,this.box_size=e,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.regenerate_hue_and_brightness();try{this.web_worker.terminate()}catch(g){}this.web_worker=new Worker(`/applets/quasi-fuchsian-groups/scripts/worker.${DEBUG?"":"min."}js`),this.workers.push(this.web_worker),this.web_worker.onmessage=i=>{this.brightness=i.data[0],this.wilson.change_canvas_size(this.image_width,this.image_height);for(let t=0;t<this.image_height;t++)for(let s=0;s<this.image_width;s++){let e=4*t*this.image_width+4*s,a=this.wilson.utils.hsv_to_rgb(this.hue[this.image_width*t+s],1,this.brightness[this.image_width*t+s]);this.image[e]=a[0],this.image[e+1]=a[1],this.image[e+2]=a[2],this.image[e+3]=255}this.wilson.render.draw_frame(this.image),h()},this.web_worker.postMessage([this.image_width,this.image_height,this.max_depth,this.max_pixel_brightness,this.box_size,this.coefficients])})}regenerate_hue_and_brightness(){this.hue=Array(this.image_width*this.image_height),this.brightness=Array(this.image_width*this.image_height),this.image=new Uint8ClampedArray(this.image_width*this.image_height*4);for(let i=0;i<this.image_height;i++)for(let t=0;t<this.image_width;t++)this.x=i/this.image_height*this.box_size-this.box_size/2,this.y=this.box_size/2-t/this.image_width*this.box_size,this.hue[this.image_width*i+t]=(Math.atan2(-this.y,-this.x)+Math.PI)/(2*Math.PI),this.brightness[this.image_width*i+t]=0}change_aspect_ratio(){this.image_size=this.resolution_small,this.wilson.fullscreen.currently_fullscreen?Page.Layout.aspect_ratio>=1?(this.image_width=this.image_size,this.image_height=Math.floor(this.image_size/Page.Layout.aspect_ratio)):(this.image_width=Math.floor(this.image_size*Page.Layout.aspect_ratio),this.image_height=this.image_size):(this.image_width=this.image_size,this.image_height=this.image_size),this.wilson.change_canvas_size(this.image_width,this.image_height),this.regenerate_hue_and_brightness(),window.requestAnimationFrame(this.draw_frame.bind(this))}}