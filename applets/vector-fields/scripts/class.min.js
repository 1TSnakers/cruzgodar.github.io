import{doubleEncodingGlsl,getGlslBundle,loadGlsl}from"../../../scripts/src/complexGlsl.min.js";import{AnimationFrameApplet}from"/scripts/applets/animationFrameApplet.min.js";import{Applet,getMaxGlslString}from"/scripts/applets/applet.min.js";import{addTemporaryListener}from"/scripts/src/main.min.js";import{Wilson}from"/scripts/wilson.min.js";class VectorField extends AnimationFrameApplet{loadPromise;resolution=500;numParticles=0;maxParticles=5e3;aspectRatio=1;zoomLevel=.6515;fixedPointX=0;fixedPointY=0;dt=.00375;lifetime=150;particles=[];freeParticleSlots=[];updateTexture;dimTexture;updateCanvas;dimCanvas;wilsonUpdate;wilsonDim;panVelocityX=0;panVelocityY=0;zoomVelocity=0;nextPanVelocityX=0;nextPanVelocityY=0;nextZoomVelocity=0;lastPanVelocitiesX=[];lastPanVelocitiesY=[];lastZoomVelocities=[];panFriction=.96;panVelocityStartThreshhold=25e-5;panVelocityStopThreshhold=25e-5;zoomFriction=.9;zoomVelocityStartThreshhold=.002;zoomVelocityStopThreshhold=.002;timeElapsedHistoryLength=60;lastTimeElapsed=new Array(this.timeElapsedHistoryLength);averageTimeElapsed;frame=0;constructor({canvas,draggable1Location=[1,0],draggable2Location=[-1,0]}){super(canvas),this.updateCanvas=this.createHiddenCanvas(),this.dimCanvas=this.createHiddenCanvas();this.wilsonUpdate=new Wilson(this.updateCanvas,{renderer:"gpu",shader:`
			precision highp float;
			varying vec2 uv;
			
			void main(void)
			{
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		`,canvasWidth:100,canvasHeight:100}),this.wilsonUpdate.render.createFramebufferTexturePair(),this.wilsonUpdate.gl.bindTexture(this.wilsonUpdate.gl.TEXTURE_2D,this.wilsonUpdate.render.framebuffers[0].texture),this.wilsonUpdate.gl.bindFramebuffer(this.wilsonUpdate.gl.FRAMEBUFFER,null);var i={renderer:"gpu",shader:`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			uniform float dimAmount;
			
			void main(void)
			{
				vec3 v = texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0).xyz;
				
				gl_FragColor = vec4(v.x - dimAmount / 255.0, v.y, v.z, 1.0);
			}
		`,canvasWidth:this.resolution,canvasHeight:this.resolution},i=(this.wilsonDim=new Wilson(this.dimCanvas,i),this.wilsonDim.render.initUniforms(["dimAmount"],0),this.wilsonDim.render.loadNewShader(`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform vec2 pan;
			
			void main(void)
			{
				vec2 texCoord = (uv + vec2(1.0, 1.0)) / 2.0 - pan;
				
				if (texCoord.x >= 0.0 && texCoord.x < 1.0 && texCoord.y >= 0.0 && texCoord.y < 1.0)
				{
					vec3 v = texture2D(uTexture, texCoord).xyz;
					
					gl_FragColor = vec4(v.x, v.y, v.z, 1.0);
					
					return;
				}
				
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		`),this.wilsonDim.render.initUniforms(["pan"],1),this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[0]),this.wilsonDim.render.loadNewShader(`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform float scale;
			uniform vec2 fixedPoint;
			
			void main(void)
			{
				vec2 texCoord = ((uv + vec2(1.0, 1.0)) / 2.0 - fixedPoint) * scale + fixedPoint;
				
				if (texCoord.x >= 0.0 && texCoord.x < 1.0 && texCoord.y >= 0.0 && texCoord.y < 1.0)
				{
					vec3 v = texture2D(uTexture, texCoord).xyz;
					
					gl_FragColor = vec4(v.x / 1.06, v.y, v.z, 1.0);
					
					return;
				}
				
				gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
			}
		`),this.wilsonDim.render.initUniforms(["scale","fixedPoint"],2),this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[0]),this.wilsonDim.render.createFramebufferTexturePair(this.wilsonDim.gl.UNSIGNED_BYTE),this.wilsonDim.gl.bindTexture(this.wilsonDim.gl.TEXTURE_2D,this.wilsonDim.render.framebuffers[0].texture),this.wilsonDim.gl.bindFramebuffer(this.wilsonDim.gl.FRAMEBUFFER,null),this.dimTexture=new Uint8Array(this.resolution*this.resolution*4),`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform float maxBrightness;

			uniform float stepSizeX1;
			uniform float stepSizeY1;
			uniform float stepSizeX2;
			uniform float stepSizeY2;
			uniform float stepSizeX3;
			uniform float stepSizeY3;
			
			vec3 hsv2rgb(vec3 c)
			{
				vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
				vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
				return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
			}

			vec3 getPixel(vec2 uv)
			{
				vec3 v = texture2D(uTexture, (vec2(1.0 + uv.x, 1.0 - uv.y)) / 2.0).xyz;

				return hsv2rgb(vec3(v.y, v.z, v.x / maxBrightness));
			}
			
			void main(void)
			{
				vec3 distance1 = getPixel(uv);

				// Make a 2x2 square down and right.
				vec3 distance2 = getPixel(uv + vec2(stepSizeX1, 0.0));
				vec3 distance3 = getPixel(uv + vec2(0.0, stepSizeY1));
				vec3 distance6 = getPixel(uv + vec2(stepSizeX1, stepSizeY1));

				// Make a 3x3 square centered on the pixel.
				vec3 distance4 = getPixel(uv + vec2(-stepSizeX2, 0.0));
				vec3 distance5 = getPixel(uv + vec2(0.0, -stepSizeY2));
				vec3 distance7 = getPixel(uv + vec2(stepSizeX2, -stepSizeY2));
				vec3 distance8 = getPixel(uv + vec2(-stepSizeX2, stepSizeY2));
				vec3 distance9 = getPixel(uv + vec2(-stepSizeX2, -stepSizeY2));

				// Make a 5x5 circle centered on the pixel.
				vec3 distance10 = getPixel(uv + vec2(2.0 * stepSizeX3, 0.0));
				vec3 distance11 = getPixel(uv + vec2(2.0 * stepSizeX3, stepSizeY3));
				vec3 distance12 = getPixel(uv + vec2(2.0 * stepSizeX3, -stepSizeY3));
				vec3 distance13 = getPixel(uv + vec2(-2.0 * stepSizeX3, 0.0));
				vec3 distance14 = getPixel(uv + vec2(-2.0 * stepSizeX3, stepSizeY3));
				vec3 distance15 = getPixel(uv + vec2(-2.0 * stepSizeX3, -stepSizeY3));
				vec3 distance16 = getPixel(uv + vec2(0.0, 2.0 * stepSizeY3));
				vec3 distance17 = getPixel(uv + vec2(stepSizeX3, 2.0 * stepSizeY3));
				vec3 distance18 = getPixel(uv + vec2(-stepSizeX3, 2.0 * stepSizeY3));
				vec3 distance19 = getPixel(uv + vec2(0.0, -2.0 * stepSizeY3));
				vec3 distance20 = getPixel(uv + vec2(stepSizeX3, -2.0 * stepSizeY3));
				vec3 distance21 = getPixel(uv + vec2(-stepSizeX3, -2.0 * stepSizeY3));

				gl_FragColor = vec4(${getMaxGlslString("distance",21)}, 1.0);
			}
		`),i={renderer:"gpu",shader:i,canvasWidth:this.resolution,canvasHeight:this.resolution,worldWidth:2*Math.PI,worldHeight:2*Math.PI,worldCenterX:0,worldCenterY:0,useFullscreen:!0,trueFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",switchFullscreenCallback:this.generateNewField.bind(this,{}),useDraggables:!0,draggablesMousemoveCallback:this.onDragDraggable.bind(this),draggablesTouchmoveCallback:this.onDragDraggable.bind(this),mousedownCallback:this.onGrabCanvas.bind(this),touchstartCallback:this.onGrabCanvas.bind(this),mousedragCallback:this.onDragCanvas.bind(this),touchmoveCallback:this.onDragCanvas.bind(this),mouseupCallback:this.onReleaseCanvas.bind(this),touchendCallback:this.onReleaseCanvas.bind(this),wheelCallback:this.onWheelCanvas.bind(this),pinchCallback:this.onPinchCanvas.bind(this)},i=(this.wilson=new Wilson(canvas,i),this.wilson.render.initUniforms(["maxBrightness","stepSizeX1","stepSizeY1","stepSizeX2","stepSizeY2","stepSizeX3","stepSizeY3"]),this.wilson.gl.uniform1f(this.wilson.uniforms.maxBrightness,this.lifetime/255),this.wilson.render.createFramebufferTexturePair(this.wilson.gl.UNSIGNED_BYTE),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.draggables.add(...draggable1Location),this.wilson.draggables.add(...draggable2Location),this.handleResizeEvent.bind(this));addTemporaryListener({object:window,event:"resize",callback:i}),this.loadPromise=loadGlsl()}run({generatingCode,resolution=500,maxParticles=1e4,dt=.00375,lifetime=150,worldCenterX=0,worldCenterY=0,zoomLevel=.6515}){this.dt=dt;var i=`
			precision highp float;
			precision highp sampler2D;
			
			varying vec2 uv;
			
			uniform sampler2D uTexture;
			
			uniform float dt;
			
			uniform vec2 draggableArg;
			uniform vec2 draggableArg2;
			
			
			
			${getGlslBundle(generatingCode)}
			
			${doubleEncodingGlsl}
			
			
			
			vec2 f(float x, float y)
			{
				return vec2${generatingCode};
			}
			
			
			
			void main(void)
			{
				vec4 sample = texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0);
				
				if (int(sample.z) == 0)
				{
					return;
				}
				
				vec2 d = f(sample.x, sample.y);
		`,e=`
				${i}
				
				gl_FragColor = encodeFloat(dt * d.x + sample.x);
			}
		`,t=`
				${i}
				
				gl_FragColor = encodeFloat(dt * d.y + sample.y);
			}
		`,s=`
				${i}
				
				gl_FragColor = encodeFloat((atan(d.y, d.x) + 3.14159265) / 6.28318531);
			}
		`,o=`
				${i}
				
				gl_FragColor = encodeFloat(1.0 - exp(-1.2 * (d.x * d.x + d.y * d.y)));
			}
		`,i=`
				${i}
				
				gl_FragColor = encodeFloat(1.0 - exp(-1.2 * .9 * (d.x * d.x + d.y * d.y)));
			}
		`;this.wilsonUpdate.render.shaderPrograms=[],this.wilsonUpdate.render.loadNewShader(e),this.wilsonUpdate.render.loadNewShader(t),this.wilsonUpdate.render.loadNewShader(s),this.wilsonUpdate.render.loadNewShader(o),this.wilsonUpdate.render.loadNewShader(i);for(let a=0;a<5;a++)this.wilsonUpdate.render.initUniforms(["dt","draggableArg","draggableArg2"],a),this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[a]),this.wilsonUpdate.gl.uniform1f(this.wilsonUpdate.uniforms.dt[a],this.dt),this.wilsonUpdate.gl.uniform2fv(this.wilsonUpdate.uniforms.draggableArg[a],this.wilson.draggables.worldCoordinates[0]),this.wilsonUpdate.gl.uniform2fv(this.wilsonUpdate.uniforms.draggableArg2[a],this.wilson.draggables.worldCoordinates[1]);this.wilson.draggables.draggables[0].style.display=-1!==generatingCode.indexOf("draggableArg")?"block":"none",this.wilson.draggables.draggables[1].style.display=-1!==generatingCode.indexOf("draggableArg2")?"block":"none",this.generateNewField({resolution:resolution,maxParticles:maxParticles,dt:dt,lifetime:lifetime,worldCenterX:worldCenterX,worldCenterY:worldCenterY,zoomLevel:zoomLevel})}generateNewField({resolution=this.resolution,maxParticles=this.maxParticles,dt=this.dt,lifetime=this.lifetime,worldCenterX=this.wilson.worldCenterX,worldCenterY=this.wilson.worldCenterY,zoomLevel=this.zoomLevel}){this.resolution=resolution,this.maxParticles=maxParticles,this.dt=dt,this.lifetime=lifetime,this.wilson.worldCenterX=worldCenterX,this.wilson.worldCenterY=worldCenterY,this.zoomLevel=zoomLevel,this.zoomCanvas(),this.wilson.gl.uniform1f(this.wilson.uniforms.maxBrightness,this.lifetime/255),this.numParticles=0;var i=Math.ceil(Math.sqrt(maxParticles));this.wilsonUpdate.changeCanvasSize(i,i),this.changeAspectRatio(),this.particles=new Array(this.maxParticles),this.freeParticleSlots=new Array(this.maxParticles);for(let s=0;s<this.maxParticles;s++)this.particles[s]=[0,0,0],this.freeParticleSlots[s]=s;this.updateTexture=new Float32Array(this.wilsonUpdate.canvasWidth*this.wilsonUpdate.canvasHeight*4);for(let o=0;o<this.wilsonUpdate.canvasHeight;o++)for(let i=0;i<this.wilsonUpdate.canvasWidth;i++){var e=this.wilsonUpdate.canvasWidth*o+i;this.updateTexture[4*e]=0,this.updateTexture[4*e+1]=0,this.updateTexture[4*e+2]=0,this.updateTexture[4*e+3]=0}this.dimTexture=new Uint8Array(this.wilson.canvasWidth*this.wilson.canvasHeight*4);for(let a=0;a<this.wilson.canvasHeight;a++)for(let i=0;i<this.wilson.canvasWidth;i++){var t=this.wilson.canvasWidth*a+i;this.dimTexture[4*t]=0,this.dimTexture[4*t+1]=0,this.dimTexture[4*t+2]=0}this.resume()}drawFrame(timeElapsed){try{for(let i=0;i<5;i++)this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[i]),this.wilsonUpdate.gl.uniform1f(this.wilsonUpdate.uniforms.dt[i],this.dt*timeElapsed/6.944);if(this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[0]),this.frame<this.timeElapsedHistoryLength){if(this.lastTimeElapsed[this.frame]=Math.min(timeElapsed,16),this.frame===this.timeElapsedHistoryLength-1){let i=0;for(let e=0;e<this.timeElapsedHistoryLength;e++)i+=this.lastTimeElapsed[e];this.wilsonDim.gl.uniform1f(this.wilsonDim.uniforms.dimAmount[0],i/this.timeElapsedHistoryLength/6.944)}this.frame++}if(this.numParticles<this.maxParticles){var e=Math.min(Math.ceil(this.maxParticles/80),this.maxParticles-this.numParticles);for(let i=this.freeParticleSlots.length-e;i<this.freeParticleSlots.length;i++)this.createParticle(this.freeParticleSlots[i]);this.freeParticleSlots.splice(this.freeParticleSlots.length-e,e)}if(this.lastPanVelocitiesX.push(this.nextPanVelocityX),this.lastPanVelocitiesY.push(this.nextPanVelocityY),this.lastPanVelocitiesX.shift(),this.lastPanVelocitiesY.shift(),0!==this.nextPanVelocityX||0!==this.nextPanVelocityY){let i=-this.nextPanVelocityX,e=-this.nextPanVelocityY;Math.abs(i/this.wilson.worldWidth*this.wilson.canvasWidth)<1?i=0:this.nextPanVelocityX=0,Math.abs(e/this.wilson.worldHeight*this.wilson.canvasHeight)<1?e=0:this.nextPanVelocityY=0,0===i&&0===e||(this.panGrid(i,e),this.wilson.worldCenterY-=e,this.wilson.worldCenterX-=i)}else if(0!==this.panVelocityX||0!==this.panVelocityY){let i=-this.panVelocityX*timeElapsed/6.944,e=-this.panVelocityY*timeElapsed/6.944;Math.abs(i/this.wilson.worldWidth*this.wilson.canvasWidth)<1&&(i=0),Math.abs(e/this.wilson.worldHeight*this.wilson.canvasHeight)<1&&(e=0),this.panGrid(i,e),this.wilson.worldCenterY-=e,this.panVelocityY*=this.panFriction**(timeElapsed/6.944),this.wilson.worldCenterX-=i,this.panVelocityX*=this.panFriction**(timeElapsed/6.944),this.panVelocityX**2+this.panVelocityY**2<this.panVelocityStopThreshhold**2&&(this.panVelocityX=0,this.panVelocityY=0)}this.lastZoomVelocities.push(this.nextZoomVelocity),this.lastZoomVelocities.shift(),0!==this.nextZoomVelocity&&(this.zoomCanvas(),this.zoomGrid(this.fixedPointX,this.fixedPointY,this.nextZoomVelocity),this.nextZoomVelocity=0),0!==this.zoomVelocity&&(this.zoomCanvas(this.fixedPointX,this.fixedPointY),this.zoomGrid(this.fixedPointX,this.fixedPointY,this.zoomVelocity),this.zoomLevel=Math.min(Math.max(this.zoomLevel+this.zoomVelocity*timeElapsed/6.944,-3),3),this.zoomVelocity*=this.zoomFriction**(timeElapsed/6.944),Math.abs(this.zoomVelocity)<this.zoomVelocityStopThreshhold)&&(this.zoomVelocity=0),this.updateParticles(timeElapsed),this.drawField(),this.needNewFrame=!0}catch(i){this.generateNewField({})}}createParticle(index){this.particles[index][0]=this.wilson.worldCenterX+this.wilson.worldWidth*(Math.random()-.5),this.particles[index][1]=this.wilson.worldCenterY+this.wilson.worldHeight*(Math.random()-.5),this.particles[index][2]=Math.round(this.lifetime*(.5*Math.random()+.75)),this.numParticles++}destroyParticle(index){this.particles[index][2]=0,this.freeParticleSlots.push(index),this.numParticles--}updateParticles(){for(let d=0;d<this.wilsonUpdate.canvasHeight;d++)for(let i=0;i<this.wilsonUpdate.canvasWidth;i++){var e=this.wilsonUpdate.canvasWidth*d+i;e<this.particles.length&&this.particles[e][2]?(this.updateTexture[4*e]=this.particles[e][0],this.updateTexture[4*e+1]=this.particles[e][1],this.updateTexture[4*e+2]=1):this.updateTexture[4*e+2]=0}this.wilsonUpdate.gl.texImage2D(this.wilsonUpdate.gl.TEXTURE_2D,0,this.wilsonUpdate.gl.RGBA,this.wilsonUpdate.canvasWidth,this.wilsonUpdate.canvasHeight,0,this.wilsonUpdate.gl.RGBA,this.wilsonUpdate.gl.FLOAT,this.updateTexture),this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[0]),this.wilsonUpdate.render.drawFrame();var t=new Float32Array(this.wilsonUpdate.render.getPixelData().buffer),s=(this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[1]),this.wilsonUpdate.render.drawFrame(),new Float32Array(this.wilsonUpdate.render.getPixelData().buffer)),o=(this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[2]),this.wilsonUpdate.render.drawFrame(),new Float32Array(this.wilsonUpdate.render.getPixelData().buffer)),a=(this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[3]),this.wilsonUpdate.render.drawFrame(),new Float32Array(this.wilsonUpdate.render.getPixelData().buffer)),l=(this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[4]),this.wilsonUpdate.render.drawFrame(),new Float32Array(this.wilsonUpdate.render.getPixelData().buffer));for(let c=0;c<this.wilsonUpdate.canvasHeight;c++)for(let i=0;i<this.wilsonUpdate.canvasWidth;i++){var n,r,h=this.wilsonUpdate.canvasWidth*c+i;h<this.particles.length&&this.particles[h][2]&&(this.particles[h][0]=t[h],this.particles[h][1]=s[h],r=Math.round((.5-(this.particles[h][1]-this.wilson.worldCenterY)/this.wilson.worldHeight)*this.wilson.canvasHeight),n=Math.round(((this.particles[h][0]-this.wilson.worldCenterX)/this.wilson.worldWidth+.5)*this.wilson.canvasWidth),0<=r&&r<this.wilson.canvasHeight&&0<=n&&n<this.wilson.canvasWidth&&(r=r*this.wilson.canvasWidth+n,this.dimTexture[4*r]=this.lifetime,this.dimTexture[4*r+1]=255*o[h],this.dimTexture[4*r+2]=255*Math.max(a[h],l[h]),this.particles[h][2]--,!(this.particles[h][2]<=0))||this.destroyParticle(h))}}drawField(){this.wilsonDim.gl.texImage2D(this.wilsonDim.gl.TEXTURE_2D,0,this.wilsonDim.gl.RGBA,this.wilsonDim.canvasWidth,this.wilsonDim.canvasHeight,0,this.wilsonDim.gl.RGBA,this.wilsonDim.gl.UNSIGNED_BYTE,this.dimTexture),this.wilsonDim.render.drawFrame(),this.dimTexture=this.wilsonDim.render.getPixelData(),this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.wilson.canvasWidth,this.wilson.canvasHeight,0,this.wilson.gl.RGBA,this.wilson.gl.UNSIGNED_BYTE,this.dimTexture),this.wilson.render.drawFrame()}panGrid(xDelta,yDelta){this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[1]),this.wilsonDim.gl.uniform2f(this.wilsonDim.uniforms.pan[1],xDelta/this.wilson.worldWidth,-yDelta/this.wilson.worldHeight),this.drawField(),this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[0]),this.wilson.draggables.recalculateLocations()}zoomGrid(fixedPointX,fixedPointY,zoomDelta){if(!(this.zoomLevel<=-3||3<=this.zoomLevel)){var i=Math.pow(2,zoomDelta),e=(fixedPointX-this.wilson.worldCenterX)/this.wilson.worldWidth+.5,t=(this.wilson.worldCenterY-fixedPointY)/this.wilson.worldHeight+.5;if(this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[2]),this.wilsonDim.gl.uniform1f(this.wilsonDim.uniforms.scale[2],i),this.wilsonDim.gl.uniform2f(this.wilsonDim.uniforms.fixedPoint[2],e,t),this.drawField(),this.wilsonDim.gl.useProgram(this.wilsonDim.render.shaderPrograms[0]),this.wilson.draggables.recalculateLocations(),0<zoomDelta){var s=Math.pow(2,1.5*zoomDelta);for(let i=0;i<this.particles.length;i++)this.particles[i][2]&&1<=i%s&&this.destroyParticle(i)}}}onDragDraggable(activeDraggable=0,x=this.wilson.draggables.worldCoordinates[0][0],y=this.wilson.draggables.worldCoordinates[0][1]){var i=0===activeDraggable?this.wilsonUpdate.uniforms.draggableArg:this.wilsonUpdate.uniforms.draggableArg2;for(let e=0;e<5;e++)this.wilsonUpdate.gl.useProgram(this.wilsonUpdate.render.shaderPrograms[e]),this.wilsonUpdate.gl.uniform2f(i[e],x,y)}onGrabCanvas(){this.panVelocityX=0,this.panVelocityY=0,this.zoomVelocity=0,this.lastPanVelocitiesX=[0,0,0,0],this.lastPanVelocitiesY=[0,0,0,0],this.lastZoomVelocities=[0,0,0,0]}onDragCanvas(x,y,xDelta,yDelta){this.nextPanVelocityX+=-xDelta,this.nextPanVelocityY+=-yDelta}onReleaseCanvas(){let i=0;this.lastPanVelocitiesX.forEach((velocity,index)=>{Math.abs(velocity)>this.panVelocityX&&(this.panVelocityX=Math.abs(velocity),i=index)}),this.panVelocityX<this.panVelocityStartThreshhold?this.panVelocityX=0:this.panVelocityX=this.lastPanVelocitiesX[i],this.lastPanVelocitiesY.forEach((velocity,index)=>{Math.abs(velocity)>this.panVelocityY&&(this.panVelocityY=Math.abs(velocity),i=index)}),this.panVelocityY<this.panVelocityStartThreshhold?this.panVelocityY=0:this.panVelocityY=this.lastPanVelocitiesY[i],this.lastZoomVelocities.forEach((velocity,index)=>{Math.abs(velocity)>this.zoomVelocity&&(this.zoomVelocity=Math.abs(velocity),i=index)}),this.zoomVelocity<this.zoomVelocityStartThreshhold?this.zoomVelocity=0:this.zoomVelocity=this.lastZoomVelocities[i]}onWheelCanvas(x,y,scrollAmount){this.fixedPointX=x,this.fixedPointY=y,Math.abs(scrollAmount/100)<.3?(this.nextZoomVelocity=scrollAmount/100,this.zoomLevel=Math.min(Math.max(this.zoomLevel+scrollAmount/100,-3),3)):this.zoomVelocity+=.05*Math.sign(scrollAmount)}onPinchCanvas(x,y,touchDistanceDelta){let i;i=1<=this.aspectRatio?touchDistanceDelta/this.wilson.worldWidth*10:touchDistanceDelta/this.wilson.worldHeight*10,this.zoomLevel=Math.min(Math.max(this.zoomLevel-i,-3),3),this.nextZoomVelocity=-i,this.fixedPointX=x,this.fixedPointY=y}zoomCanvas(){var i;1<=this.aspectRatio?(i=this.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,4*Math.pow(2,this.zoomLevel)*this.aspectRatio,4*Math.pow(2,this.zoomLevel)),this.wilson.worldWidth=4*Math.pow(2,this.zoomLevel)*this.aspectRatio,this.wilson.worldHeight=4*Math.pow(2,this.zoomLevel),this.wilson.worldCenterX=i[0],this.wilson.worldCenterY=i[1]):(i=this.wilson.input.getZoomedWorldCenter(this.fixedPointX,this.fixedPointY,4*Math.pow(2,this.zoomLevel),4*Math.pow(2,this.zoomLevel)/this.aspectRatio),this.wilson.worldWidth=4*Math.pow(2,this.zoomLevel),this.wilson.worldHeight=4*Math.pow(2,this.zoomLevel)/this.aspectRatio,this.wilson.worldCenterX=i[0],this.wilson.worldCenterY=i[1]),this.wilson.draggables.recalculateLocations()}changeAspectRatio(){this.wilson.fullscreen.currentlyFullscreen?(this.aspectRatio=window.innerWidth/window.innerHeight,this.wilson.changeCanvasSize(...Applet.getEqualPixelFullScreen(this.resolution)),this.wilsonDim.changeCanvasSize(...Applet.getEqualPixelFullScreen(this.resolution)),1<=this.aspectRatio?(this.wilson.worldWidth=4*Math.pow(2,this.zoomLevel)*this.aspectRatio,this.wilson.worldHeight=4*Math.pow(2,this.zoomLevel)):(this.wilson.worldWidth=4*Math.pow(2,this.zoomLevel),this.wilson.worldHeight=4*Math.pow(2,this.zoomLevel)/this.aspectRatio)):(this.aspectRatio=1,this.wilson.changeCanvasSize(this.resolution,this.resolution),this.wilsonDim.changeCanvasSize(this.resolution,this.resolution),this.wilson.worldWidth=4*Math.pow(2,this.zoomLevel),this.wilson.worldHeight=4*Math.pow(2,this.zoomLevel)),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSizeX1,700<=this.resolution?2/this.wilson.canvasWidth:0),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSizeY1,700<=this.resolution?2/this.wilson.canvasHeight:0),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSizeX2,1e3<=this.resolution?2/this.wilson.canvasWidth:0),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSizeY2,1e3<=this.resolution?2/this.wilson.canvasHeight:0),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSizeX3,1500<=this.resolution?2/this.wilson.canvasWidth:0),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSizeY3,1500<=this.resolution?2/this.wilson.canvasHeight:0)}handleResizeEvent(){this.wilson.fullscreen.currentlyFullscreen&&this.generateNewField({})}}export{VectorField};