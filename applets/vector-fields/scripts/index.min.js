!async function(){"use strict";await Site.load_glsl();let e=500,r=0,t=5e3,a=1,n=.6515,o=0,l=0,i=.0075,d=[],s=[],c=Site.applet_process_id,$=new Wilson(Page.element.querySelector("#update-canvas"),{renderer:"gpu",canvas_width:100,canvas_height:100});$.render.create_framebuffer_texture_pair();let u=null;$.gl.bindTexture($.gl.TEXTURE_2D,$.render.framebuffers[0].texture),$.gl.bindFramebuffer($.gl.FRAMEBUFFER,null);let f=`
  precision highp float;
  precision highp sampler2D;
  
  varying vec2 uv;
  
  uniform sampler2D u_texture;
  
  void main(void)
  {
   vec3 v = texture2D(u_texture, (uv + vec2(1.0, 1.0)) / 2.0).xyz;
   
   gl_FragColor = vec4(v.x - 1.0 / 255.0, v.y, v.z, 1.0);
  }
 `,g=`
  precision highp float;
  precision highp sampler2D;
  
  varying vec2 uv;
  
  uniform sampler2D u_texture;
  
  uniform vec2 pan;
  
  void main(void)
  {
   vec2 tex_coord = (uv + vec2(1.0, 1.0)) / 2.0 - pan;
   
   if (tex_coord.x >= 0.0 && tex_coord.x < 1.0 && tex_coord.y >= 0.0 && tex_coord.y < 1.0)
   {
    vec3 v = texture2D(u_texture, tex_coord).xyz;
    
    gl_FragColor = vec4(v.x, v.y, v.z, 1.0);
    
    return;
   }
   
   gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
  }
 `,h=`
  precision highp float;
  precision highp sampler2D;
  
  varying vec2 uv;
  
  uniform sampler2D u_texture;
  
  uniform float scale;
  uniform vec2 fixed_point;
  
  void main(void)
  {
   vec2 tex_coord = ((uv + vec2(1.0, 1.0)) / 2.0 - fixed_point) * scale + fixed_point;
   
   if (tex_coord.x >= 0.0 && tex_coord.x < 1.0 && tex_coord.y >= 0.0 && tex_coord.y < 1.0)
   {
    vec3 v = texture2D(u_texture, tex_coord).xyz;
    
    gl_FragColor = vec4(v.x / 1.06, v.y, v.z, 1.0);
    
    return;
   }
   
   gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
  }
 `,v={renderer:"gpu",shader:f,canvas_width:e,canvas_height:e},m=new Wilson(Page.element.querySelector("#dim-canvas"),v);m.gl.texParameteri(m.gl.TEXTURE_2D,m.gl.TEXTURE_MAG_FILTER,m.gl.LINEAR),m.gl.texParameteri(m.gl.TEXTURE_2D,m.gl.TEXTURE_MIN_FILTER,m.gl.LINEAR),m.render.load_new_shader(g),m.render.init_uniforms(["pan"],1),m.gl.useProgram(m.render.shader_programs[0]),m.render.load_new_shader(h),m.render.init_uniforms(["scale","fixed_point"],2),m.gl.useProgram(m.render.shader_programs[0]),m.render.create_framebuffer_texture_pair(m.gl.UNSIGNED_BYTE),m.gl.bindTexture(m.gl.TEXTURE_2D,m.render.framebuffers[0].texture),m.gl.bindFramebuffer(m.gl.FRAMEBUFFER,null);let p=new Uint8Array(e*e*4),w=`
  precision highp float;
  precision highp sampler2D;
  
  varying vec2 uv;
  
  uniform sampler2D u_texture;
  
  vec3 hsv2rgb(vec3 c)
  {
   vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
   vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
   return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
  }
  
  void main(void)
  {
   vec3 v = texture2D(u_texture, (vec2(1.0 + uv.x, 1.0 - uv.y)) / 2.0).xyz;
   
   gl_FragColor = vec4(hsv2rgb(vec3(v.y, v.z, v.x)), 1.0);
  }
 `,x={renderer:"gpu",shader:w,canvas_width:e,canvas_height:e,world_width:2*Math.PI,world_height:2*Math.PI,world_center_x:0,world_center_y:0,use_fullscreen:!0,true_fullscreen:!0,use_fullscreen_button:!0,enter_fullscreen_button_icon_path:"/graphics/general-icons/enter-fullscreen.png",exit_fullscreen_button_icon_path:"/graphics/general-icons/exit-fullscreen.png",switch_fullscreen_callback:k,mousedown_callback:V,touchstart_callback:V,mousedrag_callback:Z,touchmove_callback:Z,mouseup_callback:ee,touchend_callback:ee,wheel_callback:function e(r,t,a,i){o=r,l=t,.3>Math.abs(a/100)?(M=a/100,n=Math.min(Math.max(n+a/100,-3),3)):N+=.05*Math.sign(a)},pinch_callback:function e(r,t,i,d){let s;n=Math.min(Math.max(n-(s=a>=1?i/_.world_width*10:i/_.world_height*10),-3),3),M=-s,o=r,l=t}},_=new Wilson(Page.element.querySelector("#output-canvas"),x);_.render.create_framebuffer_texture_pair(_.gl.UNSIGNED_BYTE),_.gl.bindTexture(_.gl.TEXTURE_2D,_.render.framebuffers[0].texture),_.gl.bindFramebuffer(_.gl.FRAMEBUFFER,null);let b=Page.element.querySelector("#code-textarea");b.addEventListener("keydown",e=>{13===e.keyCode&&(e.preventDefault(),z())});let y=Page.element.querySelector("#generate-button");y.addEventListener("click",z);let E=Page.element.querySelector("#resolution-input");E.addEventListener("input",k);let D=Page.element.querySelector("#max-particles-input");D.addEventListener("input",k);let T=Page.element.querySelector("#speed-input");T.addEventListener("input",()=>{i=parseFloat(T.value||1)/75,$.gl.useProgram($.render.shader_programs[0]),$.gl.uniform1f($.uniforms.dt[0],i),$.gl.useProgram($.render.shader_programs[1]),$.gl.uniform1f($.uniforms.dt[1],i),$.gl.useProgram($.render.shader_programs[2]),$.gl.uniform1f($.uniforms.dt[2],i),$.gl.useProgram($.render.shader_programs[3]),$.gl.uniform1f($.uniforms.dt[3],i)});let F=Page.element.querySelector("#download-button");F.addEventListener("click",()=>{_.download_frame("a-vector-field.png")});let R={none:"",div:"(x, y)",curl:"(-y, x)",clockwork:"(sin(y), sin(x + PI))",df:"(1.0, sin(y) / (x*x + 1.0))",cross:"(sin(y / 2.5), tan(x / 2.5))"},P=Page.element.querySelector("#example-selector-dropdown");function z(){_.world_center_x=0,_.world_center_y=0,_.world_width=2*Math.PI,_.world_height=2*Math.PI,n=.6515;let e=b.value,r=`
   precision highp float;
   precision highp sampler2D;
   
   varying vec2 uv;
   
   uniform sampler2D u_texture;
   
   uniform float dt;
   
   
   
   ${Site.get_glsl_bundle(e)}
   
   
   
   //Don't know how, but this writes an honest float32 to the 32 bits of output, which JS then decodes.
   
   float shift_right(float v, float amt)
   {
    v = floor(v) + 0.5;
    return floor(v / exp2(amt));
   }
   
   float shift_left(float v, float amt)
   {
    return floor(v * exp2(amt) + 0.5);
   }
   
   float mask_last(float v, float bits)
   {
    return mod(v, shift_left(1.0, bits));
   }
   
   float extract_bits(float num, float from, float to)
   {
    from = floor(from + 0.5); to = floor(to + 0.5);
    return mask_last(shift_right(num, from), to - from);
   }
   
   vec4 encode_float(float val)
   {
    if (val == 0.0) return vec4(0, 0, 0, 0);
    float sign = val > 0.0 ? 0.0 : 1.0;
    val = abs(val);
    float exponent = floor(log2(val));
    float biased_exponent = exponent + 127.0;
    float fraction = ((val / exp2(exponent)) - 1.0) * 8388608.0;
    float t = biased_exponent / 2.0;
    float last_bit_of_biased_exponent = fract(t) * 2.0;
    float remaining_bits_of_biased_exponent = floor(t);
    float byte4 = extract_bits(fraction, 0.0, 8.0) / 255.0;
    float byte3 = extract_bits(fraction, 8.0, 16.0) / 255.0;
    float byte2 = (last_bit_of_biased_exponent * 128.0 + extract_bits(fraction, 16.0, 23.0)) / 255.0;
    float byte1 = (sign * 128.0 + remaining_bits_of_biased_exponent) / 255.0; 
    return vec4(byte4, byte3, byte2, byte1);
   }
   
   
   
   void main(void)
   {
    vec4 sample = texture2D(u_texture, (uv + vec2(1.0, 1.0)) / 2.0);
    
    if (int(sample.z) == 0)
    {
     return;
    }
    
    vec2 v = sample.xy;
    
    float x = v.x;
    float y = v.y;
  `,t=`
    ${r}
    
    vec2 d = vec2${e};
    
    gl_FragColor = encode_float(dt * d.x + x);
   }
  `,a=`
    ${r}
    
    vec2 d = vec2${e};
    
    gl_FragColor = encode_float(dt * d.y + y);
   }
  `,o=`
    ${r}
    
    vec2 d = vec2${e};
    
    gl_FragColor = encode_float((atan(d.y, d.x) + 3.14159265) / 6.28318531);
   }
  `,l=`
    ${r}
    
    vec2 d = vec2${e};
    
    gl_FragColor = encode_float(1.0 - exp(-1.2 * (d.x * d.x + d.y * d.y)));
   }
  `;$.render.shader_programs=[],$.render.load_new_shader(t),$.render.load_new_shader(a),$.render.load_new_shader(o),$.render.load_new_shader(l),$.render.init_uniforms(["dt"],0),$.render.init_uniforms(["dt"],1),$.render.init_uniforms(["dt"],2),$.render.init_uniforms(["dt"],3),$.gl.useProgram($.render.shader_programs[0]),$.gl.uniform1f($.uniforms.dt[0],i),$.gl.useProgram($.render.shader_programs[1]),$.gl.uniform1f($.uniforms.dt[1],i),$.gl.useProgram($.render.shader_programs[2]),$.gl.uniform1f($.uniforms.dt[2],i),$.gl.useProgram($.render.shader_programs[3]),$.gl.uniform1f($.uniforms.dt[3],i),k()}function k(){e=parseInt(E.value||500),r=0,t=Math.max(parseInt(D.value||3e3),100);let o=Math.ceil(Math.sqrt(t));$.change_canvas_size(o,o),i=parseFloat(T.value||1)/100,_.fullscreen.currently_fullscreen?(a=window.innerWidth/window.innerHeight)>=1?(_.change_canvas_size(Math.ceil(e*a),e),m.change_canvas_size(Math.ceil(e*a),e),_.world_width=4*Math.pow(2,n)*a,_.world_height=4*Math.pow(2,n)):(_.change_canvas_size(e,Math.ceil(e/a)),m.change_canvas_size(e,Math.ceil(e/a)),_.world_width=4*Math.pow(2,n),_.world_height=4*Math.pow(2,n)/a):(a=1,_.change_canvas_size(e,e),m.change_canvas_size(e,e),_.world_width=4*Math.pow(2,n),_.world_height=4*Math.pow(2,n)),d=Array(t),s=Array(t);for(let l=0;l<t;l++)d[l]=[0,0,0],s[l]=l;u=new Float32Array($.canvas_width*$.canvas_height*4);for(let c=0;c<$.canvas_height;c++)for(let f=0;f<$.canvas_width;f++){let g=$.canvas_width*c+f;u[4*g]=0,u[4*g+1]=0,u[4*g+2]=0,u[4*g+3]=0}p=new Uint8Array(_.canvas_width*_.canvas_height*4);for(let h=0;h<_.canvas_height;h++)for(let v=0;v<_.canvas_width;v++){let w=_.canvas_width*h+v;p[4*w]=0,p[4*w+1]=0,p[4*w+2]=0}window.requestAnimationFrame(U)}P.addEventListener("input",()=>{"none"!==P.value&&(b.value=R[P.value],z())}),z(),Page.show();let I=-1;function U(e){try{let a=e-I;if(I=e,0===a)return;if(r<t){let i=Math.min(Math.ceil(t/80),t-r);for(let f=s.length-i;f<s.length;f++)A(s[f]);s.splice(s.length-i,i)}if(Y.push(X),H.push(K),Y.shift(),H.shift(),0!==X||0!==K){let g=-X,h=-K;1>Math.abs(g/_.world_width*_.canvas_width)?g=0:X=0,1>Math.abs(h/_.world_height*_.canvas_height)?h=0:K=0,B(g,h),_.world_center_y-=h,_.world_center_x-=g}else if(0!==C||0!==G){let v=-C,m=-G;1>Math.abs(v/_.world_width*_.canvas_width)&&(v=0),1>Math.abs(m/_.world_height*_.canvas_height)&&(m=0),B(v,m),_.world_center_y-=m,G*=O,_.world_center_x-=v,C*=O,Math.sqrt(C*C+G*G)<W&&(C=0,G=0)}if(J.push(M),J.shift(),0!==M&&(er(),L(o,l,M),M=0),0!==N&&(er(o,l),L(o,l,N),n=Math.min(Math.max(n+N,-3),3),N*=j,Math.abs(N)<Q&&(N=0)),function e(){for(let r=0;r<$.canvas_height;r++)for(let t=0;t<$.canvas_width;t++){let a=$.canvas_width*r+t;a<d.length&&d[a][2]?(u[4*a]=d[a][0],u[4*a+1]=d[a][1],u[4*a+2]=1):u[4*a+2]=0}$.gl.texImage2D($.gl.TEXTURE_2D,0,$.gl.RGBA,$.canvas_width,$.canvas_height,0,$.gl.RGBA,$.gl.FLOAT,u),$.gl.useProgram($.render.shader_programs[0]),$.render.draw_frame();let n=new Float32Array($.render.get_pixel_data().buffer);$.gl.useProgram($.render.shader_programs[1]),$.render.draw_frame();let o=new Float32Array($.render.get_pixel_data().buffer);$.gl.useProgram($.render.shader_programs[2]),$.render.draw_frame();let l=new Float32Array($.render.get_pixel_data().buffer);$.gl.useProgram($.render.shader_programs[3]),$.render.draw_frame();let i=new Float32Array($.render.get_pixel_data().buffer);for(let s=0;s<$.canvas_height;s++)for(let c=0;c<$.canvas_width;c++){let f=$.canvas_width*s+c;if(f<d.length&&d[f][2]){d[f][0]=n[f],d[f][1]=o[f];let g=Math.round((.5-(d[f][1]-_.world_center_y)/_.world_height)*_.canvas_height),h=Math.round(((d[f][0]-_.world_center_x)/_.world_width+.5)*_.canvas_width);if(g>=0&&g<_.canvas_height&&h>=0&&h<_.canvas_width){let v=g*_.canvas_width+h;p[4*v]=255,p[4*v+1]=255*l[f],p[4*v+2]=255*i[f],d[f][2]--,d[f][2]<=0&&S(f)}else S(f)}}}(),q(),c!==Site.applet_process_id){console.log("Terminated applet process");return}window.requestAnimationFrame(U)}catch(w){k()}}function A(e){d[e][0]=_.world_center_x+_.world_width*(Math.random()-.5),d[e][1]=_.world_center_y+_.world_height*(Math.random()-.5),d[e][2]=Math.round(255*(.5*Math.random()+.75)),r++}function S(e){d[e][2]=0,s.push(e),r--}function q(){m.gl.texImage2D(m.gl.TEXTURE_2D,0,m.gl.RGBA,m.canvas_width,m.canvas_height,0,m.gl.RGBA,m.gl.UNSIGNED_BYTE,p),m.render.draw_frame(),p=m.render.get_pixel_data(),_.gl.texImage2D(_.gl.TEXTURE_2D,0,_.gl.RGBA,_.canvas_width,_.canvas_height,0,_.gl.RGBA,_.gl.UNSIGNED_BYTE,p),_.render.draw_frame()}function B(e,r){m.gl.useProgram(m.render.shader_programs[1]),m.gl.uniform2f(m.uniforms.pan[1],e/_.world_width,-r/_.world_height),q(),m.gl.useProgram(m.render.shader_programs[0])}function L(e,r,t){if(n<=-3||n>=3)return;let a=(e-_.world_center_x)/_.world_width+.5,o=(_.world_center_y-r)/_.world_height+.5;if(m.gl.useProgram(m.render.shader_programs[2]),m.gl.uniform1f(m.uniforms.scale[2],Math.pow(2,t)),m.gl.uniform2f(m.uniforms.fixed_point[2],a,o),q(),m.gl.useProgram(m.render.shader_programs[0]),t>0){let l=Math.pow(2,1.5*t);for(let i=0;i<d.length;i++)d[i][2]&&i%l>=1&&S(i)}}let C=0,G=0,N=0,X=0,K=0,M=0,Y=[],H=[],J=[],O=.96,W=25e-5,j=.9,Q=.002;function V(e,r,t){C=0,G=0,N=0,Y=[0,0,0,0],H=[0,0,0,0],J=[0,0,0,0]}function Z(e,r,t,a,n){X+=-t,K+=-a}function ee(e,r,t){let a=0;Y.forEach((e,r)=>{Math.abs(e)>C&&(C=Math.abs(e),a=r)}),C=C<25e-5?0:Y[a],H.forEach((e,r)=>{Math.abs(e)>G&&(G=Math.abs(e),a=r)}),G=G<25e-5?0:H[a],J.forEach((e,r)=>{Math.abs(e)>N&&(N=Math.abs(e),a=r)}),N=N<.002?0:J[a]}function er(){if(a>=1){let e=_.input.get_zoomed_world_center(o,l,4*Math.pow(2,n)*a,4*Math.pow(2,n));_.world_width=4*Math.pow(2,n)*a,_.world_height=4*Math.pow(2,n),_.world_center_x=e[0],_.world_center_y=e[1]}else{let r=_.input.get_zoomed_world_center(o,l,4*Math.pow(2,n),4*Math.pow(2,n)/a);_.world_width=4*Math.pow(2,n),_.world_height=4*Math.pow(2,n)/a,_.world_center_x=r[0],_.world_center_y=r[1]}}function et(){_.fullscreen.currently_fullscreen&&k()}window.addEventListener("resize",et),Page.temporary_handlers.resize.push(et)}();