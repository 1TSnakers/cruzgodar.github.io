import{FlagOverlap}from"./class.min.js";import{countriesByName,countryCodesAlphabetical,countryNameList,countryNames,largestAreaCountries,largestPopulationCountries,possibleAnswers,unMembers}from"./countryData.min.js";import{Button}from"/scripts/components/buttons.min.js";import{Checkbox}from"/scripts/components/checkboxes.min.js";import{Dropdown}from"/scripts/components/dropdowns.min.js";import{addHoverEvent,addHoverEventWithScale}from"/scripts/src/hoverEvents.min.js";import{$,$$,addStyle,addTemporaryListener}from"/scripts/src/main.min.js";import{animate,fuzzySearch,sleep}from"/scripts/src/utils.min.js";export default async function(){var s=new URLSearchParams(window.location.search).get("leo");const n=$("#guess-selector"),l=$("#guess-selector-input"),i=$("#country-list");let o=!1;const c=new FlagOverlap({canvas:$("#output-canvas"),overlayCanvas:$("#overlay-canvas"),guessCanvases:Array.from($$(".guess-canvas")),overlayCanvases:Array.from($$(".overlay-canvas")),progressBars:Array.from($$(".progress-bar")),progressBarTexts:Array.from($$(".progress-bar-text")),overlapCheckboxes:Array.from($$(".guess-overlap-checkbox")),loadingOverlay:$("#loading-overlay"),winOverlay:$("#win-overlay"),viewFlagButtonContainer:$("#view-flag-button").parentElement}),r=(new Button({element:$("#replay-button"),name:"Play Again",onClick:()=>{c.replay(),o=!0,l.focus()}}),new Button({element:$("#view-flag-button"),name:"View Flag",onClick:()=>c.wilsonOverlay.enterFullscreen()}),new Checkbox({element:$("#hide-flag-icons-checkbox"),name:"Hide flags in list",onInput:()=>{setTimeout(()=>{i.classList.toggle("hard-mode",r.checked)},100)}})),a=new Checkbox({element:$("#un-members-only-checkbox"),name:"UN members only",onInput:T}),d=new Checkbox({element:$("#large-area-only-checkbox"),name:"Large area countries only",onInput:T}),u=new Checkbox({element:$("#large-population-only-checkbox"),name:"Large population countries only",onInput:T}),p=new Dropdown({element:$("#possible-flags-dropdown"),name:"Possible Secret Flags",options:{all:"All Countries and Territories",americas:"The Americas",europe:"Europe",africa:"Africa",asiaAndPacific:"Asia and the Pacific",...s?{leo:"Leo"}:{}},onInput:T});p.loaded.then(()=>{c.possibleFlags=possibleAnswers[p.value||"all"]});let y=void 0;for(const[F,D]of c.overlapCheckboxes.entries())addHoverEventWithScale({element:D,scale:1.1,addBounceOnTouch:()=>!0}),D.addEventListener("click",()=>{D.classList.toggle("checked"),c.setShowDiffs(D.classList.contains("checked"),F)});addStyle(`
		.cap-background
		{
			transition: opacity .125s ease-out;
		}
	`);let m=!1,v=!1,f=void 0,h=possibleAnswers.all,g=Array.from({length:possibleAnswers.all.length},(_,i)=>i),b=[...g];for(const[B,H]of countryCodesAlphabetical.entries()){const O=document.createElement("div");O.classList.add("country-list-item"),O.setAttribute("data-country-code",H),O.innerHTML=`
			<img src="/applets/flagle/graphics/thumbnails/${H}.webp">
			<p class="body-text">${countryNames[H]}</p>
		`,O.style.order=B,i.appendChild(O),addHoverEvent({element:O,addBounceOnTouch:()=>!0,scale:1.05,callback:isHovering=>{var e;isHovering&&v?("0"!==O.style.order&&O.classList.remove("hover"),k(f)):isHovering&&(f!==b[B]&&(e=g[f],i.children[e].classList.remove("hover")),f=b[B])}}),O.addEventListener("click",async()=>{await c.loadPromise,l.value="",m=!1,l.blur(),L(),setTimeout(()=>c.guessFlag(H),100),y=H})}const w=document.createElement("div");function k(apparentIndex){var e=void 0===f?void 0:g[f],e=(void 0!==e&&i.children[e].classList.remove("hover"),f=apparentIndex,g[f]);0<i.children.length&&void 0!==e&&i.children[e].classList.add("hover")}function x(){var e=l.getBoundingClientRect().top,e=Math.min(window.innerHeight-e-100,500);i.style.maxHeight=e+"px"}async function A(){o?o=!1:(m=!0,x(),i.scrollTo(0,0),k(0),await sleep(20),"flex"!==i.style.display&&(i.style.display="flex",await animate(t=>{i.style.transform=`scale(${.975+.025*t})`,i.style.opacity=t},125,"easeOutQuad")))}async function L(){await animate(t=>{i.style.transform=`scale(${1-.025*t})`,i.style.opacity=1-t},125,"easeOutQuad"),i.style.display="none",f=void 0,C()}function C(){if(v=!0,setTimeout(()=>v=!1,100),0===l.value.length){g=Array.from({length:possibleAnswers.all.length},(_,i)=>i),b=[...g];for(const n of i.children)n.style.display="flex",n.classList.remove("hover"),n.style.order=1;f=void 0,w.style.display="none"}else{h=Array.from(new Set(fuzzySearch(l.value,countryNameList).map(name=>countriesByName[name]))),g=new Array(h.length);for(const o of i.children)o.style.display="none";for(var[e,t]of h.entries()){var t=countryCodesAlphabetical.indexOf(t),s=i.children[t];s.style.display="flex",s.style.order=e,s.classList.remove("hover"),g[e]=t,b[t]=e}i.scrollTo(0,0),w.style.display=0===h.length?"block":"none"}}w.classList.add("country-list-item"),w.innerHTML=`
		<p class="body-text" style="text-align: center; opacity: 0.5; width: 100%">No results</p>
	`,w.style.order=i.children.length,w.style.cursor="default",w.style.display="none",i.appendChild(w),l.addEventListener("focus",A),l.addEventListener("click",A),addTemporaryListener({object:document.documentElement,event:"pointerdown",callback:e=>{n.contains(e.target)||(l.blur(),m=!1,L())}}),l.addEventListener("input",()=>{C(),A()}),addTemporaryListener({object:window,event:"resize",callback:x});const E=["1","2","3","4","5","6","7","8","9","0"];async function T(){await Promise.all([a.loaded,d.loaded,u.loaded,p.loaded]),c.possibleFlags=possibleAnswers[p.value||"all"].filter(country=>!a.checked||unMembers.includes(country)).filter(country=>!d.checked||largestAreaCountries.includes(country)).filter(country=>!u.checked||largestPopulationCountries.includes(country))}addTemporaryListener({object:document.documentElement,event:"keydown",callback:e=>{if("Escape"===e.key&&m)l.blur(),m=!1,L();else if("ArrowDown"===e.key||40===e.keyCode)e.preventDefault(),f<h.length-1&&k(f+1),r=g[f],0<i.children.length&&void 0!==r&&i.children[r].scrollIntoView({behavior:"instant",block:"nearest",inline:"nearest"});else if("ArrowUp"===e.key||38===e.keyCode)e.preventDefault(),0<f&&k(f-1),r=g[f],0<i.children.length&&void 0!==r&&i.children[r].scrollIntoView({behavior:"instant",block:"nearest",inline:"nearest"});else if("Enter"===e.key){if(!function(){if(c.wilson.currentlyFullscreen||c.wilsonOverlay.currentlyFullscreen)return 1;for(const e of c.guesses)if(e.currentlyFullscreen)return 1}())if(e.preventDefault(),e.stopPropagation(),c.gameOver)c.replay();else if(0===l.value.length&&y&&0===c.guesses.length&&void 0===f&&c.guessFlag(y),void 0!==f){const a=g[f];l.value="",l.blur(),m=!1,L(),setTimeout(()=>{var e=i.children[a].getAttribute("data-country-code");c.guessFlag(e),y=e},100)}}else if("Tab"===e.key){for(var[t,s]of c.guesses.entries())if(s.currentlyFullscreen)return e.preventDefault(),c.setShowDiffs(!s.showDiffs,t),void c.overlapCheckboxes[t].classList.toggle("checked");var n,o;0!==c.guesses.length&&(n=c.guesses.length-1,o=c.guesses[n],e.preventDefault(),c.setShowDiffs(!o.showDiffs,n),c.overlapCheckboxes[n].classList.toggle("checked"))}else E.includes(e.key)||1===e.key.length&&l.focus();var r}}),new Button({element:$("#give-up-button"),name:"Give Up",onClick:()=>{0!==c.guesses.length&&c.lose()}})}