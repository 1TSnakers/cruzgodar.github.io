class DoublePendulumFractal extends Applet{resolution=1E3;dt=.01;drawnFractal=!1;pendulumCanvas=null;lastTimestamp=-1;drawingFractal=!0;wilsonPendulum=null;resolutionPendulum=2E3;lastTimestampPendulum=-1;pendulumCanvasVisible=0;theta1=0;theta2=0;p1=0;p2=0;frame=0;initialTheta1=0;initialTheta2=0;constructor(a,b){super(a);this.pendulumCanvas=b;this.wilson=new Wilson(a,{renderer:"gpu",shader:"\n\t\t\tprecision highp float;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\tgl_FragColor = vec4((uv + vec2(1.0, 1.0)) / 2.0, 0.5, 0.5);\n\t\t\t\t\n\t\t\t\treturn;\n\t\t\t}\n\t\t",
canvasWidth:this.resolution,canvasHeight:this.resolution,useFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"});this.wilson.render.loadNewShader("\n\t\t\tprecision highp float;\n\t\t\tprecision highp sampler2D;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform sampler2D uTexture;\n\t\t\t\n\t\t\tconst float dt = .01;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\tvec4 state = (texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0) - vec4(.5, .5, .5, .5)) * (3.14159265358 * 2.0);\n\t\t\t\t\n\t\t\t\tfloat denom = 16.0 - 9.0 * cos(state.x - state.y) * cos(state.x - state.y);\n\t\t\t\t\n\t\t\t\tvec4 dState = vec4(6.0 * (2.0 * state.z - 3.0 * cos(state.x - state.y) * state.w) / denom, 6.0 * (8.0 * state.w - 3.0 * cos(state.x - state.y) * state.z) / denom, 0.0, 0.0);\n\t\t\t\t\n\t\t\t\tdState.z = -(dState.x * dState.y * sin(state.x - state.y) + 3.0 * sin(state.x)) / 2.0;\n\t\t\t\t\n\t\t\t\tdState.w = (dState.x * dState.y * sin(state.x - state.y) - sin(state.y)) / 2.0;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tstate = ((dt * dState + state) / (3.14159265358 * 2.0)) + vec4(.5, .5, .5, .5);\n\t\t\t\t\n\t\t\t\tstate.xy = fract(state.xy);\n\t\t\t\t\n\t\t\t\tgl_FragColor = state;\n\t\t\t}\n\t\t");
this.wilson.render.loadNewShader("\n\t\t\tprecision highp float;\n\t\t\tprecision highp sampler2D;\n\t\t\t\n\t\t\tvarying vec2 uv;\n\t\t\t\n\t\t\tuniform sampler2D uTexture;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvec3 hsv2rgb(vec3 c)\n\t\t\t{\n\t\t\t\tvec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);\n\t\t\t\tvec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);\n\t\t\t\treturn c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tvoid main(void)\n\t\t\t{\n\t\t\t\tvec4 state = (texture2D(uTexture, (uv + vec2(1.0, 1.0)) / 2.0) - vec4(.5, .5, .5, .5));\n\t\t\t\t\n\t\t\t\tfloat h = atan(state.y, state.x) / 3.14159265258 + 1.0;\n\t\t\t\t\n\t\t\t\tfloat s = min((state.x * state.x + state.y * state.y) * 100.0, 1.0);\n\t\t\t\t\n\t\t\t\tfloat vAdd = .9 * (1.0 - 4.0 * ((uv.x * uv.x) / 4.0 + (uv.y * uv.y) / 4.0));\n\t\t\t\t\n\t\t\t\tfloat v = min(sqrt(state.z * state.z + state.w * state.w) + vAdd, 1.0);\n\t\t\t\t\n\t\t\t\tvec3 rgb = hsv2rgb(vec3(h, s, v));\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(rgb, 1.0);\n\t\t\t}\n\t\t");
this.wilson.render.createFramebufferTexturePair();this.wilson.render.createFramebufferTexturePair();a={renderer:"cpu",canvasWidth:this.resolutionPendulum,canvasHeight:this.resolutionPendulum,mousemoveCallback:this.drawPreviewPendulum.bind(this),touchmoveCallback:this.drawPreviewPendulum.bind(this),mousedownCallback:this.startPendulumAnimation.bind(this),touchendCallback:this.startPendulumAnimation.bind(this)};this.wilsonPendulum=new Wilson(this.pendulumCanvas,a);this.wilsonPendulum.ctx.lineWidth=
this.resolutionPendulum/100;this.wilsonPendulum.ctx.strokeStyle="rgb(127, 0, 255)";this.wilsonPendulum.ctx.fillStyle="rgb(0, 0, 0)";this.wilsonPendulum.draggables.container.addEventListener("mouseleave",()=>{if(1===this.pendulumCanvasVisible||3>this.frame)Page.Animate.changeOpacity(this.pendulumCanvas,0,Site.buttonAnimationTime),this.pendulumCanvasVisible=0})}run(a){this.drawnFractal=!1;this.drawingFractal=!0;this.resolution=a;this.wilson.changeCanvasSize(this.resolution,this.resolution);this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,
this.wilson.render.framebuffers[0].texture);this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.wilson.canvasWidth,this.wilson.canvasHeight,0,this.wilson.gl.RGBA,this.wilson.gl.FLOAT,null);this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture);this.wilson.gl.texImage2D(this.wilson.gl.TEXTURE_2D,0,this.wilson.gl.RGBA,this.wilson.canvasWidth,this.wilson.canvasHeight,0,this.wilson.gl.RGBA,this.wilson.gl.FLOAT,null);this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]);
this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture);this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,this.wilson.render.framebuffers[0].framebuffer);this.wilson.render.drawFrame();window.requestAnimationFrame(this.drawFrame.bind(this));this.drawnFractal=!0}drawFrame(a){const b=a-this.lastTimestamp;this.lastTimestamp=a;0!==b&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,
this.wilson.render.framebuffers[1].framebuffer),this.wilson.render.drawFrame(),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.render.drawFrame(),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,this.wilson.render.framebuffers[0].framebuffer),
this.wilson.render.drawFrame(),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.render.drawFrame(),this.drawingFractal&&!this.animationPaused&&window.requestAnimationFrame(this.drawFrame.bind(this)))}drawPreviewPendulum(a,b,c,d,e){this.drawingFractal||(0===this.pendulumCanvasVisible&&this.showPendulumCanvasPreview(),
2!==this.pendulumCanvasVisible&&(this.theta1=a*Math.PI,this.theta2=b*Math.PI,this.p2=this.p1=0,window.requestAnimationFrame(this.drawFramePendulum.bind(this))))}startPendulumAnimation(a,b,c){1===this.pendulumCanvasVisible&&(this.initialTheta1=this.theta1,this.initialTheta2=this.theta2,this.frame=this.p2=this.p1=0,this.showPendulumCanvas())}showPendulumCanvasPreview(){this.drawnFractal&&(this.drawingFractal=!1,Page.Animate.changeOpacity(this.pendulumCanvas,.5,Site.buttonAnimationTime),this.pendulumCanvasVisible=
1)}showPendulumCanvas(){this.drawnFractal&&(Page.Animate.changeOpacity(this.pendulumCanvas,1,Site.buttonAnimationTime),this.pendulumCanvasVisible=2,window.requestAnimationFrame(this.drawFramePendulum.bind(this)))}hidePendulumDrawerCanvas(){this.drawnFractal&&(this.drawingFractal=!0,Page.Animate.changeOpacity(this.pendulumCanvas,0,Site.buttonAnimationTime),this.pendulumCanvasVisible=0,window.requestAnimationFrame(this.drawFrame.bind(this)))}drawFramePendulum(a){var b=a-this.lastTimestampPendulum;this.lastTimestampPendulum=
a;if(0!==b){this.frame++;this.wilsonPendulum.ctx.fillRect(0,0,this.resolutionPendulum,this.resolutionPendulum);a=this.theta1/Math.PI;b=this.theta2/Math.PI;var c=this.p1/Math.PI,d=this.p2/Math.PI;a=this.wilsonPendulum.utils.hsvToRgb(Math.atan2(b,a)/Math.PI+1,Math.min(Math.min(50*(a*a+b*b),5*(1-Math.max(Math.abs(a),Math.abs(b)))),1),Math.min(Math.pow(c*c+d*d,.5)+3.6*((1-this.initialTheta1/(2*Math.PI))*(1-this.initialTheta1/(2*Math.PI))+(1-this.initialTheta2/(2*Math.PI))*(1-this.initialTheta2/(2*Math.PI))),
1));this.wilsonPendulum.ctx.strokeStyle=`rgb(${a[0]}, ${a[1]}, ${a[2]})`;this.wilsonPendulum.ctx.beginPath();this.wilsonPendulum.ctx.moveTo(this.resolutionPendulum/2,this.resolutionPendulum/2);this.wilsonPendulum.ctx.lineTo(this.resolutionPendulum/2+this.resolutionPendulum/6*Math.sin(this.theta1),this.resolutionPendulum/2+this.resolutionPendulum/6*Math.cos(this.theta1));this.wilsonPendulum.ctx.stroke();this.wilsonPendulum.ctx.beginPath();this.wilsonPendulum.ctx.moveTo(this.resolutionPendulum/2+(this.resolutionPendulum/
6-this.resolutionPendulum/200)*Math.sin(this.theta1),this.resolutionPendulum/2+(this.resolutionPendulum/6-this.resolutionPendulum/200)*Math.cos(this.theta1));this.wilsonPendulum.ctx.lineTo(this.resolutionPendulum/2+this.resolutionPendulum/6*Math.sin(this.theta1)+this.resolutionPendulum/6*Math.sin(this.theta2),this.resolutionPendulum/2+this.resolutionPendulum/6*Math.cos(this.theta1)+this.resolutionPendulum/6*Math.cos(this.theta2));this.wilsonPendulum.ctx.stroke();2===this.pendulumCanvasVisible&&(this.updateAngles(),
window.requestAnimationFrame(this.drawFramePendulum.bind(this)))}}updateAngles(){const a=6*(2*this.p1-3*Math.cos(this.theta1-this.theta2)*this.p2)/(16-9*Math.pow(Math.cos(this.theta1-this.theta2),2)),b=6*(8*this.p2-3*Math.cos(this.theta1-this.theta2)*this.p1)/(16-9*Math.pow(Math.cos(this.theta1-this.theta2),2)),c=-(a*b*Math.sin(this.theta1-this.theta2)+3*Math.sin(this.theta1))/2,d=(a*b*Math.sin(this.theta1-this.theta2)-Math.sin(this.theta2))/2;this.theta1+=a*this.dt*2.5;this.theta2+=b*this.dt*2.5;
this.p1+=c*this.dt*2.5;this.p2+=d*this.dt*2.5;this.theta1>=Math.PI?this.theta1-=2*Math.PI:this.theta1<-Math.PI&&(this.theta1+=2*Math.PI);this.theta2>=Math.PI?this.theta2-=2*Math.PI:this.theta2<-Math.PI&&(this.theta2+=2*Math.PI)}};
