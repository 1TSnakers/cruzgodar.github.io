"use strict";onmessage=async function(e){grid_size=e.data[0],num_grains=e.data[1],maximum_speed=e.data[2],await draw_sandpile_graph()};let grid_size=null,num_grains=null,maximum_speed=null,sandpile_graph=[],old_sandpile_graph=[];async function draw_sandpile_graph(){sandpile_graph=[],old_sandpile_graph=[];let e=[];for(let i=0;i<grid_size;i++){sandpile_graph[i]=[],old_sandpile_graph[i]=[],e[i]=[];for(let r=0;r<grid_size;r++)sandpile_graph[i][r]=0,old_sandpile_graph[i][r]=0,e[i][r]=0}sandpile_graph[Math.floor(grid_size/2)][Math.floor(grid_size/2)]=num_grains;let i=0,r=!0;for(;r;){r=!1;for(let i=1;i<=grid_size/2;i++)for(let s=1;s<=i;s++)if(sandpile_graph[i][s]>=4){let a=sandpile_graph[i][s]>>2;sandpile_graph[i][s]&=3,e[i-1][s]+=a,e[i][s+1]+=a,e[i+1][s]+=a,e[i][s-1]+=a,i===Math.floor(grid_size/2)-1&&(e[i+1][s]+=a),r=!0}for(let i=1;i<=grid_size/2;i++)for(let r=1;r<=i;r++)sandpile_graph[i][r]+=e[i][r];for(let i=1;i<=grid_size/2;i++)sandpile_graph[i][i]+=e[i][i];sandpile_graph[Math.floor(grid_size/2)][Math.floor(grid_size/2)]+=2*e[Math.floor(grid_size/2)][Math.floor(grid_size/2)];for(let i=1;i<=grid_size/2;i++)for(let r=1;r<=i;r++)e[i][r]=0;if(!1===r)break;++i%Math.floor(num_grains/500)==0&&(maximum_speed?color_piles():await color_piles())}maximum_speed?color_piles():await color_piles()}function color_piles(){return new Promise(function(e,i){let r=0;for(let e=1;e<=grid_size/2;e++)for(let i=1;i<=e;i++)sandpile_graph[e][i]>r&&(r=sandpile_graph[e][i]);for(let e=1;e<=grid_size/2;e++)for(let i=1;i<=e;i++)if(sandpile_graph[e][i]!==old_sandpile_graph[e][i]){let s=sandpile_graph[e][i],a=s/r*255;draw_8_fold_pixel(i,e,0===s?"rgb(0, 0, 0)":1===s?"rgb(0, 127, 255)":2===s?"rgb(92, 0, 255)":3===s?"rgb(255, 255, 0)":`rgb(${a}, ${a}, ${a})`)}for(let e=1;e<=grid_size/2;e++)for(let i=1;i<=e;i++)old_sandpile_graph[e][i]=sandpile_graph[e][i];setTimeout(e,50)})}function draw_8_fold_pixel(e,i,r){postMessage([e,i,r]),postMessage([grid_size-1-e,i,r]),postMessage([grid_size-1-i,e,r]),postMessage([grid_size-1-i,grid_size-1-e,r]),postMessage([grid_size-1-e,grid_size-1-i,r]),postMessage([e,grid_size-1-i,r]),postMessage([i,grid_size-1-e,r]),postMessage([i,e,r])}