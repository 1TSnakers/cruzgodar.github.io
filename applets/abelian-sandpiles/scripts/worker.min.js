"use strict";onmessage=async function(i){grid_size=i.data[0],num_grains=i.data[1],maximum_speed=i.data[2],await draw_sandpile_graph()};let grid_size=null,num_grains=null,maximum_speed=null,image=[],sandpile_graph=[],old_sandpile_graph=[];async function draw_sandpile_graph(){image=[],sandpile_graph=[],old_sandpile_graph=[];let i=[];for(let e=0;e<grid_size;e++){image[e]=[],sandpile_graph[e]=[],old_sandpile_graph[e]=[],i[e]=[];for(let a=0;a<grid_size;a++)image[e][a]="rgb(0, 0, 0)",sandpile_graph[e][a]=0,old_sandpile_graph[e][a]=0,i[e][a]=0}sandpile_graph[Math.floor(grid_size/2)][Math.floor(grid_size/2)]=num_grains;let e=0,a=!0;for(;a;){a=!1;for(let e=1;e<=grid_size/2;e++)for(let r=1;r<=e;r++)if(sandpile_graph[e][r]>=4){let l=sandpile_graph[e][r]>>2;sandpile_graph[e][r]&=3,i[e-1][r]+=l,i[e][r+1]+=l,i[e+1][r]+=l,i[e][r-1]+=l,e===Math.floor(grid_size/2)-1&&(i[e+1][r]+=l),a=!0}for(let e=1;e<=grid_size/2;e++)for(let a=1;a<=e;a++)sandpile_graph[e][a]+=i[e][a];for(let e=1;e<=grid_size/2;e++)sandpile_graph[e][e]+=i[e][e];sandpile_graph[Math.floor(grid_size/2)][Math.floor(grid_size/2)]+=2*i[Math.floor(grid_size/2)][Math.floor(grid_size/2)];for(let e=1;e<=grid_size/2;e++)for(let a=1;a<=e;a++)i[e][a]=0;if(!1===a)break;++e%Math.floor(num_grains/500)==0&&(maximum_speed?color_piles():await color_piles())}maximum_speed?color_piles():await color_piles(),postMessage(["done"])}function color_piles(){return new Promise(function(i,e){let a=0;for(let i=1;i<=grid_size/2;i++)for(let e=1;e<=i;e++)sandpile_graph[i][e]>a&&(a=sandpile_graph[i][e]);for(let i=1;i<=grid_size/2;i++)for(let e=1;e<=i;e++)if(sandpile_graph[i][e]!==old_sandpile_graph[i][e]){let r=sandpile_graph[i][e],l=r/a*255;draw_8_fold_pixel(e,i,0===r?"rgb(0, 0, 0)":1===r?"rgb(0, 127, 255)":2===r?"rgb(92, 0, 255)":3===r?"rgb(255, 255, 0)":`rgb(${l}, ${l}, ${l})`)}postMessage([image]);for(let i=1;i<=grid_size/2;i++)for(let e=1;e<=i;e++)old_sandpile_graph[i][e]=sandpile_graph[i][e];setTimeout(i,50)})}function draw_8_fold_pixel(i,e,a){image[i][e]=a,image[grid_size-1-i][e]=a,image[grid_size-1-e][i]=a,image[grid_size-1-e][grid_size-1-i]=a,image[grid_size-1-i][grid_size-1-e]=a,image[i][grid_size-1-e]=a,image[e][grid_size-1-i]=a,image[e][i]=a}