import{FlagOverlap}from"./class.min.js";import{countriesByName,countryCodesAlphabetical,countryNameList,countryNames,largestAreaCountries,largestPopulationCountries,possibleAnswers,unMembers}from"./countryData.min.js";import{Button}from"/scripts/src/buttons.min.js";import{Checkbox}from"/scripts/src/checkboxes.min.js";import{Dropdown}from"/scripts/src/dropdowns.min.js";import{addHoverEvent,addHoverEventWithScale}from"/scripts/src/hoverEvents.min.js";import{$,$$,addStyle,addTemporaryListener}from"/scripts/src/main.min.js";import{animate,fuzzySearch,sleep}from"/scripts/src/utils.min.js";export default async function(){var s=new URLSearchParams(window.location.search).get("leo");const r=$("#guess-selector-input"),l=$("#country-list");let o=!1;const i=new FlagOverlap({canvas:$("#output-canvas"),overlayCanvas:$("#overlay-canvas"),guessCanvases:Array.from($$(".guess-canvas")),overlayCanvases:Array.from($$(".overlay-canvas")),progressBars:Array.from($$(".progress-bar")),progressBarTexts:Array.from($$(".progress-bar-text")),overlapCheckboxes:Array.from($$(".guess-overlap-checkbox")),loadingOverlay:$("#loading-overlay"),winOverlay:$("#win-overlay"),viewFlagButtonContainer:$("#view-flag-button").parentElement}),a=(new Button({element:$("#replay-button"),name:"Play Again",onClick:()=>{i.replay(),o=!0,r.focus()}}),new Button({element:$("#view-flag-button"),name:"View Flag",onClick:()=>i.wilsonOverlay.enterFullscreen()}),new Checkbox({element:$("#hide-flag-icons-checkbox"),name:"Hide flags in list",onInput:()=>{setTimeout(()=>{l.classList.toggle("hard-mode",a.checked)},100)}})),n=new Checkbox({element:$("#un-members-only-checkbox"),name:"UN members only",onInput:E}),c=new Checkbox({element:$("#large-area-only-checkbox"),name:"Large area countries only",onInput:E}),d=new Checkbox({element:$("#large-population-only-checkbox"),name:"Large population countries only",onInput:E}),u=new Dropdown({element:$("#possible-flags-dropdown"),name:"Possible Secret Flags",options:{all:"All Countries and Territories",americas:"The Americas",europe:"Europe",africa:"Africa",asiaAndPacific:"Asia and the Pacific",...s?{leo:"Leo"}:{}},onInput:E});u.loaded.then(()=>{i.possibleFlags=possibleAnswers[u.value||"all"]});let p=void 0;for(const[T,D]of i.overlapCheckboxes.entries())addHoverEventWithScale({element:D,scale:1.1,addBounceOnTouch:()=>!0}),D.addEventListener("click",()=>{D.classList.toggle("checked"),i.setShowDiffs(D.classList.contains("checked"),T)});addStyle(`
		.cap-background
		{
			transition: opacity .125s ease-out;
		}

		#loading-overlay
		{
			transition: opacity 0.125s 0.25s ease-out;
		}
	`);let y=!1,v=!1,m=void 0,f=possibleAnswers.all,h=Array.from({length:possibleAnswers.all.length},(_,i)=>i),g=[...h];for(const[F,H]of countryCodesAlphabetical.entries()){const S=document.createElement("div");S.classList.add("country-list-item"),S.setAttribute("data-country-code",H),S.innerHTML=`
			<img src="/applets/flag-overlap/graphics/thumbnails/${H}.webp">
			<p class="body-text">${countryNames[H]}</p>
		`,S.style.order=F,l.appendChild(S),addHoverEvent({element:S,addBounceOnTouch:()=>!0,scale:1.05,callback:isHovering=>{var e;isHovering&&v?("0"!==S.style.order&&S.classList.remove("hover"),w(m)):isHovering&&(m!==g[F]&&(e=h[m],l.children[e].classList.remove("hover")),m=g[F])}}),S.addEventListener("pointerdown",async()=>{await i.loadPromise,r.value="",setTimeout(()=>i.guessFlag(H),100),p=H})}const b=document.createElement("div");function w(apparentIndex){var e=void 0===m?void 0:h[m],e=(void 0!==e&&l.children[e].classList.remove("hover"),m=apparentIndex,h[m]);0<l.children.length&&void 0!==e&&l.children[e].classList.add("hover")}function k(){var e=r.getBoundingClientRect().top,e=Math.min(window.innerHeight-e-100,500);l.style.maxHeight=e+"px"}async function x(){o?o=!1:(y=!0,k(),l.scrollTo(0,0),w(0),await sleep(20),"flex"!==l.style.display&&(l.style.display="flex",await animate(t=>{l.style.transform=`scale(${.975+.025*t})`,l.style.opacity=t},125,"easeOutQuad")))}async function A(){await animate(t=>{l.style.transform=`scale(${1-.025*t})`,l.style.opacity=1-t},125,"easeOutQuad"),l.style.display="none",m=void 0,L()}function L(){if(v=!0,setTimeout(()=>v=!1,100),0===r.value.length){h=Array.from({length:possibleAnswers.all.length},(_,i)=>i),g=[...h];for(const o of l.children)o.style.display="flex",o.classList.remove("hover"),o.style.order=1;m=void 0,b.style.display="none"}else{f=Array.from(new Set(fuzzySearch(r.value,countryNameList).map(name=>countriesByName[name]))),h=new Array(f.length);for(const a of l.children)a.style.display="none";for(var[e,s]of f.entries()){var s=countryCodesAlphabetical.indexOf(s),t=l.children[s];t.style.display="flex",t.style.order=e,t.classList.remove("hover"),h[e]=s,g[s]=e}l.scrollTo(0,0),b.style.display=0===f.length?"block":"none"}}b.classList.add("country-list-item"),b.innerHTML=`
		<p class="body-text" style="text-align: center; opacity: 0.5; width: 100%">No results</p>
	`,b.style.order=l.children.length,b.style.cursor="default",b.style.display="none",l.appendChild(b),r.addEventListener("focus",x),r.addEventListener("click",x),r.addEventListener("blur",()=>{y=!1,A()}),r.addEventListener("input",()=>{L(),x()}),addTemporaryListener({object:window,event:"resize",callback:k});const C=["1","2","3","4","5","6","7","8","9","0"];async function E(){await Promise.all([n.loaded,c.loaded,d.loaded,u.loaded]),i.possibleFlags=possibleAnswers[u.value||"all"].filter(country=>!n.checked||unMembers.includes(country)).filter(country=>!c.checked||largestAreaCountries.includes(country)).filter(country=>!d.checked||largestPopulationCountries.includes(country))}addTemporaryListener({object:document.documentElement,event:"keydown",callback:e=>{if("Escape"===e.key&&y)A();else if("ArrowDown"===e.key)e.preventDefault(),m<f.length-1&&w(m+1);else if("ArrowUp"===e.key)e.preventDefault(),0<m&&w(m-1);else if("Enter"===e.key){if(i.gameOver)i.replay();else if(0===r.value.length&&p&&0===i.guesses.length&&void 0===m&&i.guessFlag(p),void 0!==m){const n=h[m];r.value="",A(),setTimeout(()=>{var e=l.children[n].getAttribute("data-country-code");i.guessFlag(e),p=e},100)}}else if("Tab"===e.key){for(var[s,t]of i.guesses.entries())if(t.currentlyFullscreen)return e.preventDefault(),i.setShowDiffs(!t.showDiffs,s),void i.overlapCheckboxes[s].classList.toggle("checked");var o,a;0!==i.guesses.length&&(o=i.guesses.length-1,a=i.guesses[o],e.preventDefault(),i.setShowDiffs(!a.showDiffs,o),i.overlapCheckboxes[o].classList.toggle("checked"))}else C.includes(e.key)||1===e.key.length&&r.focus()}})}