import{FlagOverlap}from"./class.min.js";import{countriesByName,countryNameList,countryNames,largestAreaCountries,largestPopulationCountries,possibleAnswers,unMembers}from"./countryData.min.js";import{Button}from"/scripts/src/buttons.min.js";import{Checkbox}from"/scripts/src/checkboxes.min.js";import{Dropdown}from"/scripts/src/dropdowns.min.js";import{addHoverEvent,addHoverEventWithScale}from"/scripts/src/hoverEvents.min.js";import{$,$$,addStyle,addTemporaryListener}from"/scripts/src/main.min.js";import{animate,fuzzySearch,sleep}from"/scripts/src/utils.min.js";export default async function(){const r=$("#guess-selector-input"),a=$("#country-list");let s=!1;const o=new FlagOverlap({canvas:$("#output-canvas"),overlayCanvas:$("#overlay-canvas"),guessCanvases:Array.from($$(".guess-canvas")),overlayCanvases:Array.from($$(".overlay-canvas")),progressBars:Array.from($$(".progress-bar")),progressBarTexts:Array.from($$(".progress-bar-text")),overlapCheckboxes:Array.from($$(".guess-overlap-checkbox")),winOverlay:$("#win-overlay"),viewFlagButtonContainer:$("#view-flag-button").parentElement}),n=(new Button({element:$("#replay-button"),name:"Play Again",onClick:()=>{o.replay(),s=!0,r.focus()}}),new Button({element:$("#view-flag-button"),name:"View Flag",onClick:()=>o.wilsonOverlay.enterFullscreen()}),new Checkbox({element:$("#hide-flag-icons-checkbox"),name:"Hide flags in list",onInput:()=>{setTimeout(()=>{a.classList.toggle("hard-mode",n.checked)},100)}})),l=new Checkbox({element:$("#un-members-only-checkbox"),name:"UN members only",onInput:C}),i=new Checkbox({element:$("#large-area-only-checkbox"),name:"Large area countries only",onInput:C}),c=new Checkbox({element:$("#large-population-only-checkbox"),name:"Large population countries only",onInput:C}),d=new Dropdown({element:$("#possible-flags-dropdown"),name:"Possible Secret Flags",options:{all:"All Countries and Territories",americas:"The Americas",europe:"Europe",africa:"Africa",asiaAndPacific:"Asia and the Pacific"},onInput:C});d.loaded.then(()=>{o.possibleFlags=possibleAnswers[d.value||"all"]});let u=void 0;for(const[E,T]of o.overlapCheckboxes.entries())addHoverEventWithScale({element:T,scale:1.1,addBounceOnTouch:()=>!0}),T.addEventListener("click",()=>{T.classList.toggle("checked"),o.setShowDiffs(T.classList.contains("checked"),E)});addStyle(`
		.cap-background
		{
			transition: opacity .125s ease-out;
		}
	`);let p=!1,y=!1,m=void 0,v=possibleAnswers.all,f=Array.from({length:possibleAnswers.all.length},(_,i)=>i),h=[...f];for(const[H,B]of v.entries()){const F=document.createElement("div");F.classList.add("country-list-item"),F.innerHTML=`
			<img src="/applets/flag-overlap/graphics/thumbnails/${B}.webp">
			<p class="body-text">${countryNames[B]}</p>
		`,F.style.order=H,a.appendChild(F),addHoverEvent({element:F,addBounceOnTouch:()=>!0,scale:1.05,callback:isHovering=>{var e;isHovering&&y?("0"!==F.style.order&&F.classList.remove("hover"),b(m)):isHovering&&(m!==h[H]&&(e=f[m],a.children[e].classList.remove("hover")),m=h[H])}}),F.addEventListener("click",async()=>{await o.loadPromise,r.value="",setTimeout(()=>o.guessFlag(B),50),u=B})}const g=document.createElement("div");function b(apparentIndex){var e=void 0===m?void 0:f[m],e=(void 0!==e&&a.children[e].classList.remove("hover"),m=apparentIndex,f[m]);0<a.children.length&&void 0!==e&&a.children[e].classList.add("hover")}function w(){var e=r.getBoundingClientRect().top,e=Math.min(window.innerHeight-e-100,500);a.style.maxHeight=e+"px"}async function k(){s?s=!1:(p=!0,w(),a.scrollTo(0,0),b(0),await sleep(20),"flex"!==a.style.display&&(a.style.display="flex",await animate(t=>{a.style.transform=`scale(${.975+.025*t})`,a.style.opacity=t},125,"easeOutQuad")))}async function x(){await animate(t=>{a.style.transform=`scale(${1-.025*t})`,a.style.opacity=1-t},125,"easeOutQuad"),a.style.display="none",m=void 0,L()}function L(){if(y=!0,setTimeout(()=>y=!1,100),0===r.value.length){f=Array.from({length:possibleAnswers.all.length},(_,i)=>i),h=[...f];for(const n of a.children)n.style.display="flex",n.classList.remove("hover"),n.style.order=1;m=void 0,g.style.display="none"}else{v=Array.from(new Set(fuzzySearch(r.value,countryNameList).map(name=>countriesByName[name]))),f=new Array(v.length);for(const o of a.children)o.style.display="none";for(var[e,s]of v.entries()){var s=possibleAnswers.all.indexOf(s),t=a.children[s];t.style.display="flex",t.style.order=e,t.classList.remove("hover"),f[e]=s,h[s]=e}a.scrollTo(0,0),g.style.display=0===v.length?"block":"none"}}g.classList.add("country-list-item"),g.innerHTML=`
		<p class="body-text" style="text-align: center; opacity: 0.5">No results</p>
	`,g.style.order=a.children.length,g.style.cursor="default",g.style.display="none",a.appendChild(g),r.addEventListener("focus",k),r.addEventListener("click",k),r.addEventListener("blur",()=>{p=!1,x()}),r.addEventListener("input",()=>{L(),k()}),addTemporaryListener({object:window,event:"resize",callback:w});const A=["1","2","3","4","5","6","7","8","9","0"];async function C(){await Promise.all([l.loaded,i.loaded,c.loaded,d.loaded]),o.possibleFlags=possibleAnswers[d.value||"all"].filter(country=>!l.checked||unMembers.includes(country)).filter(country=>!i.checked||largestAreaCountries.includes(country)).filter(country=>!c.checked||largestPopulationCountries.includes(country))}addTemporaryListener({object:document.documentElement,event:"keydown",callback:e=>{if("Escape"===e.key&&p)x();else if("ArrowDown"===e.key)e.preventDefault(),m<v.length-1&&b(m+1);else if("ArrowUp"===e.key)e.preventDefault(),0<m&&b(m-1);else if("Enter"===e.key){if(p)if(o.gameOver)o.replay();else if(0===r.value.length&&u&&0===o.guesses.length&&void 0===m&&o.guessFlag(u),void 0!==m){const n=f[m];x(),setTimeout(()=>a.children[n].click(),50)}}else if("Tab"===e.key){for(var[s,t]of o.guesses.entries())if(t.currentlyFullscreen)return e.preventDefault(),o.setShowDiffs(!t.showDiffs,s),void o.overlapCheckboxes[s].classList.toggle("checked")}else A.includes(e.key)||1===e.key.length&&r.focus()}})}