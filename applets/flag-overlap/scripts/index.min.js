import{FlagOverlap}from"./class.min.js";import{countriesByName,countryNameList,countryNames,largestAreaCountries,largestPopulationCountries,possibleAnswers,unMembers}from"./countryData.min.js";import{Button}from"/scripts/src/buttons.min.js";import{Checkbox}from"/scripts/src/checkboxes.min.js";import{Dropdown}from"/scripts/src/dropdowns.min.js";import{addHoverEvent,addHoverEventWithScale}from"/scripts/src/hoverEvents.min.js";import{$,$$,addStyle,addTemporaryListener}from"/scripts/src/main.min.js";import{animate,fuzzySearch}from"/scripts/src/utils.min.js";export default async function(){const o=$("#guess-selector-input"),a=$("#country-list");let s=!1;const r=new FlagOverlap({canvas:$("#output-canvas"),overlayCanvas:$("#overlay-canvas"),guessCanvases:Array.from($$(".guess-canvas")),overlayCanvases:Array.from($$(".overlay-canvas")),progressBars:Array.from($$(".progress-bar")),progressBarTexts:Array.from($$(".progress-bar-text")),overlapCheckboxes:Array.from($$(".guess-overlap-checkbox")),winOverlay:$("#win-overlay"),viewFlagButtonContainer:$("#view-flag-button").parentElement}),n=(new Button({element:$("#replay-button"),name:"Play Again",onClick:()=>{r.replay(),s=!0,o.focus()}}),new Button({element:$("#view-flag-button"),name:"View Flag",onClick:()=>r.wilsonOverlay.enterFullscreen()}),new Checkbox({element:$("#hide-flag-icons-checkbox"),name:"Hide flags in list",onInput:()=>{setTimeout(()=>{a.classList.toggle("hard-mode",n.checked)},100)}})),l=new Checkbox({element:$("#un-members-only-checkbox"),name:"UN members only",onInput:A}),i=new Checkbox({element:$("#large-area-only-checkbox"),name:"Large area countries only",onInput:A}),c=new Checkbox({element:$("#large-population-only-checkbox"),name:"Large population countries only",onInput:A}),d=new Dropdown({element:$("#possible-flags-dropdown"),name:"Possible Secret Flags",options:{all:"All Countries and Territories",americas:"The Americas",europe:"Europe",africa:"Africa",asiaAndPacific:"Asia and the Pacific"},onInput:A});d.loaded.then(()=>{r.possibleFlags=possibleAnswers[d.value||"all"]});let u=void 0;for(const[L,C]of r.overlapCheckboxes.entries())addHoverEventWithScale({element:C,scale:1.1,addBounceOnTouch:()=>!0}),C.addEventListener("click",()=>{C.classList.toggle("checked"),r.setShowDiffs(C.classList.contains("checked"),L)});addStyle(`
		.cap-background
		{
			transition: opacity .125s ease-out;
		}
	`);let p=!1,m=!1,y=void 0,v=possibleAnswers.all,f=Array.from({length:possibleAnswers.all.length},(_,i)=>i),h=[...f];for(const[E,T]of v.entries()){const B=document.createElement("div");B.classList.add("country-list-item"),B.innerHTML=`
			<img src="/applets/flag-overlap/graphics/thumbnails/${T}.webp">
			<p class="body-text">${countryNames[T]}</p>
		`,B.style.order=E,a.appendChild(B),addHoverEvent({element:B,addBounceOnTouch:()=>!0,scale:1.05,callback:isHovering=>{var e;isHovering&&m?("0"!==B.style.order&&B.classList.remove("hover"),g(y)):isHovering&&(y!==h[E]&&(e=f[y],a.children[e].classList.remove("hover")),y=h[E])}}),B.addEventListener("click",async()=>{await r.loadPromise,o.value="",setTimeout(()=>r.guessFlag(T),50),u=T})}function g(apparentIndex){var e=void 0===y?void 0:f[y],e=(void 0!==e&&a.children[e].classList.remove("hover"),y=apparentIndex,f[y]);0<a.children.length&&void 0!==e&&a.children[e].classList.add("hover")}function b(){var e=o.getBoundingClientRect().top,e=Math.min(window.innerHeight-e-100,500);a.style.maxHeight=e+"px"}function w(){s?s=!1:(p=!0,b(),g(0),"flex"!==a.style.display&&(a.style.display="flex",animate(t=>{a.style.transform=`scale(${.975+.025*t})`,a.style.opacity=t},125,"easeOutQuad")))}async function k(){await animate(t=>{a.style.transform=`scale(${1-.025*t})`,a.style.opacity=1-t},125,"easeOutQuad"),a.style.display="none",y=void 0,x()}function x(){if(m=!0,setTimeout(()=>m=!1,100),0===o.value.length){f=Array.from({length:possibleAnswers.all.length},(_,i)=>i),h=[...f];for(const r of a.children)r.style.display="flex",r.classList.remove("hover"),r.style.order=1;y=void 0}else{v=Array.from(new Set(fuzzySearch(o.value,countryNameList).map(name=>countriesByName[name]))),f=new Array(v.length);for(const n of a.children)n.style.display="none";for(var[e,s]of v.entries()){var s=possibleAnswers.all.indexOf(s),t=a.children[s];t.style.display="flex",t.style.order=e,t.classList.remove("hover"),f[e]=s,h[s]=e}a.scrollTo(0,0)}}function A(){r.possibleFlags=possibleAnswers[d.value].filter(country=>!l.checked||unMembers.includes(country)).filter(country=>!i.checked||largestAreaCountries.includes(country)).filter(country=>!c.checked||largestPopulationCountries.includes(country))}o.addEventListener("focus",w),o.addEventListener("blur",()=>{p=!1,k()}),o.addEventListener("input",()=>{x(),w()}),addTemporaryListener({object:window,event:"resize",callback:b}),addTemporaryListener({object:document.documentElement,event:"keydown",callback:e=>{if("Escape"===e.key&&p)k();else if("ArrowDown"===e.key)e.preventDefault(),y<v.length-1&&g(y+1);else if("ArrowUp"===e.key)e.preventDefault(),0<y&&g(y-1);else if("Enter"===e.key&&p)if(r.gameOver)r.replay();else if(0===o.value.length&&u&&0===r.guesses.length&&void 0===y&&r.guessFlag(u),void 0!==y){const s=f[y];k(),setTimeout(()=>a.children[s].click(),50)}}})}