import{FlagOverlap}from"./class.min.js";import{countriesByName,countryNameList,countryNames,possibleAnswers}from"./countryData.min.js";import{Button}from"/scripts/src/buttons.min.js";import{Checkbox}from"/scripts/src/checkboxes.min.js";import{Dropdown}from"/scripts/src/dropdowns.min.js";import{addHoverEvent,addHoverEventWithScale}from"/scripts/src/hoverEvents.min.js";import{$,$$,addStyle,addTemporaryListener}from"/scripts/src/main.min.js";import{animate,fuzzySearch}from"/scripts/src/utils.min.js";export default async function(){const o=$("#guess-selector-input"),n=$("#country-list"),r=new FlagOverlap({canvas:$("#output-canvas"),overlayCanvas:$("#overlay-canvas"),guessCanvases:Array.from($$(".guess-canvas")),overlayCanvases:Array.from($$(".overlay-canvas")),progressBars:Array.from($$(".progress-bar")),progressBarTexts:Array.from($$(".progress-bar-text")),overlapCheckboxes:Array.from($$(".guess-overlap-checkbox")),winOverlay:$("#win-overlay"),viewFlagButtonContainer:$("#view-flag-button").parentElement}),s=(new Button({element:$("#replay-button"),name:"Play Again",onClick:()=>r.replay()}),new Button({element:$("#view-flag-button"),name:"View Flag",onClick:()=>r.wilsonOverlay.enterFullscreen()}),new Checkbox({element:$("#hide-flag-icons-checkbox"),name:"Hide flags in list",onInput:()=>{setTimeout(()=>{n.classList.toggle("hard-mode",s.checked)},100)}})),a=new Dropdown({element:$("#possible-flags-dropdown"),name:"Possible Secret Flags",options:{all:"All Countries and Territories",un:"UN Members and Observers",americas:"The Americas",europe:"Europe",africa:"Africa",asiaAndPacific:"Asia and the Pacific"},onInput:()=>{r.possibleFlags=possibleAnswers[a.value]}});a.loaded.then(()=>{r.possibleFlags=possibleAnswers[a.value||"all"]});let l=void 0;for(const[w,b]of r.overlapCheckboxes.entries())addHoverEventWithScale({element:b,scale:1.1,addBounceOnTouch:()=>!0}),b.addEventListener("click",()=>{b.classList.toggle("checked"),r.setShowDiffs(b.classList.contains("checked"),w)});addStyle(`
		.cap-background
		{
			transition: opacity .125s ease-out;
		}
	`);let i=!1,c=!1,d=void 0,p=possibleAnswers.all,v=Array.from({length:possibleAnswers.all.length},(_,i)=>i),m=[...v];for(const[k,A]of p.entries()){const L=document.createElement("div");L.classList.add("country-list-item"),L.innerHTML=`
			<img src="/applets/flag-overlap/graphics/thumbnails/${A}.webp">
			<p class="body-text">${countryNames[A]}</p>
		`,L.style.order=k,n.appendChild(L),addHoverEvent({element:L,addBounceOnTouch:()=>!0,scale:1.05,callback:isHovering=>{var e;isHovering&&c?("0"!==L.style.order&&L.classList.remove("hover"),u(d)):isHovering&&(d!==m[k]&&(e=v[d],n.children[e].classList.remove("hover")),d=m[k])}}),L.addEventListener("click",async()=>{await r.loadPromise,o.value="",setTimeout(()=>r.guessFlag(A),50),l=A})}function u(apparentIndex){var e=void 0===d?void 0:v[d],e=(void 0!==e&&n.children[e].classList.remove("hover"),d=apparentIndex,v[d]);0<n.children.length&&void 0!==e&&n.children[e].classList.add("hover")}function y(){var e=o.getBoundingClientRect().top,e=Math.min(window.innerHeight-e-100,500);n.style.maxHeight=e+"px"}function f(){i=!0,y(),u(0),"flex"!==n.style.display&&(n.style.display="flex",animate(t=>{n.style.transform=`scale(${.975+.025*t})`,n.style.opacity=t},125,"easeOutQuad"))}async function h(){await animate(t=>{n.style.transform=`scale(${1-.025*t})`,n.style.opacity=1-t},125,"easeOutQuad"),n.style.display="none",d=void 0,g()}function g(){if(c=!0,setTimeout(()=>c=!1,100),0===o.value.length){v=Array.from({length:possibleAnswers.all.length},(_,i)=>i),m=[...v];for(const t of n.children)t.style.display="flex",t.classList.remove("hover"),t.style.order=1;d=void 0}else{p=Array.from(new Set(fuzzySearch(o.value,countryNameList).map(name=>countriesByName[name]))),v=new Array(p.length);for(const a of n.children)a.style.display="none";for(var[e,s]of p.entries()){var s=possibleAnswers.all.indexOf(s),r=n.children[s];r.style.display="flex",r.style.order=e,r.classList.remove("hover"),v[e]=s,m[s]=e}n.scrollTo(0,0)}}o.addEventListener("focus",f),o.addEventListener("blur",()=>{i=!1,h()}),o.addEventListener("input",()=>{g(),f()}),addTemporaryListener({object:window,event:"resize",callback:y}),addTemporaryListener({object:document.documentElement,event:"keydown",callback:e=>{if("Escape"===e.key&&i)h();else if("ArrowDown"===e.key)e.preventDefault(),d<p.length-1&&u(d+1);else if("ArrowUp"===e.key)e.preventDefault(),0<d&&u(d-1);else if("Enter"===e.key&&i)if(r.gameOver)r.replay();else if(0===o.value.length&&l&&void 0===d&&(r.guessFlag(l),l=void 0),void 0!==d){const s=v[d];h(),setTimeout(()=>n.children[s].click(),50)}}})}