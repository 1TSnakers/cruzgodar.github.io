import{Applet,rgbToHsv}from"/scripts/applets/applet.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";const hThreshold=.25,sThreshold=.25,vThreshold=.25;class FlagOverlap extends Applet{loadPromise;wilsonCorrectFlag;resolution=2048;correctFlag="md";correctPixels;correctHsv;guesses=[];constructor({canvas}){super(canvas);var s={canvasWidth:this.resolution,interactionOptions:{callbacks:{}},fullscreenOptions:{useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}},a=(this.wilson=new WilsonCPU(canvas,s),this.createHiddenCanvas(!1));a.style.setProperty("aspect-ratio","1024 / 683","important"),this.wilsonCorrectFlag=new WilsonCPU(a,s),this.loadPromise=new Promise(resolve=>{this.drawFlag(this.wilsonCorrectFlag,this.correctFlag).then(returnValue=>{this.correctPixels=returnValue.pixels,this.correctHsv=returnValue.hsvData,resolve()})})}async drawFlag(wilson,flagId){let s;var a=new Promise(r=>s=r);const t=new Image;t.onload=()=>{wilson.ctx.drawImage(t,0,0,wilson.canvasWidth,wilson.canvasHeight),s()},t.src=`graphics/${flagId}.png`,await a;var e=wilson.ctx.getImageData(0,0,wilson.canvasWidth,wilson.canvasHeight).data,i=new Array(wilson.canvasWidth*wilson.canvasHeight*3);for(let n=0;n<wilson.canvasWidth*wilson.canvasHeight;n++){var l=rgbToHsv(e[4*n],e[4*n+1],e[4*n+2]);i[3*n]=l[0],i[3*n+1]=l[1],i[3*n+2]=l[2]}return{pixels:e,hsvData:i}}async guessFlag(flagId){var s={},a=(s.flagId=flagId,s.matchingPixels=new Array(this.wilson.canvasWidth*this.wilson.canvasHeight),await this.drawFlag(this.wilson,flagId));s.pixels=a.pixels,s.hsvData=a.hsvData;for(let l=0;l<this.wilson.canvasWidth*this.wilson.canvasHeight;l++){var t=Math.abs(s.hsvData[3*l]-this.correctHsv[3*l]),t=Math.min(t,1-t),e=Math.abs(s.hsvData[3*l+1]-this.correctHsv[3*l+1]),i=Math.abs(s.hsvData[3*l+2]-this.correctHsv[3*l+2]);s.matchingPixels[l]=t<hThreshold&&e<sThreshold&&i<vThreshold,s.matchingPixels[l]||(s.pixels[4*l]=0,s.pixels[4*l+1]=0,s.pixels[4*l+2]=0)}a=new ImageData(s.pixels,this.wilson.canvasWidth,this.wilson.canvasHeight);this.wilson.ctx.putImageData(a,0,0)}}export{FlagOverlap};