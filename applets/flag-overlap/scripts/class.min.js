import{Applet,rgbToHsv}from"/scripts/applets/applet.min.js";import{pageUrl}from"/scripts/src/main.min.js";import{WilsonCPU}from"/scripts/wilson.min.js";const hThreshold=.075,sThreshold=.4,vThreshold=.4;class FlagOverlap extends Applet{loadPromise;guessCanvases;wilsonCorrectFlag;resolution=2048;correctFlag="bw";correctPixels;correctHsv;guesses=[];constructor({canvas,guessCanvases}){super(canvas),this.guessCanvases=guessCanvases;var s={canvasWidth:this.resolution,fullscreenOptions:{useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png"}},a=(this.wilson=new WilsonCPU(canvas,s),this.createHiddenCanvas(!0,1024/683));this.wilsonCorrectFlag=new WilsonCPU(a,s),this.loadPromise=new Promise(resolve=>{this.drawFlag(this.wilsonCorrectFlag,this.correctFlag).then(returnValue=>{this.correctPixels=returnValue.pixels,this.correctHsv=returnValue.hsvData,resolve()})})}async drawFlag(wilson,flagId){let s;var a=new Promise(r=>s=r);const e=new Image;e.onload=()=>{wilson.ctx.drawImage(e,0,0,wilson.canvasWidth,wilson.canvasHeight),s()},e.src=pageUrl+`/graphics/${flagId}.png`,await a;var t=wilson.ctx.getImageData(0,0,wilson.canvasWidth,wilson.canvasHeight).data,i=new Array(wilson.canvasWidth*wilson.canvasHeight*3);for(let l=0;l<wilson.canvasWidth*wilson.canvasHeight;l++){var n=rgbToHsv(t[4*l],t[4*l+1],t[4*l+2]);i[3*l]=n[0],i[3*l+1]=n[1],i[3*l+2]=n[2]}return{pixels:t,hsvData:i}}async animateToImageData(wilson,newPixels){wilson.ctx.getImageData(0,0,wilson.canvasWidth,wilson.canvasHeight).data}updateMainCanvas(){var s=new Uint8ClampedArray(this.wilson.canvasWidth*this.wilson.canvasHeight*4);for(let a=0;a<this.wilson.canvasWidth*this.wilson.canvasHeight;a++){s[4*a]=32,s[4*a+1]=32,s[4*a+2]=32,s[4*a+3]=255;for(const e of this.guesses)if(e.matchingPixels[a]){s[4*a]=this.correctPixels[4*a],s[4*a+1]=this.correctPixels[4*a+1],s[4*a+2]=this.correctPixels[4*a+2];break}}new ImageData(s,this.wilson.canvasWidth,this.wilson.canvasHeight)}async guessFlag(flagId){const s={};s.flagId=flagId,s.matchingPixels=new Array(this.wilson.canvasWidth*this.wilson.canvasHeight);var a=await this.drawFlag(this.wilson,flagId);s.pixels=a.pixels,s.hsvData=a.hsvData;for(let n=0;n<this.wilson.canvasWidth*this.wilson.canvasHeight;n++){var e=Math.abs(s.hsvData[3*n]-this.correctHsv[3*n]),e=Math.min(e,1-e),t=Math.abs(s.hsvData[3*n+1]-this.correctHsv[3*n+1]),i=Math.abs(s.hsvData[3*n+2]-this.correctHsv[3*n+2]);s.matchingPixels[n]=e<hThreshold&&t<sThreshold&&i<vThreshold,s.matchingPixels[n]||(s.pixels[4*n]=32,s.pixels[4*n+1]=32,s.pixels[4*n+2]=32)}a=()=>{s.wilson.currentlyFullscreen?s.wilson.exitFullscreen():s.wilson.enterFullscreen()},a={canvasWidth:this.resolution,interactionOptions:{callbacks:{mousedown:a,touchstart:a}}},s.wilson=new WilsonCPU(this.guessCanvases[this.guesses.length],a),a=new ImageData(s.pixels,this.wilson.canvasWidth,this.wilson.canvasHeight);s.wilson.ctx.putImageData(a,0,0),this.guesses.push(s)}}export{FlagOverlap};