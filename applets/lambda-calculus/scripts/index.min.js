import{showPage}from"../../../scripts/src/loadPage.min.js";import{LambdaCalculus}from"./class.min.js";import{Button,DownloadButton,ToggleButton}from"/scripts/src/buttons.min.js";import{$}from"/scripts/src/main.min.js";import{setOnThemeChange}from"/scripts/src/settings.min.js";import{Slider}from"/scripts/src/sliders.min.js";import{Textarea}from"/scripts/src/textareas.min.js";import{TextBox}from"/scripts/src/textBoxes.min.js";export default function(){const r=new LambdaCalculus({canvas:$("#output-canvas")}),s=new TextBox({element:$("#resolution-input"),name:"Resolution",value:2e3,minValue:1e3,maxValue:3e3,onEnter:()=>e(!0)}),i=new Textarea({element:$("#expression-textarea"),name:"Expression",value:"",onInput:e,onEnter:()=>e(!0)}),o=(new Button({element:$("#reduce-button"),name:"Reduce",onClick:()=>e(!0)}),new ToggleButton({element:$("#play-pause-button"),name0:"Pause",name1:"Play",persistState:!1,onClick0:()=>r.animationPaused=!0,onClick1:()=>r.animationPaused=!1})),m=new Slider({element:$("#animation-time-slider"),name:"Animation Speed",value:1,min:.25,max:10,logarithmic:!0,snapPoints:[.5,1,2,3,4,5,6,7,8,9,10],onInput:function(){r.animationTime=500/m.value}});async function e(betaReduce=!1){await Promise.all([i.loaded,s.loaded,o.loaded,m.loaded]),o.state&&(o.setState({newState:!1}),r.animationPaused=!1);var e=i.value.length,{selectionStart:a,selectionEnd:n}=i.element;let t=0;i.setValue(i.value.replaceAll(/l/g,"λ").replaceAll(/([0-9]+)/g,(match,$1)=>{var e=parseInt($1);return`(λf.λx.${"f(".repeat(e)}x${")".repeat(e)})`}).replaceAll(/I/g,"(λx.x)").replaceAll(/K/g,"(λx.λy.x)").replaceAll(/S/g,"(λx.λy.λz.(xz)(yz))").replaceAll(/Y/g,"(λf.(λx.f(xx))(λx.f(xx)))").replaceAll(/Z/g,"(λf.(λx.f(λv.xxv))(λx.f(λv.xxv)))").replaceAll(/P/g,"(λx.λy.λz.zxy)").replaceAll(/F/g,"(λp.p(λx.λy.x))").replaceAll(/L/g,"(λp.p(λx.λy.y))").replaceAll(/\+/g,"(λa.λb.λf.λx.(af)(bfx))").replaceAll(/-/g,"(λm.λn.n(λn.λf.λx.n(λg.λh.h(gf))(λu.x)(λu.u))m)").replaceAll(/\*/g,"(λa.λb.λf.b(af))").replaceAll(/\^/g,"(λa.λb.ba)")),window.DEBUG&&i.setValue(i.value.replaceAll(/E/g,"((λf.(λx.f(xx))(λx.f(xx)))(λe.λm.m(λx.x)(λm.λn.em(en))(λm.λv.e(mv))))")),i.setValue(i.value.replaceAll(/[^a-km-zA-Zλ().0-9]/g,"").replaceAll(/\.+/g,match=>(t+=match.length-1,"."))),document.activeElement===i.element&&i.element.setSelectionRange(a+i.value.length-e+t,n+i.value.length-e+t);a=function(expressionString){let e=0,a=expressionString.search(/\(/g);for(let t=0;t<expressionString.length;t++){if("("===expressionString[t]?e++:")"===expressionString[t]&&e--,e<0)return[t,t+1];0===e&&(a=t+1)}if(0!==e)return[a,a+1];var n=expressionString.search(/λ([a-km-zA-Z0-9])[^.]/g);return-1===n?-1===(n=expressionString.search(/λ([a-km-zA-Z0-9])$/g))?-1===(n=expressionString.search(/λ\./g))?-1===(n=expressionString.search(/λ[a-km-zA-Z0-9]\.$/g))?-1:[n,n+expressionString.match(/λ[a-km-zA-Z0-9]\.$/g)[0].length]:[n,n+expressionString.match(/λ\./g)[0].length]:[n,n+expressionString.match(/λ([a-km-zA-Z0-9])$/g)[0].length]:[n,n+expressionString.match(/λ([a-km-zA-Z0-9])[^.]/g)[0].length]}(i.value);if(-1!==a)i.overlayElement.innerHTML=i.value.slice(0,a[0])+`<span class="invalid">${i.value.slice(a[0],a[1])}</span>`+i.value.slice(a[1]);else{const l=await r.run({resolution:s.value,expression:i.value,betaReduce:betaReduce});i.overlayElement.innerHTML=l,setTimeout(()=>i.overlayElement.innerHTML=l,50)}}new DownloadButton({element:$("#download-button"),applet:r,filename:"a-lambda-diagram.png"}),showPage(),e(),setOnThemeChange(()=>e())}