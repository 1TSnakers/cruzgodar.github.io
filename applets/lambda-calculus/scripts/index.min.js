import{LambdaCalculus}from"./class.min.js";import{Button,DownloadButton,ToggleButton}from"/scripts/src/buttons.min.js";import{Checkbox}from"/scripts/src/checkboxes.min.js";import{Dropdown}from"/scripts/src/dropdowns.min.js";import{$}from"/scripts/src/main.min.js";import{setOnThemeChange}from"/scripts/src/settings.min.js";import{Slider}from"/scripts/src/sliders.min.js";import{Textarea}from"/scripts/src/textareas.min.js";const examples={identity:"λx.x",returnLambda:"λx.λy.x",evaluation:"λx.xx",betaReduction:"(λz.zz)(λx.λy.x)",booleans:"&T (| (!F) F)",successor:">3",addition:"+34",multiplication:"*34",exponentiation:"^34",omega:"Yλx.x",recursiveTriangleNumbers:"(Y λf. λn. _(<n) 1 (+ n (f(<n)))) 4",recursiveFactorial:"(Y λf. λn. _(<n) 1 (* n (f(<n)))) 4",recursiveFibonacci:"(Y λf. λn. _(<n) 1 (+ (f(<(<n))) (f(<n)) )) 4",iterativeTriangleNumbers:"(λn.n( λg.λa.λb.g (>a) (+ab) ) (λa.λb.b) 1 0) 4",iterativeFactorial:"(λn.n( λg.λa.λb.g (>a) (*ab) ) (λa.λb.b) 1 1) 4",iterativeFibonacci:"(λn.n( λg.λa.λb.g (+ab) a ) (λa.λb.b) 1 0) 4",knuthUpArrows:"(Yλf.λn.λa.λb.(_(<n)(ba)(((<b)(λg.λc.λd.gc(f(<n)cd)))(λc.λd.d)aa)))223"};export default function(){const s=new LambdaCalculus({canvas:$("#output-canvas")}),e=new Dropdown({element:$("#examples-dropdown"),name:"Examples",options:{identity:"Identity",returnLambda:"Returning a Lambda",evaluation:"Evaluation",betaReduction:"Beta Reduction",booleans:"Booleans",successor:"Successor",addition:"Addition",multiplication:"Multiplication",exponentiation:"Exponentiation",omega:"Omega",recursiveTriangleNumbers:"Recursive Triangle Numbers",recursiveFactorial:"Recursive Factorial",iterativeTriangleNumbers:"Iterative Triangle Numbers",iterativeFactorial:"Iterative Factorial",iterativeFibonacci:"Iterative Fibonacci",knuthUpArrows:"Knuth's Up Arrows"},onInput:function(){e.value&&(o.setValue(examples[e.value]),n())}}),o=new Textarea({element:$("#expression-textarea"),name:"Expression",value:"*23",onInput:()=>{e.value&&e.setValue({newValue:"default"}),n()},onEnter:()=>n(!0)}),l=new Checkbox({element:$("#expand-shorthands-checkbox"),name:"Expand shorthands",checked:!1,onInput:()=>{e.value&&o.setValue(examples[e.value]),n(),setTimeout(()=>n(),50)}}),c=(new Button({element:$("#reduce-button"),name:"Reduce",onClick:()=>n(!0)}),new ToggleButton({element:$("#play-pause-button"),name0:"Pause",name1:"Play",persistState:!1,onClick0:()=>s.animationPaused=!0,onClick1:()=>s.animationPaused=!1})),u=new Slider({element:$("#animation-time-slider"),name:"Animation Speed",value:1,min:.25,max:20,logarithmic:!0,snapPoints:[.5,1,2,5,10],onInput:function(){s.animationTime=500/u.value}});async function n(betaReduce=!1){await Promise.all([o.loaded,c.loaded,u.loaded]),c.state&&(c.setState({newState:!1}),s.animationPaused=!1);var e=o.value.length,{selectionStart:n,selectionEnd:a}=o.element;let t=0;o.setValue(o.value.replaceAll(/l/g,"λ")),o.setValue(o.value.replaceAll(/[^a-km-zA-Zλ().0-9+*^_\-!,<>'"&=|]/g,"").replaceAll(/\.+/g,match=>(t+=match.length-1,"."))),document.activeElement===o.element&&o.element.setSelectionRange(n+o.value.length-e+t,a+o.value.length-e+t);n=function(expressionString){let e=0,n=expressionString.search(/\(/g);for(let t=0;t<expressionString.length;t++){if("("===expressionString[t]?e++:")"===expressionString[t]&&e--,e<0)return[t,t+1];0===e&&(n=t+1)}if(0!==e)return[n,n+1];var a=expressionString.search(/λ([a-km-zA-Z0-9])[^.]/g);return-1===a?-1===(a=expressionString.search(/λ([a-km-zA-Z0-9])$/g))?-1===(a=expressionString.search(/λ\./g))?-1===(a=expressionString.search(/λ[a-km-zA-Z0-9]\.$/g))?-1:[a,a+expressionString.match(/λ[a-km-zA-Z0-9]\.$/g)[0].length]:[a,a+expressionString.match(/λ\./g)[0].length]:[a,a+expressionString.match(/λ([a-km-zA-Z0-9])$/g)[0].length]:[a,a+expressionString.match(/λ([a-km-zA-Z0-9])[^.]/g)[0].length]}(o.value);if(-1!==n){a=o.value.replaceAll(/</g,";");const i=a.slice(0,n[0])+`<span class="invalid">${a.slice(n[0],n[1])}</span>`+a.slice(n[1]);void(o.overlayElement.innerHTML=i.replaceAll(/;/g,"&lt;"))}else{const[i,r]=await s.run({expression:o.value,expandShorthands:l.checked,betaReduce:betaReduce});o.setValue(r),o.overlayElement.innerHTML=i,setTimeout(()=>{o.setValue(r),o.overlayElement.innerHTML=i})}}new DownloadButton({element:$("#download-button"),applet:s,filename:"a-lambda-diagram.png"}),setTimeout(()=>n(),10),setOnThemeChange(()=>n())}