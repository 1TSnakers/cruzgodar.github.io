import{showPage}from"../../../scripts/src/loadPage.min.js";import{LambdaCalculus}from"./class.min.js";import{Button,DownloadButton,ToggleButton}from"/scripts/src/buttons.min.js";import{Checkbox}from"/scripts/src/checkboxes.min.js";import{$}from"/scripts/src/main.min.js";import{setOnThemeChange}from"/scripts/src/settings.min.js";import{Slider}from"/scripts/src/sliders.min.js";import{Textarea}from"/scripts/src/textareas.min.js";import{TextBox}from"/scripts/src/textBoxes.min.js";export default function(){const r=new LambdaCalculus({canvas:$("#output-canvas")}),i=new TextBox({element:$("#resolution-input"),name:"Resolution",value:2e3,minValue:1e3,maxValue:3e3,onEnter:()=>e(!0)}),l=new Checkbox({element:$("#expand-shorthands-checkbox"),name:"Expand shorthands",checked:!1,onInput:e}),m=new Textarea({element:$("#expression-textarea"),name:"Expression",value:"",onInput:e,onEnter:()=>e(!0)}),c=(new Button({element:$("#reduce-button"),name:"Reduce",onClick:()=>e(!0)}),new ToggleButton({element:$("#play-pause-button"),name0:"Pause",name1:"Play",persistState:!1,onClick0:()=>r.animationPaused=!0,onClick1:()=>r.animationPaused=!1})),u=new Slider({element:$("#animation-time-slider"),name:"Animation Speed",value:1,min:.25,max:10,logarithmic:!0,snapPoints:[.5,1,2,3,4,5,6,7,8,9,10],onInput:function(){r.animationTime=500/u.value}});async function e(betaReduce=!1){await Promise.all([m.loaded,i.loaded,c.loaded,u.loaded]),c.state&&(c.setState({newState:!1}),r.animationPaused=!1);var e=m.value.length,{selectionStart:n,selectionEnd:t}=m.element;let a=0;m.setValue(m.value.replaceAll(/l/g,"λ")),m.setValue(m.value.replaceAll(/[^a-km-zA-Zλ().0-9+*^-]/g,"").replaceAll(/\.+/g,match=>(a+=match.length-1,"."))),document.activeElement===m.element&&m.element.setSelectionRange(n+m.value.length-e+a,t+m.value.length-e+a);n=function(expressionString){let e=0,n=expressionString.search(/\(/g);for(let a=0;a<expressionString.length;a++){if("("===expressionString[a]?e++:")"===expressionString[a]&&e--,e<0)return[a,a+1];0===e&&(n=a+1)}if(0!==e)return[n,n+1];var t=expressionString.search(/λ([a-km-zA-Z0-9])[^.]/g);return-1===t?-1===(t=expressionString.search(/λ([a-km-zA-Z0-9])$/g))?-1===(t=expressionString.search(/λ\./g))?-1===(t=expressionString.search(/λ[a-km-zA-Z0-9]\.$/g))?-1:[t,t+expressionString.match(/λ[a-km-zA-Z0-9]\.$/g)[0].length]:[t,t+expressionString.match(/λ\./g)[0].length]:[t,t+expressionString.match(/λ([a-km-zA-Z0-9])$/g)[0].length]:[t,t+expressionString.match(/λ([a-km-zA-Z0-9])[^.]/g)[0].length]}(m.value);if(-1!==n)m.overlayElement.innerHTML=m.value.slice(0,n[0])+`<span class="invalid">${m.value.slice(n[0],n[1])}</span>`+m.value.slice(n[1]);else{const[s,o]=await r.run({resolution:i.value,expression:m.value,expandShorthands:l.checked,betaReduce:betaReduce});m.setValue(o),m.overlayElement.innerHTML=s,setTimeout(()=>{m.setValue(o),m.overlayElement.innerHTML=s},50)}}new DownloadButton({element:$("#download-button"),applet:r,filename:"a-lambda-diagram.png"}),showPage(),e(),setOnThemeChange(()=>e())}