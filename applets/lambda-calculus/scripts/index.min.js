import{showPage}from"../../../scripts/src/loadPage.min.js";import{LambdaCalculus}from"./class.min.js";import{Button,DownloadButton}from"/scripts/src/buttons.min.js";import{$}from"/scripts/src/main.min.js";import{setOnThemeChange}from"/scripts/src/settings.min.js";import{Slider}from"/scripts/src/sliders.min.js";import{Textarea}from"/scripts/src/textareas.min.js";import{TextBox}from"/scripts/src/textBoxes.min.js";export default function(){const r=new LambdaCalculus({canvas:$("#output-canvas")}),s=new TextBox({element:$("#resolution-input"),name:"Resolution",value:2e3,minValue:1e3,maxValue:3e3,onEnter:()=>n(!0)}),l=new Textarea({element:$("#expression-textarea"),name:"Expression",value:"",onInput:n,onEnter:()=>n(!0),allowEnter:!0}),e=(new Button({element:$("#reduce-button"),name:"Reduce",onClick:()=>n(!0)}),new Slider({element:$("#animation-time-slider"),name:"Animation Speed",value:1,min:.25,max:10,logarithmic:!0,onInput:function(){r.animationTime=500/e.value}}));async function n(betaReduce=!1){await Promise.all([l.loaded,s.loaded]);var e=l.value.length,{selectionStart:n,selectionEnd:t}=l.element,n=(l.setValue(l.value.replaceAll(/l/gi,"λ").replaceAll(/([0-9]+)/g,(match,$1)=>{var e=parseInt($1);return`(λf.λx.${"f(".repeat(e)}x${")".repeat(e)})`}).replaceAll(/I/g,"(λx.x)").replaceAll(/K/g,"(λx.λy.x)").replaceAll(/S/g,"(λx.λy.λz.(xz)(yz))").replaceAll(/Y/g,"(λf.(λx.f(xx))(λx.f(xx)))")),l.setValue(l.value.replaceAll(/[^a-km-zA-KM-Zλ().0-9]/g,"")),l.element.setSelectionRange(n+l.value.length-e,t+l.value.length-e),function(expressionString){let e=0,n=expressionString.search(/\(/g);for(let a=0;a<expressionString.length;a++){if("("===expressionString[a]?e++:")"===expressionString[a]&&e--,e<0)return[a,a+1];0===e&&(n=a+1)}if(0!==e)return[n,n+1];var t=expressionString.search(/λ([a-mk-zA-KM-Z0-9])[^.]/g);return-1===t?-1===(t=expressionString.search(/λ([a-mk-zA-KM-Z0-9])$/g))?-1===(t=expressionString.search(/λ\./g))?-1===(t=expressionString.search(/λ[a-mk-zA-KM-Z0-9]\.$/g))?-1:[t,t+expressionString.match(/λ[a-mk-zA-KM-Z0-9]\.$/g)[0].length]:[t,t+expressionString.match(/λ\./g)[0].length]:[t,t+expressionString.match(/λ([a-mk-zA-KM-Z0-9])$/g)[0].length]:[t,t+expressionString.match(/λ([a-mk-zA-KM-Z0-9])[^.]/g)[0].length]}(l.value));if(-1!==n)l.overlayElement.innerHTML=l.value.slice(0,n[0])+`<span class="invalid">${l.value.slice(n[0],n[1])}</span>`+l.value.slice(n[1]);else{const a=r.run({resolution:s.value,expression:l.value,betaReduce:betaReduce});l.overlayElement.innerHTML=a,setTimeout(()=>l.overlayElement.innerHTML=a,50)}}new DownloadButton({element:$("#download-button"),applet:r,filename:"lambda-calculus.png"}),showPage(),n(),setOnThemeChange(()=>n())}