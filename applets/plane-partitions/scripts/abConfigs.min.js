import{PlanePartitions}from"./class.min.js";const absoluteMinAEntry=-5;function isValidABConfig({lambda,mu,nu,A,B}){if(!PlanePartitions.verifyPp(A)||!PlanePartitions.verifyPp(B))return!1;for(;lambda.length<nu[0];)lambda.push(0);for(;mu.length<nu.length;)mu.push(0);const t=[];let n=0,a=0;for(;A[n][0]===1/0;)n++;for(;A[0][a]===1/0;)a++;if(A[n-1][a-1]!==1/0)throw new Error("Infinite part of A is not rectangular!");for(let c=0;c<A.length;c++)for(let e=0;e<A[c].length;e++){const v=c-n,x=e-a;if(!(v<0&&x<0)){const M=0<=v&&v<nu.length&&0<=x&&x<nu[v];var r=0<=x?lambda[x]:1/0,l=0<=v?mu[v]:1/0;if(A[c][e]>Math.min(r,l))return!1;if(0<=v&&0<=x){if(B[v][x]<0)return!1;if(M&&B[v][x]>Math.max(r,l))return!1;if(!M&&B[v][x]>Math.min(r,l))return!1;if(!M&&A[c][e]!==-1/0)return!1}else if(A[c][e]<0)return!1;var[i,o]=v<0?[lambda[x],0]:x<0?[mu[v],0]:M?[Math.min(lambda[x],mu[v]),Math.max(lambda[x],mu[v])]:[0,Math.min(lambda[x],mu[v])];for(let n=M?absoluteMinAEntry:0;n<Math.max(i,o);n++){var[u,m]=(()=>{if(v<0)return[1,1];if(x<0)return[1,2];if(n<0)return[1,3];if(M&&n<Math.min(lambda[x],mu[v]))return[3,0];if(!M)return[2,3];if(n>=lambda[x])return[2,1];if(n>=mu[v])return[2,2];throw new Error("Region/label code is broken")})(),f=A[c][e]<=n&&n<i,h=0<=v&&0<=x&&B[v][x]<=n&&n<o,g=0<=v&&0<=x&&n<o&&0<=n;(1===u&&f||2===u&&!h&&g||3===u&&(f&&!h||!f&&h))&&t.push([v,x,n,m])}}}var s=[];const b=structuredClone(t),d=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];for(;0!==b.length;){let n=[],e=[b[0]];for(b.splice(0,1);0!==e.length;){const y=[];e.forEach(activeBox=>{d.forEach(direction=>{var n=boxIsInArray([activeBox[0]+direction[0],activeBox[1]+direction[1],activeBox[2]+direction[2]],b);-1!==n&&(y.push(b[n]),b.splice(n,1))})}),n=n.concat(e),e=y}s.push(n)}for(let p=0;p<s.length;p++){var e=new Set(s[p].map(box=>box[3]));if(e.delete(0),1<e.size)return[!1,void 0];if(0!==e.size){const[C]=e;s[p].forEach(box=>{var n=boxIsInArray(box,t);t[n][3]=C})}}return[!0,t]}function boxIsInArray(box,array){for(let e=0;e<array.length;e++){var n=array[e];if(n[0]===box[0]&&n[1]===box[1]&&n[2]===box[2])return e}return-1}function getAsciiLabel(box,boxes){var n=boxIsInArray(box,boxes);return-1===n?"?":0===(n=boxes[n][3])?"*":""+n}function getMinimalABConfig({lambda,mu,nu,negativeWidth=2}){for(;lambda.length<nu[0];)lambda.push(0);for(;mu.length<nu.length;)mu.push(0);var e=new Array(negativeWidth+mu.length),t=new Array(mu.length);for(let l=0;l<e.length;l++){e[l]=new Array(negativeWidth+lambda.length),l>=negativeWidth&&(t[l-negativeWidth]=new Array(lambda.length));for(let n=0;n<e[l].length;n++){const i=l-negativeWidth,o=n-negativeWidth;if(i<0&&o<0)e[l][n]=1/0;else{const u=0<=i&&i<nu.length&&0<=o&&o<nu[i];var[a,r]=i<0?[lambda[o],0]:o<0?[mu[i],0]:u?[Math.min(lambda[o],mu[i]),Math.max(lambda[o],mu[i])]:[-1/0,Math.min(lambda[o],mu[i])];e[l][n]=a,0<=i&&0<=o&&(t[i][o]=r)}}}return[e,t]}function iterateThroughEntries({lambda,mu,nu,A,B,i,j}){for(;lambda.length<nu[0];)lambda.push(0);for(;mu.length<nu.length;)mu.push(0);let n=0,e=0;for(;A[n][0]===1/0;)n++;for(;A[0][e]===1/0;)e++;var r=i-n,l=j-e;if(!(r<0&&l<0)){var t=0<=r&&r<nu.length&&0<=l&&l<nu[r],o=0<=r&&0<=l&&!t?-1/0:Math.min(0===i?lambda[l]:A[i-1][j],0===j?mu[r]:A[i][j-1]),u=Math.max(Math.max(i===A.length-1?-1/0:A[i+1][j],j===A[0].length-1?-1/0:A[i][j+1]),t?absoluteMinAEntry:0),m=0<=r&&0<=l?Math.min(0==r?1/0:B[r-1][l],0==l?1/0:B[r][l-1]):1/0,f=0<=r&&0<=l?Math.max(r==B.length-1?0:B[1+r][l],l==B[0].length-1?0:B[r][1+l]):1/0,h=structuredClone(A),g=structuredClone(B);let a="";if(o===-1/0)for(let n=m;n>=f;n--){g[r][l]=n;var s=isValidABConfig({lambda:lambda,mu:mu,nu:nu,A:h,B:g});if(s[0]){let n=getAsciiLabel([r,l,h[i][j]],s[1]);"?"===n&&0<=r&&0<=l&&(n=getAsciiLabel([r,l,g[r][l]],s[1])),a=a+n+" "}else a+="  "}else if(m===1/0)for(let e=o;e>=u;e--){h[i][j]=e;var b=isValidABConfig({lambda:lambda,mu:mu,nu:nu,A:h,B:g});if(b[0]){let n=getAsciiLabel([r,l,h[i][j]],b[1]);"?"===n&&0<=r&&0<=l&&(n=getAsciiLabel([r,l,g[r][l]],b[1])),a=a+(e===absoluteMinAEntry?"v":n)+"\n"}else a+="\n"}else for(let t=o;t>=u;t--){for(let n=m;n>=f;n--){h[i][j]=t,g[r][l]=n;var d=isValidABConfig({lambda:lambda,mu:mu,nu:nu,A:h,B:g});if(d[0]){let n=getAsciiLabel([r,l,h[i][j]],d[1]);"?"===n&&0<=r&&0<=l&&(n=getAsciiLabel([r,l,g[r][l]],d[1])),a=a+(t===absoluteMinAEntry?"v":n)+" "}else a+="  "}a+="\n"}return a}}function printABConfig({A,B}){let e="",t=0,n=0;for(;A[t][0]===1/0;)t++;for(;A[0][n]===1/0;)n++;let a=2;for(let u=0;u<A[0].length;u++)for(let n=0;n<A.length;n++){var r=Math.abs(A[n][u])===1/0?1:(""+A[n][u]).length;a=Math.max(a,r+1)}for(let m=0;m<A.length;m++){var l=m-t;for(let n=0;n<A[m].length;n++){var i=A[m][n]===1/0?"^":A[m][n]===-1/0?"v":""+A[m][n],o=a-i.length;e+=" ".repeat(o-1)+i+" "}if(0<=l){e+="  ";for(let n=0;n<B[l].length;n++)e+=B[l][n]+" "}e+="\n"}console.log(e)}function testAllEntriesOfABConfig({lambda,mu,nu,A,B,onlyUnboundedBelow=!1}){let e=0,t=0;for(;A[e][0]===1/0;)e++;for(;A[0][t]===1/0;)t++;for(let u=0;u<A.length;u++)for(let n=0;n<A.length;n++){var a,r,l,i,o;u<e&&n<t||(a=this.iterateThroughEntries({A:A,B:B,lambda:lambda,mu:mu,nu:nu,i:u,j:n}),onlyUnboundedBelow||(console.log(u,n),console.log(a)),r=u-e,l=n-t,0<=r&&0<=l&&r<nu.length&&l==nu[r]-1&&(nu[r]--,i=structuredClone(A),o=structuredClone(B),i[u][n]=-1/0,o[r][l]=Math.min(lambda[l],mu[r]),onlyUnboundedBelow&&(console.log(u,n),console.log(a)),console.log(this.iterateThroughEntries({A:i,B:o,lambda:lambda,mu:mu,nu:nu,i:u,j:n})),nu[r]++))}}function getArrayVersionOfABConfig({lambda,mu,nu,A,B}){let e=0,t=0;for(;A[e][0]===1/0;)e++;for(;A[0][t]===1/0;)t++;var a=new Array(16),r=new Array(16);for(let o=0;o<16;o++){a[o]=new Array(16),r[o]=new Array(16);for(let n=0;n<16;n++){var l=o-8+e,i=n-8+t;if(0<=l&&l<A.length&&0<=i&&i<A[l].length)a[o][n]=Math.min(Math.max(A[l][i]+8,0),16);else{const u=n-8<0?1/0:n-8>=lambda.length?0:lambda[n-8],m=o-8<0?1/0:o-8>=mu.length?0:mu[o-8];l=0<=o-8&&o-8<nu.length&&n-8<nu[o-8]||o-8<0||n-8<0?Math.min(u,m):-1/0;a[o][n]=Math.min(Math.max(l+8,0),16)}16===a[o][n]&&(a[o][n]=1/0),o<B.length&&n<B[o].length?r[o][n]=B[o][n]:r[o][n]=0}}return[a,r]}export{isValidABConfig,getMinimalABConfig,iterateThroughEntries,printABConfig,testAllEntriesOfABConfig,getArrayVersionOfABConfig};