import{Applet,getEqualPixelFullScreen,tempShader}from"../../../scripts/applets/applet.min.js";import{createShader}from"./createShader.min.js";import{SolRooms,SolSpheres}from"./geometries/sol.min.js";import anime from"/scripts/anime.min.js";import{edgeDetectShader}from"/scripts/applets/raymarchApplet.min.js";import{aspectRatio}from"/scripts/src/layout.min.js";import{$,addTemporaryListener}from"/scripts/src/main.min.js";import{Wilson}from"/scripts/wilson.min.js";const moveFriction=.96,moveStopThreshhold=.01,rollingFriction=.92,rollingStopThreshhold=.01;function rotateVectors(vec1,vec2,theta){var t=Math.cos(theta),e=Math.sin(theta);return[[vec1[0]*t+vec2[0]*e,vec1[1]*t+vec2[1]*e,vec1[2]*t+vec2[2]*e,vec1[3]*t+vec2[3]*e],[-vec1[0]*e+vec2[0]*t,-vec1[1]*e+vec2[1]*t,-vec1[2]*e+vec2[2]*t,-vec1[3]*e+vec2[3]*t]]}function addVectors(vec1,vec2){return[vec1[0]+vec2[0],vec1[1]+vec2[1],vec1[2]+vec2[2],vec1[3]+vec2[3]]}function scaleVector(c,vec){return[c*vec[0],c*vec[1],c*vec[2],c*vec[3]]}function magnitude(vec){return Math.sqrt(vec[0]*vec[0]+vec[1]*vec[1]+vec[2]*vec[2]+vec[3]*vec[3])}function normalize(vec){var t=magnitude(vec);return[vec[0]/t,vec[1]/t,vec[2]/t,vec[3]/t]}function dotProduct(vec1,vec2){return vec1[0]*vec2[0]+vec1[1]*vec2[1]+vec1[2]*vec2[2]+vec1[3]*vec2[3]}function mat4TimesVector(mat,vec){return[mat[0][0]*vec[0]+mat[0][1]*vec[1]+mat[0][2]*vec[2]+mat[0][3]*vec[3],mat[1][0]*vec[0]+mat[1][1]*vec[1]+mat[1][2]*vec[2]+mat[1][3]*vec[3],mat[2][0]*vec[0]+mat[2][1]*vec[1]+mat[2][2]*vec[2]+mat[2][3]*vec[3],mat[3][0]*vec[0]+mat[3][1]*vec[1]+mat[3][2]*vec[2]+mat[3][3]*vec[3]]}class ThurstonGeometries extends Applet{resolution=500;useAntialiasing=!1;aspectRatioX=1;aspectRatioY=1;fov=Math.tan(50*Math.PI/180);fovFactor=1;geometryData;rotatedForwardVec;rotatedUpVec;restrictCamera=!0;movingAmount=[0,0,0];rollingAmount=0;automoving=!1;automovingDirection=()=>[0,0,0,0];automovingSpeed=1;movingSubsteps=1;needNewFrame=!0;constructor({canvas}){super(canvas);var t={renderer:"gpu",shader:tempShader,canvasWidth:this.resolution,canvasHeight:this.resolution,useFullscreen:!0,trueFullscreen:!0,useFullscreenButton:!0,enterFullscreenButtonIconPath:"/graphics/general-icons/enter-fullscreen.png",exitFullscreenButtonIconPath:"/graphics/general-icons/exit-fullscreen.png",switchFullscreenCallback:()=>this.changeResolution(),mousedownCallback:this.onGrabCanvas.bind(this),touchstartCallback:this.onGrabCanvas.bind(this),mousedragCallback:this.onDragCanvas.bind(this),touchmoveCallback:this.onDragCanvas.bind(this),mouseupCallback:this.onReleaseCanvas.bind(this),touchendCallback:this.onReleaseCanvas.bind(this)};this.wilson=new Wilson(canvas,t);addTemporaryListener({object:window,event:"resize",callback:()=>this.changeResolution()}),this.listenForKeysPressed(["w","s","a","d","q","e"," ","shift","z"],(key,pressed)=>{if("z"===key){const t={t:0},e=this.fovFactor,i=pressed?.25:1;anime({targets:t,t:1,duration:250,easing:"easeOutCubic",update:()=>{this.fovFactor=e*(1-t.t)+t.t*i,this.needNewFrame=!0}})}}),this.listenForNumTouches()}run(geometryData,resetWorldCenter=!0){this.geometryData=geometryData,this.updateAutomaticMoving=()=>{},this.movingAmount=[0,0,0];var t=this.geometryData.usesFiberComponent?"vec4 pos, float fiber":"vec4 pos",e=this.geometryData.usesFiberComponent?", fiber":"",t={maxMarches:this.geometryData.maxMarches,maxT:this.geometryData.maxT,stepFactor:this.geometryData.stepFactor,uniformGlsl:this.geometryData.uniformGlsl??"",dotProductGlsl:this.geometryData.dotProductGlsl,normalizeGlsl:this.geometryData.normalizeGlsl,getNormalVecGlsl:this.geometryData.getNormalVecGlsl,functionGlsl:this.geometryData.functionGlsl??"",posSignature:t,distanceEstimatorGlsl:this.geometryData.distanceEstimatorGlsl,getColorGlsl:this.geometryData.getColorGlsl,addFiberArgument:e,lightGlsl:this.geometryData.lightGlsl,ambientOcclusionDenominator:this.geometryData.ambientOcclusionDenominator,doClipBrightening:this.geometryData.doClipBrightening,fogGlsl:this.geometryData.fogGlsl,raymarchSetupGlsl:this.geometryData.raymarchSetupGlsl??"",geodesicGlsl:this.geometryData.geodesicGlsl,correctPosGlsl:this.geometryData.correctPosGlsl,finalTeleportationGlsl:this.geometryData.finalTeleportationGlsl??"",updateTGlsl:this.geometryData.updateTGlsl},e=createShader(t);resetWorldCenter&&(this.wilson.worldCenterX=0,this.wilson.worldCenterY=0,this.lastWorldCenterX=this.wilson.worldCenterX,this.lastWorldCenterY=this.wilson.worldCenterY),this.wilson.render.shaderPrograms=[],this.wilson.render.loadNewShader(e),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]),this.initUniforms(0),this.useAntialiasing&&(this.wilson.render.loadNewShader(edgeDetectShader),this.wilson.render.initUniforms(["stepSize"],1),e=createShader({...t,antialiasing:!0}),this.wilson.render.loadNewShader(e),this.initUniforms(2),this.createTextures()),setTimeout(()=>window.dispatchEvent(new Event("resize")),16),this.resume()}initUniforms(programIndex){this.wilson.render.initUniforms(["aspectRatioX","aspectRatioY","uvScale","uvCenter","resolution","clipDistance","fov","cameraPos","normalVec","upVec","rightVec","forwardVec"].concat(this.geometryData.uniformNames??[]),programIndex),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatioX[programIndex],1),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatioY[programIndex],1),this.wilson.gl.uniform1f(this.wilson.uniforms.uvScale[programIndex],1),this.wilson.gl.uniform2fv(this.wilson.uniforms.uvCenter[programIndex],[0,0]),this.wilson.gl.uniform1i(this.wilson.uniforms.resolution[programIndex],this.resolution),this.wilson.gl.uniform1f(this.wilson.uniforms.fov[programIndex],(this.geometryData.fov??this.fov)*this.fovFactor),this.wilson.gl.uniform4fv(this.wilson.uniforms.cameraPos[programIndex],this.geometryData.cameraPos),this.wilson.gl.uniform4fv(this.wilson.uniforms.normalVec[programIndex],this.geometryData.normalVec),this.wilson.gl.uniform4fv(this.wilson.uniforms.upVec[programIndex],this.geometryData.upVec),this.wilson.gl.uniform4fv(this.wilson.uniforms.rightVec[programIndex],this.geometryData.rightVec),this.wilson.gl.uniform4fv(this.wilson.uniforms.forwardVec[programIndex],this.geometryData.forwardVec)}createTextures(){this.wilson.render.framebuffers=[],this.wilson.render.createFramebufferTexturePair(),this.wilson.render.createFramebufferTexturePair(),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.gl.uniform1f(this.wilson.uniforms.stepSize[1],1/this.resolution),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0])}resume(){this.needNewFrame=!0,this.animationPaused=!1,requestAnimationFrame(this.drawFrame.bind(this))}drawFrame(timestamp){var e=timestamp-this.lastTimestamp;if(this.lastTimestamp=timestamp,0!=e){if(this.geometryData.teleportCamera(this.rotatedForwardVec,this.recomputeRotation.bind(this)),this.geometryData.updateUniforms(this.wilson.gl,this.wilson.uniforms,0),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.geometryData.updateUniforms(this.wilson.gl,this.wilson.uniforms,2),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0])),this.pan.update(e),this.keysPressed.w||2===this.numTouches?this.movingAmount[0]=1:(this.keysPressed.s||3<=this.numTouches)&&(this.movingAmount[0]=-1),this.keysPressed.d?this.movingAmount[1]=1:this.keysPressed.a&&(this.movingAmount[1]=-1),this.keysPressed[" "]?this.movingAmount[2]=1:this.keysPressed.shift&&(this.movingAmount[2]=-1),this.keysPressed.e?this.rollingAmount=1:this.keysPressed.q&&(this.rollingAmount=-1),this.updateAutomaticMoving(e),0!==this.movingAmount[0]||0!==this.movingAmount[1]||0!==this.movingAmount[2]){this.needNewFrame=!0,this.movingAmount[0]&&(this.handleMoving([Math.sign(this.movingAmount[0]),0,0],e*Math.abs(this.movingAmount[0])),this.geometryData.correctVectors()),this.movingAmount[1]&&(this.handleMoving([0,Math.sign(this.movingAmount[1]),0],e*Math.abs(this.movingAmount[1])),this.geometryData.correctVectors()),this.movingAmount[2]&&!this.geometryData.render1D&&(this.handleMoving([0,0,Math.sign(this.movingAmount[2])],e*Math.abs(this.movingAmount[2])),this.geometryData.correctVectors());for(let t=0;t<3;t++)this.movingAmount[t]*=moveFriction**(e/6.944),Math.abs(this.movingAmount[t])<moveStopThreshhold&&(this.movingAmount[t]=0)}else this.movingAmount=[0,0,0];this.geometryData.correctVectors(),this.handleRotating(),this.handleRolling(e),this.updateUniforms(0),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.updateUniforms(2),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0])),this.needNewFrame&&(this.useAntialiasing&&this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,this.wilson.render.framebuffers[0].framebuffer),this.wilson.render.drawFrame(),this.geometryData.drawFrameCallback(),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[1]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[0].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,this.wilson.render.framebuffers[1].framebuffer),this.wilson.render.drawFrame(),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.bindTexture(this.wilson.gl.TEXTURE_2D,this.wilson.render.framebuffers[1].texture),this.wilson.gl.bindFramebuffer(this.wilson.gl.FRAMEBUFFER,null),this.wilson.render.drawFrame(),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0])),this.needNewFrame=!1),this.animationPaused||requestAnimationFrame(this.drawFrame.bind(this))}}downloadFrame(filename){this.needNewFrame=!0,this.drawFrame(),this.wilson.downloadFrame(filename,!1)}async downloadMosaic(filename,size){this.wilson.gl.uniform1f(this.wilson.uniforms.uvScale[0],1/size),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.uniform1f(this.wilson.uniforms.uvScale[2],1/size),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]));const i=[];for(let t=0;t<size;t++)i.push((1+2*t)/size-1);const s=[];for(let e=0;e<size;e++){s.push([]);for(let t=0;t<size;t++)s[e].push(document.createElement("canvas")),s[e][t].width=this.resolution,s[e][t].height=this.resolution}const o=async()=>{var t=document.createElement("canvas"),e=(t.width=this.resolution*size,t.height=this.resolution*size,t.getContext("2d",{colorSpace:"display-p3"}));for(let i=0;i<size;i++)for(let t=0;t<size;t++)e.drawImage(s[i][t],i*this.resolution,t*this.resolution);e.translate(0,this.resolution*size),e.scale(1,-1),e.drawImage(t,0,0),t.toBlob(blob=>{var t=document.createElement("a");t.href=URL.createObjectURL(blob),t.download=filename,t.click()}),await new Promise(resolve=>setTimeout(resolve,100)),this.wilson.gl.uniform1f(this.wilson.uniforms.uvScale[0],1),this.wilson.gl.uniform2fv(this.wilson.uniforms.uvCenter[0],[0,0]),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.uniform1f(this.wilson.uniforms.uvScale[2],1),this.wilson.gl.uniform2fv(this.wilson.uniforms.uvCenter[2],[0,0]),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0])),this.needNewFrame=!0};let r=0,a=0;const n=async()=>{var t=s[r][a].getContext("2d",{colorSpace:"display-p3"}),e=(this.wilson.gl.uniform2fv(this.wilson.uniforms.uvCenter[0],[i[r],i[a]]),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.uniform2fv(this.wilson.uniforms.uvCenter[2],[i[r],i[a]]),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0])),this.needNewFrame=!0,this.drawFrame(),new ImageData(new Uint8ClampedArray(this.wilson.render.getPixelData()),this.resolution,this.resolution));t.putImageData(e,0,0),await new Promise(resolve=>setTimeout(resolve,500)),++a===size&&(a=0,r++),r!==size?requestAnimationFrame(n):o()};requestAnimationFrame(n)}updateUniforms(programIndex){this.wilson.gl.uniform4fv(this.wilson.uniforms.cameraPos[programIndex],this.geometryData.cameraPos),this.wilson.gl.uniform4fv(this.wilson.uniforms.normalVec[programIndex],this.geometryData.normalVec),this.wilson.gl.uniform4fv(this.wilson.uniforms.upVec[programIndex],this.geometryData.render1D?[0,0,0,0]:this.rotatedUpVec),this.wilson.gl.uniform4fv(this.wilson.uniforms.rightVec[programIndex],this.geometryData.rightVec),this.wilson.gl.uniform4fv(this.wilson.uniforms.forwardVec[programIndex],this.rotatedForwardVec),this.wilson.gl.uniform1f(this.wilson.uniforms.fov[programIndex],(this.geometryData.fov??this.fov)*this.fovFactor)}handleMoving(movingAmount,timeElapsed){for(let i=0;i<this.movingSubsteps;i++){var t=this.rotatedForwardVec,t=this.geometryData.normalize([movingAmount[0]*t[0]+movingAmount[1]*this.geometryData.rightVec[0]+movingAmount[2]*this.geometryData.upVec[0],movingAmount[0]*t[1]+movingAmount[1]*this.geometryData.rightVec[1]+movingAmount[2]*this.geometryData.upVec[1],movingAmount[0]*t[2]+movingAmount[1]*this.geometryData.rightVec[2]+movingAmount[2]*this.geometryData.upVec[2],movingAmount[0]*t[3]+movingAmount[1]*this.geometryData.rightVec[3]+movingAmount[2]*this.geometryData.upVec[3]]),e=timeElapsed/(1e3*this.movingSubsteps)*this.geometryData.movingSpeed;this.automoving?this.geometryData.cameraPos=this.geometryData.correctPosition(this.geometryData.followGeodesic(this.geometryData.cameraPos,this.automovingDirection(),this.automovingSpeed*e)):this.geometryData.cameraPos=this.geometryData.correctPosition(this.geometryData.followGeodesic(this.geometryData.cameraPos,t,e)),this.geometryData.normalVec=this.geometryData.getNormalVec(this.geometryData.cameraPos),this.geometryData.handleMovingCallback(movingAmount,timeElapsed)}}recomputeRotation(newRotatedForwardVec){var t=scaleVector(1/magnitude(this.geometryData.forwardVec),this.geometryData.forwardVec),e=scaleVector(1/magnitude(this.geometryData.upVec),this.geometryData.upVec),e=addVectors(e,scaleVector(-dotProduct(t,e),t)),t=Math.asin(dotProduct(newRotatedForwardVec,e)/dotProduct(this.geometryData.upVec,e));this.wilson.worldCenterY=t,this.handleRotating()}lastWorldCenterY=0;handleRotating(){var t=this.geometryData.lockedOnOrigin?-1:1,e=(this.geometryData.render1D&&(this.wilson.worldCenterY=0),0===this.wilson.worldCenterX&&this.wilson.worldCenterY===this.lastWorldCenterY||(this.needNewFrame=!0),this.lastWorldCenterY=this.wilson.worldCenterY,this.wilson.worldCenterY=Math.min(Math.max(this.wilson.worldCenterY,-Math.PI/2+.01),Math.PI/2-.01),rotateVectors(this.geometryData.forwardVec,this.geometryData.rightVec,t*this.wilson.worldCenterX)),e=(this.geometryData.forwardVec=e[0],this.geometryData.rightVec=e[1],this.wilson.worldCenterX=0,rotateVectors(this.geometryData.forwardVec,this.geometryData.upVec,t*this.wilson.worldCenterY));this.rotatedForwardVec=e[0],this.rotatedUpVec=e[1],this.restrictCamera||(this.wilson.worldCenterY=0,this.geometryData.forwardVec=e[0],this.geometryData.upVec=e[1],this.rotatedForwardVec=e[0],this.rotatedUpVec=e[1]),this.geometryData.lockedOnOrigin&&(this.geometryData.cameraPos=scaleVector(-2.5,this.rotatedForwardVec),this.geometryData.cameraPos[3]=1)}handleRolling(timeElapsed){var t;!this.rollingAmount||this.geometryData.render1D||this.automoving||(this.needNewFrame=!0,this.wilson.worldCenterY&&(this.wilson.worldCenterY=0,this.geometryData.upVec=[...this.rotatedUpVec],this.geometryData.forwardVec=[...this.rotatedForwardVec]),t=timeElapsed*this.rollingAmount*.0015,[this.geometryData.rightVec,this.geometryData.upVec]=rotateVectors(this.geometryData.rightVec,this.geometryData.upVec,t),this.rotatedUpVec=[...this.geometryData.upVec],this.rollingAmount*=rollingFriction**(timeElapsed/6.944),Math.abs(this.rollingAmount)<rollingStopThreshhold&&(this.rollingAmount=0))}changeResolution(resolution=this.resolution){this.resolution=resolution;let t,e;this.wilson.fullscreen.currentlyFullscreen?([t,e]=getEqualPixelFullScreen(resolution),this.wilson.worldWidth=Math.max(2,2*aspectRatio),this.wilson.worldHeight=Math.max(2,2/aspectRatio)):this.geometryData?.aspectRatio?(t=Math.min(this.resolution,Math.floor(this.resolution*this.geometryData.aspectRatio)),e=Math.min(this.resolution,Math.floor(this.resolution/this.geometryData.aspectRatio)),this.geometryData.ignoreAspectRatio?(this.wilson.worldWidth=2,this.wilson.worldHeight=2):(this.wilson.worldWidth=2*Math.max(this.geometryData.aspectRatio,1),this.wilson.worldHeight=2/Math.min(this.geometryData.aspectRatio,1))):(t=this.resolution,e=this.resolution),this.wilson.changeCanvasSize(t,e),this.geometryData?.ignoreAspectRatio?(this.aspectRatioX=1,this.aspectRatioY=1):t>=e?(this.aspectRatioX=t/e,this.aspectRatioY=1):(this.aspectRatioX=1,this.aspectRatioY=t/e),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatioX[0],this.aspectRatioX),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatioY[0],this.aspectRatioY),this.wilson.gl.uniform1i(this.wilson.uniforms.resolution[0],this.resolution),this.useAntialiasing&&(this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[2]),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatioX[2],this.aspectRatioX),this.wilson.gl.uniform1f(this.wilson.uniforms.aspectRatioY[2],this.aspectRatioY),this.wilson.gl.uniform1i(this.wilson.uniforms.resolution[2],this.resolution),this.wilson.gl.useProgram(this.wilson.render.shaderPrograms[0]),this.createTextures()),this.needNewFrame=!0}moveForever({speed=1,direction=()=>[1,0,0,0],rampStart=!1}={}){let t=0;this.movingAmount=[0,0,0],this.automovingDirection=direction,this.automoving=!0,this.automovingSpeed=speed,setTimeout(()=>{this.updateAutomaticMoving=timeElapsed=>{this.automoving&&(t+=timeElapsed,this.movingAmount=[speed,0,0],rampStart)&&(this.movingAmount[0]*=Math.min(t/500,1))}},16)}async switchScene({newCameraPosOverride,duration=500}={}){if(this.geometryData instanceof SolRooms){await anime({targets:this.canvas,opacity:0,duration:duration/2,easing:"easeOutQuad"}).finished;var t=new SolSpheres;t.aspectRatio=this.geometryData.aspectRatio,this.run(t);try{$("#wall-thickness-slider").parentNode.style.display="none"}catch(t){}anime({targets:this.canvas,opacity:1,duration:duration/2,easing:"easeOutQuad"}).finished}else if(this.geometryData instanceof SolSpheres){await anime({targets:this.canvas,opacity:0,duration:duration/2,easing:"easeOutQuad"}).finished;t=new SolRooms;t.aspectRatio=this.geometryData.aspectRatio,t.sliderValues.wallThickness=.3,this.run(t);try{$("#wall-thickness-slider").parentNode.style.display=""}catch(t){}anime({targets:this.canvas,opacity:1,duration:duration/2,easing:"easeOutQuad"}).finished}else{t=0===this.geometryData.sliderValues.sceneTransition;const e=this.geometryData.sliderValues.sceneTransition,i=t?1:0;t=newCameraPosOverride??(i?this.geometryData.getNearestCorner():this.geometryData.getNearestCenter());this.moveCameraTo({newCameraPos:t,duration:duration});const s={t:0};anime({targets:s,t:1,duration:duration,easing:"easeInOutQuad",update:()=>{this.geometryData.sliderValues.sceneTransition=(1-s.t)*e+s.t*i},complete:()=>{s.t=1,this.geometryData.sliderValues.sceneTransition=(1-s.t)*e+s.t*i}})}}async moveCameraTo({newCameraPos,duration}){const i=[...this.geometryData.cameraPos],s={t:0};let o=0;await anime({targets:s,t:1,duration:duration,easing:"easeInOutSine",update:()=>{for(let e=0;e<60;e++){var t=o+(s.t-o)*e/60;this.geometryData.cameraPos=this.geometryData.correctPosition([(1-t)*i[0]+t*newCameraPos[0],(1-t)*i[1]+t*newCameraPos[1],(1-t)*i[2]+t*newCameraPos[2],(1-t)*i[3]+t*newCameraPos[3]]),this.geometryData.normalVec=this.geometryData.getNormalVec(this.geometryData.cameraPos),this.geometryData.correctVectors(),this.handleRotating()}this.needNewFrame=!0,o=s.t},complete:()=>{this.geometryData.cameraPos=this.geometryData.correctPosition(newCameraPos),this.geometryData.normalVec=this.geometryData.getNormalVec(this.geometryData.cameraPos),this.geometryData.correctVectors(),this.handleRotating(),this.needNewFrame=!0}}).finished}}export{rotateVectors,magnitude,normalize,dotProduct,mat4TimesVector,ThurstonGeometries};