!function(){"use strict";let t=document.querySelector("#output-canvas").getContext("webgl"),n=Math.min(document.querySelector("#output-canvas").offsetWidth,document.querySelector("#output-canvas").offsetHeight),e=!1,o=!1,a=!1,i=0,r=0,c=0,u=!1,s=!1,m=!1,l=!1,f=!1,_=!1,h=0,d=1,p=3.2954,v=1.9657,g=500,y=500,M=500,w=500,S=16,q=[],b=[],x=[],L=[],A=[2.1089,.41345,.95325],z=0,E=2,F=[[0,0,5],[5,5,5],[0,0,5]],P=[[-.57735,0,.816496],[1,0,0],[.707107,0,.707107]],k=[[.288675,-.5,.816496],[0,1,0],[0,.707107,.707107]],I=[[.288675,.5,.816496],[0,0,1],[-.707107,0,.707107]],U=[[],[],[0,-.707107,.707107]],T=[1.333,1.333,1.333],C=[3,3,4],R=[[0,0,1],[.57735,.57735,.57735],[0,0,1]],D=2,N=2,W=0,Y=0,H=0,X=0,B=0,G=0,O=0,V=0,$=0,j=0,K=0,J=0,Q=0,Z=0,tt=0,nt=0,et=0,ot=0,at=0,it=0;document.querySelector("#tetrahedron-radio-button").checked=!0,document.querySelector("#output-canvas").setAttribute("width",y),document.querySelector("#output-canvas").setAttribute("height",M),document.querySelector("#dim-input").addEventListener("input",pt),document.querySelector("#generate-high-res-image-button").addEventListener("click",function(){let n=g;g=parseInt(document.querySelector("#high-res-dim-input").value||2e3),document.querySelector("#output-canvas").setAttribute("width",g),document.querySelector("#output-canvas").setAttribute("height",g),t.viewport(0,0,g,g),lt();let e=document.createElement("a");e.download="a-kaleidoscopic-ifs-fractal.png",e.href=document.querySelector("#output-canvas").toDataURL(),e.click(),e.remove(),g=n,document.querySelector("#output-canvas").setAttribute("width",g),document.querySelector("#output-canvas").setAttribute("height",g),t.viewport(0,0,g,g),lt()}),document.querySelector("#tetrahedron-radio-button").addEventListener("input",function(){0!==z&&yt(0)}),document.querySelector("#cube-radio-button").addEventListener("input",function(){1!==z&&yt(1)}),document.querySelector("#octahedron-radio-button").addEventListener("input",function(){2!==z&&yt(2)});let rt=document.querySelectorAll("#scale-input, #rotation-angle-x-1-input, #rotation-angle-y-1-input, #rotation-angle-z-1-input, #rotation-angle-x-2-input, #rotation-angle-y-2-input, #rotation-angle-z-2-input");for(let t=0;t<rt.length;t++)rt[t].addEventListener("input",vt);document.querySelector("#randomize-parameters-button").addEventListener("click",function(t=!0){if(o)return;V=Y,$=H,j=X,K=B,J=G,Q=O,Z=.75*Math.random()-.375-V,tt=.75*Math.random()-.375-$,nt=1.5*Math.random()-.75-j,et=.75*Math.random()-.375-K,ot=.75*Math.random()-.375-J,at=1.5*Math.random()-.75-Q,document.querySelector("#rotation-angle-x-1-input").value=Math.round(1e6*(V+Z))/1e6,document.querySelector("#rotation-angle-y-1-input").value=Math.round(1e6*($+tt))/1e6,document.querySelector("#rotation-angle-z-1-input").value=Math.round(1e6*(j+nt))/1e6,document.querySelector("#rotation-angle-x-2-input").value=Math.round(1e6*(K+et))/1e6,document.querySelector("#rotation-angle-y-2-input").value=Math.round(1e6*(J+ot))/1e6,document.querySelector("#rotation-angle-z-2-input").value=Math.round(1e6*(Q+at))/1e6,N=D,W=0,t?gt():(Y=V+Z,H=$+tt,X=j+nt,B=K+et,G=J+ot,O=Q+at)}),window.addEventListener("resize",dt),setTimeout(dt,500),document.querySelector("#output-canvas").addEventListener("mousedown",function(n){a=!0,r=n.clientX,c=n.clientY,e||o||(e=!0,pt(g=w),t.uniform1i(st.antialiasing_uniform,0),window.requestAnimationFrame(lt))}),document.querySelector("#output-canvas").addEventListener("mousemove",function(t){if(a){t.preventDefault();let e=t.clientX,o=t.clientY,a=e-r,i=o-c;(p+=a/n*Math.PI)>=2*Math.PI?p-=2*Math.PI:p<0&&(p+=2*Math.PI),(v-=i/n*Math.PI)>Math.PI-.01?v=Math.PI-.01:v<.01&&(v=.01),r=e,c=o,ft()}}),document.documentElement.addEventListener("mouseup",function(n){!(e=(a=!1)||u||s||m||l||f||_)&&Date.now()-i>300&&(w=g,pt(g*=2),t.uniform1i(st.antialiasing_uniform,1),window.requestAnimationFrame(lt))}),document.querySelector("#output-canvas").addEventListener("touchstart",function(n){a=!0,r=n.touches[0].clientX,c=n.touches[0].clientY,2===n.touches.length?(f=!0,_=!1):3===n.touches.length&&(_=!0,f=!1),e||o||(e=!0,pt(g=w),t.uniform1i(st.antialiasing_uniform,0),window.requestAnimationFrame(lt))}),document.querySelector("#output-canvas").addEventListener("touchmove",function(t){t.preventDefault();let e=t.touches[0].clientX,o=t.touches[0].clientY,a=e-r,i=o-c;Math.abs(a)>20||Math.abs(i)>20||((p+=a/n*Math.PI)>=2*Math.PI?p-=2*Math.PI:p<0&&(p+=2*Math.PI),(v-=i/n*Math.PI)>Math.PI-.01?v=Math.PI-.01:v<.01&&(v=.01),r=e,c=o,ft())}),document.querySelector("#output-canvas").addEventListener("touchend",function(n){2===n.touches.length?(f=!0,_=!1):3===n.touches.length?(_=!0,f=!1):(f=!1,_=!1,0===n.touches.length&&(a=!1)),!(e=a||u||s||m||l||f||_)&&Date.now()-i>300&&(w=g,pt(g*=2),t.uniform1i(st.antialiasing_uniform,1),window.requestAnimationFrame(lt))}),document.documentElement.addEventListener("keydown",function(n){"INPUT"!==document.activeElement.tagName&&(87===n.keyCode?u=!0:83===n.keyCode&&(s=!0),68===n.keyCode?m=!0:65===n.keyCode&&(l=!0),e||o||(e=!0,pt(g=w),t.uniform1i(st.antialiasing_uniform,0),window.requestAnimationFrame(lt)))}),document.documentElement.addEventListener("keyup",function(n){87===n.keyCode?u=!1:83===n.keyCode&&(s=!1),68===n.keyCode?m=!1:65===n.keyCode&&(l=!1),!(e=a||u||s||m||l||f||_)&&Date.now()-i>300&&(w=g,pt(g*=2),t.uniform1i(st.antialiasing_uniform,1),window.requestAnimationFrame(lt))}),applet_canvases_to_resize=[document.querySelector("#output-canvas")],applet_canvas_resize_callback=function(){canvas_is_fullscreen?aspect_ratio>=1?(y=g,M=Math.floor(g/aspect_ratio)):(y=Math.floor(g*aspect_ratio),M=g):(y=g,M=g),n=Math.min(document.querySelector("#output-canvas").offsetWidth,document.querySelector("#output-canvas").offsetHeight),document.querySelector("#output-canvas").setAttribute("width",y),document.querySelector("#output-canvas").setAttribute("height",M),t.uniform1f(st.aspect_ratio_uniform,y/M),t.uniform1i(st.image_size_uniform,g),t.viewport(0,0,y,M),dt(),window.requestAnimationFrame(lt)},applet_canvas_true_fullscreen=!0,set_up_canvas_resizer(),setTimeout(function(){let n=mt(t,t.VERTEX_SHADER,ct),e=mt(t,t.FRAGMENT_SHADER,ut);st=t.createProgram(),t.attachShader(st,n),t.attachShader(st,e),t.linkProgram(st),t.getProgramParameter(st,t.LINK_STATUS)||(console.log(`Couldn't link shader program: ${t.getShaderInfoLog(shader)}`),t.deleteProgram(st));t.useProgram(st);let o=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,o),t.bufferData(t.ARRAY_BUFFER,new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0]),t.STATIC_DRAW),st.position_attribute=t.getAttribLocation(st,"position"),t.enableVertexAttribArray(st.position_attribute),t.vertexAttribPointer(st.position_attribute,3,t.FLOAT,!1,0,0),st.aspect_ratio_uniform=t.getUniformLocation(st,"aspect_ratio"),st.image_size_uniform=t.getUniformLocation(st,"image_size"),st.camera_pos_uniform=t.getUniformLocation(st,"camera_pos"),st.image_plane_center_pos_uniform=t.getUniformLocation(st,"image_plane_center_pos"),st.forward_vec_uniform=t.getUniformLocation(st,"forward_vec"),st.right_vec_uniform=t.getUniformLocation(st,"right_vec"),st.up_vec_uniform=t.getUniformLocation(st,"up_vec"),st.focal_length_uniform=t.getUniformLocation(st,"focal_length"),st.light_pos_uniform=t.getUniformLocation(st,"light_pos"),st.scale_center_uniform=t.getUniformLocation(st,"scale_center"),st.n1_uniform=t.getUniformLocation(st,"n1"),st.n2_uniform=t.getUniformLocation(st,"n2"),st.n3_uniform=t.getUniformLocation(st,"n3"),st.n4_uniform=t.getUniformLocation(st,"n4"),st.min_scale_factor_uniform=t.getUniformLocation(st,"min_scale_factor"),st.num_ns_uniform=t.getUniformLocation(st,"num_ns"),st.scale_uniform=t.getUniformLocation(st,"scale"),st.rotation_matrix_1_uniform=t.getUniformLocation(st,"rotation_matrix_1"),st.rotation_matrix_2_uniform=t.getUniformLocation(st,"rotation_matrix_2"),st.antialiasing_uniform=t.getUniformLocation(st,"antialiasing"),t.uniform1f(st.aspect_ratio_uniform,y/M),t.uniform1i(st.image_size_uniform,g),t.uniform3fv(st.camera_pos_uniform,A),t.uniform3fv(st.image_plane_center_pos_uniform,q),t.uniform3fv(st.forward_vec_uniform,b),t.uniform3fv(st.right_vec_uniform,x),t.uniform3fv(st.up_vec_uniform,L),t.uniform1f(st.focal_length_uniform,E),t.uniform3fv(st.light_pos_uniform,F[z]),t.uniform3fv(st.scale_center_uniform,R[z]),t.uniform3fv(st.n1_uniform,P[z]),t.uniform3fv(st.n2_uniform,k[z]),t.uniform3fv(st.n3_uniform,I[z]),t.uniform3fv(st.n4_uniform,U[z]),t.uniform1f(st.min_scale_factor_uniform,T[z]),t.uniform1i(st.num_ns_uniform,C[z]),t.uniform1f(st.scale_uniform,D),t.uniformMatrix3fv(st.rotation_matrix_1_uniform,!1,[1,0,0,0,1,0,0,0,1]),t.uniformMatrix3fv(st.rotation_matrix_2_uniform,!1,[1,0,0,0,1,0,0,0,1]),t.uniform1i(st.antialiasing_uniform,0),ft(),t.viewport(0,0,y,M),window.requestAnimationFrame(lt)},500);const ct="\n\t\tattribute vec3 position;\n\t\tvarying vec2 uv;\n\n\t\tvoid main(void)\n\t\t{\n\t\t\tgl_Position = vec4(position, 1.0);\n\n\t\t\t//Interpolate quad coordinates in the fragment shader.\n\t\t\tuv = position.xy;\n\t\t}\n\t",ut="\n\t\tprecision highp float;\n\t\t\n\t\tvarying vec2 uv;\n\t\t\n\t\tuniform float aspect_ratio;\n\t\t\n\t\tuniform vec3 camera_pos;\n\t\tuniform vec3 image_plane_center_pos;\n\t\tuniform vec3 forward_vec;\n\t\tuniform vec3 right_vec;\n\t\tuniform vec3 up_vec;\n\t\t\n\t\tuniform float focal_length;\n\t\t\n\t\tuniform vec3 light_pos;\n\t\tconst float light_brightness = 2.0;\n\t\t\n\t\tuniform int image_size;\n\t\t\n\t\tuniform int antialiasing;\n\t\t\n\t\t\n\t\t\n\t\tconst float clip_distance = 1000.0;\n\t\tconst int max_marches = 32;\n\t\tconst vec3 fog_color = vec3(0.0, 0.0, 0.0);\n\t\tconst float fog_scaling = .2;\n\t\tconst int num_sierpinski_iterations = 16;\n\t\t\n\t\t\n\t\tvec3 color;\n\t\t\n\t\tconst vec3 color_1 = vec3(1.0, 0.0, 0.0);\n\t\tconst vec3 color_2 = vec3(0.0, 1.0, 0.0);\n\t\tconst vec3 color_3 = vec3(0.0, 0.0, 1.0);\n\t\tconst vec3 color_4 = vec3(1.0, 1.0, 0.0);\n\t\t\n\t\t\n\t\t\n\t\tuniform vec3 scale_center;\n\t\t\n\t\tuniform int num_ns;\n\t\t\n\t\tuniform vec3 n1;\n\t\tuniform vec3 n2;\n\t\tuniform vec3 n3;\n\t\tuniform vec3 n4;\n\t\t\n\t\tuniform float min_scale_factor;\n\t\t\n\t\t\n\t\t\n\t\tuniform float scale;\n\t\t\n\t\t\n\t\t\n\t\tuniform mat3 rotation_matrix_1;\n\t\tuniform mat3 rotation_matrix_2;\n\t\t\n\t\t\n\t\t\n\t\tfloat distance_estimator(vec3 pos)\n\t\t{\n\t\t\tvec3 mutable_pos = pos;\n\t\t\t\n\t\t\tcolor = vec3(1.0, 1.0, 1.0);\n\t\t\tfloat color_scale = .5;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t//We'll find the closest vertex, scale everything by a factor of 2 centered on that vertex (so that we don't need to recalculate the vertices), and repeat.\n\t\t\tfor (int iteration = 0; iteration < num_sierpinski_iterations; iteration++)\n\t\t\t{\n\t\t\t\t\n\t\t\t\t//Fold space over on itself so that we can reference only the top vertex.\n\t\t\t\tfloat t1 = dot(mutable_pos, n1);\n\t\t\t\t\n\t\t\t\tif (t1 < 0.0)\n\t\t\t\t{\n\t\t\t\t\tmutable_pos -= 2.0 * t1 * n1;\n\t\t\t\t\t\n\t\t\t\t\tcolor = mix(color, color_1, color_scale);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfloat t2 = dot(mutable_pos, n2);\n\t\t\t\t\n\t\t\t\tif (t2 < 0.0)\n\t\t\t\t{\n\t\t\t\t\tmutable_pos -= 2.0 * t2 * n2;\n\t\t\t\t\t\n\t\t\t\t\tcolor = mix(color, color_2, color_scale);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tfloat t3 = dot(mutable_pos, n3);\n\t\t\t\t\n\t\t\t\tif (t3 < 0.0)\n\t\t\t\t{\n\t\t\t\t\tmutable_pos -= 2.0 * t3 * n3;\n\t\t\t\t\t\n\t\t\t\t\tcolor = mix(color, color_3, color_scale);\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\tif (num_ns >= 4)\n\t\t\t\t{\n\t\t\t\t\tfloat t4 = dot(mutable_pos, n4);\n\t\t\t\t\t\n\t\t\t\t\tif (t4 < 0.0)\n\t\t\t\t\t{\n\t\t\t\t\t\tmutable_pos -= 2.0 * t4 * n4;\n\t\t\t\t\t\t\n\t\t\t\t\t\tcolor = mix(color, color_4, color_scale);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tmutable_pos = rotation_matrix_1 * mutable_pos;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t//Scale the system -- this one takes me a fair bit of thinking to get. What's happening here is that we're stretching from a vertex, but since we never scale the vertices, the four new ones are the four closest to the vertex we scaled from. Now (x, y, z) will get farther and farther away from the origin, but that makes sense -- we're really just zooming in on the tetrahedron.\n\t\t\t\tmutable_pos = scale * mutable_pos - (scale - 1.0) * scale_center;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tmutable_pos = rotation_matrix_2 * mutable_pos;\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tcolor_scale *= .5;\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\treturn length(mutable_pos) * pow(1.0/scale, float(num_sierpinski_iterations));\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tvec3 get_surface_normal(vec3 pos)\n\t\t{\n\t\t\tfloat base = distance_estimator(pos);\n\t\t\t\n\t\t\tfloat x_step = distance_estimator(pos + vec3(.00001, 0.0, 0.0));\n\t\t\tfloat y_step = distance_estimator(pos + vec3(0.0, .00001, 0.0));\n\t\t\tfloat z_step = distance_estimator(pos + vec3(0.0, 0.0, .00001));\n\t\t\t\n\t\t\treturn normalize(vec3(x_step - base, y_step - base, z_step - base));\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tvec3 compute_shading(vec3 pos, int iteration)\n\t\t{\n\t\t\tvec3 surface_normal = get_surface_normal(pos);\n\t\t\t\n\t\t\tvec3 light_direction = normalize(light_pos - pos);\n\t\t\t\n\t\t\tfloat dot_product = dot(surface_normal, light_direction);\n\t\t\t\n\t\t\tfloat light_intensity = light_brightness * max(dot_product, -.25 * dot_product);\n\t\t\t\n\t\t\t//The last factor adds ambient occlusion.\n\t\t\tcolor = color * light_intensity * max((1.0 - float(iteration) / float(max_marches)), 0.0);\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\t//Apply fog.\n\t\t\treturn mix(color, fog_color, 1.0 - exp(-length(pos - camera_pos) * fog_scaling));\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tvec3 raymarch(vec3 start_pos)\n\t\t{\n\t\t\t//That factor of .9 is important -- without it, we're always stepping as far as possible, which results in artefacts and weirdness.\n\t\t\tvec3 ray_direction_vec = normalize(start_pos - camera_pos) * .9;\n\t\t\t\n\t\t\tvec3 final_color = fog_color;\n\t\t\t\n\t\t\tfloat normalized_scale = scale - min_scale_factor;\n\t\t\t\n\t\t\tfloat epsilon = 1.0 / (normalized_scale * normalized_scale) * .00001;\n\t\t\t\n\t\t\tfloat t = 0.0;\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\tfor (int iteration = 0; iteration < max_marches; iteration++)\n\t\t\t{\n\t\t\t\tvec3 pos = start_pos + t * ray_direction_vec;\n\t\t\t\t\n\t\t\t\tfloat distance = distance_estimator(pos);\n\t\t\t\t\n\t\t\t\t//This lowers the detail far away, which makes everything run nice and fast.\n\t\t\t\tif (distance / float(image_size) * 3.0 > epsilon)\n\t\t\t\t{\n\t\t\t\t\tepsilon = distance / float(image_size) * 3.0;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tif (distance < epsilon)\n\t\t\t\t{\n\t\t\t\t\tfinal_color = compute_shading(pos, iteration);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\telse if (t > clip_distance)\n\t\t\t\t{\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\t\n\t\t\t\t\n\t\t\t\t\n\t\t\t\tt += distance;\n\t\t\t}\n\t\t\t\n\t\t\t\n\t\t\t\n\t\t\treturn final_color;\n\t\t}\n\t\t\n\t\t\n\t\t\n\t\tvoid main(void)\n\t\t{\n\t\t\tif (antialiasing == 1)\n\t\t\t{\n\t\t\t\tvec3 final_color = (raymarch(image_plane_center_pos + right_vec * (uv.x * aspect_ratio + .5 / float(image_size)) + up_vec * (uv.y + .5 / float(image_size))) + raymarch(image_plane_center_pos + right_vec * (uv.x * aspect_ratio + .5 / float(image_size)) + up_vec * (uv.y - .5 / float(image_size))) + raymarch(image_plane_center_pos + right_vec * (uv.x * aspect_ratio - .5 / float(image_size)) + up_vec * (uv.y + .5 / float(image_size))) + raymarch(image_plane_center_pos + right_vec * (uv.x * aspect_ratio - .5 / float(image_size)) + up_vec * (uv.y - .5 / float(image_size)))) / 4.0;\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(final_color.xyz, 1.0);\n\t\t\t}\n\t\t\t\n\t\t\telse\n\t\t\t{\n\t\t\t\tvec3 final_color = raymarch(image_plane_center_pos + right_vec * uv.x * aspect_ratio + up_vec * uv.y);\n\t\t\t\t\n\t\t\t\tgl_FragColor = vec4(final_color.xyz, 1.0);\n\t\t\t}\n\t\t}\n\t";let st=null;function mt(t,n,e){let o=t.createShader(n);return t.shaderSource(o,e),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)||(console.log(`Couldn't load shader: ${t.getProgramInfoLog(shaderProgram)}`),t.deleteShader(o)),o}function lt(){t.drawArrays(t.TRIANGLE_STRIP,0,4),o?(!function(){let n=.5*Math.sin(Math.PI*it/120-Math.PI/2)+.5;D=N+W*n,Y=V+Z*n,H=$+tt*n,X=j+nt*n,B=K+et*n,G=J+ot*n,O=Q+at*n,t.uniform1f(st.scale_uniform,D);let e=[[Math.cos(X),-Math.sin(X),0],[Math.sin(X),Math.cos(X),0],[0,0,1]],a=[[Math.cos(H),0,-Math.sin(H)],[0,1,0],[Math.sin(H),0,Math.cos(H)]],i=[[1,0,0],[0,Math.cos(Y),-Math.sin(Y)],[0,Math.sin(Y),Math.cos(Y)]],r=ht(ht(e,a),i);t.uniformMatrix3fv(st.rotation_matrix_1_uniform,!1,[r[0][0],r[1][0],r[2][0],r[0][1],r[1][1],r[2][1],r[0][2],r[1][2],r[2][2]]),e=[[Math.cos(O),-Math.sin(O),0],[Math.sin(O),Math.cos(O),0],[0,0,1]],a=[[Math.cos(G),0,-Math.sin(G)],[0,1,0],[Math.sin(G),0,Math.cos(G)]],i=[[1,0,0],[0,Math.cos(B),-Math.sin(B)],[0,Math.sin(B),Math.cos(B)]],r=ht(ht(e,a),i),t.uniformMatrix3fv(st.rotation_matrix_2_uniform,!1,[r[0][0],r[1][0],r[2][0],r[0][1],r[1][1],r[2][1],r[0][2],r[1][2],r[2][2]]),121==++it&&(o=!1)}(),window.requestAnimationFrame(lt)):e&&((u||s||m||l||f||_)&&((h=d/20)<25e-6&&(h=25e-6),h>.02&&(h=.02),u||f?(A[0]+=h*b[0],A[1]+=h*b[1],A[2]+=h*b[2]):(s||_)&&(A[0]-=h*b[0],A[1]-=h*b[1],A[2]-=h*b[2]),m?(A[0]+=h*x[0]/E,A[1]+=h*x[1]/E,A[2]+=h*x[2]/E):l&&(A[0]-=h*x[0]/E,A[1]-=h*x[1]/E,A[2]-=h*x[2]/E),ft()),window.requestAnimationFrame(lt))}function ft(){var n,e;b=[Math.cos(p)*Math.sin(v),Math.sin(p)*Math.sin(v),Math.cos(v)],x=function(t){let n=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);return[t[0]/n,t[1]/n,t[2]/n]}([b[1],-b[0],0]),e=b,L=[(n=x)[1]*e[2]-n[2]*e[1],n[2]*e[0]-n[0]*e[2],n[0]*e[1]-n[1]*e[0]],d=function(t,n,e){for(let o=0;o<S;o++){let o=_t([t,n,e],P[z]);o<0&&(t-=2*o*P[z][0],n-=2*o*P[z][1],e-=2*o*P[z][2]);let a=_t([t,n,e],k[z]);a<0&&(t-=2*a*k[z][0],n-=2*a*k[z][1],e-=2*a*k[z][2]);let i=_t([t,n,e],I[z]);if(i<0&&(t-=2*i*I[z][0],n-=2*i*I[z][1],e-=2*i*I[z][2]),C[z]>=4){let o=_t([t,n,e],U[z]);o<0&&(t-=2*o*U[z][0],n-=2*o*U[z][1],e-=2*o*U[z][2])}let r=t,c=n,u=e,s=[[Math.cos(X),-Math.sin(X),0],[Math.sin(X),Math.cos(X),0],[0,0,1]],m=[[Math.cos(H),0,-Math.sin(H)],[0,1,0],[Math.sin(H),0,Math.cos(H)]],l=[[1,0,0],[0,Math.cos(Y),-Math.sin(Y)],[0,Math.sin(Y),Math.cos(Y)]],f=ht(ht(s,m),l);t=f[0][0]*r+f[0][1]*c+f[0][2]*u,n=f[1][0]*r+f[1][1]*c+f[1][2]*u,e=f[2][0]*r+f[2][1]*c+f[2][2]*u,t=D*t-(D-1)*R[z][0],n=D*n-(D-1)*R[z][1],e=D*e-(D-1)*R[z][2],r=t,c=n,u=e,s=[[Math.cos(O),-Math.sin(O),0],[Math.sin(O),Math.cos(O),0],[0,0,1]],m=[[Math.cos(G),0,-Math.sin(G)],[0,1,0],[Math.sin(G),0,Math.cos(G)]],l=[[1,0,0],[0,Math.cos(B),-Math.sin(B)],[0,Math.sin(B),Math.cos(B)]],f=ht(ht(s,m),l),t=f[0][0]*r+f[0][1]*c+f[0][2]*u,n=f[1][0]*r+f[1][1]*c+f[1][2]*u,e=f[2][0]*r+f[2][1]*c+f[2][2]*u}return Math.sqrt(t*t+n*n+e*e)*Math.pow(D,-S)}(A[0],A[1],A[2]),E=d/2,x[0]*=E/2,x[1]*=E/2,L[0]*=E/2,L[1]*=E/2,L[2]*=E/2,q=[A[0]+E*b[0],A[1]+E*b[1],A[2]+E*b[2]],t.uniform3fv(st.camera_pos_uniform,A),t.uniform3fv(st.image_plane_center_pos_uniform,q),t.uniform3fv(st.forward_vec_uniform,b),t.uniform3fv(st.right_vec_uniform,x),t.uniform3fv(st.up_vec_uniform,L),t.uniform1f(st.focal_length_uniform,E)}function _t(t,n){return t[0]*n[0]+t[1]*n[1]+t[2]*n[2]}function ht(t,n){return[[t[0][0]*n[0][0]+t[0][1]*n[1][0]+t[0][2]*n[2][0],t[0][0]*n[0][1]+t[0][1]*n[1][1]+t[0][2]*n[2][1],t[0][0]*n[0][2]+t[0][1]*n[1][2]+t[0][2]*n[2][2]],[t[1][0]*n[0][0]+t[1][1]*n[1][0]+t[1][2]*n[2][0],t[1][0]*n[0][1]+t[1][1]*n[1][1]+t[1][2]*n[2][1],t[1][0]*n[0][2]+t[1][1]*n[1][2]+t[1][2]*n[2][2]],[t[2][0]*n[0][0]+t[2][1]*n[1][0]+t[2][2]*n[2][0],t[2][0]*n[0][1]+t[2][1]*n[1][1]+t[2][2]*n[2][1],t[2][0]*n[0][2]+t[2][1]*n[1][2]+t[2][2]*n[2][2]]]}function dt(){n=Math.min(document.querySelector("#output-canvas").offsetWidth,document.querySelector("#output-canvas").offsetHeight)}function pt(n=0){0===n?((g=parseInt(document.querySelector("#dim-input").value||500))<200&&(g=200),g>2e3&&(g=2e3)):g=n,canvas_is_fullscreen&&(aspect_ratio>=1?(y=g,M=Math.floor(g/aspect_ratio)):(y=Math.floor(g*aspect_ratio),M=g)),document.querySelector("#output-canvas").setAttribute("width",y),document.querySelector("#output-canvas").setAttribute("height",M),t.uniform1f(st.aspect_ratio_uniform,y/M),t.uniform1i(st.image_size_uniform,g),t.viewport(0,0,y,M),window.requestAnimationFrame(lt)}function vt(){N=D,V=Y,$=H,j=X,K=B,J=G,Q=O,W=(parseFloat(document.querySelector("#scale-input").value||2)||2)-N,Z=(parseFloat(document.querySelector("#rotation-angle-x-1-input").value||0)||0)-V,tt=(parseFloat(document.querySelector("#rotation-angle-y-1-input").value||0)||0)-$,nt=(parseFloat(document.querySelector("#rotation-angle-z-1-input").value||0)||0)-j,et=(parseFloat(document.querySelector("#rotation-angle-x-2-input").value||0)||0)-K,ot=(parseFloat(document.querySelector("#rotation-angle-y-2-input").value||0)||0)-J,at=(parseFloat(document.querySelector("#rotation-angle-z-2-input").value||0)||0)-Q,N+W<T[z]+.1&&(W=T[z]+.1-N),gt()}function gt(){o=!0,it=0,window.requestAnimationFrame(lt)}function yt(n){document.querySelector("#output-canvas").classList.add("animated-opacity"),document.querySelector("#output-canvas").style.opacity=0,setTimeout(function(){z=n,t.uniform3fv(st.light_pos_uniform,F[z]),t.uniform3fv(st.scale_center_uniform,R[z]),t.uniform3fv(st.n1_uniform,P[z]),t.uniform3fv(st.n2_uniform,k[z]),t.uniform3fv(st.n3_uniform,I[z]),t.uniform3fv(st.n4_uniform,U[z]),t.uniform1f(st.min_scale_factor_uniform,T[z]),t.uniform1i(st.num_ns_uniform,C[z]),window.requestAnimationFrame(lt),document.querySelector("#output-canvas").style.opacity=1,setTimeout(function(){document.querySelector("#output-canvas").classList.remove("animated-opacity")})},300)}}();